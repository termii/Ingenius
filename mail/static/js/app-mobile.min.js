/*!
 * Copyright 2004-2015, AfterLogic Corp.
 * Licensed under AGPLv3 license or AfterLogic license
 * if commerical version of the product was purchased.
 * See the LICENSE file for a full license statement.
 */
!function($,window,ko,crossroads,hasher){"use strict";function CBrowser(){this.ie11=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./),this.ie=/msie/.test(navigator.userAgent.toLowerCase())&&!window.opera||this.ie11,this.ieVersion=this.getIeVersion(),this.ie8AndBelow=this.ie&&this.ieVersion<=8,this.ie9AndBelow=this.ie&&this.ieVersion<=9,this.ie10AndAbove=this.ie&&this.ieVersion>=10,this.opera=!!window.opera||/opr/.test(navigator.userAgent.toLowerCase()),this.firefox=/firefox/.test(navigator.userAgent.toLowerCase()),this.chrome=/chrome/.test(navigator.userAgent.toLowerCase())&&!/opr/.test(navigator.userAgent.toLowerCase()),this.chromeIos=/crios/.test(navigator.userAgent.toLowerCase()),this.safari=/safari/.test(navigator.userAgent.toLowerCase())&&!this.chromeIos}function CAjax(){this.sUrl="?/Ajax/",this.requests=ko.observableArray([]),this.openedRequestsCount=ko.observable(0),this.requests.subscribe(function(){this.openedRequestsCount(this.requests().length)},this),this.aActionsWithoutAuthForSend=["SystemLogin","SystemUpdateLanguageOnLogin","SystemLogout","AccountCreate","SystemSetMobile","AccountRegister","AccountGetForgotQuestion","AccountValidateForgotQuestion","AccountChangeForgotPassword"],this.aActionsWithoutAuthForSendExt=["SocialRegister","HelpdeskRegister","HelpdeskForgot","HelpdeskLogin","HelpdeskForgotChangePassword","SystemLogout","CalendarList","CalendarEventList","FilesPub"]}function CRouting(){this.defaultScreen=Enums.Screens.Mailbox,this.currentScreen=Enums.Screens.Mailbox,this.lastMailboxHash=ko.observable(Enums.Screens.Mailbox),this.lastHelpdeskHash=ko.observable(Enums.Screens.Helpdesk),this.lastSettingsHash=ko.observable(Enums.Screens.Settings),this.currentHash=ko.observable(""),this.previousHash=ko.observable("")}function CLinkBuilder(){}function CMessageSender(){this.replyText=ko.observable(""),this.replyDraftUid=ko.observable(""),this.postponedMailData=null}function CPrefetcher(){this.prefetchStarted=ko.observable(!1),this.serverInitializationsDone=ko.observable(!1),this.helpdeskInitialized=ko.observable(!1),this.fetchersIdentitiesPrefetched=ko.observable(!1),this.init()}function CSelector(e,t,i,s,o,n,r,a,l,h){this.fBeforeSelectCallback=null,this.fSelectCallback=t||function(){},this.fDeleteCallback=i||function(){},this.fDblClickCallback=!bMobileApp&&s?s:function(){},this.fEnterCallback=o||function(){},this.bResetCheckedOnClick=Utils.isUnd(r)?!1:!!r,this.bCheckOnSelect=Utils.isUnd(a)?!1:!!a,this.bUnselectOnCtrl=Utils.isUnd(l)?!1:!!l,this.bDisableMultiplySelection=Utils.isUnd(h)?!1:!!h,this.useKeyboardKeys=ko.observable(!1),this.list=ko.observableArray([]),e&&e.subscribe&&e.subscribe(function(e){this.list(e)},this),this.multiplyLineFactor=n,this.oLast=null,this.oListScope=null,this.oScrollScope=null,this.iTimer=0,this.iFactor=1,this.KeyUp=Enums.Key.Up,this.KeyDown=Enums.Key.Down,this.KeyLeft=Enums.Key.Up,this.KeyRight=Enums.Key.Down,this.multiplyLineFactor&&(this.multiplyLineFactor.subscribe?this.multiplyLineFactor.subscribe(function(e){this.iFactor=e>0?e:1},this):this.iFactor=Utils.pInt(this.multiplyLineFactor),this.KeyUp=Enums.Key.Up,this.KeyDown=Enums.Key.Down,this.KeyLeft=Enums.Key.Left,this.KeyRight=Enums.Key.Right,$("html").hasClass("rtl")&&(this.KeyLeft=Enums.Key.Right,this.KeyRight=Enums.Key.Left)),this.sActionSelector="",this.sSelectabelSelector="",this.sCheckboxSelector="";var c=this;this.listChecked=ko.computed({read:function(){var e=_.filter(this.list(),function(e){var t=e.checked(),i=e.selected();return t||c.bCheckOnSelect&&i});return e},write:function(e){e=!!e,_.each(this.list(),function(t){t.checked(e)}),this.list.valueHasMutated()},owner:this}),this.checkAll=ko.computed({read:function(){return 0<this.listChecked().length},write:function(e){this.listChecked(!!e)},owner:this}),this.selectorHook=ko.observable(null),this.selectorHook.subscribe(function(){var e=this.selectorHook();e&&e.selected(!1)},this,"beforeChange"),this.selectorHook.subscribe(function(e){e&&e.selected(!0)},this),this.itemSelected=ko.computed({read:this.selectorHook,write:function(e){this.selectorHook(e),e&&(this.oLast=e)},owner:this}),this.list.subscribe(function(e){if(_.isArray(e)){var t=this.itemSelected();t&&(_.find(e,function(e){return t===e})||this.itemSelected(null))}else this.itemSelected(null)},this),this.listCheckedOrSelected=ko.computed({read:function(){var e=this.itemSelected(),t=this.listChecked();return 0<t.length?t:e?[e]:[]},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.listCheckedAndSelected=ko.computed({read:function(){var e=[],t=this.itemSelected(),i=this.listChecked();return i&&(e=i.slice(0)),t&&-1===_.indexOf(i,t)&&e.push(t),e},write:function(e){e?this.listChecked(!0):(this.itemSelected(null),this.listChecked(!1))},owner:this}),this.isIncompleteChecked=ko.computed(function(){var e=this.list().length,t=this.listChecked().length;return e>0&&t>0&&e>t},this),this.onKeydownBinded=_.bind(this.onKeydown,this)}function CApi(){this.openPgp=null,this.openPgpCallbacks=[]}function CStorage(){this.bHtml5=!0,this.init()}function OpenPgp(e,t){this.pgp=e,this.pgpKeyring=new this.pgp.Keyring(new this.pgp.Keyring.localstore(t)),this.keys=ko.observableArray([]),this.reloadKeysFromStorage()}function OpenPgpKey(e){this.pgpKey=e;var t=this.pgpKey.getPrimaryUser();this.user=t&&t.user?t.user.userId.userid:this.pgpKey.users&&this.pgpKey.users[0]?this.pgpKey.users[0].userId.userid:"",this.emailParts=Utils.Address.getEmailParts(this.user)}function OpenPgpResult(){this.result=!0,this.errors=null,this.notices=null,this.exceptions=null}function AlertPopup(){this.alertDesc=ko.observable(""),this.closeCallback=null,this.title=ko.observable(""),this.okButtonText=ko.observable(Utils.i18n("MAIN/BUTTON_OK"))}function ConfirmPopup(){this.fConfirmCallback=null,this.confirmDesc=ko.observable(""),this.title=ko.observable(""),this.okButtonText=ko.observable(Utils.i18n("MAIN/BUTTON_OK")),this.cancelButtonText=ko.observable(Utils.i18n("MAIN/BUTTON_CANCEL")),this.shown=!1}function CImportOpenPgpKeyPopup(){this.pgp=null,this.keyArmor=ko.observable(""),this.keyArmorFocused=ko.observable(!1),this.keys=ko.observableArray([]),this.hasExistingKeys=ko.observable(!1),this.headlineText=ko.computed(function(){return Utils.i18n("OPENPGP/INFO_TEXT_INCLUDES_KEYS_PLURAL",{},null,this.keys().length)},this)}function CAppSettingsModel(e){this.AllowWebMail=!0,this.AllowUsersChangeInterfaceSettings=!0,this.AllowUsersChangeEmailSettings=!0,this.AllowUsersAddNewAccounts=!0,this.SiteName="",this.Languages=[{name:"English",value:"en"}],this.Themes=["Default"],this.DateFormats=[],this.DefaultLanguage="English",this.AttachmentSizeLimit=1024e4,this.ImageUploadSizeLimit=1024e4,this.FileSizeLimit=1024e4,this.AutoSave=!0,this.AutoSaveIntervalSeconds=60,this.IdleSessionTimeout=0,this.AllowInsertImage=!0,this.AllowBodySize=!1,this.MaxBodySize=600,this.MaxSubjectSize=255,this.JoinReplyPrefixes=!0,this.AllowAppRegisterMailto=!0,this.AllowPrefetch=!0,this.MaxPrefetchBodiesSize=5e4,this.LoginFormType=Enums.LoginFormType.Email,this.LoginAtDomainValue="",this.AllowRegistration=!1,this.AllowPasswordReset=!1,this.RegistrationDomains=[],this.RegistrationQuestions=[],this.DemoWebMail=!0,this.DemoWebMailLogin="",this.DemoWebMailPassword="",this.LoginDescription="",this.GoogleAnalyticsAccount="",this.ShowQuotaBar=!1,this.ServerUseUrlRewrite=!1,this.AllowLanguageOnLogin=!1,this.FlagsLangSelect=!1,this.CustomLoginUrl="",this.CustomLogoutUrl="",this.IosDetectOnLogin=!1,this.AllowContactsSharing=!1,this.DefaultLanguageShort="en",this.AllowOpenPgp=e,this.DefaultTab="",this.AllowIosProfile=!0,this.PasswordMinLength=0,this.PasswordMustBeComplex=!1}function CUserSettingsModel(){this.IdUser=1,this.MailsPerPage=20,this.ContactsPerPage=20,this.iInterval=-1,this.AutoCheckMailInterval=0,this.DefaultTheme="Default",this.DefaultLanguage="English",this.DefaultLanguageShort="en",this.DefaultDateFormat="MM/DD/YYYY",this.defaultTimeFormat=ko.observable(Enums.TimeFormat.F24),this.ThreadsEnabled=!0,this.useThreads=ko.observable(!0),this.SaveRepliedToCurrFolder=!0,this.AllowChangeInputDirection=!1,this.DesktopNotifications=!1,this.EmailNotification="",this.AllowCompose=!0,this.AllowReply=!0,this.AllowForward=!0,this.SaveMail=Enums.SaveMail.Checked,this.AllowFetcher=!1,this.OutlookSyncEnable=!0,this.MobileSyncEnable=!0,this.ShowPersonalContacts=!0,this.ShowGlobalContacts=!1,this.IsFilesSupported=!1,this.IsHelpdeskSupported=!1,this.IsHelpdeskAgent=!1,this.HelpdeskIframeUrl="",this.ShowContacts=this.ShowPersonalContacts||this.ShowGlobalContacts,this.LastLogin=0,this.LoginsCount=0,this.SocialName=0,this.IsDemo=!1,this.AllowVoice=!1,this.SipRealm="",this.SipWebsocketProxyUrl="",this.SipOutboundProxyUrl="",this.SipCallerID="",this.SipImpi="",this.SipImpu="",this.SipPassword="",this.VoiceProvider="",this.AllowCalendar=!0,this.CalendarSharing=!1,this.CalendarAppointments=!1,this.CalendarShowWeekEnds=!1,this.CalendarShowWorkDay=!1,this.CalendarWorkDayStarts=0,this.CalendarWorkDayEnds=0,this.CalendarWeekStartsOn=0,this.CalendarDefaultTab=Enums.CalendarDefaultTab.Month,this.mobileSync=ko.observable(null),this.MobileSyncDemoPass="demo",this.outlookSync=ko.observable(null),this.OutlookSyncDemoPass="demo",this.AllowHelpdeskNotifications=!1,this.IsCollaborationSupported=!1,this.AllowFilesSharing=!1,this.DefaultFontName="Tahoma",this.fillDefaultFontName(),this.DefaultFontSize=3,this.fillDefaultFontSize(),this.enableOpenPgp=ko.observable(!1),this.AllowAutosaveInDrafts=!0,this.AutosignOutgoingEmails=!1,this.filesEnable=ko.observable(!0),this.helpdeskSignature=ko.observable(""),this.helpdeskSignatureEnable=ko.observable(!1),this.SocialAccounts=ko.observableArray([]),this.CanLoginWithPassword=!0}function CAccountModel(){this.id=ko.observable(0),this.email=ko.observable(""),this.allowMail=ko.observable(!0),this.passwordSpecified=ko.observable(!0),this.extensions=ko.observableArray([]),this.fetchers=ko.observable(null),this.identities=ko.observable(null),this.friendlyName=ko.observable(""),this.incomingMailLogin=ko.observable(""),this.incomingMailServer=ko.observable(""),this.incomingMailPort=ko.observable(143),this.incomingMailSsl=ko.observable(!1),this.isInternal=ko.observable(!1),this.isLinked=ko.observable(!1),this.isDefault=ko.observable(!1),this.outgoingMailAuth=ko.observable(0),this.outgoingMailLogin=ko.observable(""),this.outgoingMailServer=ko.observable(""),this.outgoingMailPort=ko.observable(25),this.outgoingMailSsl=ko.observable(!1),this.isExtended=ko.observable(!1),this.signature=ko.observable(null),this.autoresponder=ko.observable(null),this.forward=ko.observable(null),this.filters=ko.observable(null),this.quota=ko.observable(0),this.usedSpace=ko.observable(0),this.quotaRecieved=ko.observable(!1),this.fullEmail=ko.computed(function(){return Utils.Address.getFullEmail(this.friendlyName(),this.email())},this),this.isCurrent=ko.observable(!1),this.isEdited=ko.observable(!1),this.extensionsRequested=ko.observable(!1),this.canBeRemoved=ko.computed(function(){return!this.isInternal()&&(!this.isDefault()||this.isDefault()&&AppData.App.AllowUsersChangeEmailSettings)},this),this.removeHint=ko.computed(function(){var e="",t="";return this.isDefault()?(AppData.User.AllowCalendar&&AppData.User.ShowContacts?e=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CONTACTS_CALENDARS_HINT"):AppData.User.AllowCalendar?e=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CALENDARS_HINT"):AppData.User.ShowContacts&&(e=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CONTACTS_HINT")),t=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_HINT",{AND_OTHER:e}),AppData.Accounts.collection().length>1&&(t+=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_NOTSINGLE_HINT"))):t=Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_HINT"),t},this),this.removeConfirmation=ko.computed(function(){return this.isDefault()?this.removeHint()+Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_DEFAULT_CONFIRMATION"):Utils.i18n("SETTINGS/ACCOUNTS_REMOVE_CONFIRMATION")},this)}function CAccountListModel(){this.defaultId=ko.observable(0),this.currentId=ko.observable(0),this.editedId=ko.observable(0),this.isCurrentAllowsMail=ko.observable(!0),this.bLockEditedWhenCurrentChange=!0,this.currentId.subscribe(function(e){var t=this.getCurrent();t.requestExtensions(),this.checkIfMailAllowed(),this.bLockEditedWhenCurrentChange||_.delay(_.bind(function(){this.editedId(e)},this),1e3)},this),this.collection=ko.observableArray([])}function CAddressModel(){this.sName="",this.sEmail="",this.sDisplay="",this.sFull="",this.loaded=ko.observable(!1),this.found=ko.observable(!1)}function CAddressListModel(){this.aCollection=[]}function CDateModel(){this.iTimeStampInUTC=0,this.oMoment=null}function CIdentityModel(){this.loyal=ko.observable(!1),this.isDefault=ko.observable(!1),this.enabled=ko.observable(!0),this.email=ko.observable(""),this.friendlyName=ko.observable(""),this.fullEmail=ko.computed(function(){return Utils.Address.getFullEmail(this.friendlyName(),this.email())},this),this.accountId=ko.observable(-1),this.id=ko.observable(-1),this.signature=ko.observable(""),this.useSignature=ko.observable(!1)}function CCommonFileModel(){this.isIosDevice=bIsIosDevice,this.isFolder=ko.observable(!1),this.isLink=ko.observable(!1),this.linkType=ko.observable(Enums.FileStorageLinkType.Unknown),this.linkUrl=ko.observable(""),this.isPopupItem=ko.observable(!1),this.id=ko.observable(""),this.fileName=ko.observable(""),this.tempName=ko.observable(""),this.displayName=ko.observable(""),this.extension=ko.observable(""),this.oembed=ko.observable(""),this.linkType.subscribe(function(e){var t="";switch(e){case Enums.FileStorageLinkType.YouTube:t="YouTube";break;case Enums.FileStorageLinkType.Vimeo:(!App.browser.ie||App.browser.ie11)&&(t="Vimeo");break;case Enums.FileStorageLinkType.SoundCloud:(!App.browser.ie||App.browser.ie10AndAbove)&&(t="SoundCloud")}this.oembed(t)},this),this.fileName.subscribe(function(e){this.id(e),this.displayName(e),this.extension(this.isFolder()?"":Utils.getFileExtension(e))},this),this.size=ko.observable(0),this.friendlySize=ko.computed(function(){return this.size()>0?Utils.friendlySize(this.size()):""},this),this.content=ko.observable(""),this.accountId=ko.observable(AppData.Accounts?AppData.Accounts.defaultId():null),this.hash=ko.observable(""),this.thumb=ko.observable(!1),this.iframedView=ko.observable(!1),this.downloadLink=ko.computed(function(){return Utils.getDownloadLinkByHash(this.accountId(),this.hash())},this),this.viewLink=ko.computed(function(){var e=Utils.File.getViewLinkByHash(this.accountId(),this.hash());return this.iframedView()?Utils.getIframeWrappwer(this.accountId(),e):e},this),this.thumbnailSrc=ko.observable(""),this.thumbnailLoaded=ko.observable(!1),this.thumbnailSessionUid=ko.observable(""),this.thumbnailLink=ko.computed(function(){return this.thumb()?Utils.getViewThumbnailLinkByHash(this.accountId(),this.hash()):""},this),this.type=ko.observable(""),this.uploadUid=ko.observable(""),this.uploaded=ko.observable(!1),this.uploadError=ko.observable(!1),this.visibleImportLink=ko.computed(function(){return AppData.User.enableOpenPgp()&&"asc"===this.extension().toLowerCase()&&""!==this.content()&&!this.isPopupItem()},this),this.isViewMimeType=ko.computed(function(){return-1!==$.inArray(this.type(),aViewMimeTypes)||this.iframedView()},this),this.isMessageType=ko.observable(!1),this.visibleViewLink=ko.computed(function(){return this.isVisibleViewLink()&&!this.isPopupItem()},this),this.visibleOpenLink=ko.computed(function(){return""!==this.linkUrl()},this),this.visibleDownloadLink=ko.computed(function(){return!this.isPopupItem()&&!this.visibleOpenLink()},this),this.subFiles=ko.observableArray([]),this.allowExpandSubFiles=ko.observable(!1),this.subFilesLoaded=ko.observable(!1),this.subFilesCollapsed=ko.observable(!1),this.subFilesStartedLoading=ko.observable(!1),this.visibleExpandLink=ko.computed(function(){return this.allowExpandSubFiles()&&!this.subFilesCollapsed()&&!this.subFilesStartedLoading()},this),this.visibleExpandingText=ko.computed(function(){return this.allowExpandSubFiles()&&!this.subFilesCollapsed()&&this.subFilesStartedLoading()},this),this.visibleSpinner=ko.observable(!1),this.statusText=ko.observable(""),this.statusTooltip=ko.computed(function(){return this.uploadError()?this.statusText():""},this),this.progressPercent=ko.observable(0),this.visibleProgress=ko.observable(!1),this.uploadStarted=ko.observable(!1),this.uploadStarted.subscribe(function(){this.uploadStarted()?(this.uploaded(!1),this.visibleProgress(!0),this.progressPercent(20)):(this.progressPercent(100),this.visibleProgress(!1),this.uploaded(!0))},this),this.allowDrag=ko.observable(!1),this.allowSelect=ko.observable(!1),this.allowCheck=ko.observable(!1),this.allowDelete=ko.observable(!1),this.allowUpload=ko.observable(!1),this.allowSharing=ko.observable(!1),this.allowHeader=ko.observable(!1),this.allowDownload=ko.observable(!0),this.downloadTitle=ko.computed(function(){var e="";return!this.allowSelect()&&this.allowDownload()&&(e=Utils.i18n("MESSAGE/ATTACHMENT_CLICK_TO_DOWNLOAD",{FILENAME:this.fileName(),SIZE:this.friendlySize()}),""===this.friendlySize()&&(e=e.replace(" ()",""))),e},this),this.oembedHtml=ko.observable("")}function CMailAttachmentModel(){this.folderName=ko.observable(""),this.messageUid=ko.observable(""),this.cid=ko.observable(""),this.contentLocation=ko.observable(""),this.inline=ko.observable(!1),this.linked=ko.observable(!1),this.mimePartIndex=ko.observable(""),this.messagePart=ko.observable(null),CCommonFileModel.call(this),this.isMessageType=ko.computed(function(){return this.type(),this.mimePartIndex(),"message/rfc822"===this.type()&&""!==this.mimePartIndex()},this)}function CFolderModel(e){this.iAccountId=e,this.bNamespace=!1,this.iLevel=0,this.sDelimiter="",this.bExists=!0,this.sUidNext="",this.sHash="",this.messageCount=ko.observable(0),this.unseenMessageCount=ko.observable(0),this.sRealUnseenMessageCount=0,this.hasExtendedInfo=ko.observable(!1),this.fullName=ko.observable(""),this.fullNameHash=ko.observable(""),this.bSelectable=!0,this.subscribed=ko.observable(!0),this.name=ko.observable(""),this.nameForEdit=ko.observable(""),this.subfolders=ko.observableArray([]),this.subfoldersMessagesCount=ko.observable(0),this.type=ko.observable(Enums.FolderTypes.User),this.bVirtual=!1,this.selected=ko.observable(!1),this.expanded=ko.observable(!1),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.edited=ko.observable(!1),this.oMessages={},this.oUids={},this.aResponseHandlers=[],this.aRequestedUids=[],this.aRequestedThreadUids=[],this.requestedLists=[],this.hasChanges=ko.observable(!1),this.relevantInformationLastMoment=null}function CFolderListModel(){this.iAccountId=0,this.bInitialized=ko.observable(!1),this.expandFolders=ko.observable(!1),this.expandNames=ko.observableArray([]),this.collection=ko.observableArray([]),this.options=ko.observableArray([]),this.sNamespaceFolder="",this.oStarredFolder=null,this.oNamedCollection={},this.aLinedCollection=[];var e=this,t=function(e){return function(t){t&&t.type(e)}},i=function(t){return{read:function(){return this.collection(),t()?t().fullName():""},write:function(e){t(this.getFolderByFullName(e))},owner:e}};this.currentFolder=ko.observable(null),this.inboxFolder=ko.observable(null),this.sentFolder=ko.observable(null),this.draftsFolder=ko.observable(null),this.spamFolder=ko.observable(null),this.trashFolder=ko.observable(null),this.countsCompletelyFilled=ko.observable(!1),this.inboxFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.sentFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.draftsFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.spamFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.trashFolder.subscribe(t(Enums.FolderTypes.User),this,"beforeChange"),this.inboxFolder.subscribe(t(Enums.FolderTypes.Inbox)),this.sentFolder.subscribe(t(Enums.FolderTypes.Sent)),this.draftsFolder.subscribe(t(Enums.FolderTypes.Drafts)),this.spamFolder.subscribe(t(Enums.FolderTypes.Spam)),this.trashFolder.subscribe(t(Enums.FolderTypes.Trash)),this.inboxFolderFullName=ko.computed(i(this.inboxFolder)),this.sentFolderFullName=ko.computed(i(this.sentFolder)),this.draftsFolderFullName=ko.computed(i(this.draftsFolder)),this.spamFolderFullName=ko.computed(i(this.spamFolder)),this.trashFolderFullName=ko.computed(i(this.trashFolder)),this.currentFolderFullName=ko.computed(i(this.currentFolder)),this.currentFolderType=ko.computed(function(){return this.currentFolder()?this.currentFolder().type():Enums.FolderTypes.User},this),this.sDelimiter=""}function CMessageModel(){this.accountId=ko.observable(AppData.Accounts.currentId()),this.folder=ko.observable(""),this.uid=ko.observable(""),this.subject=ko.observable(""),this.emptySubject=ko.computed(function(){return""===Utils.trim(this.subject())},this),this.subjectForDisplay=ko.computed(function(){return this.emptySubject()?Utils.i18n("MAILBOX/EMPTY_SUBJECT"):this.subject()},this),this.messageId=ko.observable(""),this.size=ko.observable(0),this.friendlySize=ko.computed(function(){return Utils.friendlySize(this.size())},this),this.textSize=ko.observable(0),this.oDateModel=new CDateModel,this.fullDate=ko.observable(""),this.oFrom=new CAddressListModel,this.fullFrom=ko.observable(""),this.oTo=new CAddressListModel,this.to=ko.observable(""),this.fromOrToText=ko.observable(""),this.oCc=new CAddressListModel,this.cc=ko.observable(""),this.oBcc=new CAddressListModel,this.bcc=ko.observable(""),this.oSender=new CAddressListModel,this.oReplyTo=new CAddressListModel,this.seen=ko.observable(!1),this.flagged=ko.observable(!1),this.partialFlagged=ko.observable(!1),this.answered=ko.observable(!1),this.forwarded=ko.observable(!1),this.hasAttachments=ko.observable(!1),this.hasIcalAttachment=ko.observable(!1),this.hasVcardAttachment=ko.observable(!1),this.showCalendarIcon=ko.computed(function(){return AppData.User.AllowCalendar&&this.hasIcalAttachment()},this),this.folderObject=ko.computed(function(){return App.MailCache.getFolderByFullName(this.accountId(),this.folder())},this),this.threadsAllowed=ko.computed(function(){var e=this.folderObject(),t=e&&(e.type()===Enums.FolderTypes.Drafts||e.type()===Enums.FolderTypes.Spam||e.type()===Enums.FolderTypes.Trash);return AppData.User.useThreads()&&!t},this),this.otherSendersAllowed=ko.computed(function(){var e=this.folderObject();return e&&e.type()!==Enums.FolderTypes.Drafts&&e.type()!==Enums.FolderTypes.Sent},this),this.threadPart=ko.observable(!1),this.threadPart.subscribe(function(){this.threadPart()&&(this.partialFlagged(!1),this.threadSenders(!1))},this),this.threadParentUid=ko.observable(""),this.threadUids=ko.observableArray([]),this.threadSenders=ko.observableArray([]),this.threadMoreSendersText=ko.observable(""),this.threadSendersText=ko.computed(function(){if(this.otherSendersAllowed()){var e=this.threadSenders();if(e.length>3)return this.threadMoreSendersText(Utils.i18n("MAILBOX/THREAD_MORE_SENDERS",{COUNT:e.length-1})),", "+e[0];if(this.threadMoreSendersText(""),e.length>0)return e.unshift(""),e.join(", ")}return""},this),this.threadSendersVisible=ko.computed(function(){return this.threadSendersText().length>0},this),this.threadMoreSendersVisible=ko.computed(function(){return this.threadMoreSendersText().length>0},this),this.threadCount=ko.computed(function(){return this.threadUids().length},this),this.threadUnreadCount=ko.observable(0),this.threadOpened=ko.observable(!1),this.threadLoading=ko.observable(!1),this.threadLoadingVisible=ko.computed(function(){return this.threadsAllowed()&&this.threadOpened()&&this.threadLoading()},this),this.threadCountVisible=ko.computed(function(){return this.threadsAllowed()&&this.threadCount()>0&&!this.threadLoading()},this),this.threadCountHint=ko.computed(function(){return this.threadCount()>0?this.threadOpened()?Utils.i18n("MAILBOX/THREAD_TOOLTIP_FOLD"):this.threadUnreadCount()>0?Utils.i18n("MAILBOX/THREAD_TOOLTIP_HAS_UNSEEN_PLURAL",{},null,this.threadUnreadCount()):Utils.i18n("MAILBOX/THREAD_TOOLTIP_UNFOLD"):""},this),this.threadCountForLoad=ko.observable(5),this.threadNextLoadingVisible=ko.observable(!1),this.threadNextLoadingLinkVisible=ko.observable(!1),this.threadFunctionLoadNext=null,this.threadShowAnimation=ko.observable(!1),this.threadHideAnimation=ko.observable(!1),this.importance=ko.observable(Enums.Importance.Normal),this.draftInfo=ko.observableArray([]),this.sensitivity=ko.observable(Enums.Sensitivity.Nothing),this.hash=ko.observable(""),this.downloadLink=ko.computed(function(){return this.hash().length>0?Utils.getDownloadLinkByHash(this.accountId(),this.hash()):""},this),this.completelyFilled=ko.observable(!1),this.checked=ko.observable(!1),this.checked.subscribe(function(e){if(!this.threadOpened()&&App.MailCache.useThreadsInCurrentList()){var t=App.MailCache.folderList().getFolderByFullName(this.folder());_.each(this.threadUids(),function(i){var s=t.oMessages[i];s&&s.checked(e)})}},this),this.selected=ko.observable(!1),this.deleted=ko.observable(!1),this.trimmed=ko.observable(!1),this.trimmedTextSize=ko.observable(0),this.inReplyTo=ko.observable(""),this.references=ko.observable(""),this.readingConfirmation=ko.observable(""),this.isPlain=ko.observable(!1),this.text=ko.observable(""),this.textBodyForNewWindow=ko.observable(""),this.$text=null,this.rtl=ko.observable(!1),this.hasExternals=ko.observable(!1),this.isExternalsShown=ko.observable(!1),this.isExternalsAlwaysShown=ko.observable(!1),this.foundCids=ko.observableArray([]),this.attachments=ko.observableArray([]),this.usesAttachmentString=!1,this.allAttachmentsHash="",this.safety=ko.observable(!1),this.sourceHeaders=ko.observable(""),this.date=ko.observable(""),this.ical=ko.observable(null),this.vcard=ko.observable(null),this.textRaw=ko.observable(""),this.encryptedMessage=ko.observable(!1),this.signedMessage=ko.observable(!1),this.domMessageForPrint=ko.observable(null),this.Custom={}}function CUidListModel(){this.resultCount=ko.observable(-1),this.search=ko.observable(""),this.filters=ko.observable(""),this.collection=ko.observableArray([]),this.threadUids={}}function CIcalModel(){this.uid=ko.observable(""),this.lastModification=ko.observable(!0),this.sSequence=1,this.file=ko.observable(""),this.attendee=ko.observable(""),this.type=ko.observable(""),this.icalType=ko.observable(""),this.icalConfig=ko.observable(""),this.type.subscribe(function(){var e=this.type().split("-"),t=e.shift(),i=_.find(Enums.IcalType,function(e){return t===e},this),s=e.join("-"),o=_.find(Enums.IcalConfig,function(e){return s===e},this);t!==i&&(t=Enums.IcalType.Save),this.icalType(t),s!==o&&(s=Enums.IcalConfig.NeedsAction),this.icalConfig(s),this.fillDecisions()},this),this.isRequestType=ko.computed(function(){return this.icalType()===Enums.IcalType.Request},this),this.isCancelType=ko.computed(function(){return this.icalType()===Enums.IcalType.Cancel},this),this.cancelDecision=ko.observable(""),this.isReplyType=ko.computed(function(){return this.icalType()===Enums.IcalType.Reply},this),this.replyDecision=ko.observable(""),this.isSaveType=ko.computed(function(){return this.icalType()===Enums.IcalType.Save},this),this.isJustSaved=ko.observable(!1),this.isAccepted=ko.computed(function(){return this.icalConfig()===Enums.IcalConfig.Accepted},this),this.isDeclined=ko.computed(function(){return this.icalConfig()===Enums.IcalConfig.Declined},this),this.isTentative=ko.computed(function(){return this.icalConfig()===Enums.IcalConfig.Tentative},this),this.location=ko.observable(""),this.description=ko.observable(""),this.when=ko.observable(""),this.calendarId=ko.observable(""),this.calendars=ko.observableArray([]),AppData.SingleMode&&window.opener?(this.calendars(window.opener.App.CalendarCache.calendars()),window.opener.App.CalendarCache.calendars.subscribe(function(){this.calendars(window.opener.App.CalendarCache.calendars())},this)):(this.calendars(App.CalendarCache.calendars()),App.CalendarCache.calendars.subscribe(function(){this.calendars(App.CalendarCache.calendars())},this)),this.selectedCalendarId=ko.observable(""),this.chosenCalendarName=ko.computed(function(){var e=null;return""!==this.calendarId()&&(e=_.find(this.calendars(),function(e){return e.id===this.calendarId()},this)),e?e.name:""},this),this.calendarIsChosen=ko.computed(function(){return""!==this.chosenCalendarName()},this),this.visibleCalendarDropdown=ko.computed(function(){return!this.calendarIsChosen()&&this.calendars().length>1&&(this.isRequestType()||this.isSaveType())},this),this.visibleCalendarName=ko.computed(function(){return this.calendarIsChosen()},this),this.visibleFirstCalendarName=ko.computed(function(){return 1===this.calendars().length&&!this.calendarIsChosen()},this),this.visibleCalendarRow=ko.computed(function(){return""!==this.attendee()&&(this.visibleCalendarDropdown()||this.visibleCalendarName()||this.visibleFirstCalendarName())},this),this.visibleRequestButtons=ko.computed(function(){return this.isRequestType()&&""!==this.attendee()},this),this.animation=ko.observable(!1)}function CVcardModel(){this.uid=ko.observable(""),this.file=ko.observable(""),this.name=ko.observable(""),this.email=ko.observable(""),this.exists=ko.observable(!1),this.isJustSaved=ko.observable(!1)}function CContactModel(){this.allowSendEmails=ko.computed(function(){return AppData.App.AllowWebMail&&AppData.Accounts.isCurrentAllowsMail()},this),this.sEmailDefaultType=Enums.ContactEmailType.Personal,this.sPhoneDefaultType=Enums.ContactPhoneType.Mobile,this.sAddressDefaultType=Enums.ContactAddressType.Personal,this.voiceApp=null,App.Phone&&(this.voiceApp=App.Phone.voiceApp),this.idContact=ko.observable(""),this.idUser=ko.observable(""),this.global=ko.observable(!1),this.itsMe=ko.observable(!1),this.isNew=ko.observable(!1),this.readOnly=ko.observable(!1),this.edited=ko.observable(!1),this.extented=ko.observable(!1),this.personalCollapsed=ko.observable(!1),this.businessCollapsed=ko.observable(!1),this.otherCollapsed=ko.observable(!1),this.groupsCollapsed=ko.observable(!1),this.displayName=ko.observable(""),this.firstName=ko.observable(""),this.lastName=ko.observable(""),this.nickName=ko.observable(""),this.skype=ko.observable(""),this.facebook=ko.observable(""),this.displayNameFocused=ko.observable(!1),this.primaryEmail=ko.observable(this.sEmailDefaultType),this.primaryPhone=ko.observable(this.sPhoneDefaultType),this.primaryAddress=ko.observable(this.sAddressDefaultType),this.mainPrimaryEmail=ko.computed({read:this.primaryEmail,write:function(e){this.primaryEmail(!Utils.isUnd(e)&&0<=Utils.inArray(e,[Enums.ContactEmailType.Personal,Enums.ContactEmailType.Business,Enums.ContactEmailType.Other])?e:Enums.ContactEmailType.Personal)},owner:this}),this.mainPrimaryPhone=ko.computed({read:this.primaryPhone,write:function(e){this.primaryPhone(!Utils.isUnd(e)&&0<=Utils.inArray(e,[Enums.ContactPhoneType.Mobile,Enums.ContactPhoneType.Personal,Enums.ContactPhoneType.Business])?e:Enums.ContactPhoneType.Mobile)},owner:this}),this.mainPrimaryAddress=ko.computed({read:this.primaryAddress,write:function(e){this.primaryAddress(!Utils.isUnd(e)&&0<=Utils.inArray(e,[Enums.ContactAddressType.Personal,Enums.ContactAddressType.Business])?e:Enums.ContactAddressType.Personal)},owner:this}),this.personalEmail=ko.observable(""),this.personalStreetAddress=ko.observable(""),this.personalCity=ko.observable(""),this.personalState=ko.observable(""),this.personalZipCode=ko.observable(""),this.personalCountry=ko.observable(""),this.personalWeb=ko.observable(""),this.personalFax=ko.observable(""),this.personalPhone=ko.observable(""),this.personalMobile=ko.observable(""),this.businessEmail=ko.observable(""),this.businessCompany=ko.observable(""),this.businessDepartment=ko.observable(""),this.businessJob=ko.observable(""),this.businessOffice=ko.observable(""),this.businessStreetAddress=ko.observable(""),this.businessCity=ko.observable(""),this.businessState=ko.observable(""),this.businessZipCode=ko.observable(""),this.businessCountry=ko.observable(""),this.businessWeb=ko.observable(""),this.businessFax=ko.observable(""),this.businessPhone=ko.observable(""),this.otherEmail=ko.observable(""),this.otherBirthdayMonth=ko.observable("0"),this.otherBirthdayDay=ko.observable("0"),this.otherBirthdayYear=ko.observable("0"),this.otherNotes=ko.observable(""),this.etag=ko.observable(""),this.sharedToAll=ko.observable(!1),this.birthdayIsEmpty=ko.computed(function(){var e="0"===this.otherBirthdayMonth(),t="0"===this.otherBirthdayDay(),i="0"===this.otherBirthdayYear();
return e||t||i},this),this.otherBirthday=ko.computed(function(){var e="",t=Utils.pInt(this.otherBirthdayYear()),i=Utils.pInt(this.otherBirthdayMonth()),s=Utils.pInt(this.otherBirthdayDay()),o=new CDateModel;if(!this.birthdayIsEmpty()){var n=moment().diff(moment(t+"/"+i+"/"+s,"YYYY/MM/DD"),"years"),r=Utils.i18n("CONTACTS/YEARS_TEXT_PLURAL",{COUNT:n},null,n);o.setDate(t,i>0?i-1:0,s),e=o.getShortDate()+" ("+r+")"}return e},this),this.groups=ko.observableArray([]),this.groupsIsEmpty=ko.computed(function(){return 0===this.groups().length},this),this.email=ko.computed({read:function(){var e="";switch(this.primaryEmail()){case Enums.ContactEmailType.Personal:e=this.personalEmail();break;case Enums.ContactEmailType.Business:e=this.businessEmail();break;case Enums.ContactEmailType.Other:e=this.otherEmail()}return e},write:function(e){switch(this.primaryEmail()){case Enums.ContactEmailType.Personal:this.personalEmail(e);break;case Enums.ContactEmailType.Business:this.businessEmail(e);break;case Enums.ContactEmailType.Other:this.otherEmail(e);break;default:this.primaryEmail(this.sEmailDefaultType),this.email(e)}},owner:this}),this.personalIsEmpty=ko.computed(function(){var e=this.personalEmail()!==this.email()?this.personalEmail():"";return""==""+e+this.personalStreetAddress()+this.personalCity()+this.personalState()+this.personalZipCode()+this.personalCountry()+this.personalWeb()+this.personalFax()+this.personalPhone()+this.personalMobile()},this),this.businessIsEmpty=ko.computed(function(){var e=this.businessEmail()!==this.email()?this.businessEmail():"";return""==""+e+this.businessCompany()+this.businessDepartment()+this.businessJob()+this.businessOffice()+this.businessStreetAddress()+this.businessCity()+this.businessState()+this.businessZipCode()+this.businessCountry()+this.businessWeb()+this.businessFax()+this.businessPhone()},this),this.otherIsEmpty=ko.computed(function(){var e=this.otherEmail()!==this.email()?this.otherEmail():"";return""==""+e+this.otherNotes()&&this.birthdayIsEmpty()},this),this.phone=ko.computed({read:function(){var e="";switch(this.primaryPhone()){case Enums.ContactPhoneType.Mobile:e=this.personalMobile();break;case Enums.ContactPhoneType.Personal:e=this.personalPhone();break;case Enums.ContactPhoneType.Business:e=this.businessPhone()}return e},write:function(e){switch(this.primaryPhone()){case Enums.ContactPhoneType.Mobile:this.personalMobile(e);break;case Enums.ContactPhoneType.Personal:this.personalPhone(e);break;case Enums.ContactPhoneType.Business:this.businessPhone(e);break;default:this.primaryPhone(this.sEmailDefaultType),this.phone(e)}},owner:this}),this.address=ko.computed({read:function(){var e="";switch(this.primaryAddress()){case Enums.ContactAddressType.Personal:e=this.personalStreetAddress();break;case Enums.ContactAddressType.Business:e=this.businessStreetAddress()}return e},write:function(e){switch(this.primaryAddress()){case Enums.ContactAddressType.Personal:this.personalStreetAddress(e);break;case Enums.ContactAddressType.Business:this.businessStreetAddress(e);break;default:this.primaryAddress(this.sEmailDefaultType),this.address(e)}},owner:this}),this.emails=ko.computed(function(){var e=[];return""!==this.personalEmail()&&e.push({text:Utils.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalEmail(),value:Enums.ContactEmailType.Personal}),""!==this.businessEmail()&&e.push({text:Utils.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessEmail(),value:Enums.ContactEmailType.Business}),""!==this.otherEmail()&&e.push({text:Utils.i18n("CONTACTS/OPTION_OTHER")+": "+this.otherEmail(),value:Enums.ContactEmailType.Other}),e},this),this.phones=ko.computed(function(){var e=[];return""!==this.personalMobile()&&e.push({text:Utils.i18n("CONTACTS/LABEL_MOBILE")+": "+this.personalMobile(),value:Enums.ContactPhoneType.Mobile}),""!==this.personalPhone()&&e.push({text:Utils.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalPhone(),value:Enums.ContactPhoneType.Personal}),""!==this.businessPhone()&&e.push({text:Utils.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessPhone(),value:Enums.ContactPhoneType.Business}),e},this),this.addresses=ko.computed(function(){var e=[];return""!==this.personalStreetAddress()&&e.push({text:Utils.i18n("CONTACTS/OPTION_PERSONAL")+": "+this.personalStreetAddress(),value:Enums.ContactAddressType.Personal}),""!==this.businessStreetAddress()&&e.push({text:Utils.i18n("CONTACTS/OPTION_BUSINESS")+": "+this.businessStreetAddress(),value:Enums.ContactAddressType.Business}),e},this),this.hasEmails=ko.computed(function(){return 0<this.emails().length},this),this.extented.subscribe(function(e){e&&(this.personalCollapsed(!this.personalIsEmpty()),this.businessCollapsed(!this.businessIsEmpty()),this.otherCollapsed(!this.otherIsEmpty()),this.groupsCollapsed(!this.groupsIsEmpty()))},this),this.birthdayMonthSelect=CContactModel.birthdayMonthSelect,this.birthdayYearSelect=CContactModel.birthdayYearSelect,this.birthdayDaySelect=ko.computed(function(){for(var e=1,t=Utils.pInt(Utils.daysInMonth(this.otherBirthdayMonth(),this.otherBirthdayYear())),i="",s=[{text:Utils.i18n("DATETIME/DAY"),value:"0"}];t>=e;e++)i=e.toString(),s.push({text:i,value:i});return s},this);for(var e=new Date,t="",i=e.getFullYear(),s=1932;i>=s;i--)t=i.toString(),this.birthdayYearSelect.push({text:t,value:t});this.canBeSave=ko.computed(function(){return""!==this.displayName()||!!this.emails().length},this),this.sendMailLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.email()):"#"},this),this.sendMailToPersonalLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.personalEmail()):"#"},this),this.sendMailToBusinessLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.businessEmail()):"#"},this),this.sendMailToOtherLink=ko.computed(function(){return bMobileApp?this.getSendMailLink(this.otherEmail()):"#"},this)}function CGroupModel(){this.isNew=ko.observable(!1),this.readOnly=ko.observable(!1),this.idGroup=ko.observable(""),this.idUser=ko.observable(""),this.name=ko.observable(""),this.isOrganization=ko.observable(!1),this.email=ko.observable(""),this.country=ko.observable(""),this.city=ko.observable(""),this.company=ko.observable(""),this.fax=ko.observable(""),this.phone=ko.observable(""),this.state=ko.observable(""),this.street=ko.observable(""),this.web=ko.observable(""),this.zip=ko.observable(""),this.edited=ko.observable(!1),this.nameFocused=ko.observable(!1),this.canBeSave=ko.computed(function(){return""!==this.name()},this),this.newContactsInGroupCount=ko.observable(0),this.newContactsInGroupHint=ko.computed(function(){var e=this.newContactsInGroupCount();return this.isNew()&&e>0?Utils.i18n("CONTACTS/CONTACT_ADD_TO_NEW_HINT_PLURAL",{COUNT:e},null,e):""},this),this.events=ko.observableArray([])}function CContactListItemModel(){this.bIsGroup=!1,this.bIsOrganization=!1,this.bReadOnly=!1,this.bItsMe=!1,this.bGlobal=!1,this.sId="",this.sName="",this.sEmail="",this.bSharedToAll=!1,this.deleted=ko.observable(!1),this.checked=ko.observable(!1),this.selected=ko.observable(!1),this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.groupType=ko.observable([])}function CSignatureModel(){this.iAccountId=0,this.type=ko.observable(!0),this.options=ko.observable(0),this.signature=ko.observable("")}function CAutoresponderModel(){this.iAccountId=0,this.enable=!1,this.subject="",this.message=""}function CFetcherModel(){this.FETCHER=!0,this.id=ko.observable(0),this.accountId=ko.observable(0),this.isEnabled=ko.observable(!1),this.isLocked=ko.observable(!1).extend({autoResetToFalse:1e3}),this.email=ko.observable(""),this.userName=ko.observable(""),this.folder=ko.observable(""),this.signatureOptions=ko.observable(!1),this.signature=ko.observable(""),this.incomingMailServer=ko.observable(""),this.incomingMailPort=ko.observable(0),this.incomingMailSsl=ko.observable(!1),this.incomingMailLogin=ko.observable(""),this.leaveMessagesOnServer=ko.observable(""),this.isOutgoingEnabled=ko.observable(!1),this.outgoingMailServer=ko.observable(""),this.outgoingMailPort=ko.observable(0),this.outgoingMailSsl=ko.observable(!1),this.outgoingMailAuth=ko.observable(!1),this.fullEmail=ko.computed(function(){return Utils.Address.getFullEmail(this.userName(),this.email())},this)}function CFetcherListModel(){this.accountId=0,this.collection=ko.observableArray([])}function CForwardModel(){this.iAccountId=0,this.enable=!1,this.email=""}function CSieveFiltersModel(){this.iAccountId=0,this.collection=ko.observableArray([])}function CSieveFilterModel(e){this.iAccountId=e,this.enable=ko.observable(!0).extend({reversible:!0}),this.field=ko.observable("").extend({reversible:!0}),this.condition=ko.observable("").extend({reversible:!0}),this.filter=ko.observable("").extend({reversible:!0}),this.action=ko.observable("").extend({reversible:!0}),this.folder=ko.observable("").extend({reversible:!0})}function CInformationViewModel(){this.iAnimationDuration=500,this.iReportDuration=5e3,this.iErrorDuration=1e4,this.loadingMessage=ko.observable(""),this.loadingHidden=ko.observable(!0),this.loadingVisible=ko.observable(!1),this.reportMessage=ko.observable(""),this.reportHidden=ko.observable(!0),this.reportVisible=ko.observable(!1),this.reportVisibleClose=ko.observable(!1),this.iReportTimeout=-1,this.errorMessage=ko.observable(""),this.errorHidden=ko.observable(!0),this.errorVisible=ko.observable(!1),this.iErrorTimeout=-1,this.isHtmlError=ko.observable(!1),this.gray=ko.observable(!1)}function CHeaderBaseViewModel(){var e=this;this.mobileApp=bMobileApp,this.mobileDevice=AppData.AllowMobile&&bMobileDevice,this.allowWebMail=AppData.App.AllowWebMail,this.currentAccountId=AppData.Accounts.currentId,this.currentAccountId.subscribe(function(){_.delay(function(){e.changeMailLinkText()},300)},this),this.tabs=App.headerTabs,this.mailLinkText=ko.observable(""),this.accounts=ko.computed(function(){return 1===AppData.Accounts.collection().length?AppData.Accounts.collection():_.filter(AppData.Accounts.collection(),function(e){return e.allowMail()})},this),this.currentTab=App.Screens.currentScreen,this.isMailboxTab=ko.computed(function(){return this.currentTab()===Enums.Screens.Mailbox},this),this.helpdeskUnseenCount=App.helpdeskUnseenCount,this.helpdeskUnseenVisible=ko.computed(function(){return this.currentTab()!==Enums.Screens.Helpdesk&&!!this.helpdeskUnseenCount()},this),this.helpdeskPendingCount=App.helpdeskPendingCount,this.helpdeskPendingVisible=ko.computed(function(){return this.currentTab()!==Enums.Screens.Helpdesk&&!!this.helpdeskPendingCount()},this),this.mailUnseenCount=App.mailUnseenCount,this.mailUnseenVisible=ko.computed(function(){return this.currentTab()!==Enums.Screens.Mailbox&&!!this.mailUnseenCount()},this),this.mailboxHash=App.Routing.lastMailboxHash,this.settingsHash=App.Routing.lastSettingsHash,this.contactsRecivedAnim=App.ContactsCache.recivedAnim,this.calendarRecivedAnim=App.CalendarCache.recivedAnim,this.appCustomLogo=ko.observable(AppData.AppStyleImage||""),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CHeaderMobileViewModel(){CHeaderBaseViewModel.call(this)}function CPageSwitcherViewModel(e,t){this.shown=!1,this.currentPage=ko.observable(1),this.count=ko.observable(e),this.perPage=ko.observable(t),this.firstPage=ko.observable(1),this.lastPage=ko.observable(1),this.pagesCount=ko.computed(function(){var e=Math.ceil(this.count()/this.perPage());return e>0?e:1},this),ko.computed(function(){var e=20,t=4,i=this.pagesCount(),s=this.currentPage(),o=s,n=s;if(i>1)for(;;){if(e--,o>1&&(o--,t--),0===t)break;if(i>n&&(n++,t--),0===t)break;if(0===e)break}this.firstPage(o),this.lastPage(n)},this),this.visibleFirst=ko.computed(function(){return this.firstPage()>1},this),this.visibleLast=ko.computed(function(){return this.lastPage()<this.pagesCount()},this),this.clickPage=_.bind(this.clickPage,this),this.pages=ko.computed(function(){var e=this.firstPage(),t=[];if(this.firstPage()<this.lastPage())for(;e<=this.lastPage();e++)t.push({number:e,current:e===this.currentPage(),clickFunc:this.clickPage});return t},this),this.hotKeysBind()}function CHtmlEditorViewModel(e,t){this.mobileApp=bMobileApp,this.oParent=t,this.creaId="creaId"+Math.random().toString().replace(".",""),this.textFocused=ko.observable(!1),this.workareaDom=ko.observable(),this.uploaderAreaDom=ko.observable(),this.editorUploaderBodyDragOver=ko.observable(!1),this.editorUploaderProgress=ko.observable(!1),this.htmlEditorDom=ko.observable(),this.toolbarDom=ko.observable(),this.colorPickerDropdownDom=ko.observable(),this.insertLinkDropdownDom=ko.observable(),this.insertImageDropdownDom=ko.observable(),this.isEnable=ko.observable(!0),this.isEnable.subscribe(function(){this.oCrea&&this.oCrea.setEditable(this.isEnable())},this),this.bInsertImageAsBase64=e,this.bAllowFileUpload=!(e&&void 0===window.File),this.allowInsertImage=ko.observable(AppData.App.AllowInsertImage),this.lockFontSubscribing=ko.observable(!1),this.bAllowImageDragAndDrop=!App.browser.ie10AndAbove,this.aFonts=["Arial","Arial Black","Courier New","Tahoma","Times New Roman","Verdana"],this.sDefaultFont=AppData.User.DefaultFontName,this.correctFontFromSettings(),this.selectedFont=ko.observable(""),this.selectedFont.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontName(this.selectedFont())},this),this.iDefaultSize=AppData.User.DefaultFontSize,this.selectedSize=ko.observable(0),this.selectedSize.subscribe(function(){!this.oCrea||this.lockFontSubscribing()||this.inactive()||this.oCrea.fontSize(this.selectedSize())},this),this.visibleInsertLinkPopup=ko.observable(!1),this.linkForInsert=ko.observable(""),this.linkFocused=ko.observable(!1),this.visibleLinkPopup=ko.observable(!1),this.linkPopupDom=ko.observable(null),this.linkHrefDom=ko.observable(null),this.linkHref=ko.observable(""),this.visibleLinkHref=ko.observable(!1),this.visibleImagePopup=ko.observable(!1),this.visibleImagePopup.subscribe(function(){this.onImageOut()},this),this.imagePopupTop=ko.observable(0),this.imagePopupLeft=ko.observable(0),this.imageSelected=ko.observable(!1),this.tooltipText=ko.observable(""),this.tooltipPopupTop=ko.observable(0),this.tooltipPopupLeft=ko.observable(0),this.visibleInsertImagePopup=ko.observable(!1),this.imageUploaderButton=ko.observable(null),this.uploadedImagePathes=ko.observableArray([]),this.imagePathFromWeb=ko.observable(""),this.visibleFontColorPopup=ko.observable(!1),this.oFontColorPicker=new CColorPickerViewModel(Utils.i18n("HTMLEDITOR/TEXT_COLOR_CAPTION"),this.setTextColorFromPopup,this),this.oBackColorPicker=new CColorPickerViewModel(Utils.i18n("HTMLEDITOR/BACKGROUND_COLOR_CAPTION"),this.setBackColorFromPopup,this),this.activitySource=ko.observable(1),this.activitySourceSubscription=null,this.inactive=ko.observable(!1),this.inactive.subscribe(function(){var e=this.removeAllTags(this.getText());this.inactive()?(""===e||"&nbsp;"===e)&&(this.setText('<span style="color: #AAAAAA;">'+Utils.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")+"</span>"),this.oCrea&&this.oCrea.setBlur()):e===Utils.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")&&this.setText("")},this),this.allowChangeInputDirection=Utils.isRTL()||AppData.User.AllowChangeInputDirection,this.disabled=ko.observable(!1),this.textChanged=ko.observable(!1),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CColorPickerViewModel(e,t,i){this.aGreyColors=["rgb(0, 0, 0)","rgb(68, 68, 68)","rgb(102, 102, 102)","rgb(153, 153, 153)","rgb(204, 204, 204)","rgb(238, 238, 238)","rgb(243, 243, 243)","rgb(255, 255, 255)"],this.aBrightColors=["rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],this.aColorLines=[["rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)"],["rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)"],["rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)"],["rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)"],["rgb(153, 0, 0)","rgb(180, 95, 6)","rgb(191, 144, 0)","rgb(56, 118, 29)","rgb(19, 79, 92)","rgb(11, 83, 148)","rgb(53, 28, 117)","rgb(116, 27, 71)"],["rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]],this.caption=e,this.pickHandler=t,this.pickContext=i,this.colorPickerDom=ko.observable(null)}function CPhoneViewModel(){this.phone=App.Phone,this.action=this.phone.action,this.report=this.phone.report,this.logs=ko.observableArray([]),this.logsToShow=ko.observableArray([]),this.spinner=ko.observable(!0),this.tooltip=ko.observable(Utils.i18n("PHONE/NOT_CONNECTED")),this.indicator=ko.observable(Utils.i18n("PHONE/MISSED_CALLS")),this.dropdownShow=ko.observable(!1),this.input=ko.observable(""),this.input.subscribe(function(e){this.dropdownShow(""===e&&this.action()===Enums.PhoneAction.OnlineActive)},this),this.inputFocus=ko.observable(!1),this.inputFocus.subscribe(function(e){e&&""===this.input()&&this.action()===Enums.PhoneAction.OnlineActive&&this.dropdownShow(!0)},this),this.phoneAutocompleteItem=ko.observable(null),this.action.subscribe(function(e){switch(e){case Enums.PhoneAction.Offline:this.tooltip(Utils.i18n("PHONE/NOT_CONNECTED"));break;case Enums.PhoneAction.OfflineError:this.tooltip(Utils.i18n("Connection error"));break;case Enums.PhoneAction.OfflineInit:this.tooltip(Utils.i18n("PHONE/CONNECTING"));break;case Enums.PhoneAction.OfflineActive:break;case Enums.PhoneAction.Online:this.tooltip(Utils.i18n("PHONE/CONNECTED")),this.input(""),this.report(""),this.timer("stop");break;case Enums.PhoneAction.OnlineActive:break;case Enums.PhoneAction.Outgoing:this.timer("start");break;case Enums.PhoneAction.OutgoingConnect:this.tooltip(Utils.i18n("In Call"));break;case Enums.PhoneAction.Incoming:break;case Enums.PhoneAction.IncomingConnect:this.tooltip(Utils.i18n("In Call")),this.report(""),this.timer("start")}},this),$(document).on("click",_.bind(function(e){0===$(e.target).closest(".item.phone, .ui-autocomplete").length&&this.action()===Enums.PhoneAction.OnlineActive&&(this.action(Enums.PhoneAction.Online),this.dropdownShow(!1))},this))}function CWrapLoginViewModel(){this.bSocialInviteMode="string"==typeof Utils.Common.getRequestParam("invite-auth"),this.socialInviteTitle=Utils.i18n("LOGIN/SOCIAL_INVITE_TITLE",{SITENAME:AppData.App.SiteName}),this.socialInviteText=Utils.i18n("LOGIN/SOCIAL_INVITE_TEXT"),this.rtl=ko.observable(Utils.isRTL()),this.allowRegistration=AppData.App.AllowRegistration,this.allowPasswordReset=AppData.App.AllowPasswordReset,this.oLoginViewModel=new CLoginViewModel,this.allowRegistration&&(this.oRegisterViewModel=new CRegisterViewModel),this.allowPasswordReset&&(this.oForgotViewModel=new CForgotViewModel),this.gotoForgot=this.allowPasswordReset?this.oForgotViewModel.gotoForgot:ko.observable(!1),this.gotoRegister=ko.observable(!1),this.emailVisible=this.oLoginViewModel.emailVisible,this.loginVisible=this.oLoginViewModel.loginVisible,this.loginDescription=ko.observable(AppData.App.LoginDescription||""),this.aLanguages=AppData.App.Languages,this.currentLanguage=ko.observable(AppData.App.DefaultLanguage),this.allowLanguages=ko.observable(AppData.App.AllowLanguageOnLogin),this.viewLanguagesAsDropdown=ko.observable(!AppData.App.FlagsLangSelect),this.loginCustomLogo=ko.observable(AppData.LoginStyleImage||""),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CLoginViewModel(){this.allowRegistration=AppData.App.AllowRegistration,this.allowPasswordReset=AppData.App.AllowPasswordReset,this.email=ko.observable(""),this.login=ko.observable(""),this.password=ko.observable(""),this.emailFocus=ko.observable(!1),this.loginFocus=ko.observable(!1),this.passwordFocus=ko.observable(!1),this.loading=ko.observable(!1),this.changingLanguage=ko.observable(!1),this.loginFocus.subscribe(function(e){e&&""===this.login()&&this.login(this.email())},this),this.loginFormType=ko.observable(AppData.App.LoginFormType),this.loginAtDomainValue=ko.observable(AppData.App.LoginAtDomainValue),this.loginAtDomainValueWithAt=ko.computed(function(){var e=this.loginAtDomainValue();return""===e?"":"@"+e},this),this.emailVisible=ko.computed(function(){return Enums.LoginFormType.Login!==this.loginFormType()},this),this.loginVisible=ko.computed(function(){return Enums.LoginFormType.Email!==this.loginFormType()},this),this.signMeType=ko.observable(AppData.App.LoginSignMeType),this.signMe=ko.observable(Enums.LoginSignMeType.DefaultOn===this.signMeType()),this.signMeType.subscribe(function(){this.signMe(Enums.LoginSignMeType.DefaultOn===this.signMeType())},this),this.signMeFocused=ko.observable(!1),this.emailDom=ko.observable(null),this.loginDom=ko.observable(null),this.passwordDom=ko.observable(null),this.focusedField="",this.canBeLogin=ko.computed(function(){return!this.loading()&&!this.changingLanguage()},this),this.signInButtonText=ko.computed(function(){return Utils.i18n(this.loading()?"LOGIN/BUTTON_SIGNING_IN":"LOGIN/BUTTON_SIGN_IN")},this),this.loginCommand=Utils.createCommand(this,this.signIn,this.canBeLogin),this.email(AppData.App.DemoWebMailLogin||""),this.password(AppData.App.DemoWebMailPassword||""),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this]),this.shake=ko.observable(!1).extend({autoResetToFalse:800})}function CForgotViewModel(){this.gotoForgot=ko.observable(!1),this.gotoForgot.subscribe(function(){this.visibleEmailForm(!0),this.visibleQuestionForm(!1),this.visiblePasswordForm(!1)},this),this.visibleEmailForm=ko.observable(!0),this.email=ko.observable(""),this.emailFocus=ko.observable(!1),this.gettingQuestion=ko.observable(!1),this.getQuestionButtonText=ko.computed(function(){return Utils.i18n(this.gettingQuestion()?"LOGIN/BUTTON_GETTING_QUESTION":"LOGIN/BUTTON_GET_QUESTION")},this),this.allowGetQuestion=ko.computed(function(){return!this.gettingQuestion()&&""!==Utils.trim(this.email())},this),this.getQuestionCommand=Utils.createCommand(this,this.executeGetQuestion,this.allowGetQuestion),this.visibleQuestionForm=ko.observable(!1),this.question=ko.observable(""),this.answer=ko.observable(""),this.answerFocus=ko.observable(!1),this.validatingAnswer=ko.observable(!1),this.validateAnswerButtonText=ko.computed(function(){return Utils.i18n(this.validatingAnswer()?"LOGIN/BUTTON_VALIDATING_ANSWER":"LOGIN/BUTTON_VALIDATE_ANSWER")},this),this.allowValidatingAnswer=ko.computed(function(){return!this.validatingAnswer()&&""!==Utils.trim(this.answer())},this),this.validateAnswerCommand=Utils.createCommand(this,this.executeValidateAnswer,this.allowValidatingAnswer),this.visiblePasswordForm=ko.observable(!1),this.password=ko.observable(""),this.confirmPassword=ko.observable(""),this.passwordFocus=ko.observable(!1),this.confirmPasswordFocus=ko.observable(!1),this.changingPassword=ko.observable(!1),this.changePasswordButtonText=ko.computed(function(){return Utils.i18n(this.changingPassword()?"LOGIN/BUTTON_RESETTING_PASSWORD":"LOGIN/BUTTON_RESET_PASSWORD")},this),this.allowChangePassword=ko.computed(function(){var e=Utils.trim(this.password()),t=Utils.trim(this.confirmPassword()),i=""===e||""===t;return!this.changingPassword()&&!i},this),this.changePasswordCommand=Utils.createCommand(this,this.executeChangePassword,this.allowChangePassword),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CRegisterViewModel(){this.name=ko.observable(""),this.login=ko.observable(""),this.password=ko.observable(""),this.confirmPassword=ko.observable(""),this.question=ko.observable(""),this.yourQuestion=ko.observable(""),this.answer=ko.observable(""),this.allowQuestionPart=Utils.isNonEmptyArray(AppData.App.RegistrationQuestions),this.visibleYourQuestion=ko.computed(function(){return this.question()===Utils.i18n("LOGIN/OPTION_YOUR_QUESTION")},this),this.nameFocus=ko.observable(!1),this.loginFocus=ko.observable(!1),this.passwordFocus=ko.observable(!1),this.confirmPasswordFocus=ko.observable(!1),this.questionFocus=ko.observable(!1),this.answerFocus=ko.observable(!1),this.yourQuestionFocus=ko.observable(!1),this.domains=ko.observable(Utils.isNonEmptyArray(AppData.App.RegistrationDomains)?AppData.App.RegistrationDomains:[]),this.domain=ko.computed(function(){return 1===this.domains().length?this.domains()[0]:""},this),this.selectedDomain=ko.observable(this.domains().length>0?this.domains()[0]:""),this.registrationQuestions=[],this.allowQuestionPart&&(this.registrationQuestions=_.map(_.union("",_.without(AppData.App.RegistrationQuestions,"*")),function(e){return{text:""!==e?e:Utils.i18n("LOGIN/LABEL_SELECT_QUESTION"),value:e}}),-1!==_.indexOf(AppData.App.RegistrationQuestions,"*")&&this.registrationQuestions.push({text:Utils.i18n("LOGIN/OPTION_YOUR_QUESTION"),value:Utils.i18n("LOGIN/OPTION_YOUR_QUESTION")})),this.loading=ko.observable(!1),this.canBeRegister=ko.computed(function(){var e=Utils.trim(this.login()),t=Utils.trim(this.password()),i=Utils.trim(this.confirmPassword()),s=Utils.trim(this.visibleYourQuestion()?this.yourQuestion():this.question()),o=Utils.trim(this.answer()),n=""===e||""===t||""===i||this.allowQuestionPart&&(""===s||""===o);return!this.loading()&&!n},this),this.registerButtonText=ko.computed(function(){return Utils.i18n(this.loading()?"LOGIN/BUTTON_REGISTERING":"LOGIN/BUTTON_REGISTER")},this),this.registerCommand=Utils.createCommand(this,this.registerAccount,this.canBeRegister),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CFolderListViewModel(){this.accounts=AppData.Accounts.collection,this.mobileApp=bMobileApp,this.folderList=App.MailCache.folderList,this.manageFoldersHash=App.Routing.buildHashFromArray([Enums.Screens.Settings,Enums.SettingsTab.EmailAccounts,Enums.AccountSettingsTab.Folders]),this.quotaProc=ko.observable(-1),this.quotaDesc=ko.observable(""),ko.computed(function(){if(!AppData.App||AppData.App&&!AppData.App.ShowQuotaBar)return!0;App.MailCache.quotaChangeTrigger();var e=AppData.Accounts.getCurrent(),t=e?e.quota():0,i=e?e.usedSpace():0,s=t>0?Math.ceil(i/t*100):-1;return s=s>100?100:s,this.quotaProc(s),this.quotaDesc(s>-1?Utils.i18n("MAILBOX/QUOTA_TOOLTIP",{PROC:s,QUOTA:Utils.friendlySize(1024*t)}):""),!0},this),this.isCurrentAllowsMail=AppData.Accounts.isCurrentAllowsMail}function CMessageListViewModel(e){this.isPublic=bExtApp,this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){return this.bDragActive()},this),this.openMessageInNewWindowBinded=e,this.isFocused=ko.observable(!1),this.messagesContainer=ko.observable(null),this.searchInput=ko.observable(""),this.searchInputFrom=ko.observable(""),this.searchInputTo=ko.observable(""),this.searchInputSubject=ko.observable(""),this.searchInputText=ko.observable(""),this.searchSpan=ko.observable(""),this.highlightTrigger=ko.observable(""),this.currentMessage=App.MailCache.currentMessage,this.currentMessage.subscribe(function(){this.isFocused(!1),this.selector.itemSelected(this.currentMessage())},this),this.folderList=App.MailCache.folderList,this.folderList.subscribe(this.onFolderListSubscribe,this),this.folderFullName=ko.observable(""),this.folderType=ko.observable(Enums.FolderTypes.User),this.filters=ko.observable(""),this.uidList=App.MailCache.uidList,this.uidList.subscribe(function(){this.uidList().searchCountSubscription&&(this.uidList().searchCountSubscription.dispose(),this.uidList().searchCountSubscription=void 0),this.uidList().searchCountSubscription=this.uidList().resultCount.subscribe(function(){this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.uidList().resultCount()>=0&&this.oPageSwitcher.setCount(this.uidList().resultCount())},this),this.useThreads=ko.computed(function(){var e=this.folderList().currentFolder(),t=e&&e.withoutThreads(),i=""===this.uidList().search()&&""===this.uidList().filters();return AppData.User.useThreads()&&!t&&i},this),this.collection=App.MailCache.messages,this._search=ko.observable(""),this.search=ko.computed({read:function(){return Utils.trim(this._search())},write:this._search,owner:this}),this.isEmptyList=ko.computed(function(){return 0===this.collection().length},this),this.isNotEmptyList=ko.computed(function(){return 0!==this.collection().length},this),this.isSearch=ko.computed(function(){return this.search().length>0},this),this.isUnseenFilter=ko.computed(function(){return this.filters()===Enums.FolderFilter.Unseen},this),this.isLoading=App.MailCache.messagesLoading,this.isError=App.MailCache.messagesLoadingError,this.visibleInfoLoading=ko.computed(function(){return!this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchLoading=ko.computed(function(){return this.isSearch()&&this.isLoading()},this),this.visibleInfoSearchList=ko.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&!this.isLoading()&&!this.isEmptyList()},this),this.visibleInfoMessageListEmpty=ko.computed(function(){return!this.isLoading()&&!this.isSearch()&&""===this.filters()&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoStarredFolderEmpty=ko.computed(function(){return!this.isLoading()&&!this.isSearch()&&this.filters()===Enums.FolderFilter.Flagged&&this.isEmptyList()&&!this.isError()},this),this.visibleInfoSearchEmpty=ko.computed(function(){return this.isSearch()&&!this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.visibleInfoMessageListError=ko.computed(function(){return!this.isSearch()&&this.isError()},this),this.visibleInfoSearchError=ko.computed(function(){return this.isSearch()&&this.isError()},this),this.visibleInfoUnseenFilterList=ko.computed(function(){return this.isUnseenFilter()&&(this.isLoading()||!this.isEmptyList())},this),this.visibleInfoUnseenFilterEmpty=ko.computed(function(){return this.isUnseenFilter()&&this.isEmptyList()&&!this.isError()&&!this.isLoading()},this),this.searchText=ko.computed(function(){return Utils.i18n("MAILBOX/INFO_SEARCH_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""})},this),this.unseenFilterText=ko.computed(function(){return""===this.search()?Utils.i18n("MAILBOX/INFO_UNSEEN_FILTER_RESULT",{FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""}):Utils.i18n("MAILBOX/INFO_SEARCH_UNSEEN_FILTER_RESULT",{SEARCH:this.calculateSearchStringForDescription(),FOLDER:this.folderList().currentFolder()?this.folderList().currentFolder().displayName():""})},this),this.unseenFilterEmptyText=ko.computed(function(){return Utils.i18n(""===this.search()?"MAILBOX/INFO_UNSEEN_FILTER_EMPTY":"MAILBOX/INFO_SEARCH_UNSEEN_FILTER_EMPTY")},this),this.isEnableGroupOperations=ko.observable(!1).extend({throttle:250}),this.selector=new CSelector(this.collection,_.bind(this.routeForMessage,this),_.bind(this.onDeletePress,this),_.bind(this.onMessageDblClick,this),_.bind(this.onEnterPress,this)),this.checkedUids=ko.computed(function(){var e=this.selector.listChecked(),t=_.map(e,function(e){return e.uid()}),i=App.MailCache.folderList().currentFolder(),s=i?i.getThreadCheckedUidsFromList(e):[],o=_.union(t,s);return o},this),this.checkedOrSelectedUids=ko.computed(function(){var e=this.checkedUids();return 0===e.length&&App.MailCache.currentMessage()&&!App.MailCache.currentMessage().deleted()&&(e=[App.MailCache.currentMessage().uid()]),e},this),ko.computed(function(){this.isEnableGroupOperations(0<this.selector.listCheckedOrSelected().length)
},this),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.pageSwitcherLocked=ko.observable(!1),this.oPageSwitcher=new CPageSwitcherViewModel(0,AppData.User.MailsPerPage),this.oPageSwitcher.currentPage.subscribe(function(e){var t=this.folderList().currentFolderFullName(),i=!bMobileApp&&this.currentMessage()?this.currentMessage().uid():"",s=this.search();this.pageSwitcherLocked()||this.changeRoutingForMessageList(t,e,i,s,this.filters())},this),this.currentPage=ko.observable(0),this.listChangedThrottle=App.browser.firefox||App.browser.ie?ko.observable(!1).extend({throttle:10}):ko.observable(!1),this.firstCompleteCollection=ko.observable(!0),this.collection.subscribe(function(){this.collection().length>0&&this.firstCompleteCollection(!1)},this),this.currentAccountId=AppData.Accounts.currentId,this.listChanged=ko.computed(function(){return[this.firstCompleteCollection(),this.currentAccountId(),this.folderFullName(),this.filters(),this.search(),this.oPageSwitcher.currentPage()]},this),this.listChanged.subscribe(function(){this.listChangedThrottle(!this.listChangedThrottle())},this),this.bAdvancedSearch=ko.observable(!1),this.searchAttachmentsCheckbox=ko.observable(!1),this.searchAttachments=ko.observable(""),this.searchAttachments.subscribe(function(e){this.searchAttachmentsCheckbox(!!e)},this),this.searchAttachmentsFocus=ko.observable(!1),this.searchFromFocus=ko.observable(!1),this.searchSubjectFocus=ko.observable(!1),this.searchToFocus=ko.observable(!1),this.searchTextFocus=ko.observable(!1),this.searchTrigger=ko.observable(null),this.searchDateStartFocus=ko.observable(!1),this.searchDateEndFocus=ko.observable(!1),this.searchDateStartDom=ko.observable(null),this.searchDateStart=ko.observable(""),this.searchDateEndDom=ko.observable(null),this.searchDateEnd=ko.observable(""),this.dateFormatDatePicker="yy.mm.dd",this.attachmentsPlaceholder=ko.computed(function(){return Utils.i18n("MAILBOX/SEARCH_FIELD_HAS_ATTACHMENTS")},this),_.delay(_.bind(function(){this.createDatePickerObject(this.searchDateStartDom()),this.createDatePickerObject(this.searchDateEndDom())},this),1e3),this.isCurrentAllowsMail=AppData.Accounts.isCurrentAllowsMail;var t=Utils.i18n("MAILBOX/INFO_ADDING_NEW_ACCOUNT").split(/%STARTLINK%|%ENDLINK%/);this.sAddingInfo1=t.length>0?t[0]:"",this.sAddingInfo2=t.length>1?t[1]:"",this.sAddingInfo3=t.length>2?t[2]:""}function CMessagePaneViewModel(e){this.openMessageInNewWindowBinded=e,this.singleMode=ko.observable(AppData.SingleMode),this.isLoading=ko.observable(!1),App.MailCache.folderList.subscribe(this.onFolderListSubscribe,this),this.messages=App.MailCache.messages,this.messages.subscribe(this.onMessagesSubscribe,this),this.currentMessage=App.MailCache.currentMessage,this.currentMessage.subscribe(this.onCurrentMessageSubscribe,this),AppData.User.defaultTimeFormat.subscribe(this.onCurrentMessageSubscribe,this),this.displayedMessageUid=ko.observable(""),this.isCurrentMessage=ko.computed(function(){return!!this.currentMessage()},this),this.isCurrentMessageLoaded=ko.computed(function(){return this.isCurrentMessage()&&!this.isLoading()},this),this.visibleNoMessageSelectedText=ko.computed(function(){return this.messages().length>0&&!this.isCurrentMessage()},this),this.prevMessageUid=App.MailCache.prevMessageUid,this.nextMessageUid=App.MailCache.nextMessageUid,this.isEnablePrevMessage=ko.computed(function(){return"string"==typeof this.prevMessageUid()&&""!==this.prevMessageUid()},this),this.isEnableNextMessage=ko.computed(function(){return"string"==typeof this.nextMessageUid()&&""!==this.nextMessageUid()},this),this.isEnableDelete=this.isCurrentMessage,this.isEnableReply=this.isCurrentMessageLoaded,this.isEnableReplyAll=this.isCurrentMessageLoaded,this.isEnableResend=this.isCurrentMessageLoaded,this.isEnableForward=this.isCurrentMessageLoaded,this.isEnablePrint=this.isCurrentMessageLoaded,this.isEnableSave=this.isCurrentMessage,this.allowSaveAsPdf=ko.observable(!!AppData.AllowSaveAsPdf),this.isEnableSaveAsPdf=ko.computed(function(){return this.isCurrentMessageLoaded()&&this.allowSaveAsPdf()},this),this.deleteCommand=Utils.createCommand(this,this.executeDeleteMessage,this.isEnableDelete),this.prevMessageCommand=Utils.createCommand(this,this.executePrevMessage,this.isEnablePrevMessage),this.nextMessageCommand=Utils.createCommand(this,this.executeNextMessage,this.isEnableNextMessage),this.replyCommand=Utils.createCommand(this,this.executeReply,this.isEnableReply),this.replyAllCommand=Utils.createCommand(this,this.executeReplyAll,this.isEnableReplyAll),this.resendCommand=Utils.createCommand(this,this.executeResend,this.isEnableResend),this.forwardCommand=Utils.createCommand(this,this.executeForward,this.isEnableForward),this.printCommand=Utils.createCommand(this,this.executePrint,this.isEnablePrint),this.saveCommand=Utils.createCommand(this,this.executeSave,this.isEnableSave),this.saveAsPdfCommand=Utils.createCommand(this,this.executeSaveAsPdf,this.isEnableSaveAsPdf),this.moreCommand=Utils.createCommand(this,null,this.isCurrentMessageLoaded),this.ical=ko.observable(null),this.icalSubscription=this.ical.subscribe(function(){null!==this.ical()&&(App.CalendarCache.firstRequestCalendarList(),this.icalSubscription.dispose())},this),this.vcard=ko.observable(null),this.visiblePicturesControl=ko.observable(!1),this.visibleShowPicturesLink=ko.observable(!1),this.visibleAppointmentInfo=ko.computed(function(){return null!==this.ical()},this),this.visibleVcardInfo=ko.computed(function(){return null!==this.vcard()},this),this.sensitivityText=ko.computed(function(){var e="";if(this.currentMessage())switch(this.currentMessage().sensitivity()){case Enums.Sensitivity.Confidential:e=Utils.i18n("MESSAGE/SENSITIVITY_CONFIDENTIAL");break;case Enums.Sensitivity.Personal:e=Utils.i18n("MESSAGE/SENSITIVITY_PERSONAL");break;case Enums.Sensitivity.Private:e=Utils.i18n("MESSAGE/SENSITIVITY_PRIVATE")}return e},this),this.visibleConfirmationControl=ko.computed(function(){return this.currentMessage()&&""!==this.currentMessage().readingConfirmation()},this),this.isCurrentNotDraftOrSent=ko.computed(function(){var e=App.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()!==Enums.FolderTypes.Drafts&&e.type()!==Enums.FolderTypes.Sent},this),this.isCurrentSentFolder=ko.computed(function(){var e=App.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()===Enums.FolderTypes.Sent},this),this.isCurrentNotDraftFolder=ko.computed(function(){var e=App.MailCache.folderList().currentFolder();return e&&e.fullName().length>0&&e.type()!==Enums.FolderTypes.Drafts},this),this.isVisibleReplyTool=this.isCurrentNotDraftOrSent,this.isVisibleResendTool=this.isCurrentSentFolder,this.isVisibleForwardTool=this.isCurrentNotDraftFolder,this.uid=ko.observable(""),this.folder=ko.observable(""),this.folder.subscribe(function(){this.jqPanelHelper&&this.jqPanelHelper.trigger("resize",[null,"min",null,!0])},this),this.subject=ko.observable(""),this.emptySubject=ko.computed(function(){return""===Utils.trim(this.subject())},this),this.subjectForDisplay=ko.computed(function(){return this.emptySubject()?Utils.i18n("MAILBOX/EMPTY_SUBJECT"):this.subject()},this),this.importance=ko.observable(Enums.Importance.Normal),this.oFromAddr=ko.observable(null),this.from=ko.observable(""),this.fromEmail=ko.observable(""),this.fullFrom=ko.observable(""),this.to=ko.observable(""),this.aToAddr=ko.observableArray([]),this.cc=ko.observable(""),this.aCcAddr=ko.observableArray([]),this.bcc=ko.observable(""),this.aBccAddr=ko.observableArray([]),this.allRecipients=ko.observable(""),this.aAllRecipients=ko.observableArray([]),this.recipientsContacts=ko.observableArray([]),this.currentAccountEmail=ko.observable(),this.meSender=Utils.i18n("MESSAGE/ME_SENDER"),this.meRecipient=Utils.i18n("MESSAGE/ME_RECIPIENT"),this.fullDate=ko.observable(""),this.midDate=ko.observable(""),this.textBody=ko.observable(""),this.textBodyForNewWindow=ko.observable(""),this.domTextBody=ko.observable(null),this.rtlMessage=ko.observable(!1),this.contentHasFocus=ko.observable(!1),this.decryptPassword=ko.observable(""),this.visibleDecryptControl=ko.observable(!1),this.visibleVerifyControl=ko.observable(!1),this.fakeHeader=ko.computed(function(){return!(this.visiblePicturesControl()||this.visibleConfirmationControl()||""!==this.sensitivityText()||this.visibleDecryptControl()||this.visibleVerifyControl())},this),this.mobileApp=bMobileApp,this.attachments=ko.observableArray([]),this.usesAttachmentString=!0,this.attachmentsInString=ko.computed(function(){return _.map(this.attachments(),function(e){return e.fileName()},this).join(", ")},this),this.notInlineAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.visibleDownloadAllAttachments=ko.computed(function(){return AppData.ZipAttachments&&this.notInlineAttachments().length>1},this),this.visibleSaveAttachmentsToFiles=AppData.User.IsFilesSupported,this.visibleDownloadAllAttachmentsSeparately=ko.computed(function(){return this.notInlineAttachments().length>1},this),this.visibleExtendedDownload=ko.computed(function(){return!this.mobileApp&&(this.visibleDownloadAllAttachments()||this.visibleDownloadAllAttachmentsSeparately()||this.visibleSaveAttachmentsToFiles)},this),this.detailsVisible=ko.observable("1"===App.Storage.getData("MessageDetailsVisible")),this.detailsTooltip=ko.computed(function(){return Utils.i18n(this.detailsVisible()?"MESSAGE/ACTION_HIDE_DETAILS":"MESSAGE/ACTION_SHOW_DETAILS")},this),this.hasNotInlineAttachments=ko.computed(function(){return this.notInlineAttachments().length>0},this),this.hasBodyText=ko.computed(function(){return this.textBody().length>0},this),this.visibleAddMenu=ko.observable(!1),this.replyText=ko.observable(""),this.replyTextFocus=ko.observable(!1),this.replyPaneVisible=ko.computed(function(){return this.currentMessage()&&this.currentMessage().completelyFilled()},this),this.replySendingStarted=ko.observable(!1),this.replySavingStarted=ko.observable(!1),this.replyAutoSavingStarted=ko.observable(!1),this.requiresPostponedSending=ko.observable(!1),this.replyAutoSavingStarted.subscribe(function(){!this.replyAutoSavingStarted()&&this.requiresPostponedSending()&&(App.MessageSender.sendPostponedMail(this.replyDraftUid()),this.requiresPostponedSending(!1))},this),ko.computed(function(){(!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted())&&this.stopAutosaveTimer(),!this.replyTextFocus()||this.replyAutoSavingStarted()||this.replySavingStarted()||this.replySendingStarted()||this.startAutosaveTimer()},this),this.saveButtonText=ko.computed(function(){return Utils.i18n(this.replyAutoSavingStarted()?"COMPOSE/TOOL_SAVING":"COMPOSE/TOOL_SAVE")},this),this.replyDraftUid=ko.observable(""),this.replyLoadingText=ko.computed(function(){return this.replySendingStarted()?Utils.i18n("COMPOSE/INFO_SENDING"):this.replySavingStarted()?Utils.i18n("COMPOSE/INFO_SAVING"):""},this),this.isEnableSendQuickReply=ko.computed(function(){return this.isCurrentMessageLoaded()&&""!==this.replyText()&&!this.replySendingStarted()},this),this.isEnableSaveQuickReply=ko.computed(function(){return this.isEnableSendQuickReply()&&!this.replySavingStarted()&&!this.replyAutoSavingStarted()},this),this.saveQuickReplyCommand=Utils.createCommand(this,this.executeSaveQuickReply,this.isEnableSaveQuickReply),this.sendQuickReplyCommand=Utils.createCommand(this,this.executeSendQuickReplyCommand,this.isEnableSendQuickReply),this.domMessageHeader=ko.observable(null),this.domQuickReply=ko.observable(null),this.domMessageForPrint=ko.observable(null),this.replyTextFocusThrottled=ko.observable(!1).extend({throttle:50}),this.replyTextFocus.subscribe(function(){this.replyTextFocusThrottled(this.replyTextFocus())},this),this.isQuickReplyActive=ko.computed(function(){return this.replyText().length>0||this.replyTextFocusThrottled()},this),this.jqPanelHelper=null,this.visibleAttachments=ko.observable(!1),this.showMessage=function(){this.visibleAttachments(!1)},this.showAttachments=function(){this.visibleAttachments(!0)},this.defaultFontName=AppData.User.DefaultFontName,App.nowDateNumber&&App.nowDateNumber.subscribe(function(){this.updateMomentDate()},this),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CMailViewModel(){this.folderList=App.MailCache.folderList,this.domFolderList=ko.observable(null),this.openMessageInNewWindowBinded=_.bind(this.openMessageInNewWindow,this),this.oFolderList=new CFolderListViewModel,this.oMessageList=new CMessageListViewModel(this.openMessageInNewWindowBinded),this.oMessagePane=new CMessagePaneViewModel(this.openMessageInNewWindowBinded),this.isEnableGroupOperations=this.oMessageList.isEnableGroupOperations,this.composeLink=ko.observable(App.Routing.buildHashFromArray(App.Links.compose())),this.composeCommand=Utils.createCommand(this,this.executeCompose,AppData.Accounts.isCurrentAllowsMail),this.checkMailCommand=Utils.createCommand(this,this.executeCheckMail,AppData.Accounts.isCurrentAllowsMail),this.checkMailIndicator=ko.observable(!0).extend({throttle:50}),ko.computed(function(){this.checkMailIndicator(App.MailCache.checkMailStarted()||App.MailCache.messagesLoading())},this),this.markAsReadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAsRead,this.isEnableGroupOperations),this.markAsUnreadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAsUnread,this.isEnableGroupOperations),this.markAllReadCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeMarkAllRead),this.moveToFolderCommand=Utils.createCommand(this,Utils.emptyFunction,this.isEnableGroupOperations),this.deleteCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeDelete,this.isEnableGroupOperations),this.selectedCount=ko.computed(function(){return this.oMessageList.checkedUids().length},this),this.emptyTrashCommand=Utils.createCommand(App.MailCache,App.MailCache.executeEmptyTrash,this.oMessageList.isNotEmptyList),this.emptySpamCommand=Utils.createCommand(App.MailCache,App.MailCache.executeEmptySpam,this.oMessageList.isNotEmptyList),this.spamCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeSpam,this.isEnableGroupOperations),this.notSpamCommand=Utils.createCommand(this.oMessageList,this.oMessageList.executeNotSpam,this.isEnableGroupOperations),this.bVisibleComposeMessage=AppData.User.AllowCompose,this.isVisibleReplyTool=ko.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Enums.FolderTypes.Drafts&&this.folderList().currentFolderType()!==Enums.FolderTypes.Sent},this),this.isVisibleForwardTool=ko.computed(function(){return this.folderList().currentFolder()&&this.folderList().currentFolderFullName().length>0&&this.folderList().currentFolderType()!==Enums.FolderTypes.Drafts},this),this.isSpamFolder=ko.computed(function(){return this.folderList().currentFolderType()===Enums.FolderTypes.Spam},this),this.allowedSpamAction=ko.computed(function(){var e=AppData.Accounts.getCurrent();return!!this.folderList().spamFolder()&&!!e&&e.extensionExists("AllowSpamFolderExtension")&&!this.isSpamFolder()},this),this.allowedNotSpamAction=ko.computed(function(){var e=AppData.Accounts.getCurrent();return!!this.folderList().spamFolder()&&!!e&&e.extensionExists("AllowSpamFolderExtension")&&this.isSpamFolder()},this),this.isTrashFolder=ko.computed(function(){return this.folderList().currentFolderType()===Enums.FolderTypes.Trash},this),this.jqPanelHelper=null,this.mobileApp=bMobileApp,this.selectedPanel=ko.observable(Enums.MobilePanel.Items),App.MailCache.currentMessage.subscribe(function(){this.gotoMessagePane()},this)}function CComposeViewModel(){var e=this;this.toAddrDom=ko.observable(),this.toAddrDom.subscribe(function(){this.initInputosaurus(this.toAddrDom,this.toAddr,this.lockToAddr,"to")},this),this.ccAddrDom=ko.observable(),this.ccAddrDom.subscribe(function(){this.initInputosaurus(this.ccAddrDom,this.ccAddr,this.lockCcAddr,"cc")},this),this.bccAddrDom=ko.observable(),this.bccAddrDom.subscribe(function(){this.initInputosaurus(this.bccAddrDom,this.bccAddr,this.lockBccAddr,"bcc")},this),this.folderList=App.MailCache.folderList,this.folderList.subscribe(function(){this.getMessageOnRoute()},this),this.singleMode=ko.observable(AppData.SingleMode),this.isDemo=ko.observable(AppData.User.IsDemo),this.sending=ko.observable(!1),this.sending.subscribe(this.sendingAndSavingSubscription,this),this.saving=ko.observable(!1),this.saving.subscribe(this.sendingAndSavingSubscription,this),this.oHtmlEditor=new CHtmlEditorViewModel(!1,this),this.textFocused=this.oHtmlEditor.textFocused,this.visibleBcc=ko.observable(!1),this.visibleBcc.subscribe(function(){$html.toggleClass("screen-compose-bcc",this.visibleCc()),_.defer(_.bind(function(){$(this.bccAddrDom()).inputosaurus("resizeInput")},this))},this),this.visibleCc=ko.observable(!1),this.visibleCc.subscribe(function(){$html.toggleClass("screen-compose-cc",this.visibleCc()),_.defer(_.bind(function(){$(this.ccAddrDom()).inputosaurus("resizeInput")},this))},this),this.visibleCounter=ko.observable(!1),this.readingConfirmation=ko.observable(!1),this.saveMailInSentItems=ko.observable(!0),this.useSaveMailInSentItems=ko.observable(!1),this.composeUploaderButton=ko.observable(null),this.composeUploaderButton.subscribe(function(){this.initUploader()},this),this.composeUploaderDropPlace=ko.observable(null),this.composeUploaderBodyDragOver=ko.observable(!1),this.composeUploaderDragOver=ko.observable(!1),this.allowDragNDrop=ko.observable(!1),this.uploaderBodyDragOver=ko.computed(function(){return this.allowDragNDrop()&&this.composeUploaderBodyDragOver()},this),this.uploaderDragOver=ko.computed(function(){return this.allowDragNDrop()&&this.composeUploaderDragOver()},this),this.selectedImportance=ko.observable(Enums.Importance.Normal),this.selectedSensitivity=ko.observable(Enums.Sensitivity.Nothing),this.oSenderSelector=new CSenderSelector,this.senderAccountId=this.oSenderSelector.senderAccountId,this.senderList=this.oSenderSelector.senderList,this.visibleFrom=ko.computed(function(){return this.senderList().length>1},this),this.selectedSender=this.oSenderSelector.selectedSender,this.selectedFetcherOrIdentity=this.oSenderSelector.selectedFetcherOrIdentity,this.selectedFetcherOrIdentity.subscribe(function(){this.oHtmlEditor.isEditing()||this.oHtmlEditor.clearUndoRedo()},this),this.signature=ko.observable(""),this.prevSignature=ko.observable(null),ko.computed(function(){var e=App.MessageSender.getClearSignature(this.senderAccountId(),this.selectedFetcherOrIdentity());null===this.prevSignature()?(this.prevSignature(e),this.signature(e)):(this.prevSignature(this.signature()),this.signature(e),this.oHtmlEditor.changeSignatureContent(this.signature(),this.prevSignature()))},this),this.lockToAddr=ko.observable(!1),this.toAddr=ko.observable("").extend({reversible:!0}),this.toAddr.subscribe(function(){this.lockToAddr()||($(this.toAddrDom()).val(this.toAddr()),$(this.toAddrDom()).inputosaurus("refresh"))},this),this.lockCcAddr=ko.observable(!1),this.ccAddr=ko.observable("").extend({reversible:!0}),this.ccAddr.subscribe(function(){this.lockCcAddr()||($(this.ccAddrDom()).val(this.ccAddr()),$(this.ccAddrDom()).inputosaurus("refresh"))},this),this.lockBccAddr=ko.observable(!1),this.bccAddr=ko.observable("").extend({reversible:!0}),this.bccAddr.subscribe(function(){this.lockBccAddr()||($(this.bccAddrDom()).val(this.bccAddr()),$(this.bccAddrDom()).inputosaurus("refresh"))},this),this.recipientEmails=ko.computed(function(){var e=[this.toAddr(),this.ccAddr(),this.bccAddr()].join(",").split(","),t=[];return _.each(e,function(e){var i=Utils.trim(e),s=null;""!==i&&(s=Utils.Address.getEmailParts(i),s.email&&t.push(s.email))}),t},this),this.subject=ko.observable("").extend({reversible:!0}),this.counter=ko.observable(0),this.plainText=ko.observable(!1),this.textBody=ko.observable(""),this.textBody.subscribe(function(){this.oHtmlEditor.setText(this.textBody(),this.plainText()),this.oHtmlEditor.commit()},this),this.focusedField=ko.observable(),this.textFocused.subscribe(function(){this.textFocused()&&this.focusedField("text")},this),this.subjectFocused=ko.observable(!1),this.subjectFocused.subscribe(function(){this.subjectFocused()&&this.focusedField("subject")},this),this.draftUid=ko.observable(""),this.draftUid.subscribe(function(){App.MailCache.editedDraftUid(this.draftUid())},this),this.draftInfo=ko.observableArray([]),this.routeType=ko.observable(""),this.routeParams=ko.observableArray([]),this.inReplyTo=ko.observable(""),this.references=ko.observable(""),this.bUploadStatus=!1,this.iUploadAttachmentsTimer=0,this.messageUploadAttachmentsStarted=ko.observable(!1),this.messageUploadAttachmentsStarted.subscribe(function(t){window.clearTimeout(e.iUploadAttachmentsTimer),t?e.iUploadAttachmentsTimer=window.setTimeout(function(){e.bUploadStatus=!0,App.Api.showLoading(Utils.i18n("COMPOSE/INFO_ATTACHMENTS_LOADING"))},4e3):e.bUploadStatus?e.iUploadAttachmentsTimer=window.setTimeout(function(){e.bUploadStatus=!1,App.Api.hideLoading()},1e3):App.Api.hideLoading()},this),this.attachments=ko.observableArray([]),this.attachmentsChanged=ko.observable(!1),this.attachments.subscribe(function(){this.attachmentsChanged(!0)},this),this.notUploadedAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.uploaded()})},this),this.allAttachmentsUploaded=ko.computed(function(){return 0===this.notUploadedAttachments().length&&!this.messageUploadAttachmentsStarted()},this),this.notInlineAttachments=ko.computed(function(){return _.filter(this.attachments(),function(e){return!e.linked()})},this),this.notInlineAttachments.subscribe(function(){$html.toggleClass("screen-compose-attachments",this.notInlineAttachments().length>0)},this),this.allowStartSending=ko.computed(function(){return!this.saving()},this),this.allowStartSending.subscribe(function(){this.allowStartSending()&&this.requiresPostponedSending()&&(App.MessageSender.sendPostponedMail(this.draftUid()),this.requiresPostponedSending(!1))},this),this.requiresPostponedSending=ko.observable(!1),this.oJua=null,this.isDraftsCleared=ko.observable(!1),this.autoSaveTimer=-1,this.shown=ko.observable(!1),this.shown.subscribe(function(){this.shown()||this.stopAutosaveTimer()},this),this.backToListOnSendOrSave=ko.observable(!1),this.enableOpenPgp=AppData.User.enableOpenPgp,this.pgpSecured=ko.observable(!1),this.pgpSecured.subscribe(function(){this.oHtmlEditor.disabled(this.pgpSecured())},this),this.pgpEncrypted=ko.observable(!1),this.fromDrafts=ko.observable(!1),this.visibleDoPgpButton=ko.computed(function(){return this.enableOpenPgp()&&(!this.pgpSecured()||this.pgpEncrypted()&&this.fromDrafts())},this),this.visibleUndoPgpButton=ko.computed(function(){return this.enableOpenPgp()&&this.pgpSecured()&&(!this.pgpEncrypted()||!this.fromDrafts())},this),this.isEnableOpenPgpCommand=ko.computed(function(){return this.enableOpenPgp()&&!this.pgpSecured()},this),this.backToListCommand=Utils.createCommand(this,this.executeBackToList),this.sendCommand=Utils.createCommand(this,this.executeSend,this.isEnableSending),this.saveCommand=Utils.createCommand(this,this.executeSaveCommand,this.isEnableSaving),this.openPgpCommand=Utils.createCommand(this,this.confirmOpenPgp,this.isEnableOpenPgpCommand),this.messageFields=ko.observable(null),this.bottomPanel=ko.observable(null),this.mobileApp=bMobileApp,this.showHotkeysHints=!bMobileDevice&&!bMobileApp,this.aHotkeys=[{value:"Ctrl+Enter",action:Utils.i18n("COMPOSE/HOTKEY_SEND")},{value:"Ctrl+S",action:Utils.i18n("COMPOSE/HOTKEY_SAVE")},{value:"Ctrl+Z",action:Utils.i18n("COMPOSE/HOTKEY_UNDO")},{value:"Ctrl+Y",action:Utils.i18n("COMPOSE/HOTKEY_REDO")},{value:"Ctrl+K",action:Utils.i18n("COMPOSE/HOTKEY_LINK")},{value:"Ctrl+B",action:Utils.i18n("COMPOSE/HOTKEY_BOLD")},{value:"Ctrl+I",action:Utils.i18n("COMPOSE/HOTKEY_ITALIC")},{value:"Ctrl+U",action:Utils.i18n("COMPOSE/HOTKEY_UNDERLINE")}],this.allowFiles=ko.observable(!1),this.closeBecauseSingleCompose=ko.observable(!1),this.changedInPreviousWindow=ko.observable(!1),this.minHeightAdjustTrigger=ko.observable(!1).extend({autoResetToFalse:105}),this.minHeightRemoveTrigger=ko.observable(!1).extend({autoResetToFalse:105}),this.jqContainers=$(".pSevenMain:first, .popup.compose_popup"),ko.computed(function(){this.minHeightAdjustTrigger(),this.minHeightRemoveTrigger(),_.delay(function(){$(".compose_popup .panel_content .panels").trigger("resize")},200)},this),this.hasSomethingToSave=ko.computed(function(){return this.isChanged()&&this.isEnableSaving()},this),this.saveAndCloseTooltip=ko.computed(function(){return Utils.i18n(this.hasSomethingToSave()?"COMPOSE/TOOL_SAVE_CLOSE":"COMPOSE/TOOL_CLOSE")},this),window.opener&&setTimeout(function(){window.onbeforeunload=function(){return e.hasSomethingToSave()?(e.beforeHide(window.close),""):void 0}},1e3),this.splitterDom=ko.observable(),this.fromToExpandColapssed=ko.observable(!1),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("view-model-defined",[this.__name,this])}function CSenderSelector(){this.senderList=ko.observableArray([]),this.senderAccountId=ko.observable(AppData.Accounts.currentId()),this.selectedFetcherOrIdentity=ko.observable(null),this.lockSelectedSender=ko.observable(!1),this.selectedSender=ko.observable(""),this.selectedSender.subscribe(function(){if(!this.lockSelectedSender()){var e=AppData.Accounts.getAccount(this.senderAccountId()),t=this.selectedSender(),i=null;0===t.indexOf("fetcher")?e.fetchers()&&(t=t.replace("fetcher",""),i=_.find(e.fetchers().collection(),function(e){return e.id()===Utils.pInt(t)})):i=_.find(e.identities(),function(e){return e.id()===Utils.pInt(t)}),i&&this.selectedFetcherOrIdentity(i)}},this)}function CContactsImportViewModel(e){this.oJua=null,this.oParent=e,this.visibility=ko.observable(!1),this.importing=ko.observable(!1)}function CContactsViewModel(){this.isPublic=bExtApp,this.contactCount=ko.observable(0),this.uploaderArea=ko.observable(null),this.bDragActive=ko.observable(!1),this.bDragActiveComp=ko.computed(function(){return this.bDragActive()},this),this.importingHelpLink=App.getHelpLink("ImportingContacts"),this.allowSendEmails=ko.computed(function(){return AppData.App.AllowWebMail&&AppData.Accounts.isCurrentAllowsMail()},this),this.loadingList=ko.observable(!1),this.preLoadingList=ko.observable(!1),this.loadingList.subscribe(function(e){this.preLoadingList(e)},this),this.loadingViewPane=ko.observable(!1),this.showPersonalContacts=ko.observable(!1),this.showGlobalContacts=ko.observable(!1),this.showSharedToAllContacts=ko.observable(!1),this.showAllContacts=ko.computed(function(){return 1<[this.showPersonalContacts()?"1":"",this.showGlobalContacts()?"1":"",this.showSharedToAllContacts()?"1":""].join("").length},this),this.recivedAnimShare=ko.observable(!1).extend({autoResetToFalse:500}),this.recivedAnimUnshare=ko.observable(!1).extend({autoResetToFalse:500}),this.isGlobalGroupSelect=ko.observable(!0),this.isAllOrSubOrGlobalGroupSelect=ko.observable(!0),this.selectedGroupType=ko.observable(Enums.ContactsGroupListType.Personal),this.selectedGroupType.subscribe(function(e){this.isGlobalGroupSelect(e===Enums.ContactsGroupListType.Global),this.isAllOrSubOrGlobalGroupSelect(e===Enums.ContactsGroupListType.SubGroup||e===Enums.ContactsGroupListType.Global||e===Enums.ContactsGroupListType.All)},this),this.selectedGroupInList=ko.observable(null),this.selectedGroupInList.subscribe(function(){var e=this.selectedGroupInList();e&&e.selected(!1)},this,"beforeChange"),this.selectedGroupInList.subscribe(function(e){e&&this.showPersonalContacts()&&(e.selected(!0),this.selectedGroupType(Enums.ContactsGroupListType.SubGroup),this.requestContactList())},this),this.selectedGroup=ko.observable(null),this.selectedContact=ko.observable(null),this.selectedGroupContactsList=ko.observable(null),this.currentGroupId=ko.observable(""),this.oContactModel=new CContactModel,this.oGroupModel=new CGroupModel,this.oContactImportViewModel=new CContactsImportViewModel(this),this.selectedOldItem=ko.observable(null),this.selectedItem=ko.computed({read:function(){return this.selectedContact()||this.selectedGroup()||null},write:function(e){e instanceof CContactModel?(this.oContactImportViewModel.visibility(!1),this.selectedGroup(null),this.selectedContact(e)):e instanceof CGroupModel?(this.oContactImportViewModel.visibility(!1),this.selectedContact(null),this.selectedGroup(e),this.currentGroupId(e.idGroup())):(this.selectedGroup(null),this.selectedContact(null)),this.loadingViewPane(!1)},owner:this}),this.sortOrder=ko.observable(!0),this.sortType=ko.observable(Enums.ContactSortType.Name),this.collection=ko.observableArray([]),this.contactUidForRequest=ko.observable(""),this.collection.subscribe(function(){this.collection().length>0&&""!==this.contactUidForRequest()&&(this.requestContact(this.contactUidForRequest()),this.contactUidForRequest(""))},this),this.isSearchFocused=ko.observable(!1),this.searchInput=ko.observable(""),this.search=ko.observable(""),this.groupFullCollection=ko.observableArray([]),this.selectedContact.subscribe(function(e){if(e){var t=e.groups();_.each(this.groupFullCollection(),function(e){e.checked(e&&0<=Utils.inArray(e.Id(),t))})}},this),this.selectedGroupType.subscribe(function(e){Enums.ContactsGroupListType.All!==e||this.showAllContacts()?Enums.ContactsGroupListType.Personal===e&&!this.showPersonalContacts()&&this.showGlobalContacts()?this.selectedGroupType(Enums.ContactsGroupListType.Global):Enums.ContactsGroupListType.Global===e&&!this.showGlobalContacts()&&this.showPersonalContacts()?this.selectedGroupType(Enums.ContactsGroupListType.Personal):(Enums.ContactsGroupListType.Personal===e||Enums.ContactsGroupListType.Global===e||Enums.ContactsGroupListType.SharedToAll===e||Enums.ContactsGroupListType.All===e)&&(this.selectedGroupInList(null),this.selectedItem(null),this.selector.listCheckedOrSelected(!1),this.requestContactList()):this.selectedGroupType(Enums.ContactsGroupListType.Personal)},this),this.pageSwitcherLocked=ko.observable(!1),this.oPageSwitcher=new CPageSwitcherViewModel(0,AppData.User.ContactsPerPage),this.oPageSwitcher.currentPage.subscribe(function(){var e=this.selectedGroupType(),t=e===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";this.pageSwitcherLocked()||App.Routing.setHash(App.Links.contacts(e,t,this.search(),this.oPageSwitcher.currentPage()))},this),this.currentPage=ko.observable(1),this.search.subscribe(function(e){this.searchInput(e)},this),this.searchSubmitCommand=Utils.createCommand(this,function(){var e=this.selectedGroupType(),t=e===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";App.Routing.setHash(App.Links.contacts(e,t,this.searchInput()))}),this.selector=new CSelector(this.collection,_.bind(function(e){if(e){var t=this.selectedGroupType(),i=t===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";App.Routing.setHash(App.Links.contacts(t,i,this.search(),this.oPageSwitcher.currentPage(),e.sId))}},this),_.bind(this.executeDelete,this),_.bind(this.onContactDblClick,this)),this.checkAll=this.selector.koCheckAll(),this.checkAllIncomplite=this.selector.koCheckAllIncomplete(),this.allowContactsSharing=!!AppData.App.AllowContactsSharing,this.isCheckedOrSelected=ko.computed(function(){return 0<this.selector.listCheckedOrSelected().length},this),this.isEnableAddContacts=this.isCheckedOrSelected,this.isEnableRemoveContactsFromGroup=this.isCheckedOrSelected,this.isEnableDeleting=this.isCheckedOrSelected,this.isEnableSharing=this.isCheckedOrSelected,this.visibleShareCommand=ko.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&this.selectedGroupType()===Enums.ContactsGroupListType.Personal},this),this.visibleUnshareCommand=ko.computed(function(){return this.showPersonalContacts()&&this.showSharedToAllContacts()&&this.selectedGroupType()===Enums.ContactsGroupListType.SharedToAll
},this),this.isSelectedGroupTypeNotGlobal=ko.computed(function(){return this.selectedGroupType()!==Enums.ContactsGroupListType.Global},this),this.isExport=ko.computed(function(){return this.contactCount()},this),this.newContactCommand=Utils.createCommand(this,this.executeNewContact,this.isSelectedGroupTypeNotGlobal),this.newGroupCommand=Utils.createCommand(this,this.executeNewGroup),this.addContactsCommand=Utils.createCommand(this,Utils.emptyFunction,this.isEnableAddContacts),this.deleteCommand=Utils.createCommand(this,this.executeDelete,this.isEnableDeleting),this.shareCommand=Utils.createCommand(this,this.executeShare,this.isEnableSharing),this.removeFromGroupCommand=Utils.createCommand(this,this.executeRemoveFromGroup,this.isEnableRemoveContactsFromGroup),this.importCommand=Utils.createCommand(this,this.executeImport),this.exportCSVCommand=Utils.createCommand(this,this.executeCSVExport,this.isExport),this.exportVCFCommand=Utils.createCommand(this,this.executeVCFExport,this.isExport),this.saveCommand=Utils.createCommand(this,this.executeSave),this.updateSharedToAllCommand=Utils.createCommand(this,this.executeUpdateSharedToAll,function(){return 1===this.selector.listCheckedOrSelected().length}),this.newMessageCommand=Utils.createCommand(this,function(){var e=this.selector.listCheckedOrSelected(),t=[];_.isArray(e)&&0<e.length&&(t=_.map(e,function(e){return e.EmailAndName()}),t=_.compact(t),App.Api.composeMessageToAddresses(t.join(", ")))},function(){return 0<this.selector.listCheckedOrSelected().length}),this.selector.listCheckedOrSelected.subscribe(function(e){this.oGroupModel.newContactsInGroupCount(e.length)},this),this.isSearch=ko.computed(function(){return""!==this.search()},this),this.isEmptyList=ko.computed(function(){return 0===this.collection().length},this),this.inGroup=ko.computed(function(){return Enums.ContactsGroupListType.SubGroup===this.selectedGroupType()},this),this.searchText=ko.computed(function(){return Utils.i18n("CONTACTS/INFO_SEARCH_RESULT",{SEARCH:this.search()})},this),this.mobileApp=bMobileApp,this.selectedPanel=ko.observable(Enums.MobilePanel.Items),this.selectedItem.subscribe(function(){var e=this.selectedItem()&&this.selectedItem()instanceof CGroupModel&&!this.selectedItem().isNew();this.selectedItem()&&!e?this.gotoViewPane():this.gotoContactList()},this)}function CScreens(){var e=$(window);this.resizeAll=_.debounce(function(){e.resize()},100),this.oScreens={},this.currentScreen=ko.observable(""),this.informationScreen=ko.observable(null),this.popups=[]}function CMailCache(){this.currentAccountId=AppData.Accounts.currentId,this.currentAccountId.subscribe(function(e){var t=AppData.Accounts.getAccount(e),i=this.oFolderListItems[e];t&&(t.quotaRecieved(!1),this.messagesLoadingError(!1),i?this.folderList(i):(this.messagesLoading(t.allowMail()),this.folderList(new CFolderListModel),this.messages([]),this.currentMessage(null),this.getFolderList(e)))},this),this.editedAccountId=AppData.Accounts.editedId,this.editedAccountId.subscribe(function(e){var t=this.oFolderListItems[e];t?this.editedFolderList(t):this.currentAccountId()!==e&&(this.editedFolderList(new CFolderListModel),this.getFolderList(e))},this),this.oFolderListItems={},this.quotaChangeTrigger=ko.observable(!1),this.checkMailStarted=ko.observable(!1),this.checkMailStartedAccountId=ko.observable(0),this.defaultFolderList=ko.observable(new CFolderListModel),this.folderList=ko.observable(new CFolderListModel),this.folderListLoading=ko.observableArray([]),this.editedFolderList=ko.observable(new CFolderListModel),this.newMessagesCount=ko.computed(function(){var e=this.folderList().inboxFolder();return e?e.unseenMessageCount():0},this),this.newMessagesCount.subscribe(function(e){App.mailUnseenCount(e>99?"99+":e)},this),this.messages=ko.observableArray([]),this.messages.subscribe(function(){this.messages().length>0&&this.messagesLoadingError(!1)},this),this.uidList=ko.observable(new CUidListModel),this.page=ko.observable(1),this.messagesLoading=ko.observable(!1),this.messagesLoadingError=ko.observable(!1),this.currentMessage=ko.observable(null),this.currentMessage.subscribe(function(){this.currentMessage()&&AfterLogicApi.runPluginHook("view-message",[AppData.Accounts.currentId(),this.currentMessage().folder(),this.currentMessage().uid()])},this),this.nextMessageUid=ko.computed(function(){var e="",t="",i=null,s=null,o=!1;return this.currentMessage()&&AppData.SingleMode&&(o=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),i=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),AppData.ThreadLevel||o?(AppData.ThreadLevel=!0,o&&(s=i.getMessageByUid(this.currentMessage().threadParentUid()),s&&(_.each(s.threadUids(),function(i,s,o){i===e&&s>0&&(t=o[s-1])}),(Utils.isUnd(t)||""===t)&&(t=s.uid())))):(_.each(this.uidList().collection(),function(i,s,o){i===e&&s>0&&(t=o[s-1])}),Utils.isUnd(t)&&(t=""),""===t&&window.opener&&window.opener.App&&window.opener.App.Prefetcher&&window.opener.App.Prefetcher.prefetchNextPage(e))),t},this),this.prevMessageUid=ko.computed(function(){var e=this.currentMessage()?this.currentMessage().uid():"",t="",i=null,s=null,o=!1;return this.currentMessage()&&AppData.SingleMode&&(o=this.currentMessage().threadPart()&&""!==this.currentMessage().threadParentUid(),i=this.folderList().getFolderByFullName(this.currentMessage().folder()),e=this.currentMessage().uid(),AppData.ThreadLevel||o?(AppData.ThreadLevel=!0,o?(s=i.getMessageByUid(this.currentMessage().threadParentUid()),s&&(_.each(s.threadUids(),function(i,s,o){i===e&&s+1<o.length&&(t=o[s+1])}),Utils.isUnd(t)&&(t=""))):this.currentMessage().threadCount()>0&&(t=this.currentMessage().threadUids()[0])):(_.each(this.uidList().collection(),function(i,s,o){i===e&&s+1<o.length&&(t=o[s+1])}),Utils.isUnd(t)&&(t=""),""===t&&window.opener&&window.opener.App&&window.opener.App.Prefetcher&&window.opener.App.Prefetcher.prefetchPrevPage(e))),t},this),this.savingDraftUid=ko.observable(""),this.editedDraftUid=ko.observable(""),this.disableComposeAutosave=ko.observable(!1),this.aResponseHandlers=[],AppData.User.useThreads.subscribe(function(){_.each(this.oFolderListItems,function(e){_.each(e.collection(),function(e){e.markHasChanges(),e.removeAllMessageListsFromCacheIfHasChanges()},this)},this),this.messages([])},this),this.iAutoCheckMailTimer=-1,this.waitForUnseenMessages=ko.observable(!0),this.iMessageSetSeenCount=0,this.__name="CMailCache"}function CContactsCache(){this.contacts={},this.responseHandlers={},this.vcardAttachments=[],this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.newContactParams=null}function CCalendarCache(){this.calendars=ko.observableArray([]),this.calendarsLoadingStarted=ko.observable(!1),this.icalAttachments=[],this.recivedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.calendarSettingsChanged=ko.observable(!1),this.calendarChanged=ko.observable(!1),this.canRequestCalendarList=ko.observable(!1)}function AbstractApp(){this.browser=new CBrowser;try{this.favico=!this.browser.ie8AndBelow&&window.Favico?new window.Favico({animation:"none"}):null}catch(e){this.favico=null}this.Ajax=new CAjax,this.Screens=new CScreens,this.Api=new CApi,this.Storage=new CStorage,this.helpdeskUnseenCount=ko.observable(0),this.helpdeskPendingCount=ko.observable(0),this.mailUnseenCount=ko.observable(0),this.InternetConnectionError=!1}function AppBase(){AbstractApp.call(this),this.headerTabs=ko.observableArray([]),this.screensTitle={},this.Phone=null,this.Routing=new CRouting,this.Links=new CLinkBuilder,this.MessageSender=new CMessageSender,this.Prefetcher=new CPrefetcher,this.MailCache=null,this.ContactsCache=new CContactsCache,this.CalendarCache=new CCalendarCache,this.currentScreen=this.Screens.currentScreen,this.currentScreen.subscribe(this.setTitle,this),this.focused=ko.observable(!0),this.focused.subscribe(function(){AppData.SingleMode||window.opener||this.setTitle()},this),this.filesRecievedAnim=ko.observable(!1).extend({autoResetToFalse:500}),this.init(),this.newMessagesCount=this.MailCache.newMessagesCount,this.newMessagesCount.subscribe(this.setTitle,this),this.currentMessage=this.MailCache.currentMessage,this.currentMessage.subscribe(this.setTitle,this),this.notification=null,this.initHeaderInfo(),this.sessionTimeoutFunctions=[],this.initSessionTimeout(),this.sResetPassHash=Utils.Common.getRequestParam("reset-pass")||""}function AppMobile(){AppBase.call(this)}var Consts={},Enums={},Utils={},I18n=window.pSevenI18N||{},App={},AfterLogicApi={},AppData=window.pSevenAppData||{},bExtApp=!1,bMobileApp=!1,$html=$("html"),bIsWindowsPhone=-1<navigator.userAgent.indexOf("Windows Phone"),bIsIosDevice=!bIsWindowsPhone&&(-1<navigator.userAgent.indexOf("iPhone")||-1<navigator.userAgent.indexOf("iPod")||-1<navigator.userAgent.indexOf("iPad")),bIsAndroidDevice=!bIsWindowsPhone&&-1<navigator.userAgent.toLowerCase().indexOf("android"),bMobileDevice=bIsWindowsPhone||bIsIosDevice||bIsAndroidDevice,aViewMimeTypes=["image/jpeg","image/png","image/gif","text/html","text/plain","text/css","text/rfc822-headers","message/delivery-status","application/x-httpd-php","application/javascript","application/pdf"];if(window.Modernizr&&navigator&&window.Modernizr.addTest("pdf",function(){for(var e=navigator.mimeTypes,t=0,i=e.length;i>t;t++)if("application/pdf"===e[t].type)return!0;return!1}),Date.now||(Date.now=function(){return(new Date).getTime()}),bMobileApp=!0,window.Modernizr&&navigator&&window.Modernizr.addTest("native-android-browser",function(){var e=navigator.userAgent;return e.indexOf("Mozilla/5.0")>-1&&e.indexOf("Android ")>-1&&e.indexOf("534")>-1&&e.indexOf("AppleWebKit")>-1}),CBrowser.prototype.getIeVersion=function(){var e=navigator.userAgent.toLowerCase(),t=Utils.pInt(e.slice(e.indexOf("msie")+4,e.indexOf(";",e.indexOf("msie")+4)));return this.ie11&&(t=11),t},CAjax.prototype.AddActionsWithoutAuthForSendExt=function(e){e=Utils.isUnd(e)?"":e,""!==e&&-1===_.indexOf(this.aActionsWithoutAuthForSendExt,e)&&this.aActionsWithoutAuthForSendExt.push(e)},CAjax.prototype.AddActionsWithoutAuthForSend=function(e){e=Utils.isUnd(e)?"":e,""!==e&&-1===_.indexOf(this.aActionsWithoutAuthForSend,e)&&this.aActionsWithoutAuthForSend.push(e)},CAjax.prototype.hasOpenedRequests=function(e){return e=Utils.isUnd(e)?"":e,this.requests(_.filter(this.requests(),function(t){var i=t&&4===t.Xhr.readyState,s=!t||0===t.Xhr.readyState&&"abort"===t.Xhr.statusText,o=""===e||t&&t.Parameters.Action===e;return t&&!i&&!s&&o})),this.requests().length>0},CAjax.prototype.isSearchMessages=function(){var e=!1;return _.each(this.requests(),function(t){t&&t.Parameters&&"MessagesGetList"===t.Parameters.Action&&""!==t.Parameters.Search&&(e=!0)},this),e},CAjax.prototype.isAllowedActionWithoutAuth=function(e){return-1!==_.indexOf(this.aActionsWithoutAuthForSend,e)},CAjax.prototype.isAllowedExtAction=function(e){return"SocialRegister"===e||"HelpdeskRegister"===e||"HelpdeskForgot"===e||"HelpdeskLogin"===e||"SystemLogout"===e},CAjax.prototype.doSend=function(e,t,i,s){var o=_.bind(s||null,this,e,t,i),n=_.bind(this.fail,this,e,t,i),r=_.bind(this.always,this,e),a=null;AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("ajax-default-request",[e.Action,e]),AppData.Token&&(e.Token=AppData.Token),this.abortRequests(e),Utils.log("Ajax request send",e.Action,e),a=$.ajax({url:this.sUrl,type:"POST",async:!0,dataType:"json",data:e,success:o,error:n,complete:r,timeout:"MessagesGetBodies"===e.Action?1e5:5e4}),this.requests().push({Parameters:e,Xhr:a})},CAjax.prototype.send=function(e,t,i){var s=void 0===e.AccountID,o=s||AppData.Accounts.hasAccountWithId(e.AccountID);e&&(AppData.Auth&&o||this.isAllowedActionWithoutAuth(e.Action))&&(s&&"Login"!==e.Action&&(e.AccountID=AppData.Accounts.currentId()),this.doSend(e,t,i,this.done))},CAjax.prototype.sendExt=function(e,t,i){var s=-1!==_.indexOf(this.aActionsWithoutAuthForSendExt,e.Action);e&&(AppData.Auth||s)&&(AppData.TenantHash&&(e.TenantHash=AppData.TenantHash),this.doSend(e,t,i,this.doneExt))},CAjax.prototype.abortRequests=function(e){switch(e.Action){case"MessageMove":case"MessageDelete":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("MessageGet");break;case"MessagesGetList":case"MessageSetSeen":case"MessageSetFlagged":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder});break;case"MessagesSetAllSeen":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("MessagesGetListByUids",{Folder:e.Folder});break;case"FolderClear":this.abortRequestByActionName("MessagesGetList",{Folder:e.Folder}),this.abortRequestByActionName("FoldersGetRelevantInformation");break;case"FoldersGetRelevantInformation":this.abortRequestByActionName("FoldersGetRelevantInformation");break;case"MessagesGetFlags":this.abortRequestByActionName("MessagesGetFlags");break;case"ContactList":case"ContactGlobalList":this.abortRequestByActionName("ContactList"),this.abortRequestByActionName("ContactGlobalList");break;case"ContactGet":case"ContactGlobal":this.abortRequestByActionName("ContactGet"),this.abortRequestByActionName("ContactGlobal");break;case"CalendarEventUpdate":this.abortRequestByActionName("CalendarEventUpdate",{calendarId:e.calendarId,uid:e.uid});break;case"CalendarList":this.abortRequestByActionName("CalendarList");break;case"CalendarEventList":this.abortRequestByActionName("CalendarEventList")}},CAjax.prototype.abortRequestByActionName=function(e,t){var i;_.each(this.requests(),function(s,o){if(i=!1,s&&s.Parameters.Action===e)switch(e){case"MessagesGetList":t.Folder===s.Parameters.Folder&&(i=!0);break;case"CalendarEventUpdate":t.calendarId===s.Parameters.calendarId&&t.uid===s.Parameters.uid&&(i=!0);break;default:i=!0}i&&(s.Xhr.abort(),this.requests()[o]=void 0)},this),this.requests(_.compact(this.requests()))},CAjax.prototype.abortAllRequests=function(){_.each(this.requests(),function(e){e&&e.Xhr.abort()},this),this.requests([])},CAjax.prototype.done=function(e,t,i,s,o){var n=this.isAllowedActionWithoutAuth(e.Action),r=AppData.Accounts.hasAccountWithId(e.AccountID),a=e.AccountID===AppData.Accounts.defaultId();if(Utils.log("Ajax request done",e.Action,o,Utils.getAjaxDataForLog(e.Action,s),e),n||r){if(s&&!s.Result)switch(s.ErrorCode){case Enums.Errors.InvalidToken:n||App.tokenProblem();break;case Enums.Errors.AuthError:a&&!n&&(this.abortAllRequests(),App.authProblem())}this.executeResponseHandler(t,i,s,e)}},CAjax.prototype.doneExt=function(e,t,i,s){this.executeResponseHandler(t,i,s,e)},CAjax.prototype.fail=function(e,t,i,s,o,n){var r={Result:!1,ErrorCode:0};switch(Utils.log("Ajax request fail",e.Action,o,e),o){case"abort":r={Result:!1,ErrorCode:Enums.Errors.NotDisplayedError};break;default:case"error":case"parseerror":r=""===n?{Result:!1,ErrorCode:Enums.Errors.NotDisplayedError}:{Result:!1,ErrorCode:Enums.Errors.DataTransferFailed}}this.executeResponseHandler(t,i,r,e)},CAjax.prototype.executeResponseHandler=function(e,t,i,s){i||(i={Result:!1,ErrorCode:0}),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("ajax-default-response",[s.Action,i]),"function"!=typeof e||i.StopExecuteResponse||e.apply(t,[i,s])},CAjax.prototype.always=function(e,t,i){"abort"!==i&&(_.each(this.requests(),function(t,i){t&&_.isEqual(t.Parameters,e)&&(this.requests()[i]=void 0)},this),this.requests(_.compact(this.requests())),Utils.checkConnection(e.Action,i),App.Prefetcher&&"parsererror"!==i&&!this.hasOpenedRequests()&&App.Prefetcher.start())},Enums.Screens={Login:"login",Information:"information",Header:"header",Mailbox:"mailbox",SingleMessageView:"single-message-view",Compose:"compose",SingleCompose:"single-compose",Settings:"settings",Contacts:"contacts",Calendar:"calendar",FileStorage:"files",Helpdesk:"helpdesk",SingleHelpdesk:"single-helpdesk"},Enums.CalendarDefaultTab={Day:1,Week:2,Month:3},Enums.TimeFormat={F24:"0",F12:"1"},Enums.Errors={InvalidToken:101,AuthError:102,DataBaseError:104,LicenseProblem:105,DemoLimitations:106,Captcha:107,AccessDenied:108,CanNotGetMessage:202,ImapQuota:205,NotSavedInSentItems:304,NoRequestedMailbox:305,CanNotChangePassword:502,AccountOldPasswordNotCorrect:503,FetcherIncServerNotAvailable:702,FetcherLoginNotCorrect:703,HelpdeskThrowInWebmail:805,HelpdeskUserNotExists:807,HelpdeskUserNotActivated:808,IncorrectFileExtension:811,MailServerError:901,DataTransferFailed:1100,NotDisplayedError:1155},Enums.FolderTypes={Inbox:1,Sent:2,Drafts:3,Spam:4,Trash:5,Virus:6,Starred:7,System:9,User:10},Enums.FolderFilter={Flagged:"flagged",Unseen:"unseen"},Enums.LoginFormType={Email:0,Login:3,Both:4},Enums.LoginSignMeType={DefaultOff:0,DefaultOn:1,Unuse:2},Enums.ReplyType={Reply:"reply",ReplyAll:"reply-all",Resend:"resend",Forward:"forward"},Enums.Importance={Low:5,Normal:3,High:1},Enums.Sensitivity={Nothing:0,Confidential:1,Private:2,Personal:3},Enums.ContactEmailType={Personal:"Personal",Business:"Business",Other:"Other"},Enums.ContactPhoneType={Mobile:"Mobile",Personal:"Personal",Business:"Business"},Enums.ContactAddressType={Personal:"Personal",Business:"Business"},Enums.ContactSortType={Email:"Email",Name:"Name",Frequency:"Frequency"},Enums.SaveMail={Hidden:0,Checked:1,Unchecked:2},Enums.SettingsTab={Common:"common",EmailAccounts:"accounts",Calendar:"calendar",MobileSync:"mobile_sync",OutLookSync:"outlook_sync",Helpdesk:"helpdesk",Pgp:"pgp",Services:"services",CloudStorage:"cloud-storage"},Enums.AccountSettingsTab={Properties:"properties",Signature:"signature",Filters:"filters",Autoresponder:"autoresponder",Forward:"forward",Folders:"folders",FetcherInc:"fetcher-inc",FetcherOut:"fetcher-out",FetcherSig:"fetcher-sig",IdentityProperties:"identity-properties",IdentitySignature:"identity-signature"},Enums.AccountCreationPopupType={OneStep:1,TwoSteps:2,ConnectToMail:3},Enums.ContactsGroupListType={Personal:0,SubGroup:1,Global:2,SharedToAll:3,All:4},Enums.IcalType={Request:"REQUEST",Reply:"REPLY",Cancel:"CANCEL",Save:"SAVE"},Enums.IcalConfig={Accepted:"ACCEPTED",Declined:"DECLINED",Tentative:"TENTATIVE",NeedsAction:"NEEDS-ACTION"},Enums.IcalConfigInt={Accepted:1,Declined:2,Tentative:3,NeedsAction:0},Enums.Key={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Esc:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Up:38,Down:40,Left:37,Right:39,Del:46,Six:54,a:65,b:66,c:67,f:70,i:73,k:75,n:78,p:80,q:81,r:82,s:83,u:85,v:86,y:89,z:90,F5:116,Comma:188,Dot:190,Dash:192,Apostrophe:222},Enums.MouseKey={Left:0,Middle:1,Right:2},Enums.FileStorageType={Personal:"personal",Corporate:"corporate",Shared:"shared",GoogleDrive:"google",Dropbox:"dropbox"},Enums.FileStorageLinkType={Unknown:0,GoogleDrive:1,Dropbox:2,YouTube:3,Vimeo:4,SoundCloud:5},Enums.HelpdeskThreadStates={None:0,Pending:1,Waiting:2,Answered:3,Resolved:4,Deferred:5},Enums.HelpdeskPostType={Normal:0,Internal:1,System:2},Enums.HelpdeskFilters={All:0,Pending:1,Resolved:2,InWork:3,Open:4,Archived:9},Enums.CalendarAccess={Full:0,Write:1,Read:2},Enums.CalendarEditRecurrenceEvent={None:0,OnlyThisInstance:1,AllEvents:2},Enums.CalendarRepeatPeriod={None:0,Daily:1,Weekly:2,Monthly:3,Yearly:4},Enums.CalendarAlways={Disable:0,Enable:1},Enums.PhoneAction={Offline:"offline",OfflineError:"offline_error",OfflineInit:"offline_init",OfflineActive:"offline_active",Online:"online",OnlineActive:"online_active",Incoming:"incoming",IncomingConnect:"incoming_connect",Outgoing:"outgoing",OutgoingConnect:"outgoing_connect",Settings:"settings"},Enums.HtmlEditorImageSizes={Small:"small",Medium:"medium",Large:"large",Original:"original"},Enums.MobilePanel={Groups:1,Items:2,View:3},Enums.PgpAction={Import:"import",Generate:"generate",Encrypt:"encrypt",Sign:"sign",EncryptSign:"encrypt-sign",Verify:"ferify",DecryptVerify:"decrypt-ferify"},Enums.SocialType={Unknown:0,Google:1,Dropbox:2,Facebook:3,Twitter:4,Vkontakte:5},Enums.notificationPermission={Granted:"granted",Denied:"denied",Default:"default"},Enums.AnotherMessageComposedAnswer={Discard:"Discard",SaveAsDraft:"SaveAsDraft",Cancel:"Cancel"},Utils.inArray=$.inArray,Utils.isFunc=$.isFunction,Utils.trim=$.trim,Utils.emptyFunction=function(){},Utils.isUnd=function(e){return void 0===e},Utils.isNull=function(e){return null===e},Utils.isNormal=function(e){return!Utils.isUnd(e)&&!Utils.isNull(e)},Utils.isNumeric=function(e){return Utils.isNormal(e)?/^[1-9]+[0-9]*$/.test(e.toString()):!1},Utils.pInt=function(e){var t=window.parseInt(e,10);return isNaN(t)&&(t=0),t},Utils.pString=function(e){return Utils.isNormal(e)?e.toString():""},Utils.isNonEmptyArray=function(e,t){return t=t||1,_.isArray(e)&&t<=e.length},Utils.pImport=function(e,t,i){e[t]=i},Utils.pExport=function(e,t,i){return Utils.isUnd(e[t])?i:e[t]},Utils.encodeHtml=function(e){return e?e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""},Utils.i18n=function(e,t,i,s){var o="",n=Utils.isUnd(I18n[e])?Utils.isNormal(i)?i:e:I18n[e];if(Utils.isUnd(s)||(n=function(e,t){var i=Utils.getPlural(AppData.User.DefaultLanguage,e),s=t.split("|");return s&&s[i]?s[i]:s&&s[0]?s[0]:t}(s,n)),Utils.isNormal(t))for(o in t)if(t.hasOwnProperty(o)){var r=new RegExp("%"+o+"%","g");n=n.replace(r,t[o])}return n},Utils.roundNumber=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},Utils.friendlySize=function(e){var t=1024,i=t*t,s=t*t*t;return e=Utils.pInt(e),e>=s?Utils.roundNumber(e/s,1)+Utils.i18n("MAIN/GIGABYTES"):e>=i?Utils.roundNumber(e/i,1)+Utils.i18n("MAIN/MEGABYTES"):e>=t?Utils.roundNumber(e/t,0)+Utils.i18n("MAIN/KILOBYTES"):e+Utils.i18n("MAIN/BYTES")},Utils.timeOutAction=function(){var e={};return function(t,i,s){Utils.isUnd(e[t])&&(e[t]=0),window.clearTimeout(e[t]),e[t]=window.setTimeout(i,s)}}(),Utils.$log=null,Utils.aLog=[],Utils.log=function(){function e(e,t){return"string"==typeof t&&t.length>50?t.substring(0,50):t}if(AppData&&AppData.ClientDebug&&App.browser&&!App.browser.ie9AndBelow){var t=Utils.$log||$('<div style="display: none;"></div>').appendTo("body"),i=[];_.each(arguments,function(t){var s="string"==typeof t?t:JSON.stringify(t,e);0===i.length&&(s=" *** "+s+" *** "),i.push(s)}),i.push(moment().format(" *** D MMMM, YYYY, HH:mm:ss *** ")),Utils.$log=t,Utils.aLog.length>200&&Utils.aLog.shift(),Utils.aLog.push(Utils.encodeHtml(i.join(", "))),t.html(Utils.aLog.join("<br /><br />"))}},Utils.getAjaxDataForLog=function(e,t){var i=t;if(t&&t.Result)switch(e){case"MessagesGetList":case"MessagesGetListByUids":i={Result:{Uids:t.Result.Uids,UidNext:t.Result.UidNext,FolderHash:t.Result.FolderHash,MessageCount:t.Result.MessageCount,MessageUnseenCount:t.Result.MessageUnseenCount,MessageResultCount:t.Result.MessageResultCount}};break;case"MessageGet":i={Result:{Folder:t.Result.Folder,Uid:t.Result.Uid,Subject:t.Result.Subject,Size:t.Result.Size,TextSize:t.Result.TextSize,From:t.Result.From,To:t.Result.To}};break;case"MessagesGetBodies":i={Result:_.map(t.Result,function(e){return{Uid:e.Uid,Subject:e.Subject}})}}else t&&(i={Result:t.Result,ErrorCode:t.ErrorCode});return i},Utils.getImportContactsLink=function(){return"?/ImportContacts/"},Utils.getExportContactsLink=function(e){return"?/Raw/Contacts"+e+"/"},Utils.getExportCalendarLinkByHash=function(e,t){return"?/Raw/Calendar/"+e+"/"+t},Utils.getDownloadLinkByHash=function(e,t,i,s){return i=Utils.isUnd(i)?!1:!!i,s=Utils.isUnd(s)?"":s,"?/Raw/Download/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Utils.getIframeLinkByHash=function(e,t,i,s){return i=Utils.isUnd(i)?!1:!!i,s=Utils.isUnd(s)?"":s,"?/Raw/Iframe/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Utils.getIframeWrappwer=function(e,t){return"?/Raw/Iframe/"+e+"/"+window.encodeURIComponent(t)+"/"},Utils.getViewThumbnailLinkByHash=function(e,t,i,s){return i=Utils.isUnd(i)?!1:!!i,s=Utils.isUnd(s)?"":s,"?/Raw/Thumbnail/"+e+"/"+t+"/"+(i?"1":"0")+(""===s?"":"/"+s)},Utils.getFilestorageDownloadLinkByHash=function(e,t,i){var s="?/Raw/FilesDownload/"+e+"/"+t;return Utils.isUnd(i)||(s=s+"/0/"+i),s},Utils.getFilestorageViewLinkByHash=function(e,t,i){var s="?/Raw/FilesView/"+e+"/"+t;return Utils.isUnd(i)||(s=s+"/0/"+i),s},Utils.getFilestorageViewThumbnailLinkByHash=function(e,t,i){var s="?/Raw/FilesThumbnail/"+e+"/"+t;return Utils.isUnd(i)||(s=s+"/0/"+i),s},Utils.getFilestoragePublicViewLinkByHash=function(e){return"?/Window/Files/0/"+e},Utils.getFilestoragePublicDownloadLinkByHash=function(e){return"?/Raw/FilesPub/0/"+e},Utils.daysInMonth=function(e,t){return e>0&&13>e&&t>0?new Date(t,e,0).getDate():31},Utils.WindowOpener={_iDefaultRatio:.8,_aOpenedWins:[],openMessage:function(e,t){if(e){var i=e.folder(),s=e.uid(),o="";o=App.Routing.buildHashFromArray(t?[Enums.Screens.SingleCompose,"drafts",i,s]:[Enums.Screens.SingleMessageView,i,"msg"+s]),this.openTab(o)}},openTab:function(e,t){$.cookie("aft-cache-ctrl","1");var i=null;return i=window.open(e,"_blank"),i&&(i.focus(),i.name=t?t:AppData.Accounts?AppData.Accounts.currentId():0,this._aOpenedWins.push(i)),i},open:function(e,t,i){var s=i?",menubar=yes":",menubar=no",o="location=no,toolbar=no,status=no,scrollbars=yes,resizable=yes"+s,n=null;return t=t.replace(/\W/g,""),o+=this._getSizeParameters(),n=window.open(e,t,o),n.focus(),n.name=AppData.Accounts?AppData.Accounts.currentId():0,this._aOpenedWins.push(n),n},getOpenedDraftUids:function(){this._aOpenedWins=_.filter(this._aOpenedWins,function(e){return!e.closed});var e=_.map(this._aOpenedWins,function(e){return e.App&&window.location.origin===e.location.origin?e.App.MailCache.editedDraftUid():""});return App.Screens.hasOpenedMinimizedPopups()&&e.push(App.MailCache.editedDraftUid()),_.uniq(_.compact(e))},closeComposesWithDraftUids:function(e){_.each(this._aOpenedWins,function(t){t.App&&-1!==Utils.inArray(t.App.MailCache.editedDraftUid(),e)&&t.close()}),-1!==Utils.inArray(App.MailCache.editedDraftUid(),e)&&App.Api.closeComposePopup()},closeAll:function(){for(var e=this._aOpenedWins.length,t=0,i=null;e>t;t++)i=this._aOpenedWins[t],i.closed||i.close();this._aOpenedWins=[]},_getSizeParameters:function(){var e=window.screen.width,t=Math.ceil(e*this._iDefaultRatio),i=Math.ceil((e-t)/2),s=window.screen.height,o=Math.ceil(s*this._iDefaultRatio),n=Math.ceil((s-o)/2);return",width="+t+",height="+o+",top="+n+",left="+i}},Utils.delegateRun=function(e,t,i){e&&e[t]&&e[t].apply(e,_.isArray(i)?i:[])},Utils.strRepeat=function(e,t){return new Array(t+1).join(e)},Utils.deferredUpdate=function(e,t,i,s){!e.__interval&&t?(e.__state=!0,s(e,!0),e.__interval=window.setInterval(function(){e.__state||(s(e,!1),window.clearInterval(e.__interval),e.__interval=null)},i)):t||(e.__state=!1)},Utils.draggableMessages=function(){return $('<div class="draggable draggableMessages"><div class="content"><span class="count-text"></span></div></div>').appendTo("#pSevenHidden")},Utils.draggableContacts=function(){return $('<div class="draggable draggableContacts"><div class="content"><span class="count-text"></span></div></div>').appendTo("#pSevenHidden")},Utils.removeActiveFocus=function(){if(document&&document.activeElement&&document.activeElement.blur){var e=$(document.activeElement);(e.is("input")||e.is("textarea"))&&document.activeElement.blur()}},Utils.uiDropHelperAnim=function(e,t){var i=0,s=0,o=0,n=0,r=0,a=0,l=t.helper.clone().appendTo("#pSevenHidden"),h=$(e.target).find(".animGoal"),c=null;h=$(h[0]?h[0]:e.target),c=h&&h[0]?h.offset():null,c&&(i=window.Math.round(c.left),s=window.Math.round(c.top),r=h.width(),a=h.height(),o=i,r>0&&(o+=window.Math.round(r/2)),n=s,a>0&&(n+=window.Math.round(a/2)),l.animate({left:o+"px",top:n+"px","font-size":"0px",opacity:0},800,"easeOutQuint",function(){$(this).remove()}))},Utils.isTextFieldFocused=function(){var e=document&&document.activeElement?document.activeElement:null,t=e?e.tagName:null,i=e&&e.type?e.type.toLowerCase():null,s=e?e.contentEditable:null;return"INPUT"===t&&("text"===i||"password"===i||"email"===i)||"TEXTAREA"===t||"IFRAME"===t||"true"===s},Utils.removeSelection=function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},Utils.getMonthNamesArray=function(){for(var e=Utils.i18n("DATETIME/MONTH_NAMES").split(" "),t=12,i=e.length;t>i;i++)e[i]="";return e},Utils.getPlural=function(e,t){var i=0;switch(t=Utils.pInt(t),e){case"Arabic":i=0===t?0:1===t?1:2===t?2:t%100>=3&&10>=t%100?3:t%100>=11?4:5;break;case"Bulgarian":i=1===t?0:1;break;case"Chinese-Simplified":i=0;break;case"Chinese-Traditional":i=1===t?0:1;break;case"Czech":i=1===t?0:t>=2&&4>=t?1:2;break;case"Danish":i=1===t?0:1;break;case"Dutch":i=1===t?0:1;break;case"English":i=1===t?0:1;break;case"Estonian":i=1===t?0:1;break;case"Finish":i=1===t?0:1;break;case"French":i=1===t?0:1;break;case"German":i=1===t?0:1;break;case"Greek":i=1===t?0:1;break;case"Hebrew":i=1===t?0:1;break;case"Hungarian":i=1===t?0:1;break;case"Italian":i=1===t?0:1;break;case"Japanese":i=0;break;case"Korean":i=0;break;case"Latvian":i=t%10===1&&t%100!==11?0:0!==t?1:2;break;case"Lithuanian":i=t%10===1&&t%100!==11?0:t%10>=2&&(10>t%100||t%100>=20)?1:2;break;case"Norwegian":i=1===t?0:1;break;case"Persian":i=0;break;case"Polish":i=1===t?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;case"Portuguese-Portuguese":i=1===t?0:1;break;case"Portuguese-Brazil":i=1===t?0:1;break;case"Romanian":i=1===t?0:0===t||t%100>0&&20>t%100?1:2;break;case"Russian":i=t%10===1&&t%100!==11?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;case"Slovenian":i=t%10===1&&t%100!==11?0:t%10===2&&t%100!==12?1:2;break;case"Serbian":i=t%10===1&&t%100!==11?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;case"Spanish":i=1===t?0:1;break;case"Swedish":i=1===t?0:1;break;case"Thai":i=0;break;case"Turkish":i=1===t?0:1;break;case"Ukrainian":i=t%10===1&&t%100!==11?0:t%10>=2&&4>=t%10&&(10>t%100||t%100>=20)?1:2;break;case"Vietnamese":i=0;break;default:i=0}return i},Utils.getFileExtension=function(e){var t="",i=e.lastIndexOf(".");return i>-1&&(t=e.substr(i+1)),t},Utils.getFileNameWithoutExtension=function(e){var t=e,i=e.lastIndexOf(".");return i>-1&&(t=e.substr(0,i)),t},Utils.defaultOptionsAfterRender=function(e,t){t&&(Utils.isUnd(t.disable)||ko.applyBindingsToNode(e,{disable:t.disable},t))},Utils.getDateFormatForMoment=function(e){var t="MM/DD/YYYY";switch(e){case"MM/DD/YYYY":t="MM/DD/YYYY";break;case"DD/MM/YYYY":t="DD/MM/YYYY";break;case"DD Month YYYY":t="DD MMMM YYYY"}return t},Utils.getDateFormatForDatePicker=function(e){var t="mm/dd/yy";switch(e){case"MM/DD/YYYY":t="mm/dd/yy";break;case"DD/MM/YYYY":t="dd/mm/yy";break;case"DD Month YYYY":t="dd MM yy"}return t},Utils.getDateFormatsForSelector=function(){return _.map(AppData.App.DateFormats,function(e){switch(e){case"MM/DD/YYYY":return{name:Utils.i18n("DATETIME/DATEFORMAT_MMDDYYYY"),value:e};case"DD/MM/YYYY":return{name:Utils.i18n("DATETIME/DATEFORMAT_DDMMYYYY"),value:e};case"DD Month YYYY":return{name:Utils.i18n("DATETIME/DATEFORMAT_DDMONTHYYYY"),value:e};default:return{name:e,value:e}}})},Utils.getTitleForEvent=function(e){var t=e?Utils.trim(e.replace(/[\n\r]/," ")):"",i=t.indexOf(" ",180);return i>=0&&(t=t.substring(0,i)+"..."),t.length>200&&(t=t.substring(0,200)+"..."),t},Utils.desktopNotify=function(){var e=[];return function(t){if(t&&AppData.User.DesktopNotifications&&window.Notification&&!App.focused())switch(t.action){case"show":if(window.Notification.permission!==Enums.notificationPermission.Denied){var i,s={body:t.body||"",dir:t.dir||"auto",lang:t.lang||"",tag:t.tag||Math.floor(900*Math.random()+100),icon:t.icon||!1},o=function(){i=new window.Notification(t.title,s),i.onclick=function(){t.callback&&t.callback(),i.close()},t.timeout&&setTimeout(function(){i.close()},t.timeout),e.push(i)};window.Notification.permission===Enums.notificationPermission.Granted?o():window.Notification.permission===Enums.notificationPermission.Default&&window.Notification.requestPermission(function(e){e===Enums.notificationPermission.Granted&&o()})}break;case"hide":_.each(e,function(i,s){t.tag===i.tag&&(i.close(),e.splice(s,1))});break;case"hideAll":_.each(e,function(e){e.close()}),e.length=0}}}(),Utils.isRTL=function(){return $html.hasClass("rtl")},Utils.validateFileOrFolderName=function(e){return e=Utils.trim(e),""!==e&&!/["\/\\*?<>|:]/.test(e)
},Utils.shadeColor=function(e,t){var i=!1,s=0,o=0,n=0,r=0;return"#"===e[0]&&(e=e.slice(1),i=!0),s=window.parseInt(e,16),o=(s>>16)+t,o>255?o=255:0>o&&(o=0),n=(s>>8&255)+t,n>255?n=255:0>n&&(n=0),r=(255&s)+t,r>255?r=255:0>r&&(r=0),(i?"#":"")+(r|n<<8|o<<16).toString(16)},Utils.extend=function(e,t){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e},Utils.thumbQueue=function(){var e={},t={},i=2;return function(s,o,n){o&&n?!(s in t)||t[s]>0?(s in t||(t[s]=i,e[s]=[]),t[s]--,n(o)):e[s].push({imageSrc:o,imageSrcObserver:n,messageUid:s}):e[s]&&e[s].length&&(e[s][0].imageSrcObserver(e[s][0].imageSrc),e[s].shift())}}(),Utils.checkConnection=function(){var e=-1,t=(new Date).getTime(),i=0,s=!1;return setInterval(function(){i=(new Date).getTime(),s=i>t+5e3+1e3,t=i,s&&App.Api.hideError(!0)},5e3),function(t,i){clearTimeout(e),"error"!==i?(App.InternetConnectionError=!1,App.Api.hideError(!0)):"SystemPing"===t?(App.InternetConnectionError=!0,App.Api.showError(Utils.i18n("WARNING/NO_INTERNET_CONNECTION"),!1,!0,!0),e=setTimeout(function(){App.Ajax.send({Action:"SystemPing"})},6e4)):App.Ajax.send({Action:"SystemPing"})}}(),Utils.loadScript=function(e,t,i,s){var o=document.createElement("script");!Utils.isUnd(s)&&t&&(window[s]=t),Utils.isUnd(i)&&(i={}),_.each(i,function(e,t){o.setAttribute(t,e)}),o.type="text/javascript",o.src=e,document.body.appendChild(o)},Utils.registerMailto=function(e){!window.navigator||!Utils.isFunc(window.navigator.registerProtocolHandler)||e&&1===App.Storage.getData("MailtoAsked")||(window.navigator.registerProtocolHandler("mailto",Utils.Common.getAppPath()+"#"+Enums.Screens.Compose+"/to/%s",""!==AppData.App.SiteName?AppData.App.SiteName:"WebMail"),App.Storage.setData("MailtoAsked",1))},Utils.CustomTooltip={_$Region:null,_$ArrowTop:null,_$Text:null,_$ArrowBottom:null,_iArrowBorderLeft:0,_iArrowMarginLeft:0,_iLeftShift:0,_bInitialized:!1,_bShown:!1,iHideTimer:0,iTimer:0,init:function(){this._bInitialized||(this._$Region=$('<span class="custom_tooltip"></span>').appendTo("body").hide(),this._$ArrowTop=$('<span class="custom_tooltip_arrow top"></span>').appendTo(this._$Region),this._$Text=$('<span class="custom_tooltip_text"></span>').appendTo(this._$Region),this._$ArrowBottom=$('<span class="custom_tooltip_arrow bottom"></span>').appendTo(this._$Region),this._iArrowMarginLeft=Utils.pInt(this._$ArrowTop.css("margin-left")),this._iArrowBorderLeft=Utils.pInt(this._$ArrowTop.css("border-left-width")),this._iLeftShift=Utils.pInt(this._$Region.css("margin-left"))+this._iArrowMarginLeft+this._iArrowBorderLeft,this._bInitialized=!0),this._$ArrowTop.show(),this._$ArrowBottom.hide(),this._$ArrowTop.css({"margin-left":this._iArrowMarginLeft+"px"}),this._$ArrowBottom.css({"margin-left":this._iArrowMarginLeft+"px"})},show:function(e,t){this.init();var i=t.offset(),s=t.width(),o=70>s?s/2:s/4,n=Utils.pInt(t.css("padding-left")),r=$("body");this._$Text.html(e),this._bShown=!0,this._$Region.stop().fadeIn(260,_.bind(function(){this._bShown||this._$Region.hide()},this)).css({top:i.top+t.outerHeight()+1,left:i.left+n+o-this._iLeftShift,right:"auto"}),r.outerHeight()<this._$Region.outerHeight()+this._$Region.offset().top&&(this._$ArrowTop.hide(),this._$ArrowBottom.show(),this._$Region.css({top:i.top-this._$Region.outerHeight()})),setTimeout(function(){r.width()<this._$Region.outerWidth(!0)+this._$Region.offset().left&&(this._$Region.css({left:"auto",right:0}),this._$ArrowTop.css({"margin-left":o+i.left-this._$Region.offset().left-this._iArrowBorderLeft+"px"}),this._$ArrowBottom.css({"margin-left":o+i.left-this._$Region.offset().left-this._iArrowBorderLeft+Utils.pInt(this._$Region.css("margin-right"))+"px"}))}.bind(this),1)},hide:function(){this._bInitialized&&(this._bShown=!1,this._$Region.hide())}},Utils.htmlStartsWithBlockquote=function(e){var t=e.split("<blockquote"),i=t.length>0?t[0]:"",s=Utils.trim(i.replace(/<[^>]*>/g,""));return""===s},Utils.escapeQuotes=function(e){return e.replace(/'/g,"\\'").replace(/"/g,'\\"')},Utils.checkCookies=function(){$.cookie("checkCookie","1",{path:"/"});var e="1"===$.cookie("checkCookie");return e||App.Screens.showError(Utils.i18n("WARNING/COOKIES_DISABLED"),!1,!0),e},Utils.calmEvent=function(e){e&&(e.stop&&e.stop(),e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.cancelBubble=!0,e.returnValue=!1)},Utils.Common={},Utils.Common.getRequestParam=function(e){var t=[],i=[],s=null;return void 0===this.aGetParams&&(t=""!==location.search?location.search.substr(1).split("&"):[],t.length>0&&_.each(t,function(e){var t=e.split("=");i[t[0]]=t.length>1?t[1]:""}),this.aGetParams=i),void 0!==this.aGetParams[e]&&(s=this.aGetParams[e]),s},Utils.Common.getAppPath=function(){var e=window.location.origin||window.location.protocol+"//"+window.location.host;return e+window.location.pathname},Utils.Common.clearAndReloadLocation=function(e,t){if(e||""===window.location.search&&""===window.location.hash)window.location.reload();else{var i=Utils.Common.getAppPath();t||""===window.location.search||(i+=window.location.search),"replaceState"in history?(history.replaceState("",document.title,i),window.location.reload(!0)):window.location.href=i}},Utils.File={},Utils.File.getViewLinkByHash=function(e,t,i,s){var o="?/Raw/View/"+e+"/"+t,n=i===!0?"/1":"/0",r="string"==typeof s&&""!==s?"/"+s:"";return o+n+r},"object"!=typeof Utils&&(window.Utils={}),Utils.Message={},Utils.Message.showInlinePictures=function(e,t,i,s){var o=function(e){return _.find(t,function(t){return t.CID===e})},n=function(e){return _.find(t,function(t){return t.ContentLocation===e})};"string"!=typeof s&&(s=""),i.length>0&&($("[data-x-src-cid]",e).each(function(){var e=$(this).attr("data-x-src-cid"),t=o(e);t&&t.ViewLink.length>0&&$(this).attr("src",s+t.ViewLink)}),$("[data-x-style-cid]",e).each(function(){var e="",t=$(this).attr("data-x-style-cid-name"),i=$(this).attr("data-x-style-cid"),s=o(i);s&&s.ViewLink.length>0&&""!==t&&(e=$.trim($(this).attr("style")),e=""===e?"":";"===e.substr(-1)?e+" ":e+"; ",$(this).attr("style",e+t+": url('"+s.ViewLink+"')"))})),$("[data-x-src-location]",e).each(function(){var e=$(this).attr("data-x-src-location"),t=n(e);t||(t=o(e)),t&&t.ViewLink.length>0&&$(this).attr("src",s+t.ViewLink)})},Utils.Message.showExternalPictures=function(e){$("[data-x-src]",e).each(function(){$(this).attr("src",$(this).attr("data-x-src")).removeAttr("data-x-src")}),$("[data-x-style-url]",e).each(function(){var e=$.trim($(this).attr("style"));e=""===e?"":";"===e.substr(-1)?e+" ":e+"; ",$(this).attr("style",e+$(this).attr("data-x-style-url")).removeAttr("data-x-style-url")})},Utils.Message.joinReplyPrefixesInSubject=function(e,t,i){var s=[t.toUpperCase()],o=[i.toUpperCase()],n=_.union(s,o).join("|"),r="",a=e.split(":"),l=[],h="";return _.each(a,function(e){if(0===h.length){var r=$.trim(e.toUpperCase()),a=-1!==_.indexOf(s,r),c=-1!==_.indexOf(o,r),p=1,u=l.length>0?l[l.length-1]:null;if(!a&&!c){var d=new window.RegExp("^\\s?("+n+")\\s?[\\[\\(]([\\d]+)[\\]\\)]$","gi").exec(r);d&&3===d.length&&(a=-1!==_.indexOf(s,d[1].toUpperCase()),c=-1!==_.indexOf(o,d[1].toUpperCase()),p=Utils.pInt(d[2]))}a?u&&u.prefix===t?u.count+=p:l.push({prefix:t,count:p}):c?u&&u.prefix===i?u.count+=p:l.push({prefix:i,count:p}):h=e}else h+=":"+e}),_.each(l,function(e){r+=1===e.count?e.prefix+": ":e.prefix+"["+e.count+"]: "}),r+=$.trim(h)},Utils.Address={},Utils.Address.isCorrectEmail=function(e){return!!e.match(/^[A-Z0-9\"!#\$%\^\{\}`~&'\+\-=_\.]+@[A-Z0-9\.\-]+$/i)},Utils.Address.getFullEmail=function(e,t){var i="";return i=t.length>0?e.length>0?Utils.Address.isCorrectEmail(e)||-1!==e.indexOf(",")?'"'+e+'" <'+t+">":e+" <"+t+">":t:e},Utils.Address.getEmailParts=function(e,t){for(var i=e.indexOf('"'),s=e.indexOf('"',i+1),o=e.indexOf("<",s),n=-1,r=-1,a="",l="";-1!==o;)n=o,o=e.indexOf("<",o+1);return o=n,r=e.indexOf(">",o+1),-1===o?l=$.trim(e):(i=t?-1:i,a=$.trim(-1===i?e.substring(0,o):e.substring(i+1,s)),l=$.trim(e.substring(o+1,r))),{name:a,email:l,fullEmail:Utils.Address.getFullEmail(a,l)}},Utils.Address.getArrayRecipients=function(e,t){for(var i=[",",";"," "],s="",o=e,n=0,r=0,a="",l=null,h=[];o.length>0;){for(n=Utils.Address._getFirstSeparatorPosition(o,i),r=n;-1!==_.indexOf(i,o[r+1]);)r++;-1===n?(a=s+o,l=Utils.Address.getEmailParts(a),(t||Utils.Address.isCorrectEmail(l.email))&&h.push(l),o=""):(a=s+o.substring(0,n),l=Utils.Address.getEmailParts(a),Utils.Address.isCorrectEmail(l.email)?(h.push(l),s=""):s+=o.substring(0,r+1),o=o.substring(r+1))}return h},Utils.Address._getFirstSeparatorPosition=function(e,t){var i=-1;return _.each(t,function(t){var s=e.indexOf(t);-1!==s&&(-1===i||i>s)&&(i=s)}),i},Utils.Address.getIncorrectEmailsFromAddressString=function(e){for(var t=e.replace(/"[^"]*"/g,"").replace(/;/g,",").split(","),i=[],s=0,o=t.length,n="",r=null;o>s;s++)n=$.trim(t[s]),n.length>0&&(r=Utils.Address.getEmailParts($.trim(t[s])),Utils.Address.isCorrectEmail(r.email)||i.push(r.email));return i},ko.bindingHandlers.command={init:function(e,t,i,s){var o=$(e),n=t();if(!n||!n.enabled||!n.canExecute)throw new Error("You are not using command function");o.addClass("command"),ko.bindingHandlers[o.is("form")?"submit":"click"].init.apply(s,arguments)},update:function(e,t){var i=!0,s=$(e),o=t();i=o.enabled(),s.toggleClass("command-not-enabled",!i),i&&(i=o.canExecute(),s.toggleClass("unavailable",!i)),s.toggleClass("command-disabled disable disabled",!i),s.toggleClass("enable",i)}},ko.bindingHandlers.simpleTemplate={init:function(e){var t=$(e);t.length>0&&"replaced"!==t.data("replaced")&&(t.html(t.html().replace(/&lt;script(.*?)&gt;/i,"<script$1>").replace(/&lt;\/script(.*?)&gt;/i,"</script>")),t.data("replaced","replaced"))}},ko.bindingHandlers.findFocused={init:function(e){var t=$(e),i=null;i=t.find(".catch-focus"),i&&1===i.length&&i[0]&&i.on("blur",function(){t.removeClass("focused")}).on("focus",function(){t.addClass("focused")})}},ko.bindingHandlers.findFilled={init:function(e){var t=$(e),i=null,s=null;i=t.find(".catch-filled"),i&&1===i.length&&i[0]&&(s=function(){t.toggleClass("filled",""!==i.val())},s(),_.delay(s,200),i.on("change",s))}},ko.bindingHandlers.alert={init:function(e,t){window.alert(ko.utils.unwrapObservable(t()))},update:function(e,t){window.alert(ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.onEnter={init:function(e,t,i,s){ko.bindingHandlers.event.init(e,function(){return{keyup:function(i,s){s&&13===window.parseInt(s.keyCode,10)&&($(e).trigger("change"),t().call(this,i))}}},i,s)}},ko.bindingHandlers.onCtrlEnter={init:bMobileApp?null:function(e,t,i,s){ko.bindingHandlers.event.init(e,function(){return{keydown:function(i,s){return s&&13===window.parseInt(s.keyCode,10)&&s.ctrlKey?($(e).trigger("change"),t().call(this,i),!1):!0}}},i,s)}},ko.bindingHandlers.onEsc={init:bMobileApp?null:function(e,t,i,s){ko.bindingHandlers.event.init(e,function(){return{keyup:function(i,s){s&&27===window.parseInt(s.keyCode,10)&&($(e).trigger("change"),t().call(this,i))}}},i,s)}},ko.bindingHandlers.onFocusSelect={init:function(e,t,i,s){ko.bindingHandlers.event.init(e,function(){return{focus:function(){e.select()}}},i,s)}},ko.bindingHandlers.onEnterChange={init:function(e,t,i,s){ko.bindingHandlers.event.init(e,function(){return{keyup:function(t,i){i&&13===window.parseInt(i.keyCode,10)&&$(e).trigger("change")}}},i,s)}},ko.bindingHandlers.fadeIn={update:function(e,t){ko.utils.unwrapObservable(t())&&$(e).hide().fadeIn("fast")}},ko.bindingHandlers.fadeOut={update:function(e,t){ko.utils.unwrapObservable(t())&&$(e).fadeOut()}},ko.bindingHandlers.csstext={init:function(e,t){e&&e.styleSheet&&!Utils.isUnd(e.styleSheet.cssText)?e.styleSheet.cssText=ko.utils.unwrapObservable(t()):$(e).text(ko.utils.unwrapObservable(t()))},update:function(e,t){e&&e.styleSheet&&!Utils.isUnd(e.styleSheet.cssText)?e.styleSheet.cssText=ko.utils.unwrapObservable(t()):$(e).text(ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.i18n={init:function(e,t){var i=$(e).data("i18n"),s=i?Utils.i18n(i):i;if(""!==s)switch(t()){case"value":$(e).val(s);break;case"text":$(e).text(s);break;case"html":$(e).html(s);break;case"title":$(e).attr("title",s);break;case"placeholder":$(e).attr({placeholder:s})}}},ko.bindingHandlers.link={init:function(e,t){$(e).attr("href",ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.title={init:function(e,t){$(e).attr("title",ko.utils.unwrapObservable(t()))},update:function(e,t){$(e).attr("title",ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.initDom={init:function(e,t){if(t())if(_.isArray(t()))for(var i=t(),s=i.length-1;s>=0;s--)i[s]($(e));else t()($(e))}},ko.bindingHandlers.customScrollbar={init:bMobileApp?null:function(e,t){if(!bMobileDevice){var i=$(e),s=_.defaults(t(),{oScroll:null,scrollToTopTrigger:null,scrollToBottomTrigger:null,scrollTo:null}),o=null;s=s,i.addClass("scroll-wrap").customscroll(s),o=i.data("customscroll"),s.oScroll&&Utils.isFunc(s.oScroll.subscribe)?s.oScroll(o):s.oScroll=o,Utils.isUnd(s.reset)||(e._customscroll_reset=_.throttle(function(){o.reset()},100)),s.scrollToTopTrigger&&Utils.isFunc(s.scrollToTopTrigger.subscribe)&&s.scrollToTopTrigger.subscribe(function(){o&&o.scrollToTop()}),s.scrollToBottomTrigger&&Utils.isFunc(s.scrollToBottomTrigger.subscribe)&&s.scrollToBottomTrigger.subscribe(function(){o&&o.scrollToBottom()}),s.scrollTo&&Utils.isFunc(s.scrollTo.subscribe)&&s.scrollTo.subscribe(function(){o&&o.scrollTo(s.scrollTo())})}},update:bMobileApp?null:function(e,t){bMobileDevice||(e._customscroll_reset&&e._customscroll_reset(),Utils.isUnd(t().top)||$(e).data("customscroll").vertical.set(t().top))}},ko.bindingHandlers.customOptions={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,i,s,o){for(var n=0,r=0,a=ko.utils.arrayMap(ko.utils.arrayFilter(e.childNodes,function(e){return e.tagName&&"OPTION"===e.tagName&&e.selected}),function(e){return ko.selectExtensions.readValue(e)||e.innerText||e.textContent}),l=e.scrollTop,h=ko.utils.unwrapObservable(t());e.length>0;)ko.cleanNode(e.options[0]),e.remove(0);if(h){"number"!=typeof h.length&&(h=[h]);var c=i().optionsBind;for(n=0,r=h.length;r>n;n++){var p=document.createElement("OPTION"),u=ko.utils.unwrapObservable(h[n]);ko.selectExtensions.writeValue(p,u),p.appendChild(document.createTextNode(u)),e.appendChild(p),c&&(p.setAttribute("data-bind",c),ko.applyBindings(o.createChildContext(u),p))}var d=e.getElementsByTagName("OPTION"),m=0,g=navigator.userAgent.indexOf("MSIE 6")>=0;for(n=0,r=d.length;r>n;n++)ko.utils.arrayIndexOf(a,ko.selectExtensions.readValue(d[n]))>=0&&(g?d[n].setAttribute("selected",!0):d[n].selected=!0,m++);e.scrollTop=l,m<a.length&&ko.utils.triggerEvent(e,"change")}}},ko.bindingHandlers.splitter={init:bMobileApp?null:function(e,t){setTimeout(function(){$(e).splitter(t())},1)}},ko.bindingHandlers.dropdown={update:function(e,t,i,s){var o,n,r,a=$(e),l=_.defaults(t(),{disabled:"disabled",expand:"expand",control:!0,container:".dropdown_content",scrollToTopContainer:".scroll-inner",passClick:!0,trueValue:!0}),h="function"==typeof l.control?l.control():l.control,c=a.find(".control"),p=a.find(".dropdown"),u=a.find(".dropdown_helper"),d=a.find(".dropdown_arrow"),m=a.find(".dropdown_arrow.bottom"),g=$(document),f=!1,b=function(){Utils.isUnd(l.callback)||l.callback.call(s,a.hasClass(l.expand)?l.trueValue:!1,a)},A=function(e){e.stopPropagation()},C=function(){l.scrollToTopContainer&&a.find(l.scrollToTopContainer).scrollTop(0)},y=function(e){Utils.isUnd(e)&&(e=!a.hasClass(l.expand)),!e&&a.hasClass(l.expand)&&C(),a.toggleClass(l.expand,e),m.length>0&&a.hasClass(l.expand)&&p.css({top:a.position().top-u.height()+"px",left:a.position().left+"px",width:"auto"})},M=function(e){o=u.offset(),Utils.isUnd(o)||(n=o.left+10,r=$(window).width()-(n+u.outerWidth(!0)),r>0&&(r=0),u.css("left",e||r+"px"),d.css("left",e||Math.abs(r?r+parseInt(d.css("margin-left")):0)+"px"))},S=function(e){var t=$(e.originalEvent.originalTarget).parents(".dropdown"),i=t.length>0;i||a.hasClass(l.disabled)||f||(y(),_.defer(function(){b()}),a.hasClass(l.expand)&&(l.close&&l.close.subscribe&&l.close(!0),_.defer(function(){g.on("click.dropdown",function(e){!l.passClick&&e.button===Enums.MouseKey.Right||f||(g.unbind("click.dropdown"),l.close&&l.close.subscribe&&l.close(!1),y(!1),b(),M(0)),f=!1})}),M()))};a.off(),c.off(),l.passClick||(a.find(l.container).on("click",A),a.on("click",A),c.on("click",A)),y(!1),l.close&&l.close.subscribe&&l.close.subscribe(function(e){e||(g.unbind("click.dropdown"),y(!1)),b()}),a.on("mousedown",function(e){f=$(e.target).hasClass("customscroll-scrollbar")||$(e.target.parentElement).hasClass("customscroll-scrollbar")}),a.on("click",function(e){h||S(e)}),c.on("click",function(e){h&&S(e)})}},ko.bindingHandlers.customSelect={init:function(e,t,i,s){var o=$(e),n=_.defaults(t(),{disabled:"disabled",selected:"selected",expand:"expand",control:!0,input:!1,expandState:function(){}}),r=[],a=n.control?o.find(".control"):o,l=o.find(".dropdown_content"),h=o.find(".link"),c=function(e){_.each(r,function(e){e.removeClass(n.selected)});var t=_.find(n.options,function(t){return t[n.optionsValue]===e});return Utils.isUnd(t)?t=n.options[0]:(r[_.indexOf(n.options,t)].addClass(n.selected),h.text($.trim(t[n.optionsText]))),t[n.optionsValue]},p=function(e){l.empty(),r=[],_.each(e?e:n.options,function(e){var t=$('<span class="item"></span>').text(e[n.optionsText]).data("value",e[n.optionsValue]),i=e.isDisabled;i?t.data("isDisabled",i).addClass("disabled"):t.data("isDisabled",i).removeClass("disabled"),r.push(t),l.append(t)},this)};p(),l.on("click",".item",function(){var e=$(this);e.data("isDisabled")||n.value(e.data("value"))}),!n.input&&n.value&&n.value.subscribe&&(n.value.subscribe(function(){var e=c(n.value());n.value()!==e&&n.value(e)},s),n.value.valueHasMutated()),n.input&&n.value&&n.value.subscribe&&(n.value.subscribe(function(){c(n.value())},s),n.value.valueHasMutated()),n.input&&n.value&&n.value.subscribe&&(n.value.subscribe(function(){c(n.value())},s),n.value.valueHasMutated()),n.alarmOptions&&n.alarmOptions.subscribe(function(){p()},s),n.timeOptions&&n.timeOptions.subscribe(function(e){p(e)},s),o.removeClass(n.expand),a.click(function(){if(!o.hasClass(n.disabled)&&(o.toggleClass(n.expand),n.expandState(o.hasClass(n.expand)),o.hasClass(n.expand))){var e=o.find(".dropdown_content"),t=e.find(".selected");t.position()&&(e.scrollTop(0),e.scrollTop(t.position().top-100)),_.defer(function(){$(document).one("click",function(){o.removeClass(n.expand),n.expandState(!1)})})}})}},ko.bindingHandlers.moveToFolderFilter={init:function(e,t){var i=$(e),s=t(),o=$(e).find(s.container),n=_.isArray(s.options)?s.options:s.options(),r=s.value?s.value():"",a=_.find(n,function(e){return e[s.optionsValue]===r});a||(r="",s.value("")),i.removeClass("expand"),o.empty(),_.each(n,function(e){var t=$('<span class="item"></span>').text(e[s.optionsText]).data("value",e[s.optionsValue]);r===e[s.optionsValue]&&t.addClass("selected"),e.jq=t,o.append(t)}),o.on("click",".item",function(){var e=$(this).data("value");s.value(e)}),i.click(function(){i.toggleClass("expand"),i.hasClass("expand")&&_.defer(function(){$(document).one("click",function(){i.removeClass("expand")})})})},update:function(e,t){var i=$(e),s=t(),o=_.isArray(s.options)?s.options:s.options(),n=s.value?s.value():"",r=_.find(o,function(e){return e[s.optionsValue]===n}),a=i.find(".link");_.each(o,function(e){e.jq&&e.jq.toggleClass("selected",n===e[s.optionsValue])}),r&&a.text($.trim(r[s.optionsText]))}},ko.bindingHandlers.contactCardInMessage={update:bMobileApp||bMobileDevice?null:function(e,t){var i=$(e),s=t(),o=s.address,n=$("div.item_viewer[data-email='"+o+"']"),r=!1,a=0,l=function(){n&&i&&(r=!0,clearTimeout(a),setTimeout(function(){var e,t,s,o=i.offset();r&&o.left+o.top!==0&&(e=o.left+10,t=o.top+i.height()+6,s=$(window).width()-(e+396),s>0&&(s=0),n.addClass("expand").offset({top:t,left:e+s}))},180))},h=function(){r&&n&&i&&(r=!1,a=setTimeout(function(){r||n.removeClass("expand")},200))};n.length>0?(i.off().on("mouseover",function(){n.off().on("mouseenter",l).on("mouseleave",h).find(".link, .button").off(".links").on("click.links",function(){r=!1,n.removeClass("expand")}),setTimeout(function(){n.find(".link, .button").off("click.links").on("click.links",function(){r=!1,n.removeClass("expand")})}.bind(this),100),l()}).on("mouseout",h),r=!1,n.removeClass("expand")):i.off()}},ko.bindingHandlers.contactcard={init:bMobileApp||bMobileDevice?null:function(e,t){var i=$(e),s=!1,o=_.defaults(t(),{disabled:"disabled",expand:"expand",control:!0}),n=o.control?i.find(".control"):i;void 0!==o.trigger&&void 0!==o.trigger.subscribe&&(i.removeClass(o.expand),n.bind({mouseover:function(){!i.hasClass(o.disabled)&&o.trigger()&&(s=!0,_.delay(function(){s&&(void 0!==o.controlWidth&&void 0!==o.controlWidth.subscribe&&o.controlWidth(n.width()),i.addClass(o.expand))},200))},mouseout:function(){o.trigger()&&(s=!1,_.delay(function(){s||i.removeClass(o.expand)},200))}}))}},ko.bindingHandlers.checkmail={update:function(e,t){var i=e.oOptions||null,s=e.jqElement||null,o=e.oIconIE||null,n=t(),r=n.state;void 0!==n.state&&(s||(e.jqElement=s=$(e)),i||(e.oOptions=i=_.defaults(n,{activeClass:"process",duration:800})),Utils.deferredUpdate(s,r,i.duration,function(t,n){if(App.browser.ie9AndBelow)if(o||(e.oIconIE=o=s.find(".icon")),!o.__intervalIE&&n){var r=0,a="";o.__intervalIE=setInterval(function(){a="0px -"+20*r+"px",r=7>r?r+1:0,o.css({"background-position":a})},1e3/12)}else o.css({"background-position":"0px 0px"}),clearInterval(o.__intervalIE),o.__intervalIE=null;else t.toggleClass(i.activeClass,n)}))}},ko.bindingHandlers.heightAdjust={update:function(e,t){var i=e.jqElement||null,s=0,o=t().location,n=t().delay||400;i||(e.jqElement=i=$(e)),_.delay(function(){_.each(t().elements,function(e){var t=e();t&&(s+=t.is(":visible")?t.outerHeight():0)}),"top"===o||void 0===o?i.css({"padding-top":s,"margin-top":-s}):"bottom"===o&&i.css({"padding-bottom":s,"margin-bottom":-s})},n)}},ko.bindingHandlers.minHeightAdjust={update:function(e,t){var i=$(e),s=t(),o=s.adjustElement||$("body"),n=s.minHeight||0;s.removeTrigger&&o.css("min-height","inherit"),s.trigger&&_.delay(function(){o.css({"min-height":i.outerHeight(!0)+n})},100)}},ko.bindingHandlers.watchWidth={init:function(e,t){var i=!1;i||t().subscribe(function(){t()($(e).outerWidth()),i=!0},this)}},ko.bindingHandlers.columnCalc={init:function(e,t){var i=$(e),s=t().prop,o=null,n=0;o=i.find(t().itemSelector),void 0!==o[0]&&(n=o.outerWidth(!0),n=1>=n?1:n,s&&$(window).bind("resize",function(){var e=i.width();s(e>0?Math.floor(e/n):1)}))}},ko.bindingHandlers.listWithMoreButton={init:function(e){var t=$(e),i=!1;t.closest("div.panel.left_panel").resize(function(){var e=t.find("span.hotkey"),s=t.find("span.item"),o=t.find("span.more_hints").show(),n=t.width(),r=o.width(),a=!0;i?i=!1:(_.each(e,function(e,t){var o=$(e),l=o.width();a&&n>r+l?(i=!1,o.show(),$(s[t]).hide(),r+=l):(i=!0,a=!1,o.hide(),$(s[t]).show())}),a&&o.hide())})}},ko.bindingHandlers.quickReplyAnim={update:bMobileApp?null:function(e,t){var i=e.jqTextarea||null,s=e.jqStatus||null,o=e.jqButtons||null,n=e.jqElement||null,r=e.oPrevActions||null,a=t(),l=null;l=_.defaults(a,{saveAction:!1,sendAction:!1,activeAction:!1}),n||(e.jqElement=n=$(e),e.jqTextarea=i=n.find("textarea"),e.jqStatus=s=n.find(".status"),e.jqButtons=o=n.find(".buttons"),e.oPrevActions=r={saveAction:null,sendAction:null,activeAction:null}),App.browser.ie9AndBelow?(!i||n.defualtHeight||i.defualtHeight||(n.defualtHeight=n.outerHeight(),i.defualtHeight=i.outerHeight(),s.defualtHeight=o.outerHeight(),o.defualtHeight=o.outerHeight()),_.defer(function(){var e=r.activeAction!==l.activeAction,t=r.sendAction!==l.sendAction,a=r.saveAction!==l.saveAction;e&&(l.activeAction?(i.animate({height:i.defualtHeight+50},300),n.animate({"max-height":n.defualtHeight+o.defualtHeight+50},300)):(i.animate({height:i.defualtHeight},300),n.animate({"max-height":n.defualtHeight},300))),(t||a)&&(l.sendAction?(n.animate({"max-height":"30px"},300),s.animate({"max-height":"30px",opacity:1},300)):l.saveAction?n.animate({"max-height":0},300):(n.animate({"max-height":n.defualtHeight+o.defualtHeight+50},300),s.animate({"max-height":0,opacity:0},300)))})):(n.toggleClass("saving",l.saveAction),n.toggleClass("sending",l.sendAction),n.toggleClass("active",l.activeAction)),_.defer(function(){r=l})}},ko.extenders.reversible=function(e){var t=e();return e.commit=function(){t=e()},e.revert=function(){e(t)},e.commitedValue=function(){return t},e.changed=function(){return t!==e()},e},ko.extenders.autoResetToFalse=function(e,t){return e.iTimeout=0,e.subscribe(function(i){i&&(window.clearTimeout(e.iTimeout),e.iTimeout=window.setTimeout(function(){e.iTimeout=0,e(!1)},Utils.pInt(t)))}),e},Utils.createCommand=function(e,t,i){var s=t?function(){return s.canExecute&&s.canExecute()?t.apply(e,Array.prototype.slice.call(arguments)):!1}:function(){};return s.enabled=ko.observable(!0),i=Utils.isUnd(i)?!0:i,s.canExecute=ko.computed(Utils.isFunc(i)?function(){return s.enabled()&&i.call(e)}:function(){return s.enabled()&&!!i}),s},ko.bindingHandlers.autocomplete={init:function(e,t){function i(e){return e.split(/,\s*/)}function s(e){return i(e).pop()}var o=t(),n=$(e);o&&n&&n[0]&&n.autocomplete({minLength:0,autoFocus:!0,source:function(e,t){o(s(e.term),t)},search:function(){return s(this.value).length>0},focus:function(){return!1},select:function(e,t){var s=i(this.value),o=null;return s.pop(),s.push(t.item.value),s.push(""),this.value=s.join(", ").slice(0,-2),n.trigger("change"),o=function(e){var t=e.value.length;e.blur(),e.focus(),e.setSelectionRange&&e.setSelectionRange(t,t)},o(n[0]),!1}}).on("click",function(){""===n.val()&&($(n.autocomplete("widget")).is(":visible")?n.autocomplete("close"):(n.autocomplete("option","minLength",0),n.autocomplete("search"),n.autocomplete("option","minLength",1)))})}},ko.bindingHandlers.autocompleteSimple={init:function(e,t){var i=$(e),s=t(),o=s.callback,n=s.dataAccessor?s.dataAccessor:Utils.emptyFunction(),r=s.deleteAccessor?s.deleteAccessor:Utils.emptyFunction(),a=Utils.emptyFunction(),l=function(){r(c),$.ui.autocomplete.prototype.__response.call(i.data("autocomplete"),_.filter(h,function(e){return e.value!==c.value}))},h=null,c=null;o&&i&&i[0]&&i.autocomplete({minLength:1,autoFocus:!0,position:{collision:"flip"},source:function(e,t){a=t,o(e.term,function(e){h=e,a(e)})},focus:function(e,t){c=t.item},open:function(){$(i.autocomplete("widget")).find("span.del").on("click",function(e){Utils.calmEvent(e),l()})},select:function(e,t){return _.delay(function(){i.trigger("change")},5),n(t.item),!0}}).on("click",function(){""===i.val()&&($(i.autocomplete("widget")).is(":visible")?i.autocomplete("close"):(i.autocomplete("option","minLength",0),i.autocomplete("search"),i.autocomplete("option","minLength",1)))}).on("keydown",function(e){h&&c&&!c.global&&e.keyCode===Enums.Key.Del&&e.shiftKey&&(Utils.calmEvent(e),l())})}},ko.bindingHandlers.draggablePlace={init:bMobileApp?null:function(e,t,i,s){if(null===t())return null;var o=i?i():null;$(e).draggable({distance:20,handle:".dragHandle",cursorAt:{top:0,left:0},helper:function(e){return t().apply(s,e&&e.target?[ko.dataFor(e.target),e.ctrlKey]:null)},start:o&&o.draggableDragStartCallback?o.draggableDragStartCallback:Utils.emptyFunction,stop:o&&o.draggableDragStopCallback?o.draggableDragStopCallback:Utils.emptyFunction}).on("mousedown",function(){Utils.removeActiveFocus()})}},ko.bindingHandlers.droppable={init:bMobileApp?null:function(e,t){var i=t(),s=i.valueFunc,o=i.switchObserv;!1!==s&&$(e).droppable({hoverClass:"droppableHover",drop:function(e,t){s(e,t)}}),o&&s!==!1&&(o.subscribe(function(t){$(e).data().droppable&&$(e).droppable(t?"disable":"enable")},this),o.valueHasMutated())}},ko.bindingHandlers.draggable={init:bMobileApp?null:function(e,t){$(e).attr("draggable",ko.utils.unwrapObservable(t()))}},ko.bindingHandlers.autosize={init:function(e,t){var i=$(e),s=t(),o=i.height(),n=i.outerHeight(),r=i.innerHeight(),a=n-r,l=r-o,h=s.minHeight?s.minHeight:0,c=s.maxHeight?s.maxHeight:0,p=s.scrollableHeight?s.scrollableHeight:1e3,u=s.autosizeTrigger?s.autosizeTrigger:null,d=function(e){var t=0;App.browser.firefox&&(t=2*parseInt(i.css("padding-top"),10)),c?setTimeout(function(){i.prop("scrollHeight")<c?(i.height(h-l-a),i.height(i.prop("scrollHeight")+t-l)):i.height(c-l-a)},100):(e||i.prop("scrollHeight")<p)&&setTimeout(function(){i.height(h-l-a),i.height(i.prop("scrollHeight")+t-l)},100)};i.on("keydown",function(){d()}),i.on("paste",function(){d()}),u&&u.subscribe(function(e){d(e)},this),d()}},ko.bindingHandlers.customBind={init:function(e,t,i,s){var o=t(),n=o.onKeydown?o.onKeydown:null,r=o.onKeyup?o.onKeyup:null,a=o.onPaste?o.onPaste:null,l=o.onInput?o.onInput:null,h=o.valueObserver?o.valueObserver:null;ko.bindingHandlers.event.init(e,function(){return{keydown:function(t,i){return n&&n.call(this,e,i,h),!0},keyup:function(t,i){return r&&r.call(this,e,i,h),!0},paste:function(t,i){return a&&a.call(this,e,i,h),!0},input:function(t,i){return l&&l.call(this,e,i,h),!0}}},i,s)}},ko.bindingHandlers.fade={init:function(e,t){var i=$(e),s=$('<span class="faded"></span>'),o=_.defaults(t(),{color:null,css:"fadeout"}),n=o.color,r=o.css,a=function(e){if(""!==e){var t=l(e),i="rgba("+t.r+","+t.g+","+t.b;h(e,i)}},l=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e=e.replace(t,function(e,t,i,s){return t+t+i+i+s+s}),i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},h=function(e,t){Utils.isRTL()?s.css("filter","progid:DXImageTransform.Microsoft.gradient(startColorstr='"+e+"', endColorstr='"+e+"',GradientType=1 )").css("background-image","-webkit-gradient(linear, left top, right top, color-stop(0%,"+t+",1)), color-stop(100%,"+t+",0)))").css("background-image","-moz-linear-gradient(left, "+t+",1)0%, "+t+",0)100%)").css("background-image","-webkit-linear-gradient(left, "+t+"1)0%,"+t+",0)100%)").css("background-image","-o-linear-gradient(left, "+t+",1)0%,"+t+",0)100%)").css("background-image","-ms-linear-gradient(left, "+t+",1)0%,"+t+",0)100%)").css("background-image","linear-gradient(left, "+t+",1)0%,"+t+",0)100%)"):s.css("filter","progid:DXImageTransform.Microsoft.gradient(startColorstr='"+e+"', endColorstr='"+e+"',GradientType=1 )").css("background-image","-webkit-gradient(linear, left top, right top, color-stop(0%,"+t+",0)), color-stop(100%,"+t+",1)))").css("background-image","-moz-linear-gradient(left, "+t+",0)0%, "+t+",1)100%)").css("background-image","-webkit-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","-o-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","-ms-linear-gradient(left, "+t+",0)0%,"+t+",1)100%)").css("background-image","linear-gradient(left, "+t+",0)0%,"+t+",1)100%)")};i.parent().addClass(r),i.after(s),void 0!==o.color.subscribe&&(a(n()),n.subscribe(function(e){a(e)},this))}},ko.bindingHandlers.highlighter={init:function(e,t,i,s){function o(e){if(A){var t=0,i=a.text(),s=i.split(d),o=[],l='<span class="search_highlight">$&</span>';$.each(s,function(e,t){_.any(u,function(e){return e===t})?$.each(t,function(e,t){o.push($(t.replace(/(.)/,l)))}):$.each(t,function(e,t){o.push(" "===t?document.createTextNode(" "):document.createTextNode(t))})}),e?a.empty().append(o):(t=n(),a.empty().append(o),r(t))}}function n(){var t,i,s,o,n=0;return"undefined"!=typeof window.getSelection?(t=window.getSelection().getRangeAt(0),i=t.cloneRange(),i.selectNodeContents(e),i.setEnd(t.endContainer,t.endOffset),n=i.toString().length):"undefined"!=typeof document.selection&&"Control"!==document.selection.type&&(s=document.selection.createRange(),o=document.body.createTextRange(),o.moveToElementText(e),o.setEndPoint("EndToEnd",s),n=o.text.length),n}function r(t){var i,s,o;if(!e)return!1;if(document.createRange)i=document.createRange(),i.selectNodeContents(e),i.setStart(e,t),i.setEnd(e,t),s=window.getSelection(),s.removeAllRanges(),s.addRange(i);else{if(e.createTextRange)return o=e.createTextRange(),o.collapse(!0),o.moveEnd(t),o.moveStart(t),o.select(),!0;
if(e.setSelectionRange)return e.setSelectionRange(t,t),!0}return!1}var a=$(e),l=t(),h=l.valueObserver?l.valueObserver:null,c=l.highlighterValueObserver?l.highlighterValueObserver:null,p=l.highlightTrigger?l.highlightTrigger:null,u=["from:","to:","subject:","text:","email:","has:","date:","text:","body:"],d=function(){var e="";return $.each(u,function(t,i){e=t?e+"|\\b"+i:e+"\\b"+i}),new RegExp("("+e+")","g")}(),m=function(e){return e.replace(/\xC2\xA0/g," ").replace(/\xA0/g," ").replace(/[\s]+/g," ")},g=-1,f=window.navigator.language||window.navigator.userLanguage,b=["zh","zh-TW","zh-CN","zh-HK","zh-SG","zh-MO","ja","ja-JP","ko","ko-KR","vi","vi-VN","th","th-TH"],A=!_.include(b,f);ko.bindingHandlers.event.init(e,function(){return{keydown:function(e,t){return t.keyCode!==Enums.Key.Enter},keyup:function(e,t){var i=[Enums.Key.Left,Enums.Key.Right,Enums.Key.Home,Enums.Key.End],s=-1!==Utils.inArray(t.keyCode,i);return t.keyCode===Enums.Key.Shift||t.keyCode===Enums.Key.Ctrl||t.keyCode===Enums.Key.Dash||t.keyCode===Enums.Key.Apostrophe||t.keyCode===Enums.Key.Six&&t.shiftKey||s||(t.ctrlKey||g===Enums.Key.Ctrl)&&t.keyCode===Enums.Key.a||(h(m(a.text())),o(!1)),g=t.keyCode,!0},paste:function(){return setTimeout(function(){h(m(a.text())),o(!1)},0),!0}}},i,s),setTimeout(function(){o(!0)},0),p.notifySubscribers(),p.subscribe(function(e){setTimeout(function(){o(!!e)},0)},this),c.subscribe(function(){a.text(h())},this)}},ko.bindingHandlers.quoteText={init:function(e,t,i,s){var o=($(e),$('<span class="button_quote">'+Utils.i18n("HELPDESK/BUTTON_QUOTE")+"</span>")),n=t(),r=n.actionHandler,a=!1,l=null,h="";$("#pSevenContent").append(o),$(document.body).on("click",function(e){a=!!$(e.target).parents(".posts")[0],document.getSelection?(l=document.getSelection(),l&&(h=l.toString())):h=document.selection.createRange().text,a&&""!==h.replace(/[\n\r\s]/,"")?o.css({top:e.clientY+20,left:e.clientX+20}).show():o.hide()}),o.on("click",function(){r.call(s,h)})}},ko.bindingHandlers.adjustHeightToContent={init:function(e){var t=$(e),i=null,s=null,o=null;_.delay(_.bind(function(){i=$(_.max(t.find(".title .text"),function(e){return e.offsetWidth})),s=i.parent(),o=s.find(".icon"),t.css("min-width",parseInt(s.css("margin-left"))+parseInt(s.css("padding-left"))+parseInt(o.width())+parseInt(o.css("margin-left"))+parseInt(o.css("margin-right"))+parseInt(o.css("padding-left"))+parseInt(o.css("padding-right"))+parseInt(i.width())+parseInt(i.css("margin-left"))+parseInt(i.css("padding-left"))+10)},this),1)}},ko.bindingHandlers.customTooltip={init:bMobileDevice||bMobileApp?null:function(e,t){var i=Utils.i18n(t()),s=$(e),o=s.find("span.dropdown"),n=!1,r=function(){var e=$(this);e.hasClass("expand")||(clearTimeout(Utils.CustomTooltip.iHideTimer),n=!0,clearTimeout(Utils.CustomTooltip.iTimer),Utils.CustomTooltip.iTimer=setTimeout(function(){n&&(e.hasClass("expand")?(n=!1,clearTimeout(Utils.CustomTooltip.iTimer),Utils.CustomTooltip.hide()):Utils.CustomTooltip.show(i,e))},100))},a=function(){clearTimeout(Utils.CustomTooltip.iHideTimer),Utils.CustomTooltip.iHideTimer=setTimeout(function(){n=!1,clearTimeout(Utils.CustomTooltip.iTimer),Utils.CustomTooltip.hide()},10)},l=function(){},h=function(){s.unbind("mouseover",r),s.unbind("mouseout",a),s.unbind("click",a),o.unbind("mouseover",a),o.unbind("mouseout",l),""!==i&&(s.bind("mouseover",r),s.bind("mouseout",a),s.bind("click",a),o.bind("mouseover",a),o.bind("mouseout",l))},c=null;"function"==typeof i&&(i=i()),h(),"function"==typeof t().subscribe&&null===c&&(c=t().subscribe(function(e){i=e,h()}))}},ko.bindingHandlers.foreachprop={transformObject:function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&t.push({key:i,value:e[i]});return t},init:function(e,t,i,s,o){var n=ko.utils.unwrapObservable(t()),r=ko.bindingHandlers.foreachprop.transformObject(n);return ko.applyBindingsToNode(e,{foreach:r},o),{controlsDescendantBindings:!0}}},CRouting.prototype.init=function(e){this.defaultScreen=e,hasher.initialized.removeAll(),hasher.changed.removeAll(),hasher.initialized.add(this.parseRouting,this),hasher.changed.add(this.parseRouting,this),hasher.init(),hasher.initialized.removeAll()},CRouting.prototype.finalize=function(){hasher.dispose()},CRouting.prototype.setHashFromString=function(e){var t=location.hash===decodeURIComponent(e);return t||(location.hash=e),t},CRouting.prototype.replaceHashWithoutMessageUid=function(e){if("string"==typeof e&&""!==e){var t=location.hash.replace("/msg"+e,"");this.replaceHashFromString(t)}},CRouting.prototype.replaceHashFromString=function(e){location.hash!==e&&location.replace(e)},CRouting.prototype.setHash=function(e){return this.setHashFromString(this.buildHashFromArray(e))},CRouting.prototype.replaceHash=function(e){this.replaceHashFromString(this.buildHashFromArray(e))},CRouting.prototype.replaceHashDirectly=function(e){hasher.stop(),this.replaceHashFromString(this.buildHashFromArray(e)),hasher.init()},CRouting.prototype.setPreviousHash=function(){location.hash=this.previousHash()},CRouting.prototype.buildHashFromArray=function(e){var t=0,i=0,s="";if(_.isArray(e))for(i=e.length;i>t;t++)e[t]=encodeURIComponent(e[t]);else e=[encodeURIComponent(e.toString())];return s=e.join("/"),""!==s&&(s="#"+s),s},CRouting.prototype.getHashFromHref=function(){var e=location.href.indexOf("#"),t="";return-1!==e&&(t=location.href.substr(e+1)),t},CRouting.prototype.isSingleMode=function(){var e=this.getScreenFromHash(),t=e===Enums.Screens.SingleMessageView||e===Enums.Screens.SingleCompose||e===Enums.Screens.SingleHelpdesk;return this.currentScreen=e,t},CRouting.prototype.goDirectly=function(e,t){hasher.stop(),this.setHash(e),this.parseRouting(t),hasher.init()},CRouting.prototype.historyBackWithoutParsing=function(){hasher.stop(),location.hash=this.currentHash(),hasher.init()},CRouting.prototype.getScreenFromHash=function(){var e=this.getHashFromHref(),t=e.split("/");return decodeURIComponent(t.shift())||this.defaultScreen},CRouting.prototype.parseRouting=function(e){var t=App.Screens.getCurrentScreenModel(),i=_.bind(this.chooseScreen,this,e);t&&Utils.isFunc(t.beforeHide)?t.beforeHide(i):i()},CRouting.prototype.chooseScreen=function(e){var t=this.getHashFromHref(),i=t.split("/"),s=decodeURIComponent(i.shift())||this.defaultScreen,o=!!_.find(Enums.Screens,function(e){return e===s}),n=0,r=i.length;for(s===Enums.Screens.Mailbox&&this.lastMailboxHash(t),s===Enums.Screens.Helpdesk&&this.lastHelpdeskHash(t),s===Enums.Screens.Settings&&this.lastSettingsHash(t),this.previousHash(this.currentHash()),this.currentHash(t);r>n;n++)i[n]=decodeURIComponent(i[n]);switch($.isArray(e)&&(i=_.union(i,e)),this.currentScreen=s,s){case Enums.Screens.SingleMessageView:case Enums.Screens.SingleCompose:case Enums.Screens.SingleHelpdesk:AppData.SingleMode=!0,App.Screens.showCurrentScreen(s,i);break;default:o||(s=this.defaultScreen),AppData.SingleMode=!1,App.Screens.showNormalScreen(Enums.Screens.Header),App.Screens.showCurrentScreen(s,i);break;case Enums.Screens.Mailbox:AppData.SingleMode=!1,App.Screens.showNormalScreen(Enums.Screens.Header),App.Screens.showCurrentScreen(Enums.Screens.Mailbox,i)}},CLinkBuilder.prototype.mailbox=function(e,t,i,s,o){var n=[Enums.Screens.Mailbox];return t=Utils.isNormal(t)?Utils.pInt(t):1,i=Utils.isNormal(i)?Utils.pString(i):"",s=Utils.isNormal(s)?Utils.pString(s):"",o=Utils.isNormal(o)?Utils.pString(o):"",e&&""!==e&&n.push(e),o&&""!==o&&n.push("filter:"+o),t>1&&n.push("p"+t),i&&""!==i&&n.push("msg"+i),s&&""!==s&&n.push(s),n},CLinkBuilder.prototype.inbox=function(){return this.mailbox()},CLinkBuilder.prototype.parseMailbox=function(e){var t="INBOX",i=1,s="",o="",n="",r="",a=0;return Utils.isNonEmptyArray(e)&&(t=Utils.pString(e[a]),a++,e.length>a&&(r=Utils.pString(e[a]),r==="filter:"+Enums.FolderFilter.Flagged&&(n=Enums.FolderFilter.Flagged,a++),r==="filter:"+Enums.FolderFilter.Unseen&&(n=Enums.FolderFilter.Unseen,a++)),e.length>a&&(r=Utils.pString(e[a]),this.isPageParam(r)&&(i=Utils.pInt(r.substr(1)),0>=i&&(i=1),a++)),e.length>a&&(r=Utils.pString(e[a]),this.isMsgParam(r)&&(s=r.substr(3),a++)),e.length>a&&(o=Utils.pString(e[a]))),{Folder:t,Page:i,Uid:s,Search:o,Filters:n}},CLinkBuilder.prototype.contacts=function(e,t,i,s,o){var n=[Enums.Screens.Contacts];return"number"==typeof e&&n.push(e),t&&""!==t&&n.push(t),i&&""!==i&&n.push(i),Utils.isNumeric(s)&&n.push("p"+s),o&&""!==o&&n.push("cnt"+o),n},CLinkBuilder.prototype.parseContacts=function(e){var t=0,i=[Enums.ContactsGroupListType.Personal,Enums.ContactsGroupListType.SharedToAll,Enums.ContactsGroupListType.Global,Enums.ContactsGroupListType.All],s=Enums.ContactsGroupListType.All,o="",n="",r=1,a="";return Utils.isNonEmptyArray(e)&&(s=Utils.pInt(e[t]),t++,-1===Utils.inArray(s,i)&&(s=Enums.ContactsGroupListType.SubGroup),s===Enums.ContactsGroupListType.SubGroup&&(e.length>t?(o=Utils.pString(e[t]),t++):s=Enums.ContactsGroupListType.Personal),e.length>t&&!this.isPageParam(e[t])&&!this.isContactParam(e[t])&&(n=Utils.pString(e[t]),t++),e.length>t&&this.isPageParam(e[t])&&(r=Utils.pInt(e[t].substr(1)),t++,0>=r&&(r=1)),e.length>t&&this.isContactParam(e[t])&&(a=Utils.pString(e[t].substr(3)),t++)),{Type:s,GroupId:o,Search:n,Page:r,Uid:a}},CLinkBuilder.prototype.isPageParam=function(e){return"p"===e.substr(0,1)&&/^[1-9][\d]*$/.test(e.substr(1))},CLinkBuilder.prototype.isContactParam=function(e){return"cnt"===e.substr(0,3)&&/^[1-9][\d]*$/.test(e.substr(3))},CLinkBuilder.prototype.isMsgParam=function(e){return"msg"===e.substr(0,3)&&/^[1-9][\d]*$/.test(e.substr(3))},CLinkBuilder.prototype.compose=function(){var e=AppData.SingleMode?Enums.Screens.SingleCompose:Enums.Screens.Compose;return[e]},CLinkBuilder.prototype.composeFromMessage=function(e,t,i,s){var o=s||AppData.SingleMode?Enums.Screens.SingleCompose:Enums.Screens.Compose;return[o,e,t,i]},CLinkBuilder.prototype.composeWithToField=function(e){var t=AppData.SingleMode?Enums.Screens.SingleCompose:Enums.Screens.Compose;return[t,"to",e]},CLinkBuilder.prototype.parseToAddr=function(e){var t=decodeURI(Utils.pString(e)),i=-1!==t.indexOf("mailto:"),s=[],o=[],n="",r="",a="",l="";return i&&(s=t.replace(/^mailto:/,"").split("?"),t=s[0],2===s.length&&(o=s[1].split("&"),_.each(o,function(e){var t=e.split("=");if(2===t.length)switch(t[0].toLowerCase()){case"subject":n=t[1];break;case"cc":r=t[1];break;case"bcc":a=t[1];break;case"body":l=t[1]}}))),{to:t,hasMailto:i,subject:n,cc:r,bcc:a,body:l}},CMessageSender.prototype.setReplyData=function(e,t){this.replyText(e),this.replyDraftUid(t)},CMessageSender.prototype.send=function(e,t,i,s,o,n,r){var a=t.AccountID,l=App.MailCache.oFolderListItems[a],h="",c=l?l.sentFolderFullName():"",p=l?l.draftsFolderFullName():"",u=AppData.Accounts.getEmail(a),d=t.To.indexOf(u)>-1||t.Cc.indexOf(u)>-1||t.Bcc.indexOf(u)>-1,m=AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App:App;switch(AppData.User.SaveRepliedToCurrFolder&&!d&&Utils.isNonEmptyArray(t.DraftInfo,3)&&(c=t.DraftInfo[2]),t.Action=e,t.ShowReport=s,e){case"MessageSend":h=Utils.i18n("COMPOSE/INFO_SENDING"),i&&(t.SentFolder=c),""!==t.DraftUid&&(t.DraftFolder=p,m.MailCache.removeOneMessageFromCacheForFolder(t.AccountID,t.DraftFolder,t.DraftUid),m.Routing.replaceHashWithoutMessageUid(t.DraftUid));break;case"MessageSave":h=Utils.i18n("COMPOSE/INFO_SAVING"),t.DraftFolder=p,App.MailCache.savingDraftUid(t.DraftUid),m.MailCache.startMessagesLoadingWhenDraftSaving(t.AccountID,t.DraftFolder),m.Routing.replaceHashWithoutMessageUid(t.DraftUid)}s&&App.Api.showLoading(h),r?this.postponedMailData={Parameters:t,MessageSendResponseHandler:o,MessageSendResponseContext:n}:App.Ajax.send(t,o,n)},CMessageSender.prototype.sendPostponedMail=function(e){var t=this.postponedMailData,i=t.Parameters,s=i.AccountID,o=App.MailCache.oFolderListItems[s],n=o?o.draftsFolderFullName():"",r=AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App:App;""!==e&&(i.DraftUid=e,i.DraftFolder=n,r.MailCache.removeOneMessageFromCacheForFolder(i.AccountID,i.DraftFolder,i.DraftUid),r.Routing.replaceHashWithoutMessageUid(i.DraftUid)),this.postponedMailData&&(App.Ajax.send(i,t.MessageSendResponseHandler,t.MessageSendResponseContext),this.postponedMailData=null)},CMessageSender.prototype.sendReplyMessage=function(e,t,i,s,o,n){var r=null,a=App.MailCache.currentMessage(),l=[],h=null;a&&(l=a.oTo.aCollection.concat(a.oCc.aCollection),h=this.getFirstFetcherOrIdentityByRecipientsOrDefault(l,a.accountId()),r=this.getReplyDataFromMessage(a,Enums.ReplyType.ReplyAll,a.accountId(),h,!1,t,i),r.AccountID=a.accountId(),h&&(r.FetcherID=h&&h.FETCHER?h.id():"",r.IdentityID=h&&!h.FETCHER?h.id():""),r.Bcc="",r.Importance=Enums.Importance.Normal,r.Sensitivity=Enums.Sensitivity.Nothing,r.ReadingConfirmation="0",r.IsQuickReply="1",r.IsHtml="1",r.Attachments=this.convertAttachmentsForSending(r.Attachments),this.send(e,r,AppData.User.getSaveMailInSentItems(),!1,s,o,n))},CMessageSender.prototype.convertAttachmentsForSending=function(e){var t={};return _.each(e,function(e){t[e.tempName()]=[e.fileName(),e.cid(),e.inline()?"1":"0",e.linked()?"1":"0",e.contentLocation()]}),t},CMessageSender.prototype.onMessageSendOrSaveResponse=function(e,t,i){var s,o,n,r=AppData.SingleMode&&window.opener&&window.opener.App?window.opener.App:App,a=!!e.Result;switch(i||App.Api.hideLoading(),t.Action){case"MessageSave":a?(t.ShowReport&&!i&&App.Api.showReport(Utils.i18n("COMPOSE/REPORT_MESSAGE_SAVED")),e.Result.NewUid||(AppData.User.AllowAutosaveInDrafts=!1)):t.ShowReport&&App.Api.showErrorByCode(e,Utils.i18n("COMPOSE/ERROR_MESSAGE_SAVING"));break;case"MessageSend":a||e.ErrorCode===Enums.Errors.NotSavedInSentItems?(a||e.ErrorCode!==Enums.Errors.NotSavedInSentItems?t.IsQuickReply?App.Api.showReport(Utils.i18n("COMPOSE/REPORT_MESSAGE_SENT")):r.Api.showReport(Utils.i18n("COMPOSE/REPORT_MESSAGE_SENT")):App.Api.showError(Utils.i18n("WARNING/SENT_EMAIL_NOT_SAVED")),_.isArray(t.DraftInfo)&&3===t.DraftInfo.length&&(n=t.DraftInfo[0],o=t.DraftInfo[1],s=t.DraftInfo[2],App.MailCache.markMessageReplied(t.AccountID,s,o,n))):App.Api.showErrorByCode(e,Utils.i18n("COMPOSE/ERROR_MESSAGE_SENDING")),t.SentFolder&&r.MailCache.removeMessagesFromCacheForFolder(t.AccountID,t.SentFolder)}return t.DraftFolder&&!i&&r.MailCache.removeMessagesFromCacheForFolder(t.AccountID,t.DraftFolder),{Action:t.Action,Result:a,NewUid:e.Result?e.Result.NewUid:""}},CMessageSender.prototype.getReplyDataFromMessage=function(e,t,i,s,o,n,r){var a={DraftInfo:[],DraftUid:"",To:"",Cc:"",Bcc:"",Subject:"",Attachments:[],InReplyTo:e.messageId(),References:this.getReplyReferences(e)},l=[],h=e.oReplyTo.getFull(),c=e.oTo.getFull();switch((""===h||e.oFrom.getFirstEmail()===e.oReplyTo.getFirstEmail()&&""===e.oReplyTo.getFirstName())&&(h=e.oFrom.getFull()),n&&""!==n||(n=this.replyText(),this.replyText("")),"forward"===t?a.Text=n+this.getForwardMessageBody(e,i,s):"resend"===t?(a.Text=e.getConvertedHtml(),a.Cc=e.cc(),a.Bcc=e.bcc()):a.Text=n+this._getReplyMessageBody(e,i,s,o),r?a.DraftUid=r:(a.DraftUid=this.replyDraftUid(),this.replyDraftUid("")),t){case Enums.ReplyType.Reply:a.DraftInfo=[Enums.ReplyType.Reply,e.uid(),e.folder()],a.To=h,a.Subject=this.getReplySubject(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Enums.ReplyType.ReplyAll:a.DraftInfo=[Enums.ReplyType.ReplyAll,e.uid(),e.folder()],a.To=h,a.Cc=this._getReplyAllCcAddr(e,i,s),a.Subject=this.getReplySubject(e.subject(),!0),l=_.filter(e.attachments(),function(e){return e.linked()});break;case Enums.ReplyType.Resend:a.DraftInfo=[Enums.ReplyType.Resend,e.uid(),e.folder(),e.cc(),e.bcc()],a.To=c,a.Subject=e.subject(),l=e.attachments();break;case Enums.ReplyType.Forward:a.DraftInfo=[Enums.ReplyType.Forward,e.uid(),e.folder()],a.Subject=this.getReplySubject(e.subject(),!1),l=e.attachments()}return _.each(l,function(e){if(e.getCopy){var t=e.getCopy(),i=Date.now().toString();t.getInThumbQueue(i),a.Attachments.push(t)}}),a},CMessageSender.prototype.getReplyReferences=function(e){var t=e.references(),i=e.messageId(),s=t.indexOf(i);return-1===s&&(t+=" "+i),t},CMessageSender.prototype._getReplyMessageBody=function(e,t,i,s){var o=Utils.i18n("COMPOSE/REPLY_MESSAGE_TITLE",{DATE:e.oDateModel.getDate(),TIME:e.oDateModel.getTime(),SENDER:Utils.encodeHtml(e.oFrom.getFull())}),n="<br /><br />"+this.getSignatureText(t,i,s)+'<br /><br /><div data-anchor="reply-title">'+o+"</div><blockquote>"+e.getConvertedHtml()+"</blockquote>";return n},CMessageSender.prototype.getClearSignature=function(e,t){var i=AppData.Accounts.getAccount(e),s=!!(t?t.useSignature?t.useSignature():t.signatureOptions():!0),o="";return i&&s&&(o=t&&t.accountId()===i.id()?t.signature():i.signature()&&parseInt(i.signature().options())?i.signature().signature():""),o},CMessageSender.prototype.getSignatureText=function(e,t,i){var s=this.getClearSignature(e,t);return i?'<div data-anchor="signature">'+s+"</div>":"<div>"+s+"</div>"},CMessageSender.prototype.getFirstFetcherOrIdentityByRecipientsOrDefault=function(e,t){var i=AppData.Accounts.getAccount(t),s=this.getAccountFetchersIdentitiesList(i),o=[],n=null;return _.each(e,function(e){if(!n)switch(o=_.filter(s,function(t){return e.sEmail===t.email}),o.length){case 0:break;case 1:n=o[0];break;default:n=_.find(o,function(t){return e.sEmail===t.email&&e.sName===t.name}),n||(n=_.find(o,function(e){return e.isDefault}),n||(n=o[0]))}}),n||(n=_.find(s,function(e){return e.isDefault})),n&&n.result},CMessageSender.prototype.getAccountFetchersIdentitiesList=function(e){var t=[];return e&&(e.fetchers()&&_.each(e.fetchers().collection(),function(e){t.push({email:e.email(),name:e.userName(),isDefault:!1,result:e})}),_.each(e.identities(),function(e){t.push({email:e.email(),name:e.friendlyName(),isDefault:e.isDefault(),result:e})})),t},CMessageSender.prototype.getForwardMessageBody=function(e,t,i){var s=Utils.encodeHtml(e.oCc.getFull()),o=""!==s?Utils.i18n("COMPOSE/FORWARD_MESSAGE_BODY_CC",{CCADDR:s}):"",n=Utils.i18n("COMPOSE/FORWARD_MESSAGE_TITLE",{FROMADDR:Utils.encodeHtml(e.oFrom.getFull()),TOADDR:Utils.encodeHtml(e.oTo.getFull()),CCPART:o,FULLDATE:e.oDateModel.getFullDate(),SUBJECT:e.subject()}),r="<br /><br />"+this.getSignatureText(t,i,!0)+'<br /><br /><div data-anchor="reply-title">'+n+"</div><br /><br />"+e.getConvertedHtml();return r},CMessageSender.prototype._getReplyAllCcAddr=function(e,t,i){var s=new CAddressListModel,o=_.union(e.oTo.aCollection,e.oCc.aCollection,e.oBcc.aCollection),n=_.find(AppData.Accounts.collection(),function(e){return e.id()===t},this),r=new CAddressModel,a=new CAddressModel;return r.sEmail=n.email(),a.sEmail=i?i.email():"",s.addCollection(o),s.excludeCollection(_.union(e.oFrom.aCollection,[r,a])),s.getFull()},CMessageSender.prototype.getReplySubject=function(e,t){var i=Utils.i18n("COMPOSE/REPLY_PREFIX"),s=Utils.i18n("COMPOSE/FORWARD_PREFIX"),o=t?i:s,n=o+": "+e;return AppData.App.JoinReplyPrefixes&&(n=Utils.Message.joinReplyPrefixesInSubject(n,i,s)),n},CMessageSender.prototype.getHtmlFromText=function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\r/g,"").replace(/\n/g,"<br />")},CPrefetcher.prototype.init=function(){setInterval(_.bind(function(){this.start()},this),1e4)},CPrefetcher.prototype.start=function(){!AppData.Auth||AppData.SingleMode||App.InternetConnectionError||App.Ajax.hasOpenedRequests()||(this.prefetchStarted(!1),this.prefetchAll())},CPrefetcher.prototype.prefetchAll=function(){this.prefetchFetchersIdentities(),this.prefetchAccountFilters(),AppData.App.AllowPrefetch?(this.startMessagesPrefetch(),this.startThreadListPrefetch(),this.doServerInitializations(),this.prefetchStarredMessageList(),this.startOtherPagesPrefetch(),this.prefetchUnseenMessageList(),this.prefetchAccountQuota(),this.startOtherFoldersPrefetch(),this.prefetchCalendarList(),this.initHelpdesk()):(this.doServerInitializations(),this.prefetchStarredMessageList(),this.prefetchAccountQuota(),this.prefetchCalendarList(),this.initHelpdesk())},CPrefetcher.prototype.prefetchCalendarList=function(){this.prefetchStarted()||this.prefetchStarted(App.CalendarCache.firstRequestCalendarList())},CPrefetcher.prototype.prefetchFetchersIdentities=function(){AppData.SingleMode||this.fetchersIdentitiesPrefetched()||this.prefetchStarted()||!AppData.User.AllowFetcher&&!AppData.AllowIdentities||(AppData.Accounts.populateFetchersIdentities(),this.fetchersIdentitiesPrefetched(!0),this.prefetchStarted(!0))},CPrefetcher.prototype.initHelpdesk=function(){!AppData.User.IsHelpdeskSupported||this.prefetchStarted()||this.helpdeskInitialized()||(App.Screens.initHelpdesk(),this.helpdeskInitialized(!0),this.prefetchStarted(!0))},CPrefetcher.prototype.doServerInitializations=function(){AppData.SingleMode||this.prefetchStarted()||this.serverInitializationsDone()||(App.Ajax.send({Action:"SystemDoServerInitializations"}),this.serverInitializationsDone(!0),this.prefetchStarted(!0))},CPrefetcher.prototype.prefetchStarredMessageList=function(){if(!this.prefetchStarted()){var e=App.MailCache.folderList(),t=e?e.inboxFolder():null,i=null;t&&!t.hasChanges()&&(i=App.MailCache.requestMessageList(t.fullName(),1,"",Enums.FolderFilter.Flagged,!1,!1),i.RequestStarted&&this.prefetchStarted(!0))}},CPrefetcher.prototype.prefetchUnseenMessageList=function(){if(!this.prefetchStarted()){var e=App.MailCache.folderList(),t=e?e.inboxFolder():null,i=null;t&&!t.hasChanges()&&(i=App.MailCache.requestMessageList(t.fullName(),1,"",Enums.FolderFilter.Unseen,!1,!1),i.RequestStarted&&this.prefetchStarted(!0))}},CPrefetcher.prototype.startOtherPagesPrefetch=function(){this.prefetchStarted()||this.startPagePrefetch(App.MailCache.page()+1),this.prefetchStarted()||this.startPagePrefetch(App.MailCache.page()-1)},CPrefetcher.prototype.prefetchNextPage=function(e){var t=App.MailCache.uidList(),i=_.indexOf(t.collection(),e),s=Math.ceil(i/AppData.User.MailsPerPage)+1;this.startPagePrefetch(s-1)},CPrefetcher.prototype.prefetchPrevPage=function(e){var t=App.MailCache.uidList(),i=_.indexOf(t.collection(),e),s=Math.ceil((i+1)/AppData.User.MailsPerPage)+1;this.startPagePrefetch(s)},CPrefetcher.prototype.startPagePrefetch=function(e){var t=App.MailCache.folderList().currentFolder(),i=App.MailCache.uidList(),s=(e-1)*AppData.User.MailsPerPage,o=e>0&&s<i.resultCount(),n=null,r=null;t&&!t.hasChanges()&&o&&(n={folder:t.fullName(),page:e,search:i.search()},t.hasListBeenRequested(n)||(r=App.MailCache.requestMessageList(n.folder,n.page,n.search,"",!1,!1),r&&r.RequestStarted&&this.prefetchStarted(!0)))},CPrefetcher.prototype.startOtherFoldersPrefetch=function(){if(!this.prefetchStarted()){var e=App.MailCache.folderList(),t=e.currentFolderFullName(),i=AppData.Accounts.getCurrentFetchersAndFiltersFolderNames(),s=e?[e.inboxFolderFullName(),e.sentFolderFullName(),e.draftsFolderFullName(),e.spamFolderFullName()]:[],o=i.length<3?this.getOtherFolderNames(3-i.length):[],n=_.uniq(_.compact(_.union(s,i,o)));_.each(n,_.bind(function(i){t!==i&&this.startFolderPrefetch(e.getFolderByFullName(i))},this))}},CPrefetcher.prototype.getOtherFolderNames=function(e){var t=App.MailCache.folderList().inboxFolder(),i=t?t.subfolders():[],s=_.filter(App.MailCache.folderList().collection(),function(e){return!e.isSystem()},this),o=_.first(_.union(i,s),e);return _.map(o,function(e){return e.fullName()})},CPrefetcher.prototype.startFolderPrefetch=function(e){if(!this.prefetchStarted()&&e){var t=1,i="",s={folder:e.fullName(),page:t,search:i},o=null;e.hasListBeenRequested(s)||(o=App.MailCache.requestMessageList(s.folder,s.page,s.search,"",!1,!1),o&&o.RequestStarted&&this.prefetchStarted(!0))}},CPrefetcher.prototype.startThreadListPrefetch=function(){if(!this.prefetchStarted()){var e=[],t=App.MailCache.getCurrentFolder();_.each(App.MailCache.messages(),function(i){i.threadCount()>0&&_.each(i.threadUids(),function(i){var s=t.oMessages[i];s&&t.hasThreadUidBeenRequested(i)||e.push(i)})},this),e.length>0&&(e=e.slice(0,AppData.User.MailsPerPage),t.addRequestedThreadUids(e),t.loadThreadMessages(e),this.prefetchStarted(!0))}},CPrefetcher.prototype.startMessagesPrefetch=function(){if(!this.prefetchStarted()){var e=App.MailCache.currentAccountId(),t=App.MailCache.getCurrentFolder(),i=0,s=AppData.App.MaxPrefetchBodiesSize,o=[],n=null,r=2048,a=function(e){var n=!e.deleted()&&!e.completelyFilled(),a=!_.find(o,function(t){return t===e.uid()},this),l=!t.hasUidBeenRequested(e.uid());s>i&&n&&a&&l&&(o.push(e.uid()),i+=e.trimmedTextSize()+r)};t&&t.selected()&&(_.each(App.MailCache.messages(),a),_.each(t.oMessages,a),o.length>0&&(t.addRequestedUids(o),n={AccountID:e,Action:"MessagesGetBodies",Folder:t.fullName(),Uids:o},App.Ajax.send(n,this.onMessagesGetBodiesResponse,this),this.prefetchStarted(!0)))}},CPrefetcher.prototype.onMessagesGetBodiesResponse=function(e,t){var i=App.MailCache.getFolderByFullName(t.AccountID,t.Folder);_.isArray(e.Result)&&_.each(e.Result,function(e){i.parseAndCacheMessage(e,!1,!1)})},CPrefetcher.prototype.prefetchAccountQuota=function(){var e=AppData.Accounts.getCurrent(),t=AppData.App&&AppData.App.ShowQuotaBar,i=e&&!e.quotaRecieved();!this.prefetchStarted()&&t&&i&&(e.updateQuotaParams(),this.prefetchStarted(!0))},CPrefetcher.prototype.prefetchAccountFilters=function(){var e=AppData.Accounts.getCurrent();!this.prefetchStarted()&&e&&!e.filters()&&e.allowMail()&&e.extensionExists("AllowSieveFiltersExtension")&&(e.requestFilters(),this.prefetchStarted(!0))},CSelector.prototype.iTimer=0,CSelector.prototype.bResetCheckedOnClick=!1,CSelector.prototype.bCheckOnSelect=!1,CSelector.prototype.bUnselectOnCtrl=!1,CSelector.prototype.bDisableMultiplySelection=!1,CSelector.prototype.setBeforeSelectCallback=function(e){this.fBeforeSelectCallback=e||null},CSelector.prototype.getLastOrSelected=function(){var e=0,t=null;return _.each(this.list(),function(i){i.checked()&&e++,i.selected()&&(t=i)}),0===e&&t?t:this.oLast},CSelector.prototype.initOnApplyBindings=function(e,t,i,s,o){$(document).on("keydown",this.onKeydownBinded),this.oListScope=s,this.oScrollScope=o,this.sActionSelector=e,this.sSelectabelSelector=t,this.sCheckboxSelector=i;var n=this,r=function(e,t,i){var s=0,o=0,r=null,a=!1,l=!1,h=[],c=!1;if(t=t?t:null,i&&i.shiftKey&&null!==t&&null!==e&&t!==e)for(h=n.list(),c=t.checked(),s=0,o=h.length;o>s;s++)r=h[s],a=!1,(r===e||r===t)&&(a=!0),a&&(l=!l),(l||a)&&r.checked(c);t&&(n.oLast=t)};$(this.oListScope).on("dblclick",e,function(e){var t=ko.dataFor(this);!t||!e||e.ctrlKey||e.altKey||e.shiftKey||n.onDblClick(t)}),bMobileDevice&&$(this.oListScope).on("touchstart",e,function(e){if(e){var t=e.timeStamp,i=$(this).data("lastTouch")||t,s=t-i,o=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches.length:0;$(this).data("lastTouch",t),!s||s>250||o>1||(e.preventDefault(),$(this).trigger("dblclick"))}}),$(this.oListScope).on("click",e,function(e){var t=!0,i=null,s=n.getLastOrSelected(),o=ko.dataFor(this);o&&e&&(e.shiftKey?(t=!1,n.bDisableMultiplySelection||(null===n.oLast&&(n.oLast=o),o.checked(!o.checked()),r(s,o,e))):e.ctrlKey&&(t=!1,n.bDisableMultiplySelection||(n.oLast=o,i=n.itemSelected(),!i||i.checked()||o.checked()||i.checked(!0),n.bUnselectOnCtrl&&o===n.itemSelected()?(o.checked(!o.selected()),n.itemSelected(null)):o.checked(!o.checked()))),t&&(n.onSelect(o),n.scrollToSelected()))}),$(this.oListScope).on("click",i,function(e){var t=ko.dataFor(this);t&&e&&!n.bDisableMultiplySelection&&(e.shiftKey?(null===n.oLast&&(n.oLast=t),r(n.getLastOrSelected(),t,e)):n.oLast=t),e&&e.stopPropagation&&e.stopPropagation()}),$(this.oListScope).on("dblclick",i,function(e){e&&e.stopPropagation&&e.stopPropagation()})},CSelector.prototype.getResultSelection=function(e,t){var i=this,s=!1,o=!1,n=null,r=this.iFactor,a=!!this.multiplyLineFactor,l=0,h=0,c=[];if(!e&&-1<Utils.inArray(t,[this.KeyUp,this.KeyDown,this.KeyLeft,this.KeyRight,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End]))c=this.list(),c&&0<c.length&&(-1<Utils.inArray(t,[this.KeyDown,this.KeyRight,Enums.Key.PageUp,Enums.Key.Home])?n=c[0]:-1<Utils.inArray(t,[this.KeyUp,this.KeyLeft,Enums.Key.PageDown,Enums.Key.End])&&(n=c[c.length-1]));else if(e&&(c=this.list(),h=c?c.length:0,h>0))if(Enums.Key.Home===t||Enums.Key.PageUp===t||Enums.Key.End===t||Enums.Key.PageDown===t||a&&(Enums.Key.Left===t||Enums.Key.Right===t)||!a&&(Enums.Key.Up===t||Enums.Key.Down===t))_.each(c,function(r){if(!s)switch(t){case i.KeyUp:case i.KeyLeft:e===r?s=!0:n=r;break;case Enums.Key.Home:case Enums.Key.PageUp:n=r,s=!0;break;case i.KeyDown:case i.KeyRight:o?(n=r,s=!0):e===r&&(o=!0);break;case Enums.Key.End:case Enums.Key.PageDown:n=r}});else if(a&&this.KeyDown===t){for(;h>l;l++)if(e===c[l]){l+=r,l>h-1&&(l-=r),n=c[l];break}}else if(a&&this.KeyUp===t)for(l=h;l>=0;l--)if(e===c[l]){l-=r,0>l&&(l+=r),n=c[l];break}return n},CSelector.prototype.shiftClickResult=function(e,t,i){if(t){var s=!!this.multiplyLineFactor,o=!1,n=!1;-1<Utils.inArray(i,s?[Enums.Key.Left,Enums.Key.Right]:[Enums.Key.Up,Enums.Key.Down])?t.checked(!t.checked()):-1<Utils.inArray(i,s?[Enums.Key.Up,Enums.Key.Down,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End]:[Enums.Key.Left,Enums.Key.Right,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End])&&(n=!t.checked(),_.each(this.list(),function(i){var s=!1;(i===e||t===i)&&(o=!o,s=!0),(o||s)&&(i.checked(n),s=!1)}),s&&e&&(i===Enums.Key.Up||i===Enums.Key.Down)&&e.checked(!e.checked()))}},CSelector.prototype.clickNewSelectPosition=function(e,t){var i=this,s=0,o=null,n=this.itemSelected();o=this.getResultSelection(n,e),o?(t&&this.shiftClickResult(o,n,e),o&&this.fBeforeSelectCallback?(this.fBeforeSelectCallback(o,function(e){e&&(i.itemSelected(o),s=0===i.iTimer?50:150,0!==i.iTimer&&window.clearTimeout(i.iTimer),i.iTimer=window.setTimeout(function(){i.iTimer=0,i.onSelect(o,!1)},s),this.scrollToSelected())}),this.scrollToSelected()):(this.itemSelected(o),s=0===this.iTimer?50:150,0!==this.iTimer&&window.clearTimeout(this.iTimer),this.iTimer=window.setTimeout(function(){i.iTimer=0,i.onSelect(o)},s),this.scrollToSelected())):n&&t&&-1<Utils.inArray(e,[this.KeyUp,this.KeyDown,this.KeyLeft,this.KeyRight,Enums.Key.PageUp,Enums.Key.PageDown,Enums.Key.Home,Enums.Key.End])&&n.checked(!n.checked())},CSelector.prototype.onKeydown=function(e){var t=!0,i=0;return this.useKeyboardKeys()&&e&&!Utils.isTextFieldFocused()&&!App.Screens.hasOpenedMaximizedPopups()&&(i=e.keyCode,e.ctrlKey||this.KeyUp!==i&&this.KeyDown!==i&&this.KeyLeft!==i&&this.KeyRight!==i&&Enums.Key.PageUp!==i&&Enums.Key.PageDown!==i&&Enums.Key.Home!==i&&Enums.Key.End!==i?Enums.Key.Del!==i||e.ctrlKey||e.shiftKey?Enums.Key.Enter===i?0<this.list().length&&!e.ctrlKey&&(this.onEnter(this.itemSelected()),t=!1):!e.ctrlKey||e.altKey||e.shiftKey||Enums.Key.a!==i||(this.checkAll(!(this.checkAll()&&!this.isIncompleteChecked())),t=!1):0<this.list().length&&(this.onDelete(),t=!1):(this.clickNewSelectPosition(i,e.shiftKey),t=!1)),t},CSelector.prototype.onDelete=function(){this.fDeleteCallback.call(this,this.listCheckedOrSelected())},CSelector.prototype.onEnter=function(e){var t=this;e&&this.fBeforeSelectCallback?this.fBeforeSelectCallback(e,function(i){i&&(t.itemSelected(e),t.fEnterCallback.call(this,e))}):(this.itemSelected(e),this.fEnterCallback.call(this,e))},CSelector.prototype.selectionFunc=function(e){this.itemSelected(null),this.bResetCheckedOnClick&&this.listChecked(!1),this.itemSelected(e),this.fSelectCallback.call(this,e)},CSelector.prototype.onSelect=function(e,t){if(t=Utils.isUnd(t)?!0:!!t,this.fBeforeSelectCallback&&t){var i=this;this.fBeforeSelectCallback(e,function(t){t&&i.selectionFunc(e)})}else this.selectionFunc(e)},CSelector.prototype.onDblClick=function(e){this.fDblClickCallback.call(this,e)},CSelector.prototype.koCheckAll=function(){return ko.computed({read:this.checkAll,write:this.checkAll,owner:this})},CSelector.prototype.koCheckAllIncomplete=function(){return ko.computed({read:this.isIncompleteChecked,write:this.isIncompleteChecked,owner:this})},CSelector.prototype.scrollToSelected=function(){if(!this.oListScope||!this.oScrollScope)return!1;var e=20,t=$(this.sSelectabelSelector,this.oScrollScope),i=t.position(),s=this.oScrollScope.height(),o=t.outerHeight();
return i&&(i.top<0||i.top+o>s)?(this.oScrollScope.scrollTop(i.top<0?this.oScrollScope.scrollTop()+i.top-e:this.oScrollScope.scrollTop()+i.top-s+o+e),!0):!1},CApi.prototype.composeMessage=function(){App.Routing.setHash([Enums.Screens.Compose])},CApi.prototype.composeMessageFromDrafts=function(e,t){var i=App.Links.composeFromMessage("drafts",e,t);App.Routing.setHash(i)},CApi.prototype.composeMessageAsReplyOrForward=function(e,t,i){var s=App.Links.composeFromMessage(e,t,i);App.Routing.setHash(s)},CApi.prototype.composeMessageToAddresses=function(e){var t=App.Links.composeWithToField(e);App.Routing.setHash(t)},CApi.prototype.composeMessageWithVcard=function(e){var t=["vcard",e];App.Routing.goDirectly(App.Links.compose(),t)},CApi.prototype.composeMessageWithPgpKey=function(e,t){var i=["data-as-file",e,t];App.Routing.goDirectly(App.Links.compose(),i)},CApi.prototype.composeMessageWithFiles=function(e){var t=["file",e];App.Routing.goDirectly(App.Links.compose(),t)},CApi.prototype.closeComposePopup=function(){},CApi.prototype.createMailAccount=function(){},CApi.prototype.showChangeDefaultAccountPasswordPopup=function(){},CApi.prototype.showConfigureMailPopup=function(){},CApi.prototype.downloadByUrl=function(e){var t=null;bMobileDevice?window.open(e):(t=$('<iframe style="display: none;"></iframe>').appendTo(document.body),t.attr("src",e),setTimeout(function(){t.remove()},6e4))},CApi.prototype.isPgpSupported=function(){return!(!window.crypto||!window.crypto.getRandomValues)},CApi.prototype.pgp=function(e,t){if(Utils.isFunc(e))if(this.openPgp)e(this.openPgp);else if(this.isPgpSupported()){null!==this.openPgpCallbacks?this.openPgpCallbacks.push(e):e(!1);var i=this;this.openPgpRequest||(this.openPgpRequest=!0,$.ajax({url:"static/js/openpgp.js",dataType:"script",cache:!0,complete:function(){i.openPgp=window.openpgp?new OpenPgp(window.openpgp,"user_"+(t||"0")+"_"):!1,null!==i.openPgpCallbacks&&_.each(i.openPgpCallbacks,function(e){e(i.openPgp)}),i.openPgpCallbacks=null}}))}else e(!1)},CApi.prototype.showLoading=function(e){App.Screens.showLoading(e)},CApi.prototype.hideLoading=function(){App.Screens.hideLoading()},CApi.prototype.showReport=function(e,t){App.Screens.showReport(e,t)},CApi.prototype.showError=function(e,t,i,s){App.Screens.showError(e,t,i,s)},CApi.prototype.hideError=function(e){App.Screens.hideError(e)},CApi.prototype.showPgpErrorByCode=function(e,t,i){var s=Utils.isNonEmptyArray(e.errors)?e.errors:[],o=Utils.isNonEmptyArray(e.notices)?e.notices:[],n=[],r=[],a="",l=!1,h=!0;if(_.each(_.union(s,o),function(e){if(2===e.length)switch(e[0]){case OpenPgpResult.Enum.GenerateKeyError:a=Utils.i18n("OPENPGP/ERROR_GENERATE_KEY");break;case OpenPgpResult.Enum.ImportKeyError:a=Utils.i18n("OPENPGP/ERROR_IMPORT_KEY");break;case OpenPgpResult.Enum.ImportNoKeysFoundError:a=Utils.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_FOUND");break;case OpenPgpResult.Enum.PrivateKeyNotFoundError:case OpenPgpResult.Enum.PrivateKeyNotFoundNotice:r.push(e[1]);break;case OpenPgpResult.Enum.PublicKeyNotFoundError:h=!1,n.push(e[1]);break;case OpenPgpResult.Enum.PublicKeyNotFoundNotice:n.push(e[1]);break;case OpenPgpResult.Enum.KeyIsNotDecodedError:t===Enums.PgpAction.DecryptVerify?a=Utils.i18n("OPENPGP/ERROR_DECRYPT")+" "+Utils.i18n("OPENPGP/ERROR_KEY_NOT_DECODED",{USER:e[1]}):(t===Enums.PgpAction.Sign||t===Enums.PgpAction.EncryptSign)&&(a=Utils.i18n("OPENPGP/ERROR_SIGN")+" "+Utils.i18n("OPENPGP/ERROR_KEY_NOT_DECODED",{USER:e[1]}));break;case OpenPgpResult.Enum.SignError:a=Utils.i18n("OPENPGP/ERROR_SIGN");break;case OpenPgpResult.Enum.VerifyError:a=Utils.i18n("OPENPGP/ERROR_VERIFY");break;case OpenPgpResult.Enum.EncryptError:a=Utils.i18n("OPENPGP/ERROR_ENCRYPT");break;case OpenPgpResult.Enum.DecryptError:a=Utils.i18n("OPENPGP/ERROR_DECRYPT");break;case OpenPgpResult.Enum.SignAndEncryptError:a=Utils.i18n("OPENPGP/ERROR_ENCRYPT_OR_SIGN");break;case OpenPgpResult.Enum.VerifyAndDecryptError:a=Utils.i18n("OPENPGP/ERROR_DECRYPT_OR_VERIFY");break;case OpenPgpResult.Enum.DeleteError:a=Utils.i18n("OPENPGP/ERROR_DELETE_KEY");break;case OpenPgpResult.Enum.VerifyErrorNotice:a=Utils.i18n("OPENPGP/ERROR_VERIFY");break;case OpenPgpResult.Enum.NoSignDataNotice:l=!0}}),n.length>0?(n=_.without(n,""),n.length>0?a=Utils.i18n("OPENPGP/ERROR_NO_PUBLIC_KEYS_FOR_USERS_PLURAL",{USERS:n.join(", ")},null,n.length):t===Enums.PgpAction.Verify&&(a=Utils.i18n("OPENPGP/ERROR_NO_PUBLIC_KEY_FOUND_FOR_VERIFY")),h&&""!==a&&(a+=" "+Utils.i18n("OPENPGP/ERROR_MESSAGE_WAS_NOT_VERIFIED"))):r.length>0&&(r=_.without(r,""),r.length>0?a=Utils.i18n("OPENPGP/ERROR_NO_PRIVATE_KEYS_FOR_USERS_PLURAL",{USERS:r.join(", ")},null,r.length):t===Enums.PgpAction.DecryptVerify&&(a=Utils.i18n("OPENPGP/ERROR_NO_PRIVATE_KEY_FOUND_FOR_DECRYPT"))),""===a&&!l){switch(t){case Enums.PgpAction.Generate:a=Utils.i18n("OPENPGP/ERROR_GENERATE_KEY");break;case Enums.PgpAction.Import:a=Utils.i18n("OPENPGP/ERROR_IMPORT_KEY");break;case Enums.PgpAction.DecryptVerify:a=Utils.i18n("OPENPGP/ERROR_DECRYPT");break;case Enums.PgpAction.Verify:a=Utils.i18n("OPENPGP/ERROR_VERIFY");break;case Enums.PgpAction.Encrypt:a=Utils.i18n("OPENPGP/ERROR_ENCRYPT");break;case Enums.PgpAction.EncryptSign:a=Utils.i18n("OPENPGP/ERROR_ENCRYPT_OR_SIGN");break;case Enums.PgpAction.Sign:a=Utils.i18n("OPENPGP/ERROR_SIGN")}a=i}return""!==a&&App.Api.showError(a),l},CApi.prototype.showErrorByCode=function(e,t,i){var s=e.ErrorCode,o=e.ErrorMessage||"",n="";switch(s){default:n=t||Utils.i18n("WARNING/UNKNOWN_ERROR");break;case Enums.Errors.AuthError:n=Utils.i18n("WARNING/LOGIN_PASS_INCORRECT");break;case Enums.Errors.DataBaseError:n=Utils.i18n("WARNING/DATABASE_ERROR");break;case Enums.Errors.LicenseProblem:n=Utils.i18n("WARNING/INVALID_LICENSE");break;case Enums.Errors.DemoLimitations:n=Utils.i18n("DEMO/WARNING_THIS_FEATURE_IS_DISABLED");break;case Enums.Errors.Captcha:n=Utils.i18n("WARNING/CAPTCHA_IS_INCORRECT");break;case Enums.Errors.CanNotGetMessage:n=Utils.i18n("MESSAGE/ERROR_MESSAGE_DELETED");break;case Enums.Errors.NoRequestedMailbox:n=t+" "+Utils.i18n("COMPOSE/ERROR_INVALID_ADDRESS",{ADDRESS:e.Mailbox||""});break;case Enums.Errors.CanNotChangePassword:n=Utils.i18n("WARNING/UNABLE_CHANGE_PASSWORD");break;case Enums.Errors.AccountOldPasswordNotCorrect:n=Utils.i18n("WARNING/CURRENT_PASSWORD_NOT_CORRECT");break;case Enums.Errors.FetcherIncServerNotAvailable:n=Utils.i18n("WARNING/FETCHER_SAVE_ERROR");break;case Enums.Errors.FetcherLoginNotCorrect:n=Utils.i18n("WARNING/FETCHER_SAVE_ERROR");break;case Enums.Errors.HelpdeskUserNotExists:n=Utils.i18n("HELPDESK/ERROR_FORGOT_NO_ACCOUNT");break;case Enums.Errors.MailServerError:n=Utils.i18n("WARNING/CANT_CONNECT_TO_SERVER");break;case Enums.Errors.DataTransferFailed:n=Utils.i18n("WARNING/DATA_TRANSFER_FAILED");break;case Enums.Errors.NotDisplayedError:n=""}""!==n?(""!==o&&(n+=" ("+o+")"),this.showError(n,!1,!!i)):""!==o&&this.showError(o)},CApi.prototype.showErrorIfAttachmentSizeLimit=function(e,t){var i=Utils.i18n("COMPOSE/UPLOAD_ERROR_FILENAME_SIZE",{FILENAME:e,MAXSIZE:Utils.friendlySize(AppData.App.AttachmentSizeLimit)});return AppData.App.AttachmentSizeLimit>0&&t>AppData.App.AttachmentSizeLimit?(App.Screens.showPopup(AlertPopup,[i]),!0):!1},CApi.prototype.deleteMessages=function(e,t,i){Utils.isFunc(i)||(i=function(){});var s=App.MailCache.folderList(),o=s.currentFolderFullName(),n=s.trashFolder(),r=n&&o===n.fullName(),a=s.spamFolder(),l=a&&o===a.fullName(),h=function(s){s&&(t.MailCache.deleteMessages(e),i())};l?(t.MailCache.deleteMessages(e),i()):r?App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/CONFIRM_MESSAGES_DELETE"),h]):n?(t.MailCache.moveMessagesToFolder(n.fullName(),e),i()):n||App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/CONFIRM_MESSAGES_DELETE_NO_TRASH_FOLDER"),h])},CApi.prototype.contactCreate=function(){},AfterLogicApi.addScreenToHeader=function(e,t,i,s,o){App.addScreenToHeader(e,t,i,s,o,!0)},AfterLogicApi.setDefaultTab=function(e){var t=!!_.find(Enums.Screens,function(t){return t===e});t&&(AppData.App.DefaultTab=e)},AfterLogicApi.aSettingsTabs=[],AfterLogicApi.addSettingsTab=function(e){e.prototype.TabName&&(Enums.SettingsTab[e.prototype.TabName]=e.prototype.TabName,AfterLogicApi.aSettingsTabs.push(e))},AfterLogicApi.getPluginsSettingsTabs=function(){return AfterLogicApi.aSettingsTabs},AfterLogicApi.getSetting=function(e){return AppData.App[e]},AfterLogicApi.getPluginSettings=function(e){return AppData&&AppData.Plugins?AppData.Plugins[e]:null},AfterLogicApi.getAuthToken=function(){return App.Storage.getData("AuthToken")},AfterLogicApi.oPluginHooks={},AfterLogicApi.addPluginHook=function(e,t){Utils.isFunc(t)&&($.isArray(this.oPluginHooks[e])||(this.oPluginHooks[e]=[]),this.oPluginHooks[e].push(t))},AfterLogicApi.runPluginHook=function(e,t){$.isArray(this.oPluginHooks[e])&&(t=t||[],_.each(this.oPluginHooks[e],function(e){e.apply(null,t)}))},AfterLogicApi.sendAjaxRequest=function(e,t,i){App.Ajax.send(e,t,i)},AfterLogicApi.i18n=Utils.i18n,AfterLogicApi.getArrayRecipients=Utils.Address.getArrayRecipients,AfterLogicApi.getEmailParts=Utils.Address.getEmailParts,AfterLogicApi.isCorrectEmail=Utils.Address.isCorrectEmail,AfterLogicApi.showAlertPopup=function(e){App.Screens.showPopup(AlertPopup,[e])},AfterLogicApi.showConfirmPopup=function(e,t){App.Screens.showPopup(ConfirmPopup,[e,t])},AfterLogicApi.showPopup=function(e,t){App.Screens.showPopup(e,t)},AfterLogicApi.showReport=function(e,t){App.Screens.showReport(e,t)},AfterLogicApi.showError=function(e){App.Screens.showError(e)},AfterLogicApi.getPrimaryAccountData=function(){var e=AppData.Accounts.getDefault();return{Id:e.id(),Email:e.email(),FriendlyName:e.friendlyName()}},AfterLogicApi.getCurrentAccountData=function(){var e=AppData.Accounts.getCurrent();return{Id:e.id(),Email:e.email(),FriendlyName:e.friendlyName()}},AfterLogicApi.isMobile=function(){return this.getAppDataItem("IsMobile")},AfterLogicApi.getRequestParam=Utils.Common.getRequestParam,AfterLogicApi.editedFolderList=function(){return App.MailCache.editedFolderList},AfterLogicApi.FileSizeLimit=AppData.App.FileSizeLimit,AfterLogicApi.isFunc=Utils.isFunc,AfterLogicApi.isUnd=Utils.isUnd,AfterLogicApi.emptyFunction=Utils.emptyFunction,AfterLogicApi.getAppDataItem=function(e){return AppData&&AppData[e]?AppData[e]:null},AfterLogicApi.WindowOpener=Utils.WindowOpener,AfterLogicApi.getAppPath=Utils.Common.getAppPath,AfterLogicApi.loadScript=Utils.loadScript,AfterLogicApi.createObjectInstance=function(sClassName){var oReg=new RegExp("^[a-zA-Z]+$");return oReg.test(sClassName)?eval("new "+sClassName+"()"):null},CStorage.prototype.hasData=function(e){var t=this.bHtml5?localStorage.getItem(e):$.cookie(e);return!!t},CStorage.prototype.getData=function(e){var t=this.bHtml5?localStorage.getItem(e):$.cookie(e);return $.parseJSON(t)},CStorage.prototype.setData=function(e,t){var i=JSON.stringify(t);this.bHtml5?localStorage.setItem(e,i):$.cookie(e,i,{expires:30})},CStorage.prototype.removeData=function(e){this.bHtml5?localStorage.removeItem(e):$.cookie(e,null)},CStorage.prototype.init=function(){if("undefined"==typeof Storage)this.bHtml5=!1;else try{localStorage.setItem("check","val"),localStorage.removeItem("check")}catch(e){this.bHtml5=!1}},OpenPgp.prototype.pgp=null,OpenPgp.prototype.pgpKeyring=null,OpenPgp.prototype.keys=[],OpenPgp.prototype.getKeys=function(){return this.keys()},OpenPgp.prototype.getKeysObservable=function(){return this.keys},OpenPgp.prototype.reloadKeysFromStorage=function(){var e=[],t=this.pgpKeyring.getAllKeys();_.each(t,function(t){t&&t.primaryKey&&e.push(new OpenPgpKey(t))}),this.keys(e)},OpenPgp.prototype.convertToNativeKeys=function(e){return _.map(e,function(e){return e&&e.pgpKey?e.pgpKey:e})},OpenPgp.prototype.cloneKey=function(e){var t=null;return e&&(t=this.pgp.key.readArmored(e.armor()),t&&!t.err&&t.keys&&t.keys[0]?(t=t.keys[0],t&&t.primaryKey||(t=null)):t=null),t},OpenPgp.prototype.decryptKeyHelper=function(e,t,i,s){if(t)try{t.decrypt(Utils.pString(i)),t&&t.primaryKey&&t.primaryKey.isDecrypted||e.addError(OpenPgpResult.Enum.KeyIsNotDecodedError,s||"")}catch(o){e.addExceptionMessage(o,OpenPgpResult.Enum.KeyIsNotDecodedError,s||"")}else e.addError(OpenPgpResult.Enum.KeyIsNotDecodedError,s||"")},OpenPgp.prototype.verifyMessageHelper=function(e,t,i){var s=!1,o=null,n=[],r=[],a=[];if(i&&i.getSigningKeyIds)if(r=i.getSigningKeyIds(),r&&0<r.length)if(a=this.findKeysByEmails([t],!0),a&&0!==a.length){n=[];try{n=i.verify(this.convertToNativeKeys(a))}catch(l){e.addNotice(OpenPgpResult.Enum.VerifyErrorNotice,t)}n&&0<n.length&&(o=_.find(n,function(e){return e&&e.keyid&&e.valid}),o&&o.keyid&&a&&a[0]&&o.keyid.toHex().toLowerCase()===a[0].getId()?s=!0:e.addNotice(OpenPgpResult.Enum.VerifyErrorNotice,t))}else e.addNotice(OpenPgpResult.Enum.PublicKeyNotFoundNotice,t);else e.addNotice(OpenPgpResult.Enum.NoSignDataNotice);else e.addError(OpenPgpResult.Enum.UnknownError);return s||e.hasNotices()||e.addNotice(OpenPgpResult.Enum.VerifyErrorNotice),s},OpenPgp.prototype.generateKey=function(e,t,i){var s=new OpenPgpResult,o=null;try{o=this.pgp.generateKeyPair({userId:e,numBits:Utils.pInt(i),passphrase:Utils.trim(t)})}catch(n){s.addExceptionMessage(n)}if(o&&o.privateKeyArmored)try{this.pgpKeyring.privateKeys.importKey(o.privateKeyArmored),this.pgpKeyring.publicKeys.importKey(o.publicKeyArmored),this.pgpKeyring.store()}catch(n){s.addExceptionMessage(n,OpenPgpResult.Enum.GenerateKeyError)}else s.addError(OpenPgpResult.Enum.GenerateKeyError);return this.reloadKeysFromStorage(),s},OpenPgp.prototype.splitKeys=function(e){var t=[],i=0,s=30,o=null,n=Utils.trim(e),r=/[\-]{3,6}BEGIN[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[\-]{3,6}[\s\S]+?[\-]{3,6}END[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[\-]{3,6}/gi;for(n=n.replace(/[\r\n]([a-zA-Z0-9]{2,}:[^\r\n]+)[\r\n]+([a-zA-Z0-9\/\\+=]{10,})/g,"\n$1---xyx---$2").replace(/[\n\r]+/g,"\n").replace(/---xyx---/g,"\n\n");;){if(o=r.exec(n),!o||0>s)break;o[0]&&o[1]&&o[2]&&o[1]===o[2]&&("PRIVATE"===o[1]||"PUBLIC"===o[1])&&(t.push([o[1],o[0]]),i++),s--}return t},OpenPgp.prototype.importKeys=function(e){e=Utils.trim(e);var t=0,i=0,s=new OpenPgpResult,o=null,n=[];if(!e)return s.addError(OpenPgpResult.Enum.InvalidArgumentErrors);for(n=this.splitKeys(e),t=0;t<n.length;t++)if(o=n[t],"PRIVATE"===o[0])try{this.pgpKeyring.privateKeys.importKey(o[1]),i++}catch(r){s.addExceptionMessage(r,OpenPgpResult.Enum.ImportKeyError,"private")}else if("PUBLIC"===o[0])try{this.pgpKeyring.publicKeys.importKey(o[1]),i++}catch(r){s.addExceptionMessage(r,OpenPgpResult.Enum.ImportKeyError,"public")}return i>0?this.pgpKeyring.store():s.addError(OpenPgpResult.Enum.ImportNoKeysFoundError),this.reloadKeysFromStorage(),s},OpenPgp.prototype.getArmorInfo=function(e){e=Utils.trim(e);var t=0,i=0,s=null,o=[],n=null,r=[];if(!e)return!1;for(r=this.splitKeys(e),t=0;t<r.length;t++)if(n=r[t],"PRIVATE"===n[0])try{s=this.pgp.key.readArmored(n[1]),s&&!s.err&&s.keys&&s.keys[0]&&o.push(new OpenPgpKey(s.keys[0])),i++}catch(a){o.push(null)}else if("PUBLIC"===n[0])try{s=this.pgp.key.readArmored(n[1]),s&&!s.err&&s.keys&&s.keys[0]&&o.push(new OpenPgpKey(s.keys[0])),i++}catch(a){o.push(null)}return o},OpenPgp.prototype.findKeyByID=function(e,t){t=!!t,e=e.toLowerCase();var i=_.find(this.keys(),function(i){var s=!1,o=null;return i&&t===i.isPublic()&&(o=i.pgpKey.getKeyIds(),o&&(s=_.find(o,function(t){return t&&t.toHex&&e===t.toHex().toLowerCase()}))),!!s});return i?i:null},OpenPgp.prototype.findKeysByEmails=function(e,t,i){t=!!t;var s=[],o=this.keys();return _.each(e,function(e){var n=_.find(o,function(i){return i&&t===i.isPublic()&&e===i.getEmail()});n?s.push(n):i&&i.addError(t?OpenPgpResult.Enum.PublicKeyNotFoundError:OpenPgpResult.Enum.PrivateKeyNotFoundError,e)}),s},OpenPgp.prototype.decryptAndVerify=function(e,t,i,s){var o=this,n=null,r=null,a=null,l=null,h=null,c=new OpenPgpResult,p=[];if(n=this.pgp.message.readArmored(e),n&&n.decrypt)if(p=n.getEncryptionKeyIds(),p&&(a=null,r=null,_.each(p,function(e){r||(r=o.findKeyByID(e.toHex(),!1),r&&t!==r.getEmail()&&(r=null))}),r&&(a=r),a||_.each(p,function(e){a||(a=o.findKeyByID(e.toHex(),!1))})),a){if(l=this.cloneKey(this.convertToNativeKeys([a])[0]),this.decryptKeyHelper(c,l,s,a.getEmail()),l&&!c.hasErrors())try{h=n.decrypt(l)}catch(u){c.addExceptionMessage(u,OpenPgpResult.Enum.DecryptError),h=null}h&&!c.hasErrors()&&(this.verifyMessageHelper(c,i,h),c.result=h.getText())}else c.addError(OpenPgpResult.Enum.PrivateKeyNotFoundError);return c},OpenPgp.prototype.verify=function(e,t){var i=null,s=new OpenPgpResult;return i=this.pgp.cleartext.readArmored(e),i&&i.getText&&i.verify?(this.verifyMessageHelper(s,t,i),s.result=i.getText()):s.addError(OpenPgpResult.Enum.CanNotReadMessage),s},OpenPgp.prototype.encrypt=function(e,t){var i=new OpenPgpResult,s=this.findKeysByEmails(t,!0,i);if(!i.hasErrors())try{i.result=this.pgp.encryptMessage(this.convertToNativeKeys(s),e)}catch(o){i.addExceptionMessage(o,OpenPgpResult.Enum.EncryptError)}return i},OpenPgp.prototype.sign=function(e,t,i){var s=new OpenPgpResult,o=null,n=null,r=this.findKeysByEmails([t],!1,s);if(!s.hasErrors()&&(o=this.convertToNativeKeys(r)[0],n=this.cloneKey(o),this.decryptKeyHelper(s,n,i,t),n&&!s.hasErrors()))try{s.result=this.pgp.signClearMessage([n],e)}catch(a){s.addExceptionMessage(a,OpenPgpResult.Enum.SignError,t)}return s},OpenPgp.prototype.signAndEncrypt=function(e,t,i,s){var o=null,n=null,r=new OpenPgpResult,a=this.findKeysByEmails([t],!1,r),l=this.findKeysByEmails(i,!0,r);if(!r.hasErrors()&&(o=this.convertToNativeKeys(a)[0],n=this.cloneKey(o),this.decryptKeyHelper(r,n,s,t),n&&!r.hasErrors()))try{r.result=this.pgp.signAndEncryptMessage(this.convertToNativeKeys(l),n,e)}catch(h){r.addExceptionMessage(h,OpenPgpResult.Enum.SignAndEncryptError)}return r},OpenPgp.prototype.deleteKey=function(e){var t=new OpenPgpResult;if(e)try{this.pgpKeyring[e.isPrivate()?"privateKeys":"publicKeys"].removeForId(e.getFingerprint()),this.pgpKeyring.store()}catch(i){t.addExceptionMessage(i,OpenPgpResult.Enum.DeleteError)}else t.addError(e?OpenPgpResult.Enum.UnknownError:OpenPgpResult.Enum.InvalidArgumentError);return this.reloadKeysFromStorage(),t},OpenPgpKey.prototype.pgpKey=null,OpenPgpKey.prototype.emailParts=null,OpenPgpKey.prototype.user="",OpenPgpKey.prototype.getId=function(){return this.pgpKey.primaryKey.getKeyId().toHex().toLowerCase()},OpenPgpKey.prototype.getEmail=function(){return this.emailParts.email||this.user},OpenPgpKey.prototype.getUser=function(){return this.user},OpenPgpKey.prototype.getFingerprint=function(){return this.pgpKey.primaryKey.getFingerprint()},OpenPgpKey.prototype.getBitSize=function(){return this.pgpKey.primaryKey.getBitSize()},OpenPgpKey.prototype.getArmor=function(){return this.pgpKey.armor()},OpenPgpKey.prototype.isPrivate=function(){return!!this.pgpKey.isPrivate()},OpenPgpKey.prototype.isPublic=function(){return!this.isPrivate()},OpenPgpResult.Enum={UnknownError:0,UnknownNotice:1,InvalidArgumentError:2,GenerateKeyError:10,ImportKeyError:20,ImportNoKeysFoundError:21,PrivateKeyNotFoundError:30,PublicKeyNotFoundError:31,KeyIsNotDecodedError:32,SignError:40,VerifyError:41,EncryptError:42,DecryptError:43,SignAndEncryptError:44,VerifyAndDecryptError:45,CanNotReadMessage:50,CanNotReadKey:51,DeleteError:60,PublicKeyNotFoundNotice:70,PrivateKeyNotFoundNotice:71,VerifyErrorNotice:72,NoSignDataNotice:73},OpenPgpResult.prototype.result=!1,OpenPgpResult.prototype.errors=null,OpenPgpResult.prototype.notices=null,OpenPgpResult.prototype.addError=function(e,t){return this.result=!1,this.errors=this.errors||[],this.errors.push([e||OpenPgpResult.Enum.UnknownError,t||""]),this},OpenPgpResult.prototype.addNotice=function(e,t){return this.notices=this.notices||[],this.notices.push([e||OpenPgpResult.Enum.UnknownNotice,t||""]),this},OpenPgpResult.prototype.addExceptionMessage=function(e,t,i){return e&&(this.result=!1,this.exceptions=this.exceptions||[],this.exceptions.push(""+(e.name||"unknown")+": "+(e.message||""))),Utils.isUnd(t)||this.addError(t,i),this},OpenPgpResult.prototype.hasErrors=function(){return this.errors&&0<this.errors.length},OpenPgpResult.prototype.hasNotices=function(){return this.notices&&0<this.notices.length},AlertPopup.prototype.onShow=function(e,t,i,s){this.alertDesc(e),this.closeCallback=t||null,this.title(i||""),this.okButtonText(s||Utils.i18n("MAIN/BUTTON_OK"))},AlertPopup.prototype.popupTemplate=function(){return"Popups_AlertPopupViewModel"},AlertPopup.prototype.onEnterHandler=function(){this.close()},AlertPopup.prototype.close=function(){Utils.isFunc(this.closeCallback)&&this.closeCallback(),this.closeCommand()},ConfirmPopup.prototype.onShow=function(e,t,i,s,o){this.confirmDesc(e),this.title(i||""),this.okButtonText(s||Utils.i18n("MAIN/BUTTON_OK")),this.cancelButtonText(o||Utils.i18n("MAIN/BUTTON_CANCEL")),Utils.isFunc(t)&&(this.fConfirmCallback=t),this.shown=!0},ConfirmPopup.prototype.onHide=function(){this.shown=!1},ConfirmPopup.prototype.popupTemplate=function(){return"Popups_ConfirmPopupViewModel"},ConfirmPopup.prototype.onEnterHandler=function(){this.yesClick()},ConfirmPopup.prototype.yesClick=function(){this.shown&&this.fConfirmCallback&&this.fConfirmCallback(!0),this.closeCommand()},ConfirmPopup.prototype.noClick=function(){this.fConfirmCallback&&this.fConfirmCallback(!1),this.closeCommand()},ConfirmPopup.prototype.onEscHandler=function(){this.noClick()},CImportOpenPgpKeyPopup.prototype.onShow=function(e,t){this.pgp=e,this.keyArmor(t||""),this.keyArmorFocused(!0),this.keys([]),this.hasExistingKeys(!1),""!==this.keyArmor()&&this.checkArmor()},CImportOpenPgpKeyPopup.prototype.popupTemplate=function(){return"Popups_ImportOpenPgpKeyPopupViewModel"},CImportOpenPgpKeyPopup.prototype.checkArmor=function(){var e=null,t=[],i=this.pgp,s=!1;""===this.keyArmor()?this.keyArmorFocused(!0):i&&(e=i.getArmorInfo(this.keyArmor()),Utils.isNonEmptyArray(e)&&_.each(e,function(e){if(e){var o=i.findKeyByID(e.getId(),e.isPublic()),n=null!==o,r=e.isPublic()?"OPENPGP/PUBLIC_KEY_ADD_INFO":"OPENPGP/PRIVATE_KEY_ADD_INFO";s=s||n,t.push({armor:e.getArmor(),email:e.user,id:e.getId(),addInfo:Utils.i18n(r,{LENGTH:e.getBitSize()}),needToImport:ko.observable(!n),disabled:n})}}),0===t.length&&App.Api.showError(Utils.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_FOUND")),this.keys(t),this.hasExistingKeys(s))},CImportOpenPgpKeyPopup.prototype.importKey=function(){var e=null,t=[];this.pgp&&(_.each(this.keys(),function(e){e.needToImport()&&t.push(e.armor)}),t.length>0?(e=this.pgp.importKeys(t.join("")),e&&e.result&&App.Api.showReport(Utils.i18n("OPENPGP/REPORT_KEY_SUCCESSFULLY_IMPORTED_PLURAL",{},null,t.length)),e&&!e.result&&App.Api.showPgpErrorByCode(e,Enums.PgpAction.Import,Utils.i18n("OPENPGP/ERROR_IMPORT_KEY")),this.closeCommand()):App.Api.showError(Utils.i18n("OPENPGP/ERROR_IMPORT_NO_KEY_SELECTED")))},CAppSettingsModel.prototype.parse=function(e){this.AllowWebMail=!!e.AllowWebMail,this.AllowUsersChangeInterfaceSettings=!!e.AllowUsersChangeInterfaceSettings,this.AllowUsersChangeEmailSettings=!!e.AllowUsersChangeEmailSettings,this.AllowUsersAddNewAccounts=!!e.AllowUsersAddNewAccounts,this.SiteName=Utils.pString(e.SiteName),this.Languages=e.Languages,this.Themes=e.Themes,this.DateFormats=e.DateFormats,this.AttachmentSizeLimit=Utils.pInt(e.AttachmentSizeLimit),this.ImageUploadSizeLimit=Utils.pInt(e.ImageUploadSizeLimit),this.FileSizeLimit=Utils.pInt(e.FileSizeLimit),this.AutoSave=!!e.AutoSave,this.IdleSessionTimeout=60*Utils.pInt(e.IdleSessionTimeout)*1e3,this.AllowInsertImage=!!e.AllowInsertImage,this.AllowBodySize=!!e.AllowBodySize,this.MaxBodySize=Utils.pInt(e.MaxBodySize),this.MaxSubjectSize=Utils.pInt(e.MaxSubjectSize),this.JoinReplyPrefixes=!!e.JoinReplyPrefixes,this.AllowAppRegisterMailto=!!e.AllowAppRegisterMailto,this.AllowPrefetch=!!e.AllowPrefetch,this.LoginFormType=Utils.pInt(e.LoginFormType),this.LoginSignMeType=Utils.pInt(e.LoginSignMeType),this.LoginAtDomainValue=Utils.pString(e.LoginAtDomainValue),this.AllowRegistration=!!e.AllowRegistration,this.AllowPasswordReset=!!e.AllowPasswordReset,this.RegistrationDomains=e.RegistrationDomains,this.RegistrationQuestions=_.without(e.RegistrationQuestions,""),this.DemoWebMail=!!e.DemoWebMail,this.DemoWebMailLogin=Utils.pString(e.DemoWebMailLogin),this.DemoWebMailPassword=Utils.pString(e.DemoWebMailPassword),this.GoogleAnalyticsAccount=e.GoogleAnalyticsAccount,this.ShowQuotaBar=!!e.ShowQuotaBar,this.ServerUseUrlRewrite=!!e.ServerUseUrlRewrite,this.AllowLanguageOnLogin=!bMobileApp&&!!e.AllowLanguageOnLogin,this.FlagsLangSelect=!!e.FlagsLangSelect,this.DefaultLanguage=Utils.pString(e.DefaultLanguage),this.LoginDescription=Utils.pString(e.LoginDescription),this.CustomLoginUrl=Utils.pString(e.CustomLoginUrl),this.CustomLogoutUrl=Utils.pString(e.CustomLogoutUrl),this.IosDetectOnLogin=!!e.IosDetectOnLogin,this.AllowContactsSharing=!!e.AllowContactsSharing,""!==e.DefaultLanguageShort&&(this.DefaultLanguageShort=e.DefaultLanguageShort),this.DefaultTab=e.DefaultTab,this.AllowIosProfile=!!e.AllowIosProfile,this.PasswordMinLength=e.PasswordMinLength,this.PasswordMustBeComplex=!!e.PasswordMustBeComplex},CUserSettingsModel.prototype.fillDefaultFontName=function(){var e=Utils.pString(AppData.HtmlEditorDefaultFontName);""!==e&&(this.DefaultFontName=e)},CUserSettingsModel.prototype.fillDefaultFontSize=function(){var e=Utils.pInt(AppData.HtmlEditorDefaultFontSize);-1!==Utils.inArray(e,[2,3,5,7])&&(this.DefaultFontSize=e)},CUserSettingsModel.prototype.getSaveMailInSentItems=function(){var e=!0;switch(this.SaveMail){case Enums.SaveMail.Unchecked:e=!1;break;case Enums.SaveMail.Checked:case Enums.SaveMail.Hidden:e=!0}return e},CUserSettingsModel.prototype.getUseSaveMailInSentItems=function(){var e=!1;switch(this.SaveMail){case Enums.SaveMail.Unchecked:case Enums.SaveMail.Checked:e=!0;break;case Enums.SaveMail.Hidden:e=!1}return e},CUserSettingsModel.prototype.parse=function(e){var t=null;null!==e&&(this.IdUser=Utils.pInt(e.IdUser),this.MailsPerPage=Utils.pInt(e.MailsPerPage),this.ContactsPerPage=Utils.pInt(e.ContactsPerPage),this.AutoCheckMailInterval=Utils.pInt(e.AutoCheckMailInterval),this.DefaultTheme=Utils.pString(e.DefaultTheme),this.DefaultLanguage=Utils.pString(e.DefaultLanguage),this.DefaultLanguageShort=Utils.pString(e.DefaultLanguageShort),this.DefaultDateFormat=Utils.pString(e.DefaultDateFormat),this.defaultTimeFormat(Utils.pString(e.DefaultTimeFormat)),this.ThreadsEnabled=!!e.ThreadsEnabled,this.useThreads(!!e.UseThreads),this.SaveRepliedToCurrFolder=!!e.SaveRepliedMessagesToCurrentFolder,this.DesktopNotifications=!!e.DesktopNotifications,this.EmailNotification=Utils.pString(e.EmailNotification),this.AllowChangeInputDirection=!!e.AllowChangeInputDirection,this.AllowCompose=!!e.AllowCompose,this.AllowReply=!!e.AllowReply,this.AllowForward=!!e.AllowForward,this.SaveMail=Utils.pInt(e.SaveMail),this.AllowFetcher=!!e.AllowFetcher,this.OutlookSyncEnable=!!e.OutlookSyncEnable,this.MobileSyncEnable=!!e.MobileSyncEnable,this.ShowPersonalContacts=!!e.ShowPersonalContacts,this.ShowGlobalContacts=!!e.ShowGlobalContacts,this.ShowContacts=this.ShowPersonalContacts||this.ShowGlobalContacts,this.IsFilesSupported=!!e.IsFilesSupported&&!bMobileApp,this.filesEnable(!!e.FilesEnable&&!bMobileApp),this.IsHelpdeskSupported=!!e.IsHelpdeskSupported&&!bMobileApp,this.IsHelpdeskAgent=!!e.IsHelpdeskAgent,this.helpdeskSignature(Utils.pString(e.HelpdeskSignature)),this.helpdeskSignatureEnable(e.HelpdeskSignatureEnable?"1":"0"),this.LastLogin=Utils.pInt(e.LastLogin),this.LoginsCount=Utils.pInt(e.LoginsCount),this.SocialName=Utils.pString(e.SocialName),this.AllowCalendar=!!e.AllowCalendar&&!bMobileApp,this.CalendarSharing=!!e.CalendarSharing,this.CalendarAppointments=!!e.CalendarAppointments,this.IsDemo=!!e.IsDemo,this.AllowVoice=!!e.AllowVoice,this.SipRealm=e.SipRealm,this.SipWebsocketProxyUrl=e.SipWebsocketProxyUrl,this.SipOutboundProxyUrl=e.SipOutboundProxyUrl,this.SipCallerID=e.SipCallerID,this.SipImpi=e.SipImpi,this.SipImpu=e.SipImpu,this.SipPassword=e.SipPassword,this.VoiceProvider=e.VoiceProvider,this.AllowHelpdeskNotifications=e.AllowHelpdeskNotifications,this.IsCollaborationSupported=!!e.IsCollaborationSupported,this.AllowFilesSharing=!!e.AllowFilesSharing,this.enableOpenPgp(!!e.EnableOpenPgp),this.AllowAutosaveInDrafts=!!e.AllowAutosaveInDrafts&&(AppData.App?AppData.App.AutoSave:!1),t=e.Calendar,t&&(this.CalendarShowWeekEnds=!!t.ShowWeekEnds,this.CalendarShowWorkDay=!!t.ShowWorkDay,this.CalendarWorkDayStarts=Utils.pInt(t.WorkDayStarts),this.CalendarWorkDayEnds=Utils.pInt(t.WorkDayEnds),this.CalendarWeekStartsOn=Utils.pInt(t.WeekStartsOn),this.CalendarDefaultTab=Utils.pInt(t.DefaultTab)),this.SocialAccounts(e.SocialAccounts),this.CanLoginWithPassword=!!e.CanLoginWithPassword)},CUserSettingsModel.prototype.updateCommonSettings=function(e,t,i,s,o,n,r,a,l,h,c,p){var u=this.defaultTimeFormat()!==r;this.MailsPerPage=e,this.ContactsPerPage=t,this.AutoCheckMailInterval=i,App.MailCache.setAutocheckmailTimer(),this.DefaultTheme=s,this.DefaultLanguage=o,this.DefaultDateFormat=n,this.defaultTimeFormat(r),this.useThreads("1"===a),this.SaveRepliedToCurrFolder="1"===l,this.AllowChangeInputDirection="1"===c,this.DesktopNotifications="1"===h,this.EmailNotification=p,u&&App.nowDateNumber.valueHasMutated()},CUserSettingsModel.prototype.updateOpenPgpSettings=function(e,t){this.enableOpenPgp("1"===e),this.AllowAutosaveInDrafts="1"===t},CUserSettingsModel.prototype.updateCalendarSettings=function(e,t,i,s,o,n){this.CalendarShowWeekEnds=e,this.CalendarShowWorkDay=t,this.CalendarWorkDayStarts=i,this.CalendarWorkDayEnds=s,this.CalendarWeekStartsOn=o,this.CalendarDefaultTab=n},CUserSettingsModel.prototype.updateHelpdeskSettings=function(e,t,i){this.AllowHelpdeskNotifications=e,this.helpdeskSignature(t),this.helpdeskSignatureEnable(i)},CUserSettingsModel.prototype.onUserSettingsGetSyncResponse=function(e){e.Result?(this.mobileSync(e.Result.Mobile),this.outlookSync(e.Result.Outlook)):App.Api.showErrorByCode(e)},CUserSettingsModel.prototype.requestSyncSettings=function(){(null===this.mobileSync()||null===this.outlookSync())&&App.Ajax.send({Action:"UserSettingsGetSync"},this.onUserSettingsGetSyncResponse,this)},CAccountModel.prototype.init=function(e,t,i){this.id(e),this.email(t),this.friendlyName(i),this.signature(new CSignatureModel)},CAccountModel.prototype.onAccountGetQuotaResponse=function(e){e&&e.Result&&_.isArray(e.Result)&&1<e.Result.length&&(this.quota(Utils.pInt(e.Result[1])),this.usedSpace(Utils.pInt(e.Result[0])),App.MailCache.quotaChangeTrigger(!App.MailCache.quotaChangeTrigger())),this.quotaRecieved(!0)},CAccountModel.prototype.updateQuotaParams=function(){var e={Action:"AccountGetQuota",AccountID:this.id()};AppData.App&&AppData.App.ShowQuotaBar&&this.allowMail()&&App.Ajax.send(e,this.onAccountGetQuotaResponse,this)},CAccountModel.prototype.parse=function(e,t){this.init(parseInt(e.AccountID,10),Utils.pString(e.Email),Utils.pString(e.FriendlyName)),this.allowMail(!!e.AllowMail),this.passwordSpecified(!!e.IsPasswordSpecified),this.signature().parse(this.id(),e.Signature),this.isCurrent(t===this.id()),this.isEdited(t===this.id())},CAccountModel.prototype.requestExtensions=function(){if(!this.extensionsRequested()&&App.Ajax){var e=window.jstz?window.jstz.determine():null;App.Ajax.send({AccountID:this.id(),Action:"SystemIsAuth",ClientTimeZone:e?e.name():""},this.onSystemIsAuthResponse,this)}},CAccountModel.prototype.onSystemIsAuthResponse=function(e){var t=!!e.Result,i=t?e.Result.Extensions:[];t&&(this.setExtensions(i),this.extensionsRequested(!0))},CAccountModel.prototype.setExtensions=function(e){_.isArray(e)&&this.extensions(e)},CAccountModel.prototype.extensionExists=function(e){return-1===_.indexOf(this.extensions(),e)?!1:!0},CAccountModel.prototype.allowMailAfterConfiguring=function(){this.allowMail()||(this.passwordSpecified()&&App.Screens.showPopup(AlertPopup,[Utils.i18n("SETTINGS/ACCOUNTS_WARNING_AFTER_CONFIG_MAIL_HTML",{EMAIL:this.email()}),null,Utils.i18n("SETTINGS/ACCOUNTS_WARNING_AFTER_CONFIG_MAIL_TITLE",{EMAIL:this.email()})]),this.allowMail(!0),App.MailCache.getFolderList(this.id()))},CAccountModel.prototype.updateExtended=function(e){e&&(this.isExtended(!0),Utils.isNormal(e.FriendlyName)&&this.friendlyName(e.FriendlyName),Utils.isNormal(e.IncomingMailLogin)&&this.incomingMailLogin(e.IncomingMailLogin),Utils.isNormal(e.IncomingMailServer)&&this.incomingMailServer(e.IncomingMailServer),Utils.isNormal(e.IncomingMailPort)&&this.incomingMailPort(e.IncomingMailPort),Utils.isNormal(e.IncomingMailSsl)&&this.incomingMailSsl(!!e.IncomingMailSsl),Utils.isNormal(e.IsInternal)&&this.isInternal(e.IsInternal),Utils.isNormal(e.IsLinked)&&this.isLinked(e.IsLinked),Utils.isNormal(e.IsDefault)&&this.isDefault(e.IsDefault),Utils.isNormal(e.OutgoingMailAuth)&&this.outgoingMailAuth(e.OutgoingMailAuth),Utils.isNormal(e.OutgoingMailLogin)&&this.outgoingMailLogin(e.OutgoingMailLogin),Utils.isNormal(e.OutgoingMailServer)&&this.outgoingMailServer(e.OutgoingMailServer),Utils.isNormal(e.OutgoingMailPort)&&this.outgoingMailPort(e.OutgoingMailPort),Utils.isNormal(e.OutgoingMailSsl)&&this.outgoingMailSsl(!!e.OutgoingMailSsl),this.setExtensions(e.Extensions))
},CAccountModel.prototype.changeAccount=function(){AppData.Accounts.changeCurrentAccount(this.id(),!0)},CAccountModel.prototype.getDefaultIdentity=function(){return _.find(this.identities()||[],function(e){return e.isDefault()})},CAccountModel.prototype.getFetchersIdentitiesEmails=function(){var e=this.fetchers()?this.fetchers().collection():[],t=this.identities()||[],i=[];return _.each(e,function(e){i.push(e.email())}),_.each(t,function(e){i.push(e.email())}),i},CAccountModel.prototype.remove=function(e){var t=_.bind(this.confirmedRemove,this);this.canBeRemoved()&&(this.fAfterRemoveHandler=e,App.Screens.showPopup(ConfirmPopup,[this.removeConfirmation(),t,this.email()]))},CAccountModel.prototype.confirmedRemove=function(e){var t={Action:"AccountDelete",AccountIDToDelete:this.id()};e?App.Ajax.send(t,this.onAccountDeleteResponse,this):this.fAfterRemoveHandler=void 0},CAccountModel.prototype.onAccountDeleteResponse=function(e){e.Result?(App.Api.closeComposePopup(),AppData.Accounts.deleteAccount(this.id()),this.isDefault()?Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!0):"function"==typeof this.fAfterRemoveHandler&&(this.fAfterRemoveHandler(),this.fAfterRemoveHandler=void 0)):App.Api.showErrorByCode(e,Utils.i18n("WARNING/REMOVING_ACCOUNT_ERROR"))},CAccountModel.prototype.requestFilters=function(){var e={Action:"AccountSieveFiltersGet",AccountID:this.id()};App.Ajax.send(e,this.onAccountSieveFiltersGetResponse,this)},CAccountModel.prototype.onAccountSieveFiltersGetResponse=function(e){var t=new CSieveFiltersModel,i=Utils.pInt(e.AccountID);t.parse(i,e.Result),this.filters(t)},CAccountListModel.prototype.checkIfMailAllowed=function(){var e=this.getCurrent();this.isCurrentAllowsMail(e.allowMail())},CAccountListModel.prototype.unlockEditedWhenCurrentChange=function(){this.bLockEditedWhenCurrentChange=!1},CAccountListModel.prototype.changeCurrentAccount=function(e,t){var i=this.getCurrent(),s=this.getAccount(e);s&&this.currentId()!==e&&(i.isCurrent(!1),this.currentId(e),s.isCurrent(!0),t&&App.Routing.setHash(App.Links.inbox()))},CAccountListModel.prototype.changeEditedAccount=function(e){var t=this.getEdited(),i=this.getAccount(e);i&&this.editedId()!==e&&(t.isEdited(!1),this.editedId(e),i.isEdited(!0))},CAccountListModel.prototype.parse=function(e,t){var i=null,s=!1,o=null,n=null;_.isArray(t)&&this.collection(_.map(t,function(t){var i=new CAccountModel;return i.parse(t,e),i.id()===e&&(s=!0),i})),!s&&this.collection.length>0&&(i=this.collection()[0],e=i.id(),s=!0),s&&(this.defaultId(e),o=this.getDefault(),o.allowMail()||(n=_.find(this.collection(),function(e){return e.allowMail()})),n?(this.currentId(n.id()),this.editedId(e)):(this.currentId(e),this.editedId(e)),_.defer(function(){o.isDefault(!0)}))},CAccountListModel.prototype.hasMailAccount=function(){var e=_.find(this.collection(),function(e){return e.allowMail()},this);return!!e},CAccountListModel.prototype.getAccount=function(e){var t=_.find(this.collection(),function(t){return t.id()===e},this);return t},CAccountListModel.prototype.getCurrent=function(){return this.getAccount(this.currentId())},CAccountListModel.prototype.getDefault=function(){return this.getAccount(this.defaultId())},CAccountListModel.prototype.getEdited=function(){return this.getAccount(this.editedId())},CAccountListModel.prototype.getEmail=function(e){e=e||this.currentId();var t="",i=this.getAccount(e);return i&&(t=i.email()),t},CAccountListModel.prototype.addAccount=function(e){var t=this.getCurrent();this.collection.push(e),t.allowMail()||this.changeCurrentAccount(e.id(),!1)},CAccountListModel.prototype.deleteAccount=function(e){this.currentId()===e&&this.changeCurrentAccount(this.defaultId(),!1),this.editedId()===e&&this.changeEditedAccount(this.defaultId()),this.collection.remove(function(t){return t.id()===e})},CAccountListModel.prototype.hasAccountWithId=function(e){var t=_.find(this.collection(),function(t){return t.id()===e},this);return!!t},CAccountListModel.prototype.populateFetchersIdentities=function(){this.populateFetchers(),this.populateIdentities()},CAccountListModel.prototype.populateFetchers=function(){AppData.User.AllowFetcher&&App.Ajax.send({Action:"AccountFetcherGetList",AccountID:AppData.Accounts.defaultId()},this.onAccountFetcherGetListResponse,this)},CAccountListModel.prototype.onAccountFetcherGetListResponse=function(e){var t=null,i=this.getDefault();Utils.isNonEmptyArray(e.Result)&&(t=new CFetcherListModel,t.parse(AppData.Accounts.defaultId(),e.Result)),i.fetchers(t)},CAccountListModel.prototype.populateIdentities=function(){AppData.AllowIdentities&&(this.isCurrentAllowsMail()||this.collection().length>1)&&App.Ajax.send({Action:"AccountIdentitiesGet"},this.onAccountIdentitiesGetResponse,this)},CAccountListModel.prototype.onAccountIdentitiesGetResponse=function(e){var t={};Utils.isNonEmptyArray(e.Result)&&_.each(e.Result,function(e){var i=new CIdentityModel,s=-1;i.parse(e),s=i.accountId(),t[s]||(t[s]=[]),t[s].push(i)}),_.each(this.collection(),function(e){var i=t[e.id()],s=new CIdentityModel;Utils.isNonEmptyArray(i)||(i=[]),s.parse({"@Object":"Object/CIdentity",Loyal:!0,Default:!_.find(i,function(e){return e.isDefault()}),Email:e.email(),Enabled:!0,FriendlyName:e.friendlyName(),IdAccount:e.id(),IdIdentity:1e5*e.id(),Signature:e.signature()?e.signature().signature():"",UseSignature:e.signature()?!!e.signature().options():!1}),i.unshift(s),e.identities(i)})},CAccountListModel.prototype.populateIdentitiesFromSourceAccount=function(e){e&&_.each(this.collection(),function(t){var i=e.getAccount(t.id());i&&(t.fetchers(i.fetchers()),t.identities(i.identities()),t.signature(i.signature()))})},CAccountListModel.prototype.getAccountsEmails=function(){return _.uniq(_.map(AppData.Accounts.collection(),function(e){return e.email()}))},CAccountListModel.prototype.getAllFullEmails=function(){var e=[];return _.each(this.collection(),function(t){t&&(e.push(t.fullEmail()),t.fetchers()&&Utils.isNonEmptyArray(t.fetchers().collection())&&_.each(t.fetchers().collection(),function(t){t.isOutgoingEnabled()&&""!==t.fullEmail()&&e.push(t.fullEmail())}),Utils.isNonEmptyArray(t.identities())&&_.each(t.identities(),function(t){e.push(t.fullEmail())}))}),e},CAccountListModel.prototype.getCurrentFetchersAndFiltersFolderNames=function(){var e=this.getCurrent(),t=[];return e&&(e.filters()&&_.each(e.filters().collection(),function(e){t.push(e.folder())},this),e.fetchers()&&_.each(e.fetchers().collection(),function(e){t.push(e.folder())},this)),t},CAccountListModel.prototype.getAttendee=function(e){var t=[],i="";return _.each(this.collection(),function(e){t=e.isCurrent()?_.union(e.email(),e.getFetchersIdentitiesEmails(),t):_.union(t,e.email(),e.getFetchersIdentitiesEmails())}),t=_.uniq(t),_.each(t,_.bind(function(t){if(""===i){var s=_.find(e,function(e){return e===t});s===t&&(i=t)}},this)),i},CAddressModel.prototype.parse=function(e){null!==e&&(this.sName=Utils.pString(e.DisplayName),this.sEmail=Utils.pString(e.Email),this.sDisplay=this.sName.length>0?this.sName:this.sEmail,this.sFull=Utils.Address.getFullEmail(this.sName,this.sEmail))},CAddressModel.prototype.getEmail=function(){return this.sEmail},CAddressModel.prototype.getName=function(){return this.sName},CAddressModel.prototype.getDisplay=function(){return this.sDisplay},CAddressModel.prototype.getFull=function(){return this.sFull},CAddressListModel.prototype.parse=function(e){this.aCollection=_.map(e,function(e){var t=new CAddressModel;return t.parse(e),t})},CAddressListModel.prototype.addCollection=function(e){_.each(e,function(e){var t=_.find(this.aCollection,function(t){return e.sEmail===t.sEmail});t||this.aCollection.push(e)},this)},CAddressListModel.prototype.excludeCollection=function(e){_.each(e,function(e){this.aCollection=_.filter(this.aCollection,function(t){return e.sEmail!==t.sEmail})},this)},CAddressListModel.prototype.getFirstEmail=function(){return this.aCollection.length>0?this.aCollection[0].getEmail():""},CAddressListModel.prototype.getFirstName=function(){return this.aCollection.length>0?this.aCollection[0].getName():""},CAddressListModel.prototype.getFirstDisplay=function(){return this.aCollection.length>0?this.aCollection[0].getDisplay():""},CAddressListModel.prototype.getDisplay=function(e,t){var i=_.map(this.aCollection,function(i){return e&&t===i.sEmail?e:i.getDisplay(e)});return i.join(", ")},CAddressListModel.prototype.getFull=function(){var e=_.map(this.aCollection,function(e){return e.getFull()});return e.join(", ")},CAddressListModel.prototype.getEmails=function(){var e=_.map(this.aCollection,function(e){return e.getEmail()});return e},CDateModel.prototype.parse=function(e){this.iTimeStampInUTC=e,this.oMoment=moment.unix(this.iTimeStampInUTC)},CDateModel.prototype.setDate=function(e,t,i){this.oMoment=moment([e,t,i])},CDateModel.prototype.getTimeFormat=function(){return AppData.User.defaultTimeFormat()===Enums.TimeFormat.F24?"HH:mm":"hh:mm A"},CDateModel.prototype.getFullDate=function(){return this.oMoment?this.oMoment.format("ddd, MMM D, YYYY, "+this.getTimeFormat()):""},CDateModel.prototype.getMidDate=function(){return this.getShortDate(!0)},CDateModel.prototype.getShortDate=function(e){var t="",i=null;return this.oMoment&&(i=moment(),i.format("L")===this.oMoment.format("L")?t=this.oMoment.format(this.getTimeFormat()):(t=i.clone().subtract(1,"days").format("L")===this.oMoment.format("L")?Utils.i18n("DATETIME/YESTERDAY"):this.oMoment.format(i.year()===this.oMoment.year()?"MMM D":"MMM D, YYYY"),(Utils.isUnd(e)?1:!e)||(t+=", "+this.oMoment.format(this.getTimeFormat())))),t},CDateModel.prototype.getDate=function(){return this.oMoment?this.oMoment.format("ddd, MMM D, YYYY"):""},CDateModel.prototype.getTime=function(){return this.oMoment?this.oMoment.format(this.getTimeFormat()):""},CDateModel.prototype.convertDate=function(e){var t=Utils.getDateFormatForMoment(AppData.User.DefaultDateFormat)+" "+this.getTimeFormat();return moment(1e3*e).format(t)},CDateModel.prototype.getTimeStampInUTC=function(){return this.iTimeStampInUTC},CIdentityModel.prototype.parse=function(e){"Object/CIdentity"===e["@Object"]&&(this.loyal(!!e.Loyal),this.isDefault(!!e.Default),this.enabled(!!e.Enabled),this.email(Utils.pString(e.Email)),this.friendlyName(Utils.pString(e.FriendlyName)),this.accountId(Utils.pInt(e.IdAccount)),this.id(Utils.pInt(e.IdIdentity)),this.signature(Utils.pString(e.Signature)),this.useSignature(!!e.UseSignature))},CCommonFileModel.prototype.dataObjectName="",CCommonFileModel.prototype.isVisibleViewLink=function(){return this.uploaded()&&!this.uploadError()&&this.isViewMimeType()},CCommonFileModel.prototype.parse=function(e,t){e["@Object"]===this.dataObjectName&&(this.fileName(Utils.pString(e.FileName)),this.tempName(Utils.pString(e.TempName)),""===this.tempName()&&this.tempName(this.fileName()),this.type(Utils.pString(e.MimeType)),this.size(e.EstimatedSize?parseInt(e.EstimatedSize,10):parseInt(e.SizeInBytes,10)),this.content(Utils.pString(e.Content)),this.thumb(!!e.Thumb),this.hash(Utils.pString(e.Hash)),this.accountId(t),this.allowExpandSubFiles(!!e.Expand),this.iframedView(!!e.Iframed),this.uploadUid(this.hash()),this.uploaded(!0),Utils.isFunc(this.additionalParse)&&this.additionalParse(e))},CCommonFileModel.prototype.getInThumbQueue=function(e){this.thumbnailSessionUid(e),this.thumb()&&(!this.linked||this.linked&&!this.linked())&&Utils.thumbQueue(this.thumbnailSessionUid(),this.thumbnailLink(),this.thumbnailSrc)},CCommonFileModel.prototype.downloadFile=function(e){this.allowDownload()&&(e&&e.Api&&e.Api.downloadByUrl||(e=App),e&&this.downloadLink().length>0&&"#"!==this.downloadLink()&&e.Api.downloadByUrl(this.downloadLink()))},CCommonFileModel.prototype.onFileExpandResponse=function(e){this.subFiles([]),Utils.isNonEmptyArray(e.Result)&&(_.each(e.Result,_.bind(function(e){var t=this.getInstance();e["@Object"]=this.dataObjectName,t.parse(e,this.accountId()),this.subFiles.push(t)},this)),this.subFilesLoaded(!0),this.subFilesCollapsed(!0)),this.subFilesStartedLoading(!1)},CCommonFileModel.prototype.expandFile=function(){this.subFilesLoaded()?this.subFilesCollapsed(!0):(this.subFilesStartedLoading(!0),App.Ajax.send({Action:"FileExpand",RawKey:this.hash()},this.onFileExpandResponse,this))},CCommonFileModel.prototype.collapseFile=function(){this.subFilesCollapsed(!1)},CCommonFileModel.prototype.getInstance=function(){return new CCommonFileModel},CCommonFileModel.prototype.importFile=function(){var e=this.content(),t=_.bind(function(t){t&&App.Screens.showPopup(CImportOpenPgpKeyPopup,[t,e])},this);App.Api.pgp(t,AppData.User.IdUser)},CCommonFileModel.prototype.downloadOrViewByIconClick=function(e,t,i){""!==this.oembed()?this.viewFile(e,t):this.allowSelect()||this.downloadFile(i)},CCommonFileModel.prototype.viewFile=function(e,t){Utils.calmEvent(t),this.viewCommonFile()},CCommonFileModel.prototype.openLink=function(){Utils.WindowOpener.openTab(this.viewLink())},CCommonFileModel.prototype.viewCommonFile=function(){var e=Utils.Common.getAppPath()+this.viewLink(),t=null;this.visibleViewLink()&&this.viewLink().length>0&&"#"!==this.viewLink()&&(this.isLink()&&(e=this.linkUrl()),""!==this.oembedHtml()?App.Api.showPlayer(this.oembedHtml()):t=this.iframedView()?Utils.WindowOpener.openTab(e):Utils.WindowOpener.open(e,e,!1),t&&t.focus())},CCommonFileModel.prototype.eventDragStart=function(e,t){var i=t.originalEvent||t;return e&&i&&i.dataTransfer&&i.dataTransfer.setData&&i.dataTransfer.setData("DownloadURL",this.generateTransferDownloadUrl()),!0},CCommonFileModel.prototype.generateTransferDownloadUrl=function(){var e=this.downloadLink();return"http"!==e.substr(0,4)&&(e=Utils.Common.getAppPath()+e),this.type()+":"+this.fileName()+":"+e},CCommonFileModel.prototype.onUploadSelect=function(e,t){this.fileName(Utils.pString(t.FileName)),this.type(Utils.pString(t.Type)),this.size(Utils.pInt(t.Size)),this.uploadUid(e),this.uploaded(!1),this.visibleSpinner(!1),this.statusText(""),this.progressPercent(0),this.visibleProgress(!1)},CCommonFileModel.prototype.onUploadStart=function(){this.visibleSpinner(!0),this.visibleProgress(!0)},CCommonFileModel.prototype.onUploadProgress=function(e,t){t>0&&(this.progressPercent(Math.ceil(e/t*100)),this.visibleProgress(!0))},CCommonFileModel.prototype.onUploadComplete=function(e,t,i){var s=!(t&&i&&!i.Error),o=Utils.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN");if(this.visibleSpinner(!1),this.progressPercent(0),this.visibleProgress(!1),this.uploaded(!0),this.uploadError(s),s&&i)switch(i.Error){case"size":o=Utils.i18n("COMPOSE/UPLOAD_ERROR_SIZE");break;case"exception":110===i.ErrorCode&&(o=Utils.i18n("FILESTORAGE/UPLOAD_ERROR_MAXPATHLEN"))}this.statusText(s?o:Utils.i18n("COMPOSE/UPLOAD_COMPLETE")),s||(this.fillDataAfterUploadComplete(i,e),setTimeout(function(e){return function(){e.statusText("")}}(this),3e3))},CCommonFileModel.prototype.fillDataAfterUploadComplete=function(){},CCommonFileModel.prototype.onImageLoad=function(){this.thumb()&&!this.thumbnailLoaded()&&(this.thumbnailLoaded(!0),Utils.thumbQueue(this.thumbnailSessionUid()))},Utils.extend(CMailAttachmentModel,CCommonFileModel),CMailAttachmentModel.prototype.dataObjectName="Object/CApiMailAttachment",CMailAttachmentModel.prototype.getInstance=function(){return new CMailAttachmentModel},CMailAttachmentModel.prototype.getCopy=function(){var e=new CMailAttachmentModel;return e.copyProperties(this),e},CMailAttachmentModel.prototype.copyProperties=function(e){this.fileName(e.fileName()),this.tempName(e.tempName()),this.size(e.size()),this.accountId(e.accountId()),this.hash(e.hash()),this.type(e.type()),this.cid(e.cid()),this.contentLocation(e.contentLocation()),this.inline(e.inline()),this.linked(e.linked()),this.thumb(e.thumb()),this.thumbnailSrc(e.thumbnailSrc()),this.thumbnailLoaded(e.thumbnailLoaded()),this.statusText(e.statusText()),this.uploaded(e.uploaded()),this.iframedView(e.iframedView())},CMailAttachmentModel.prototype.isVisibleViewLink=function(){return this.uploaded()&&!this.uploadError()&&(this.isViewMimeType()||this.isMessageType())},CMailAttachmentModel.prototype.additionalParse=function(e){this.mimePartIndex(Utils.pString(e.MimePartIndex)),this.cid(Utils.pString(e.CID)),this.contentLocation(Utils.pString(e.ContentLocation)),this.inline(!!e.IsInline),this.linked(!!e.IsLinked)},CMailAttachmentModel.prototype.setMessageData=function(e,t){this.folderName(e),this.messageUid(t)},CMailAttachmentModel.prototype.onMessageGetResponse=function(e){if(this.oNewWindow){var t=e.Result,i=new CMessageModel;t?(i.parse(t,e.AccountID,!1,!0),this.messagePart(i),this.messagePart().viewMessage(this.oNewWindow)):this.oNewWindow.close(),this.oNewWindow=void 0}},CMailAttachmentModel.prototype.viewFile=function(){this.isMessageType()?this.viewMessageFile():this.viewCommonFile()},CMailAttachmentModel.prototype.viewMessageFile=function(){var e=null,t='<div style="margin: 30px; text-align: center; font: normal 14px Tahoma;">'+Utils.i18n("MAIN/LOADING")+"</div>";e=Utils.WindowOpener.open("",this.fileName()),e&&(this.messagePart()?this.messagePart().viewMessage(e):($(e.document.body).html(t),this.oNewWindow=e,App.Ajax.send({Action:"MessageGet",Folder:this.folderName(),Uid:this.messageUid(),Rfc822MimeIndex:this.mimePartIndex()},this.onMessageGetResponse,this)),e.focus())},CMailAttachmentModel.prototype.viewCommonFile=function(){var e=null,t=Utils.Common.getAppPath()+this.viewLink();this.visibleViewLink()&&this.viewLink().length>0&&"#"!==this.viewLink()&&(t=Utils.Common.getAppPath()+this.viewLink(),e=this.iframedView()?Utils.WindowOpener.openTab(t):Utils.WindowOpener.open(t,t,!1),e&&e.focus())},CMailAttachmentModel.prototype.fillDataAfterUploadComplete=function(e,t){this.cid(t),this.tempName(e.Result.Attachment.TempName),this.type(e.Result.Attachment.MimeType),this.size(e.Result.Attachment.Size),this.hash(e.Result.Attachment.Hash),this.iframedView(e.Result.Attachment.Iframed),this.accountId(e.AccountID)},CMailAttachmentModel.prototype.parseFromUpload=function(e,t){this.fileName(e.Name.toString()),this.tempName(e.TempName?e.TempName.toString():this.fileName()),this.type(e.MimeType.toString()),this.size(parseInt(e.Size,10)),this.hash(e.Hash),this.accountId(t),this.uploadUid(this.hash()),this.uploaded(!0),this.uploadStarted(!1)},CMailAttachmentModel.prototype.errorFromUpload=function(){this.uploaded(!0),this.uploadError(!0),this.uploadStarted(!1),this.statusText(Utils.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN"))},CFolderModel.prototype.setLevel=function(e){this.iLevel=e},CFolderModel.prototype.getMessageByUid=function(e){return this.oMessages[e]},CFolderModel.prototype.getFlaggedMessageUids=function(){var e=[];return _.each(this.oMessages,function(t){t.flagged()&&e.push(t.uid())}),e},CFolderModel.prototype.setMessageUnflaggedByUid=function(e){var t=this.oMessages[e];t&&t.flagged(!1)},CFolderModel.prototype.hideThreadMessages=function(e){_.each(e.threadUids(),function(e){var t=this.oMessages[e];t&&(t.deleted()||(t.threadShowAnimation(!1),t.threadHideAnimation(!0),setTimeout(function(){t.threadHideAnimation(!1)},1e3)))},this)},CFolderModel.prototype.getThreadMessages=function(e){var t=[],i=[],s=[],o=0,n=null,r=50;return _.each(e.threadUids(),function(a){if(o<e.threadCountForLoad()){var l=this.oMessages[a];l?l.deleted()||(l.markAsThreadPart(r,e.uid()),t.push(l),s.push(l.uid()),o++,n=l):(i.push(a),s.push(a),o++)}else s.push(a)},this),e.threadLoading()||this.loadThreadMessages(i),e.changeThreadUids(s,t.length),n&&t.length<e.threadUids().length&&n.showNextLoadingLink(_.bind(e.increaseThreadCountForLoad,e)),this.addThreadUidsToUidLists(e.uid(),e.threadUids()),t},CFolderModel.prototype.computeThreadData=function(e){var t=0,i=!1,s=[],o=[],n=e.oFrom.getFirstEmail();_.each(e.threadUids(),function(e){var r=this.oMessages[e],a="";r&&!r.deleted()&&(r.seen()||t++,r.flagged()&&(i=!0),a=r.oFrom.getFirstEmail(),a!==n&&-1===Utils.inArray(a,o)&&(o.push(a),s.push(a===AppData.Accounts.getEmail()?Utils.i18n("MESSAGE/ME_SENDER"):r.oFrom.getFirstDisplay())))},this),e.threadUnreadCount(t),e.partialFlagged(i),e.threadSenders(s)},CFolderModel.prototype.addThreadUidsToUidLists=function(e,t){_.each(this.oUids,function(i){_.each(i,function(i){i.addThreadUids(e,t)})})},CFolderModel.prototype.loadThreadMessages=function(e){if(e.length>0){var t={Action:"MessagesGetListByUids",Folder:this.fullName(),Uids:e};App.Ajax.send(t,this.onMessagesGetListByUidsResponse,this)}},CFolderModel.prototype.getThreadCheckedUidsFromList=function(e){var t=this,i=[];return _.each(e,function(e){e.threadCount()>0&&!e.threadOpened()&&_.each(e.threadUids(),function(e){var s=t.oMessages[e];s&&!s.deleted()&&s.checked()&&i.push(e)})}),i},CFolderModel.prototype.parseAndCacheMessage=function(e,t,i){var s=e.Uid.toString(),o=Utils.isUnd(this.oMessages[s]),n=o?new CMessageModel:this.oMessages[s];return n.parse(e,this.iAccountId,t,i),this.type()===Enums.FolderTypes.Inbox&&o&&n.flagged()&&App.MailCache.increaseStarredCount(),this.oMessages[n.uid()]=n,n},CFolderModel.prototype.onMessagesGetListByUidsResponse=function(e){var t=e.Result;t&&"Collection/MessageCollection"===t["@Object"]&&(_.each(t["@Collection"],function(e){this.parseAndCacheMessage(e,!0,!0)},this),App.MailCache.showOpenedThreads(this.fullName()))},CFolderModel.prototype.addRequestedUids=function(e){this.aRequestedUids=_.union(this.aRequestedUids,e)},CFolderModel.prototype.hasUidBeenRequested=function(e){return-1!==_.indexOf(this.aRequestedUids,e)},CFolderModel.prototype.addRequestedThreadUids=function(e){this.aRequestedThreadUids=_.union(this.aRequestedThreadUids,e)},CFolderModel.prototype.hasThreadUidBeenRequested=function(e){return-1!==_.indexOf(this.aRequestedThreadUids,e)},CFolderModel.prototype.hasListBeenRequested=function(e){var t=_.where(this.requestedLists,e),i=t.length>0;return i||this.requestedLists.push(e),i},CFolderModel.prototype.markMessageReplied=function(e,t){var i=this.oMessages[e];if(i)switch(t){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:i.answered(!0);break;case Enums.ReplyType.Forward:i.forwarded(!0)}},CFolderModel.prototype.removeAllMessages=function(){var e=null;this.oMessages={},this.oUids={},this.messageCount(0),this.unseenMessageCount(0),this.sRealUnseenMessageCount=0,e=this.getUidList("",""),e.resultCount(0)},CFolderModel.prototype.removeAllMessageListsFromCacheIfHasChanges=function(){this.hasChanges()&&(this.oUids={},this.requestedLists=[],this.aRequestedThreadUids=[],this.hasChanges(!1))},CFolderModel.prototype.removeFlaggedMessageListsFromCache=function(){_.each(this.oUids,function(e,t){delete this.oUids[t][Enums.FolderFilter.Flagged]},this)},CFolderModel.prototype.removeUnseenMessageListsFromCache=function(){_.each(this.oUids,function(e,t){delete this.oUids[t][Enums.FolderFilter.Unseen]},this)},CFolderModel.prototype.setRelevantInformation=function(e,t,i,s,o){var n=this.hasExtendedInfo()&&(this.sHash!==t||this.sRealUnseenMessageCount!==s);return o||(this.sUidNext=e),this.sHash=t,this.hasExtendedInfo()&&o||(this.messageCount(i),this.unseenMessageCount(s),0===s&&this.unseenMessageCount.valueHasMutated()),this.sRealUnseenMessageCount=s,this.hasExtendedInfo(!0),n&&this.markHasChanges(),this.relevantInformationLastMoment=moment(),n},CFolderModel.prototype.increaseCountIfHasNotInfo=function(){this.hasExtendedInfo()||this.messageCount(this.messageCount()+1)},CFolderModel.prototype.markHasChanges=function(){this.hasChanges(!0)},CFolderModel.prototype.addMessagesCountsDiff=function(e,t){var i=this.messageCount()+e,s=this.unseenMessageCount()+t;0>i&&(i=0),this.messageCount(i),0>s&&(s=0),s>i&&(s=i),this.unseenMessageCount(s)},CFolderModel.prototype.markDeletedByUids=function(e){var t=0,i=0;return _.each(e,function(e){var s=this.oMessages[e];s&&(t++,s.seen()||i++,s.deleted(!0))},this),this.addMessagesCountsDiff(-t,-i),{MinusDiff:t,UnseenMinusDiff:i}},CFolderModel.prototype.revertDeleted=function(e){var t=0,i=0;return _.each(e,function(e){var s=this.oMessages[e];s&&s.deleted()&&(t++,s.seen()||i++,s.deleted(!1))},this),this.addMessagesCountsDiff(t,i),{PlusDiff:t,UnseenPlusDiff:i}},CFolderModel.prototype.commitDeleted=function(e){_.each(e,_.bind(function(e){delete this.oMessages[e]},this)),_.each(this.oUids,function(t){_.each(t,function(t){t.deleteUids(e)})})},CFolderModel.prototype.getUidList=function(e,t){var i=null;return void 0===this.oUids[e]&&(this.oUids[e]={}),void 0===this.oUids[e][t]&&(i=new CUidListModel,i.search(e),i.filters(t),this.oUids[e][t]=i),this.oUids[e][t]},CFolderModel.prototype.initStarredFolder=function(e,t){this.bVirtual=!0,this.setLevel(e),this.fullName(t),this.name(Utils.i18n("MAIN/FOLDER_STARRED")),this.type(Enums.FolderTypes.Starred),this.initSubscriptions(""),this.initComputedFields(!0)},CFolderModel.prototype.parse=function(e,t,i,s){var o="",n=App.Storage.getData("folderAccordion")||[];return"Object/Folder"===e["@Object"]?(o=Utils.pString(e.Name),this.name(o),this.nameForEdit(o),this.fullName(Utils.pString(e.FullNameRaw)),this.fullNameHash(Utils.pString(e.FullNameHash)),this.sDelimiter=e.Delimiter,this.type(e.Type),this.bNamespace=s===this.fullName(),this.subscribed(e.IsSubscribed),this.bSelectable=e.IsSelectable,this.bExists=e.Exists,e.Extended&&this.setRelevantInformation(e.Extended.UidNext.toString(),e.Extended.Hash,e.Extended.MessageCount,e.Extended.MessageUnseenCount,!1),_.find(n,function(e){return e===this.name()},this)&&this.expanded(!0),this.initSubscriptions(t),this.initComputedFields(i),e.SubFolders):null},CFolderModel.prototype.initSubscriptions=function(e){this.unseenMessageCount.subscribe(function(){_.delay(_.bind(function(){App.MailCache.countMessages(this)},this),1e3)},this),this.subscribed.subscribe(function(){if(e){var t=App.MailCache.folderList().getFolderByFullName(e);t&&App.MailCache.countMessages(t)}},this),this.edited.subscribe(function(e){e===!1&&this.nameForEdit(this.name())},this),this.hasChanges.subscribe(function(){this.requestedLists=[]},this)},CFolderModel.prototype.initComputedFields=function(e){this.routingHash=ko.computed(function(){return App.Routing.buildHashFromArray(this.bVirtual?App.Links.mailbox(this.fullName(),1,"","",Enums.FolderFilter.Flagged):[Enums.Screens.Mailbox,this.fullName()])},this),this.isSystem=ko.computed(function(){return this.type()!==Enums.FolderTypes.User},this),this.showUnseenMessages=ko.computed(function(){return this.type()!==Enums.FolderTypes.Drafts},this),this.withoutThreads=ko.computed(function(){return this.type()===Enums.FolderTypes.Drafts||this.type()===Enums.FolderTypes.Spam||this.type()===Enums.FolderTypes.Trash},this),this.enableEmptyFolder=ko.computed(function(){return(this.type()===Enums.FolderTypes.Spam||this.type()===Enums.FolderTypes.Trash)&&this.messageCount()>0},this),this.virtualEmpty=ko.computed(function(){return this.bVirtual&&0===this.messageCount()},this),this.hasSubscribedSubfolders=ko.computed(function(){return _.any(this.subfolders(),function(e){return e.subscribed()})},this),this.canExpand=ko.computed(function(){return!this.bNamespace&&this.hasSubscribedSubfolders()},this),this.messageCountToShow=ko.computed(function(){return this.canExpand()?this.showUnseenMessages()?this.unseenMessageCount()+this.subfoldersMessagesCount():this.messageCount():this.showUnseenMessages()?this.unseenMessageCount():this.messageCount()},this),this.visible=ko.computed(function(){return this.subscribed()||this.isSystem()||this.hasSubscribedSubfolders()&&(!this.bExists||!this.bSelectable)},this),this.bCanBeSelected=this.bExists&&this.bSelectable,this.canSubscribe=ko.computed(function(){return!e&&!this.isSystem()&&this.bCanBeSelected},this),this.canDelete=ko.computed(function(){return!this.isSystem()&&this.hasExtendedInfo()&&0===this.messageCount()&&0===this.subfolders().length},this),this.canRename=ko.computed(function(){return this.bCanBeSelected&&!this.isSystem()},this),this.subscribeButtonHint=ko.computed(function(){return this.canSubscribe()?Utils.i18n(this.subscribed()?"SETTINGS/ACCOUNT_FOLDERS_HIDE_FOLDER_HINT":"SETTINGS/ACCOUNT_FOLDERS_SHOW_FOLDER_HINT"):""},this),this.deleteButtonHint=ko.computed(function(){return this.canDelete()?Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_DELETE_FOLDER_HINT"):""},this),this.usedAs=ko.computed(function(){switch(this.type()){case Enums.FolderTypes.Inbox:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_INBOX");case Enums.FolderTypes.Sent:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_SENT");case Enums.FolderTypes.Drafts:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_DRAFTS");case Enums.FolderTypes.Trash:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_TRASH");case Enums.FolderTypes.Spam:return Utils.i18n("SETTINGS/ACCOUNT_FOLDERS_USED_AS_SPAM")}return""},this),this.displayName=ko.computed(function(){switch(this.type()){case Enums.FolderTypes.Inbox:return Utils.i18n("MAIN/FOLDER_INBOX");case Enums.FolderTypes.Sent:return Utils.i18n("MAIN/FOLDER_SENT");case Enums.FolderTypes.Drafts:return Utils.i18n("MAIN/FOLDER_DRAFTS");case Enums.FolderTypes.Trash:return Utils.i18n("MAIN/FOLDER_TRASH");case Enums.FolderTypes.Spam:return Utils.i18n("MAIN/FOLDER_SPAM")}return this.name()},this),this.unseenMessagesTitle=ko.computed(function(){return this.showUnseenMessages()?Utils.i18n("MAILBOX/TITLE_UNSEEN_MESSAGES_ONLY"):""},this)},CFolderModel.prototype.onMessageGetResponse=function(e,t){var i=e.Result,s=null,o=i?i.Uid.toString():t.Uid.toString(),n=this.oMessages[o],r=n?n.selected():!1;i?(n=this.parseAndCacheMessage(i,!1,!1),n&&n.ical()&&n.ical().isReplyType()&&App.CalendarCache&&App.CalendarCache.calendarChanged(!0)):(r&&(App.Api.showErrorByCode(e,Utils.i18n("WARNING/UNKNOWN_ERROR")),App.Routing.replaceHashWithoutMessageUid(o)),n=null),s=this.aResponseHandlers[o],s&&(s.handler.call(s.context,n,o),delete this.aResponseHandlers[o])},CFolderModel.prototype.getCompletelyFilledMessage=function(e,t,i){var s=this.oMessages[e],o={Action:"MessageGet",Folder:this.fullName(),Uid:e};e.length>0&&(s&&s.completelyFilled()&&!s.trimmed()?t&&i&&t.call(i,s,e):(t&&i&&(this.aResponseHandlers[e]={handler:t,context:i}),App.Ajax.send(o,this.onMessageGetResponse,this)))},CFolderModel.prototype.showExternalPictures=function(e){var t=this.oMessages[e];void 0!==t&&t.showExternalPictures()},CFolderModel.prototype.alwaysShowExternalPicturesForSender=function(e){_.each(this.oMessages,function(t){var i=t.oFrom.aCollection;i.length>0&&i[0].sEmail===e&&t.alwaysShowExternalPicturesForSender()},this)},CFolderModel.prototype.executeGroupOperation=function(e,t,i){var s=0;_.each(this.oMessages,function(o){t.length>0?_.each(t,function(t){o&&o.uid()===t&&o[e]()!==i&&(o[e](i),s++)}):o[e](i)}),0===t.length&&(s=i?this.unseenMessageCount():this.messageCount()-this.unseenMessageCount()),"seen"===e&&s>0&&(i?this.addMessagesCountsDiff(0,-s):this.addMessagesCountsDiff(0,s),this.markHasChanges())},CFolderModel.prototype.emptyFolder=function(){var e=Utils.i18n("MAILBOX/CONFIRM_EMPTY_FOLDER"),t=_.bind(this.clearFolder,this);this.enableEmptyFolder()&&App.Screens.showPopup(ConfirmPopup,[e,t])},CFolderModel.prototype.clearFolder=function(e){var t={Action:"FolderClear",Folder:this.fullName()};this.enableEmptyFolder()&&e&&(App.Ajax.send(t),this.removeAllMessages(),App.MailCache.onClearFolder(this))},CFolderModel.prototype.getNameWhithLevel=function(){var e=this.iLevel;return!this.bNamespace&&e>0&&e--,Utils.strRepeat(" ",3*e)+this.name()},CFolderModel.prototype.onAccordion=function(e,t){var i=!this.expanded(),s=App.Storage.getData("folderAccordion")||[];i?s.push(this.name()):s=_.reject(s,function(e){return e===this.name()},this),App.Storage.setData("folderAccordion",s),this.expanded(i),App.MailCache.countMessages(this),t&&t.stopPropagation()},CFolderModel.prototype.executeUnseenFilter=function(){var e=!1;return this.messageCountToShow()>this.unseenMessageCount()&&this.onAccordion(),this.showUnseenMessages()&&this.unseenMessageCount()>0?(App.MailCache.waitForUnseenMessages(!0),e=App.Routing.setHash(App.Links.mailbox(this.fullName(),1,"","",Enums.FolderFilter.Unseen)),e&&App.MailCache.changeCurrentMessageList(this.fullName(),1,"",Enums.FolderFilter.Unseen),!1):!0},CFolderListModel.prototype.getTotalMessageCount=function(){var e=0;
return _.each(this.oNamedCollection,function(t){e+=t.messageCount()},this),e},CFolderListModel.prototype.getFoldersWithoutCountInfo=function(){var e=_.compact(_.map(this.oNamedCollection,function(e,t){return e.bCanBeSelected&&!e.hasExtendedInfo()?t:null}));return e},CFolderListModel.prototype.setCurrentFolder=function(e,t){var i=this.getFolderByFullName(e);null===i&&(i=this.inboxFolder()),null!==i&&(this.currentFolder()&&(this.currentFolder().selected(!1),this.oStarredFolder&&this.oStarredFolder.selected(!1)),this.currentFolder(i),t===Enums.FolderFilter.Flagged?this.oStarredFolder&&this.oStarredFolder.selected(!0):this.currentFolder().selected(!0))},CFolderListModel.prototype.getFolderByFullName=function(e){var t=this.oNamedCollection[e];return t?t:null},CFolderListModel.prototype.parse=function(e,t,i){var s=Utils.pString(t.Namespace);s.length>0&&(this.sNamespaceFolder=s.substring(0,s.length-1)),this.iAccountId=e,this.bInitialized(!0),this.expandFolders(AppData.MailExpandFolders&&!App.Storage.hasData("folderAccordion")),App.Storage.hasData("folderAccordion")||App.Storage.setData("folderAccordion",[]),this.oNamedCollection={},this.aLinedCollection=[],this.collection(this.parseRecursively(t["@Collection"],i))},CFolderListModel.prototype.parseRecursively=function(e,t,i,s){var o=this,n=[],r=0,a=0,l=null,h=null,c="",p=null,u=[],d=this.expandFolders(),m=AppData.Accounts.getAccount(this.iAccountId),g=m.extensionExists("DisableManageSubscribe"),f=function(){var e=o.spamFolder();m&&m.extensionExists("AllowSpamFolderExtension")||(e.type(Enums.FolderTypes.User),o.spamFolder(null))},b=function(){m&&m.extensionsRequested()&&(f(),m.extensionsRequestedSubscription.dispose(),m.extensionsRequestedSubscription=void 0)};if(s=s||"",Utils.isUnd(i)&&(i=-1),i++,_.isArray(e)){for(a=e.length;a>r;r++){switch(c=Utils.pString(e[r].FullNameRaw),h=t[c],l=new CFolderModel(this.iAccountId),p=l.parse(e[r],s,g,this.sNamespaceFolder),h&&h.hasExtendedInfo()&&!l.hasExtendedInfo()&&l.setRelevantInformation(h.sUidNext,h.sHash,h.messageCount(),h.unseenMessageCount(),!1),d&&null!==p&&(l.expanded(!0),this.expandNames().push(Utils.pString(e[r].Name))),l.setLevel(i),l.type()){case Enums.FolderTypes.Inbox:this.inboxFolder(l),this.sDelimiter=l.sDelimiter;break;case Enums.FolderTypes.Sent:this.sentFolder(l);break;case Enums.FolderTypes.Drafts:this.draftsFolder(l);break;case Enums.FolderTypes.Trash:this.trashFolder(l);break;case Enums.FolderTypes.Spam:this.spamFolder(l),m.extensionsRequested()?f():m.extensionsRequestedSubscription=m.extensionsRequested.subscribe(b)}this.oNamedCollection[l.fullName()]=l,this.aLinedCollection.push(l),n.push(l),null===p&&l.type()===Enums.FolderTypes.Inbox?(this.createStarredFolder(l.fullName(),i),this.oStarredFolder&&n.push(this.oStarredFolder)):null!==p&&(u=this.parseRecursively(p["@Collection"],t,i,l.fullName()),l.type()===Enums.FolderTypes.Inbox&&(l.bNamespace?(this.createStarredFolder(l.fullName(),i+1),this.oStarredFolder&&u.unshift(this.oStarredFolder)):(this.createStarredFolder(l.fullName(),i),this.oStarredFolder&&n.push(this.oStarredFolder))),l.subfolders(u))}d&&App.Storage.setData("folderAccordion",this.expandNames())}return n},CFolderListModel.prototype.createStarredFolder=function(e,t){this.oStarredFolder=new CFolderModel(this.iAccountId),this.oStarredFolder.initStarredFolder(t,e)},CFolderListModel.prototype.repopulateLinedCollection=function(){function e(i){_.each(i,function(i){t.aLinedCollection.push(i),i.subfolders().length>0&&e(i.subfolders())})}var t=this;return this.aLinedCollection=[],e(this.collection()),this.aLinedCollection},CFolderListModel.prototype.getOptions=function(e,t,i,s,o){t=t||!1,i=i||!1,s=s||!1,o=o||!1;var n="    ",r=[];return _.each(this.aLinedCollection,function(e){if(!(!e||e.bVirtual||i&&Enums.FolderTypes.Inbox===e.type()||o&&!e.subscribed())){var a=new Array(e.iLevel+1).join(n);r.push({name:e.name(),fullName:e.fullName(),displayName:a+e.name(),translatedDisplayName:a+e.displayName(),disable:!t&&e.isSystem()||!s&&!e.bCanBeSelected})}}),""!==e&&r.unshift({name:e,fullName:"",displayName:e,translatedDisplayName:e,disable:!1}),r},CFolderListModel.prototype.deleteFolder=function(e){var t=function(i){return e&&e.fullName()===i.fullName()?!0:(i.subfolders.remove(t),!1)};this.collection.remove(t)},CMessageModel.prototype.viewMessage=function(e){var t=this.getDomText(Utils.Common.getAppPath()),i="";this.textBodyForNewWindow(t.html()),i=$(this.domMessageForPrint()).html(),e&&($(e.document.body).html(i),e.focus(),_.each(this.attachments(),function(t){var i=$(e.document.body).find("[data-hash='download-"+t.hash()+"']");i.on("click",_.bind(t.downloadFile,t,App)),i=$(e.document.body).find("[data-hash='view-"+t.hash()+"']"),i.on("click",_.bind(t.viewFile,t))},this))},CMessageModel.prototype.fillFromOrToText=function(){var e=App.MailCache.getFolderByFullName(this.accountId(),this.folder()),t=AppData.Accounts.getAccount(this.accountId());this.fromOrToText(e.type()===Enums.FolderTypes.Drafts||e.type()===Enums.FolderTypes.Sent?this.oTo.getDisplay(Utils.i18n("MESSAGE/ME_RECIPIENT"),t.email()):this.oFrom.getDisplay(Utils.i18n("MESSAGE/ME_SENDER"),t.email()))},CMessageModel.prototype.changeThreadUids=function(e,t){this.threadUids(e),this.threadLoading(t<Math.min(this.threadUids().length,this.threadCountForLoad()))},CMessageModel.prototype.showNextLoadingLink=function(e){this.threadNextLoadingLinkVisible()&&(this.threadNextLoadingVisible(!0),this.threadFunctionLoadNext=e)},CMessageModel.prototype.increaseThreadCountForLoad=function(){this.threadCountForLoad(this.threadCountForLoad()+15),App.MailCache.showOpenedThreads(this.folder())},CMessageModel.prototype.loadNextMessages=function(){this.threadFunctionLoadNext&&(this.threadFunctionLoadNext(),this.threadNextLoadingLinkVisible(!1),this.threadFunctionLoadNext=null)},CMessageModel.prototype.markAsThreadPart=function(e,t){var i=this;this.threadPart(!0),this.threadParentUid(t),this.threadUids([]),this.threadNextLoadingVisible(!1),this.threadNextLoadingLinkVisible(!0),this.threadFunctionLoadNext=null,this.threadHideAnimation(!1),setTimeout(function(){i.threadShowAnimation(!0)},e)},CMessageModel.prototype.parse=function(e,t,i,s){var o=null,n=null,r="",a="";s&&this.threadPart(i),this.threadPart()||this.threadParentUid(""),"Object/MessageListItem"===e["@Object"]&&(this.seen(!!e.IsSeen),this.flagged(!!e.IsFlagged),this.answered(!!e.IsAnswered),this.forwarded(!!e.IsForwarded),e.Custom&&(this.Custom=e.Custom)),("Object/Message"===e["@Object"]||"Object/MessageListItem"===e["@Object"])&&(this.accountId(t),this.folder(e.Folder),this.uid(Utils.pString(e.Uid)),this.subject(Utils.pString(e.Subject)),this.messageId(Utils.pString(e.MessageId)),this.size(e.Size),this.textSize(e.TextSize),this.oDateModel.parse(e.TimeStampInUTC),this.oFrom.parse(e.From),this.oTo.parse(e.To),this.fillFromOrToText(),this.oCc.parse(e.Cc),this.oBcc.parse(e.Bcc),this.oSender.parse(e.Sender),this.oReplyTo.parse(e.ReplyTo),this.fullDate(this.oDateModel.getFullDate()),this.fullFrom(this.oFrom.getFull()),this.to(this.oTo.getFull()),this.cc(this.oCc.getFull()),this.bcc(this.oBcc.getFull()),this.hasAttachments(!!e.HasAttachments),this.hasIcalAttachment(!!e.HasIcalAttachment),this.hasVcardAttachment(!!e.HasVcardAttachment),"Object/MessageListItem"===e["@Object"]&&s&&this.threadUids(_.map(e.Threads,function(e){return e.toString()},this)),this.importance(e.Priority),_.isArray(e.DraftInfo)&&this.draftInfo(e.DraftInfo),this.sensitivity(e.Sensitivity),this.hash(Utils.pString(e.Hash)),"Object/Message"===e["@Object"]&&(this.trimmed(e.Trimmed),this.trimmedTextSize(e.TrimmedTextSize),this.inReplyTo(e.InReplyTo),this.references(e.References),this.readingConfirmation(e.ReadingConfirmation),r=Utils.pString(e.Html),a=Utils.pString(e.Plain),""!==r?(this.text(r),this.isPlain(!1)):(this.textRaw(e.PlainRaw),-1!==this.textRaw().indexOf("-----BEGIN PGP MESSAGE-----")?(this.text("<pre>"+Utils.encodeHtml(this.textRaw())+"</pre>"),this.encryptedMessage(!0)):-1!==this.textRaw().indexOf("-----BEGIN PGP SIGNED MESSAGE-----")?(this.text("<pre>"+Utils.encodeHtml(this.textRaw())+"</pre>"),this.signedMessage(!0)):this.text(""!==a?"<div>"+a+"</div>":""),this.isPlain(!0)),this.$text=null,this.isExternalsShown(!1),this.rtl(e.Rtl),this.hasExternals(!!e.HasExternals),this.foundCids(e.FoundedCIDs),this.parseAttachments(e.Attachments,t),this.safety(e.Safety),this.sourceHeaders(e.Headers),null!==e.ICAL&&(o=new CIcalModel,o.parse(e.ICAL,AppData.Accounts.getAttendee(this.oTo.getEmails())),this.ical(o)),null!==e.VCARD&&(n=new CVcardModel,n.parse(e.VCARD),this.vcard(n)),this.completelyFilled(!0)),this.updateMomentDate())},CMessageModel.prototype.updateMomentDate=function(){this.date(this.oDateModel.getShortDate(moment().clone().subtract(1,"days").format("L")===moment.unix(this.oDateModel.getTimeStampInUTC()).format("L")))},CMessageModel.prototype.getDomText=function(e,t){var i=this.$text;return e=e||"",(null===this.$text||""!==e)&&(this.completelyFilled()?(this.$text=$(this.text()),this.showInlinePictures(e),this.safety()===!0&&this.alwaysShowExternalPicturesForSender(),t&&this.isExternalsShown()&&this.showExternalPictures(),i=this.$text):i=$("")),i.clone()},CMessageModel.prototype.getConvertedHtml=function(e,t){var i=this.getDomText(e,t);return i.length>0?i.wrap("<p>").parent().html():""},CMessageModel.prototype.parseAttachments=function(e,t){if(_.isArray(e)){var i=Date.now().toString();this.attachments(_.map(e,function(e){var s=new CMailAttachmentModel;return s.parse(e,t),s.getInThumbQueue(i),s.setMessageData(this.folder(),this.uid()),s},this))}},CMessageModel.prototype.parseAddressArray=function(e){var t=[];return _.isArray(e)&&(t=_.map(e,function(e){var t=new CAddressModel;return t.parse(e),t})),t},CMessageModel.prototype.showInlinePictures=function(e){var t=_.map(this.attachments(),function(e){return{CID:e.cid(),ContentLocation:e.contentLocation(),ViewLink:e.viewLink()}});Utils.Message.showInlinePictures(this.$text,t,this.foundCids(),e)},CMessageModel.prototype.showExternalPictures=function(){Utils.Message.showExternalPictures(this.$text),this.isExternalsShown(!0)},CMessageModel.prototype.alwaysShowExternalPicturesForSender=function(){this.completelyFilled()&&(this.isExternalsAlwaysShown(!0),this.isExternalsShown()||this.showExternalPictures())},CMessageModel.prototype.openThread=function(){if(this.threadCountVisible()){var e=this.folder();this.threadOpened(!this.threadOpened()),this.threadOpened()?App.MailCache.showOpenedThreads(e):(App.MailCache.hideThreads(this),setTimeout(function(){App.MailCache.showOpenedThreads(e)},500))}},CMessageModel.prototype.downloadAllAttachments=function(){if(""!==this.allAttachmentsHash)App.Api.downloadByUrl(Utils.getDownloadLinkByHash(this.accountId(),this.allAttachmentsHash));else{var e=_.filter(this.attachments(),function(e){return!e.linked()}),t=_.map(e,function(e){return e.hash()});App.Ajax.send({Action:"MessageAttachmentsZip",Hashes:t},this.onMessageZipAttachments,this)}},CMessageModel.prototype.onMessageZipAttachments=function(e){e.Result&&(this.allAttachmentsHash=e.Result,App.Api.downloadByUrl(Utils.getDownloadLinkByHash(this.accountId(),this.allAttachmentsHash)))},CMessageModel.prototype.saveAttachmentsToFiles=function(){var e=_.filter(this.attachments(),function(e){return!e.linked()}),t=_.map(e,function(e){return e.hash()});App.filesRecievedAnim(!0),App.Ajax.send({Action:"MessageAttachmentsSaveToFiles",Attachments:t},this.onMessageAttachmentsSaveToFilesResponse,this)},CMessageModel.prototype.onMessageAttachmentsSaveToFilesResponse=function(e,t){var i=0,s=t.Attachments.length;e.Result&&_.each(t.Attachments,function(t){void 0!==e.Result[t]&&i++}),0===i?App.Api.showError(Utils.i18n("MESSAGE/ERROR_ATTACHMENTS_SAVED_TO_FILES")):s>i?App.Api.showError(Utils.i18n("MESSAGE/WARNING_ATTACHMENTS_SAVED_TO_FILES",{SAVED_COUNT:i,TOTAL_COUNT:s})):App.Api.showReport(Utils.i18n("MESSAGE/REPORT_ATTACHMENTS_SAVED_TO_FILES"))},CMessageModel.prototype.downloadAllAttachmentsSeparately=function(){_.each(this.attachments(),function(e){e.linked()||e.downloadFile(App)})},CMessageModel.prototype.toJSON=function(){return{uid:this.uid(),accountId:this.accountId(),to:this.to(),subject:this.subject(),threadPart:this.threadPart(),threadUids:this.threadUids(),threadOpened:this.threadOpened()}},CUidListModel.prototype.addThreadUids=function(e,t){-1!==_.indexOf(this.collection(),e)&&(this.threadUids[e]=t)},CUidListModel.prototype.setUidsAndCount=function(e){"Collection/MessageCollection"===e["@Object"]&&(_.each(e.Uids,function(t,i){this.collection()[i+e.Offset]=t.toString()},this),this.resultCount(e.MessageResultCount))},CUidListModel.prototype.getUidsForOffset=function(e,t){for(var i=0,s=this.collection().length,o="",n=0,r=[],a=null;s>i;i++)i>=e&&n<AppData.User.MailsPerPage&&(o=this.collection()[i],a=t[o],(a&&!a.deleted()||void 0===o)&&(n++,void 0!==o&&r.push(o)));return r},CUidListModel.prototype.deleteUids=function(e){for(var t=0,i=this.collection().length,s="",o=[],n=0;i>t;t++)s=this.collection()[t],-1===_.indexOf(e,s)?o.push(s):n++;this.collection(o),this.resultCount(this.resultCount()-n)},CIcalModel.prototype.fillDecisions=function(){var e=AppData.Accounts.getCurrent(),t=e?e.email():"";switch(this.cancelDecision(Utils.i18n("MESSAGE/APPOINTMENT_CANCELED",{SENDER:t})),this.icalConfig()){case Enums.IcalConfig.Accepted:this.replyDecision(Utils.i18n("MESSAGE/APPOINTMENT_ACCEPTED",{ATTENDEE:this.attendee()}));break;case Enums.IcalConfig.Declined:this.replyDecision(Utils.i18n("MESSAGE/APPOINTMENT_DECLINED",{ATTENDEE:this.attendee()}));break;case Enums.IcalConfig.Tentative:this.replyDecision(Utils.i18n("MESSAGE/APPOINTMENT_TENTATIVELY_ACCEPTED",{ATTENDEE:this.attendee()}))}},CIcalModel.prototype.parse=function(e,t){var i="";e&&"Object/CApiMailIcs"===e["@Object"]&&(i=Utils.pString(e.Description),this.uid(Utils.pString(e.Uid)),this.sSequence=Utils.pInt(e.Sequence),this.file(Utils.pString(e.File)),this.attendee(Utils.pString(e.Attendee)||t),this.type(e.Type),this.location(Utils.pString(e.Location)),this.description(i.replace(/\r/g,"").replace(/\n/g,"<br />")),this.when(Utils.pString(e.When)),this.calendarId(Utils.pString(e.CalendarId)),this.selectedCalendarId(Utils.pString(e.CalendarId)),App.CalendarCache.addIcal(this))},CIcalModel.prototype.acceptAppointment=function(){this.calendarId(this.selectedCalendarId()),this.changeAndSaveConfig(Enums.IcalConfig.Accepted)},CIcalModel.prototype.tentativeAppointment=function(){this.calendarId(this.selectedCalendarId()),this.changeAndSaveConfig(Enums.IcalConfig.Tentative)},CIcalModel.prototype.declineAppointment=function(){this.calendarId(""),this.selectedCalendarId(""),this.changeAndSaveConfig(Enums.IcalConfig.Declined)},CIcalModel.prototype.changeAndSaveConfig=function(e){this.icalConfig()!==e&&(this.icalConfig()===e||e===Enums.IcalConfig.Declined&&this.icalConfig()===Enums.IcalConfig.NeedsAction||App.CalendarCache.recivedAnim(!0),this.changeConfig(e),this.setAppointmentAction())},CIcalModel.prototype.changeConfig=function(e){this.type(this.icalType()+"-"+e),AppData.SingleMode&&window.opener?window.opener.App.CalendarCache.markIcalTypeByFile(this.file(),this.type(),this.cancelDecision(),this.replyDecision(),this.calendarId(),this.selectedCalendarId()):App.CalendarCache.markIcalTypeByFile(this.file(),this.type(),this.cancelDecision(),this.replyDecision(),this.calendarId(),this.selectedCalendarId())},CIcalModel.prototype.onCalendarAppointmentSetActionResponse=function(e){e.Result?App.CalendarCache&&App.CalendarCache.calendarChanged(!0):App.Api.showErrorByCode(e,Utils.i18n("WARNING/UNKNOWN_ERROR"))},CIcalModel.prototype.setAppointmentAction=function(){var e={Action:"CalendarAppointmentSetAction",AppointmentAction:this.icalConfig(),CalendarId:this.selectedCalendarId(),File:this.file(),Attendee:this.attendee()};App.Ajax.send(e,this.onCalendarAppointmentSetActionResponse,this)},CIcalModel.prototype.onCalendarSaveIcsResponse=function(e){e.Result?(e.Result.Uid&&this.uid(e.Result.Uid),App.CalendarCache&&App.CalendarCache.calendarChanged(!0)):App.Api.showErrorByCode(e)},CIcalModel.prototype.addEvent=function(){var e={Action:"CalendarSaveIcs",CalendarId:this.selectedCalendarId(),File:this.file()};App.Ajax.send(e,this.onCalendarSaveIcsResponse,this),this.isJustSaved(!0),this.calendarId(this.selectedCalendarId()),setTimeout(_.bind(function(){this.isJustSaved(!1)},this),2e4),App.CalendarCache.recivedAnim(!0)},CIcalModel.prototype.onEventDelete=function(){this.calendarId(""),this.selectedCalendarId(""),this.changeConfig(Enums.IcalConfig.NeedsAction)},CIcalModel.prototype.onEventTentative=function(){this.changeConfig(Enums.IcalConfig.Tentative)},CIcalModel.prototype.onEventAccept=function(){this.changeConfig(Enums.IcalConfig.Accepted)},CIcalModel.prototype.firstCalendarName=function(){return this.calendars()[0]?this.calendars()[0].name:""},CIcalModel.prototype.updateAttendeeStatus=function(e){if(this.icalType()===Enums.IcalType.Cancel||this.icalType()===Enums.IcalType.Reply){var t={Action:"CalendarAttendeeUpdateStatus",File:this.file(),FromEmail:e};App.Ajax.send(t,this.onCalendarAttendeeUpdateStatusResponse,this)}},CIcalModel.prototype.onCalendarAttendeeUpdateStatusResponse=function(e){e.Result&&App.CalendarCache&&(App.CalendarCache.recivedAnim(!0),App.CalendarCache.calendarChanged(!0))},CVcardModel.prototype.parse=function(e){e&&"Object/CApiMailVcard"===e["@Object"]&&(this.uid(Utils.pString(e.Uid)),this.file(Utils.pString(e.File)),this.name(Utils.pString(e.Name)),this.email(Utils.pString(e.Email)),this.exists(!!e.Exists),App.ContactsCache.addVcard(this))},CVcardModel.prototype.onContactsSaveVcfResponse=function(e){e&&e.Result&&e.Result.Uid&&this.uid(e.Result.Uid)},CVcardModel.prototype.addContact=function(){var e={Action:"ContactsSaveVcf",File:this.file()};App.Ajax.send(e,this.onContactsSaveVcfResponse,this),this.isJustSaved(!0),this.exists(!0),setTimeout(_.bind(function(){this.isJustSaved(!1)},this),2e4),App.ContactsCache.recivedAnim(!0),AppData.SingleMode&&window.opener?window.opener.App.ContactsCache.markVcardExistentByFile(this.file()):App.ContactsCache.markVcardExistentByFile(this.file())},CContactModel.birthdayMonths=Utils.getMonthNamesArray(),CContactModel.birthdayMonthSelect=[{text:Utils.i18n("DATETIME/MONTH"),value:"0"},{text:CContactModel.birthdayMonths[0],value:"1"},{text:CContactModel.birthdayMonths[1],value:"2"},{text:CContactModel.birthdayMonths[2],value:"3"},{text:CContactModel.birthdayMonths[3],value:"4"},{text:CContactModel.birthdayMonths[4],value:"5"},{text:CContactModel.birthdayMonths[5],value:"6"},{text:CContactModel.birthdayMonths[6],value:"7"},{text:CContactModel.birthdayMonths[7],value:"8"},{text:CContactModel.birthdayMonths[8],value:"9"},{text:CContactModel.birthdayMonths[9],value:"10"},{text:CContactModel.birthdayMonths[10],value:"11"},{text:CContactModel.birthdayMonths[11],value:"12"}],CContactModel.birthdayYearSelect=[{text:Utils.i18n("DATETIME/YEAR"),value:"0"}],CContactModel.prototype.getSendMailParts=function(e){return App.Links.composeWithToField(this.getFullEmail(e))},CContactModel.prototype.getSendMailLink=function(e){return App.Routing.buildHashFromArray(this.getSendMailParts(e))},CContactModel.prototype.sendMail=function(){return App.Api.composeMessageToAddresses(this.email()),bMobileApp},CContactModel.prototype.sendMailToPersonal=function(){return App.Api.composeMessageToAddresses(this.personalEmail()),bMobileApp},CContactModel.prototype.sendMailToBusiness=function(){return App.Api.composeMessageToAddresses(this.businessEmail()),bMobileApp},CContactModel.prototype.sendMailToOther=function(){return App.Api.composeMessageToAddresses(this.otherEmail()),bMobileApp},CContactModel.prototype.clear=function(){this.isNew(!1),this.readOnly(!1),this.idContact(""),this.idUser(""),this.global(!1),this.itsMe(!1),this.edited(!1),this.extented(!1),this.personalCollapsed(!1),this.businessCollapsed(!1),this.otherCollapsed(!1),this.groupsCollapsed(!1),this.displayName(""),this.firstName(""),this.lastName(""),this.nickName(""),this.skype(""),this.facebook(""),this.primaryEmail(this.sEmailDefaultType),this.primaryPhone(this.sPhoneDefaultType),this.primaryAddress(this.sAddressDefaultType),this.personalEmail(""),this.personalStreetAddress(""),this.personalCity(""),this.personalState(""),this.personalZipCode(""),this.personalCountry(""),this.personalWeb(""),this.personalFax(""),this.personalPhone(""),this.personalMobile(""),this.businessEmail(""),this.businessCompany(""),this.businessDepartment(""),this.businessJob(""),this.businessOffice(""),this.businessStreetAddress(""),this.businessCity(""),this.businessState(""),this.businessZipCode(""),this.businessCountry(""),this.businessWeb(""),this.businessFax(""),this.businessPhone(""),this.otherEmail(""),this.otherBirthdayMonth("0"),this.otherBirthdayDay("0"),this.otherBirthdayYear("0"),this.otherNotes(""),this.etag(""),this.sharedToAll(!1),this.groups([])},CContactModel.prototype.switchToNew=function(){this.clear(),this.edited(!0),this.extented(!1),this.isNew(!0),bMobileApp||this.displayNameFocused(!0)},CContactModel.prototype.switchToView=function(){this.edited(!1),this.extented(!1)},CContactModel.prototype.toObject=function(){var e={ContactId:this.idContact(),PrimaryEmail:this.primaryEmail(),PrimaryPhone:this.primaryPhone(),PrimaryAddress:this.primaryAddress(),UseFriendlyName:"1",Title:"",FullName:this.displayName(),FirstName:this.firstName(),LastName:this.lastName(),NickName:this.nickName(),Global:this.global()?"1":"0",ItsMe:this.itsMe()?"1":"0",Skype:this.skype(),Facebook:this.facebook(),HomeEmail:this.personalEmail(),HomeStreet:this.personalStreetAddress(),HomeCity:this.personalCity(),HomeState:this.personalState(),HomeZip:this.personalZipCode(),HomeCountry:this.personalCountry(),HomeFax:this.personalFax(),HomePhone:this.personalPhone(),HomeMobile:this.personalMobile(),HomeWeb:this.personalWeb(),BusinessEmail:this.businessEmail(),BusinessCompany:this.businessCompany(),BusinessJobTitle:this.businessJob(),BusinessDepartment:this.businessDepartment(),BusinessOffice:this.businessOffice(),BusinessStreet:this.businessStreetAddress(),BusinessCity:this.businessCity(),BusinessState:this.businessState(),BusinessZip:this.businessZipCode(),BusinessCountry:this.businessCountry(),BusinessFax:this.businessFax(),BusinessPhone:this.businessPhone(),BusinessWeb:this.businessWeb(),OtherEmail:this.otherEmail(),Notes:this.otherNotes(),ETag:this.etag(),BirthdayDay:this.otherBirthdayDay(),BirthdayMonth:this.otherBirthdayMonth(),BirthdayYear:this.otherBirthdayYear(),SharedToAll:this.sharedToAll()?"1":"0",GroupsIds:this.groups()};return e},CContactModel.prototype.parse=function(e){if(e&&"Object/CContact"===e["@Object"]){var t=0,i=0,s=0,o=[];switch(this.idContact(Utils.pExport(e,"IdContact","").toString()),this.idUser(Utils.pExport(e,"IdUser","").toString()),this.global(!!Utils.pExport(e,"Global",!1)),this.itsMe(!!Utils.pExport(e,"ItsMe",!1)),this.readOnly(!!Utils.pExport(e,"ReadOnly",!1)),this.displayName(Utils.pExport(e,"FullName","")),this.firstName(Utils.pExport(e,"FirstName","")),this.lastName(Utils.pExport(e,"LastName","")),this.nickName(Utils.pExport(e,"NickName","")),this.skype(Utils.pExport(e,"Skype","")),this.facebook(Utils.pExport(e,"Facebook","")),t=Utils.pInt(Utils.pExport(e,"PrimaryEmail",0))){case 1:t=Enums.ContactEmailType.Business;break;case 2:t=Enums.ContactEmailType.Other;break;default:case 0:t=Enums.ContactEmailType.Personal}switch(this.primaryEmail(t),i=Utils.pInt(Utils.pExport(e,"PrimaryPhone",0))){case 2:i=Enums.ContactPhoneType.Business;break;case 1:i=Enums.ContactPhoneType.Personal;break;default:case 0:i=Enums.ContactPhoneType.Mobile}switch(this.primaryPhone(i),s=Utils.pInt(Utils.pExport(e,"PrimaryAddress",0))){case 1:s=Enums.ContactAddressType.Business;break;default:case 0:s=Enums.ContactAddressType.Personal}this.primaryAddress(s),this.personalEmail(Utils.pExport(e,"HomeEmail","")),this.personalStreetAddress(Utils.pExport(e,"HomeStreet","")),this.personalCity(Utils.pExport(e,"HomeCity","")),this.personalState(Utils.pExport(e,"HomeState","")),this.personalZipCode(Utils.pExport(e,"HomeZip","")),this.personalCountry(Utils.pExport(e,"HomeCountry","")),this.personalWeb(Utils.pExport(e,"HomeWeb","")),this.personalFax(Utils.pExport(e,"HomeFax","")),this.personalPhone(Utils.pExport(e,"HomePhone","")),this.personalMobile(Utils.pExport(e,"HomeMobile","")),this.businessEmail(Utils.pExport(e,"BusinessEmail","")),this.businessCompany(Utils.pExport(e,"BusinessCompany","")),this.businessDepartment(Utils.pExport(e,"BusinessDepartment","")),this.businessJob(Utils.pExport(e,"BusinessJobTitle","")),this.businessOffice(Utils.pExport(e,"BusinessOffice","")),this.businessStreetAddress(Utils.pExport(e,"BusinessStreet","")),this.businessCity(Utils.pExport(e,"BusinessCity","")),this.businessState(Utils.pExport(e,"BusinessState","")),this.businessZipCode(Utils.pExport(e,"BusinessZip","")),this.businessCountry(Utils.pExport(e,"BusinessCountry","")),this.businessWeb(Utils.pExport(e,"BusinessWeb","")),this.businessFax(Utils.pExport(e,"BusinessFax","")),this.businessPhone(Utils.pExport(e,"BusinessPhone","")),this.otherEmail(Utils.pExport(e,"OtherEmail","")),this.otherBirthdayMonth(Utils.pExport(e,"BirthdayMonth","0").toString()),this.otherBirthdayDay(Utils.pExport(e,"BirthdayDay","0").toString()),this.otherBirthdayYear(Utils.pExport(e,"BirthdayYear","0").toString()),this.otherNotes(Utils.pExport(e,"Notes","")),this.etag(Utils.pExport(e,"ETag","")),this.sharedToAll(!!Utils.pExport(e,"SharedToAll",!1)),o=Utils.pExport(e,"GroupsIds",[]),_.isArray(o)&&this.groups(_.map(o,function(e){return Utils.pString(e)}))}},CContactModel.prototype.getFullEmail=function(e){return Utils.Address.getFullEmail(this.displayName(),e)},CContactModel.prototype.getEmailsString=function(){return _.uniq(_.without([this.email(),this.personalEmail(),this.businessEmail(),this.otherEmail()],"")).join(",")},CContactModel.prototype.viewAllMails=function(){App.MailCache.searchMessagesInInbox("email:"+this.getEmailsString())},CContactModel.prototype.sendThisContact=function(){App.Api.composeMessageWithVcard(this)},CContactModel.prototype.isStrLink=function(e){return/^http/.test(e)},CContactModel.prototype.onCallClick=function(e){App.Phone.call(e)},CContactModel.prototype.viewAllMailsWithContact=function(){var e=this.getEmailsString();AppData.SingleMode&&window.opener&&window.opener.App?(window.opener.App.MailCache.searchMessagesInCurrentFolder("email:"+e),window.opener.focus(),window.close()):App.MailCache.searchMessagesInCurrentFolder("email:"+e)},CGroupModel.prototype.clear=function(){this.isNew(!1),this.idGroup(""),this.idUser(""),this.name(""),this.nameFocused(!1),this.edited(!1),this.isOrganization(!1),this.email(""),this.country(""),this.city(""),this.company(""),this.fax(""),this.phone(""),this.state(""),this.street(""),this.web(""),this.zip(""),this.events([])},CGroupModel.prototype.populate=function(e){this.isNew(e.isNew()),this.idGroup(e.idGroup()),this.idUser(e.idUser()),this.name(e.name()),this.nameFocused(e.nameFocused()),this.edited(e.edited()),this.isOrganization(e.isOrganization()),this.email(e.email()),this.country(e.country()),this.city(e.city()),this.company(e.company()),this.fax(e.fax()),this.phone(e.phone()),this.state(e.state()),this.street(e.street()),this.web(e.web()),this.zip(e.zip())},CGroupModel.prototype.switchToNew=function(){this.clear(),this.edited(!0),this.isNew(!0),bMobileApp||this.nameFocused(!0)},CGroupModel.prototype.switchToView=function(){this.edited(!1)},CGroupModel.prototype.toObject=function(){return{GroupId:this.idGroup(),Name:this.name(),IsOrganization:this.isOrganization()?"1":"0",Email:this.email(),Country:this.country(),City:this.city(),Company:this.company(),Fax:this.fax(),Phone:this.phone(),State:this.state(),Street:this.street(),Web:this.web(),Zip:this.zip()}},CContactListItemModel.prototype.parse=function(e){e&&"Object/CContactListItem"===Utils.pExport(e,"@Object","")&&(this.sId=Utils.pString(e.Id),this.sName=Utils.pString(e.Name),this.sEmail=Utils.pString(e.Email),this.bIsGroup=!!e.IsGroup,this.bIsOrganization=!!e.IsOrganization,this.bReadOnly=!!e.ReadOnly,this.bItsMe=!!e.ItsMe,this.bGlobal=!!e.Global,this.bSharedToAll=!!e.SharedToAll,this.groupType(this.getGroupType(e)))},CContactListItemModel.prototype.IsGroup=function(){return this.bIsGroup},CContactListItemModel.prototype.Global=function(){return this.bGlobal},CContactListItemModel.prototype.ReadOnly=function(){return this.bReadOnly},CContactListItemModel.prototype.ItsMe=function(){return this.bItsMe},CContactListItemModel.prototype.Id=function(){return this.sId},CContactListItemModel.prototype.Name=function(){return this.sName},CContactListItemModel.prototype.Email=function(){return this.sEmail},CContactListItemModel.prototype.EmailAndName=function(){return Utils.Address.getFullEmail(this.sName,this.sEmail)},CContactListItemModel.prototype.IsSharedToAll=function(){return this.bSharedToAll},CContactListItemModel.prototype.IsOrganization=function(){return this.bIsOrganization},CContactListItemModel.prototype.getGroupType=function(e){return e.SharedToAll?Enums.ContactsGroupListType.SharedToAll:e.Global?Enums.ContactsGroupListType.Global:e.Global?null:Enums.ContactsGroupListType.Personal},CSignatureModel.prototype.parse=function(e,t){this.iAccountId=e,this.options(parseInt(t.Options,10)),this.signature(t.Signature)},CAutoresponderModel.prototype.parse=function(e,t){this.iAccountId=e,this.enable=!!t.Enable,this.subject=Utils.pString(t.Subject),this.message=Utils.pString(t.Message)},CFetcherModel.prototype.parse=function(e){this.id(Utils.pInt(e.IdFetcher)),this.accountId(Utils.pInt(e.IdAccount)),this.isEnabled(!!e.IsEnabled),this.isLocked(!!e.IsLocked),this.email(Utils.pString(e.Email)),this.userName(Utils.pString(e.Name)),this.folder(Utils.pString(e.Folder)),this.signatureOptions(!!e.SignatureOptions),this.signature(Utils.pString(e.Signature)),this.incomingMailServer(Utils.pString(e.IncomingMailServer)),this.incomingMailPort(Utils.pInt(e.IncomingMailPort)),this.incomingMailSsl(!!e.IncomingMailSsl),this.incomingMailLogin(Utils.pString(e.IncomingMailLogin)),this.leaveMessagesOnServer(!!e.LeaveMessagesOnServer),this.isOutgoingEnabled(!!e.IsOutgoingEnabled),this.outgoingMailServer(Utils.pString(e.OutgoingMailServer)),this.outgoingMailPort(Utils.pInt(e.OutgoingMailPort)),this.outgoingMailSsl(!!e.OutgoingMailSsl),this.outgoingMailAuth(!!e.OutgoingMailAuth)},CFetcherListModel.prototype.parse=function(e,t){var i=_.map(t,function(e){var t=new CFetcherModel;return t.parse(e),t});this.accountId=e,this.collection(i)},CFetcherListModel.prototype.hasFetcher=function(e){return!!this.getFetcher(e)},CFetcherListModel.prototype.getFetcher=function(e){var t=_.find(this.collection(),function(t){return t.id()===e});return t||null},CForwardModel.prototype.parse=function(e,t){this.iAccountId=e,this.enable=!!t.Enable,this.email=Utils.pString(t.Email)},CSieveFiltersModel.prototype.parse=function(e,t){var i=0,s=t.length,o=null;if(this.iAccountId=e,_.isArray(t))for(s=t.length;s>i;i++)o=new CSieveFilterModel(e),o.parse(t[i]),this.collection.push(o)},CSieveFilterModel.prototype.parse=function(e){this.enable(!!e.Enable),this.field(Utils.pInt(e.Field)),this.condition(Utils.pInt(e.Condition)),this.filter(Utils.pString(e.Filter)),this.action(Utils.pInt(e.Action)),this.folder(Utils.pString(e.FolderFullName)),this.commit()},CSieveFilterModel.prototype.revert=function(){this.enable.revert(),this.field.revert(),this.condition.revert(),this.filter.revert(),this.action.revert(),this.folder.revert()},CSieveFilterModel.prototype.commit=function(){this.enable.commit(),this.field.commit(),this.condition.commit(),this.filter.commit(),this.action.commit(),this.folder.commit()},CSieveFilterModel.prototype.toString=function(){var e=[this.enable(),this.field(),this.condition(),this.filter(),this.action(),this.folder()];return e.join(":")},CInformationViewModel.prototype.showLoading=function(e){this.loadingMessage(e&&""!==e?e:Utils.i18n("MAIN/LOADING")),this.loadingVisible(!0),_.defer(_.bind(function(){this.loadingHidden(!1)
},this))},CInformationViewModel.prototype.hideLoading=function(){this.loadingHidden(!0),setTimeout(_.bind(function(){this.loadingHidden()&&this.loadingVisible(!1)},this),this.iAnimationDuration)},CInformationViewModel.prototype.showReport=function(e,t){0!==t&&(t=t||this.iReportDuration),e&&""!==e?(this.reportMessage(e),this.reportVisible(!0),_.defer(_.bind(this.reportHidden,this,!1)),clearTimeout(this.iReportTimeout),0===t?this.reportVisibleClose(!0):(this.reportVisibleClose(!1),this.iReportTimeout=setTimeout(_.bind(this.selfHideReport,this),t))):(this.reportHidden(!0),this.reportVisible(!1))},CInformationViewModel.prototype.selfHideReport=function(){this.reportHidden(!0),setTimeout(_.bind(function(){this.reportHidden()&&this.reportVisible(!1)},this),this.iAnimationDuration)},CInformationViewModel.prototype.showError=function(e,t,i,s){e&&""!==e?(this.gray(!!s),this.errorMessage(e),this.isHtmlError(t),this.errorVisible(!0),_.defer(_.bind(function(){this.errorHidden(!1)},this)),clearTimeout(this.iErrorTimeout),i||(this.iErrorTimeout=setTimeout(_.bind(function(){this.selfHideError()},this),this.iErrorDuration))):this.selfHideError()},CInformationViewModel.prototype.selfHideError=function(){this.errorHidden(!0),setTimeout(_.bind(function(){this.errorHidden()&&this.errorVisible(!1)},this),this.iAnimationDuration)},CInformationViewModel.prototype.hideError=function(e){e=Utils.isUnd(e)?!1:!!e,e===this.gray()&&this.selfHideError()},CHeaderBaseViewModel.prototype.__name="CHeaderBaseViewModel",CHeaderBaseViewModel.prototype.onRoute=function(){this.changeMailLinkText()},CHeaderBaseViewModel.prototype.changeMailLinkText=function(){var e=AppData.Accounts.getCurrent();this.mailLinkText(e.allowMail()?AppData.Accounts.getEmail():Utils.i18n("TITLE/MAILBOX_TAB"))},CHeaderBaseViewModel.prototype.logout=function(){App.logout()},CHeaderBaseViewModel.prototype.switchToFullVersion=function(){App.Ajax.send({Action:"SystemSetMobile",Mobile:0},function(){window.location.reload()},this)},_.extend(CHeaderMobileViewModel.prototype,CHeaderBaseViewModel.prototype),CPageSwitcherViewModel.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){if(this.shown&&!Utils.isTextFieldFocused()){var t=e.keyCode;e.ctrlKey&&t===Enums.Key.Left?this.clickPreviousPage():e.ctrlKey&&t===Enums.Key.Right&&this.clickNextPage()}},this))},CPageSwitcherViewModel.prototype.hide=function(){this.shown=!1},CPageSwitcherViewModel.prototype.show=function(){this.shown=!0},CPageSwitcherViewModel.prototype.clear=function(){this.currentPage(1),this.count(0)},CPageSwitcherViewModel.prototype.setCount=function(e){this.count(e),this.currentPage()>this.pagesCount()&&this.currentPage(this.pagesCount())},CPageSwitcherViewModel.prototype.setPage=function(e,t){this.perPage(t),this.currentPage(e>this.pagesCount()?this.pagesCount():e)},CPageSwitcherViewModel.prototype.clickPage=function(e){var t=e.number;1>t&&(t=1),t>this.pagesCount()&&(t=this.pagesCount()),this.currentPage(t)},CPageSwitcherViewModel.prototype.clickFirstPage=function(){this.currentPage(1)},CPageSwitcherViewModel.prototype.clickPreviousPage=function(){var e=this.currentPage()-1;1>e&&(e=1),this.currentPage(e)},CPageSwitcherViewModel.prototype.clickNextPage=function(){var e=this.currentPage()+1;e>this.pagesCount()&&(e=this.pagesCount()),this.currentPage(e)},CPageSwitcherViewModel.prototype.clickLastPage=function(){this.currentPage(this.pagesCount())},CHtmlEditorViewModel.prototype.__name="CHtmlEditorViewModel",CHtmlEditorViewModel.prototype.hasOpenedPopup=function(){return this.visibleInsertLinkPopup()||this.visibleLinkPopup()||this.visibleImagePopup()||this.visibleInsertImagePopup()||this.visibleFontColorPopup()},CHtmlEditorViewModel.prototype.resize=function(){var e=$(this.htmlEditorDom()),t=e.parent(),i=$(this.workareaDom()),s=$(this.toolbarDom());_.delay(function(){var o=i.outerWidth(!0)-i.width(),n=e.outerWidth(!0)-e.width(),r=t.width()-n,a=i.outerHeight(!0)-i.height(),l=t.height(),h=l-a-s.outerHeight();e.width(r),i.width(r-o),e.height(l),i.height(h)},1)},CHtmlEditorViewModel.prototype.init=function(){$(document.body).on("click",_.bind(function(){this.closeAllPopups(!0)},this)),this.initEditorUploader()},CHtmlEditorViewModel.prototype.correctFontFromSettings=function(){var e=this.sDefaultFont,t=!1;_.each(this.aFonts,function(i){i.toLowerCase()===e.toLowerCase()&&(e=i,t=!0)}),t?this.sDefaultFont=e:this.aFonts.push(e)},CHtmlEditorViewModel.prototype.showLinkPopup=function(e){var t=$(this.workareaDom()),i=t.closest(".panel.compose"),s=t.position(),o=e.position(),n=e.height(),r=Math.round(o.left+s.left),a=Math.round(o.top+n+s.top);this.linkHref(e.attr("href")||e.text()),$(this.linkPopupDom()).css({left:r,top:a}),$(this.linkHrefDom()).css({left:r,top:a}),App.browser.firefox||1!==i.length||$(this.linkPopupDom()).css({"max-width":i.width()-r-40+"px","white-space":"pre-line","word-wrap":"break-word"}),this.visibleLinkPopup(!0)},CHtmlEditorViewModel.prototype.hideLinkPopup=function(){this.visibleLinkPopup(!1)},CHtmlEditorViewModel.prototype.showChangeLink=function(){this.visibleLinkHref(!0),this.hideLinkPopup()},CHtmlEditorViewModel.prototype.changeLink=function(){this.oCrea.changeLink(this.linkHref()),this.hideChangeLink()},CHtmlEditorViewModel.prototype.hideChangeLink=function(){this.visibleLinkHref(!1)},CHtmlEditorViewModel.prototype.showImagePopup=function(e,t){var i=$(this.workareaDom()),s=i.position(),o=i.offset();this.imagePopupLeft(Math.round(t.pageX+s.left-o.left)),this.imagePopupTop(Math.round(t.pageY+s.top-o.top)),this.visibleImagePopup(!0)},CHtmlEditorViewModel.prototype.hideImagePopup=function(){this.visibleImagePopup(!1)},CHtmlEditorViewModel.prototype.resizeImage=function(e){var t={width:"auto",height:"auto"};switch(e){case Enums.HtmlEditorImageSizes.Small:t.width="300px";break;case Enums.HtmlEditorImageSizes.Medium:t.width="600px";break;case Enums.HtmlEditorImageSizes.Large:t.width="1200px";break;case Enums.HtmlEditorImageSizes.Original:t.width="auto"}this.oCrea.changeCurrentImage(t),this.visibleImagePopup(!1)},CHtmlEditorViewModel.prototype.onImageOver=function(e){if("IMG"===e.target.nodeName&&!this.visibleImagePopup()){this.imageSelected(!0),this.tooltipText(Utils.i18n("HTMLEDITOR/CLICK_TO_EDIT_IMAGE"));var t=this,i=$(this.workareaDom());i.bind("mousemove.image",function(e){var s=i.position(),o=i.offset();t.tooltipPopupTop(Math.round(e.pageY+s.top-o.top)),t.tooltipPopupLeft(Math.round(e.pageX+s.left-o.left))})}return!0},CHtmlEditorViewModel.prototype.onImageOut=function(){if(this.imageSelected()){this.imageSelected(!1);var e=$(this.workareaDom());e.unbind("mousemove.image")}return!0},CHtmlEditorViewModel.prototype.commit=function(){this.textChanged(!1)},CHtmlEditorViewModel.prototype.initCrea=function(e,t,i){this.oCrea||(this.init(),this.oCrea=new Crea({creaId:this.creaId,fontNameArray:this.aFonts,defaultFontName:this.sDefaultFont,defaultFontSize:this.iDefaultSize,isRtl:Utils.isRTL(),enableDrop:!1,onChange:_.bind(this.textChanged,this,!0),onCursorMove:_.bind(this.setFontValuesFromText,this),onFocus:_.bind(this.onCreaFocus,this),onBlur:_.bind(this.onCreaBlur,this),onUrlIn:_.bind(this.showLinkPopup,this),onUrlOut:_.bind(this.hideLinkPopup,this),onImageSelect:_.bind(this.showImagePopup,this),onImageBlur:_.bind(this.hideImagePopup,this),onItemOver:bMobileDevice||bMobileApp?null:_.bind(this.onImageOver,this),onItemOut:bMobileDevice||bMobileApp?null:_.bind(this.onImageOut,this),openInsertLinkDialog:_.bind(this.insertLink,this),onUrlClicked:!0}),this.oCrea.start(this.isEnable())),this.oCrea.setTabIndex(i),this.oCrea.clearUndoRedo(),this.setText(e,t),this.setFontValuesFromText(),this.uploadedImagePathes([]),this.selectedFont(this.sDefaultFont),this.selectedSize(this.iDefaultSize)},CHtmlEditorViewModel.prototype.setFocus=function(){this.oCrea&&this.oCrea.setFocus(!1)},CHtmlEditorViewModel.prototype.changeSignatureContent=function(e,t){this.oCrea&&this.oCrea.changeSignatureContent(e,t)},CHtmlEditorViewModel.prototype.setFontValuesFromText=function(){this.lockFontSubscribing(!0),this.selectedFont(this.oCrea.getFontName()),this.selectedSize(this.oCrea.getFontSizeInNumber().toString()),this.lockFontSubscribing(!1)},CHtmlEditorViewModel.prototype.isUndoAvailable=function(){return this.oCrea?this.oCrea.isUndoAvailable():!1},CHtmlEditorViewModel.prototype.getPlainText=function(){return this.oCrea?this.oCrea.getPlainText():""},CHtmlEditorViewModel.prototype.getText=function(e){return this.oCrea?this.oCrea.getText(e):""},CHtmlEditorViewModel.prototype.setText=function(e,t){this.oCrea&&(t?this.oCrea.setPlainText(e):this.oCrea.setText(e),this.inactive.valueHasMutated())},CHtmlEditorViewModel.prototype.undoAndClearRedo=function(){this.oCrea&&(this.oCrea.undo(),this.oCrea.clearRedo())},CHtmlEditorViewModel.prototype.clearUndoRedo=function(){this.oCrea&&this.oCrea.clearUndoRedo()},CHtmlEditorViewModel.prototype.isEditing=function(){return this.oCrea?this.oCrea.bEditing:!1},CHtmlEditorViewModel.prototype.getNotDefaultText=function(){var e=this.getText();return this.removeAllTags(e)!==Utils.i18n("HTMLEDITOR/SIGNATURE_PLACEHOLDER")?e:""},CHtmlEditorViewModel.prototype.removeAllTags=function(e){return e.replace(/<style>.*<\/style>/g,"").replace(/<[^>]*>/g,"")},CHtmlEditorViewModel.prototype.setActivitySource=function(e){this.activitySource=e,null!==this.activitySourceSubscription&&this.activitySourceSubscription.dispose(),this.activitySourceSubscription=this.activitySource.subscribe(function(){this.inactive(0===Utils.pInt(this.activitySource()))},this),this.inactive(0===Utils.pInt(this.activitySource()))},CHtmlEditorViewModel.prototype.onCreaFocus=function(){this.oCrea&&(this.closeAllPopups(),this.activitySource(1),this.textFocused(!0))},CHtmlEditorViewModel.prototype.onCreaBlur=function(){this.oCrea&&this.textFocused(!1)},CHtmlEditorViewModel.prototype.onEscHandler=function(){0===App.Screens.popups.length&&this.closeAllPopups()},CHtmlEditorViewModel.prototype.closeAllPopups=function(e){e=!!e,e||this.visibleLinkPopup(!1),this.visibleInsertLinkPopup(!1),this.visibleImagePopup(!1),this.visibleInsertImagePopup(!1),this.visibleFontColorPopup(!1),AfterLogicApi.runPluginHook&&AfterLogicApi.runPluginHook("close-all-htmleditor-popups")},CHtmlEditorViewModel.prototype.insertHtml=function(e){this.oCrea&&(this.oCrea.isFocused()||this.oCrea.setFocus(!0),this.oCrea.insertHtml(e,!1))},CHtmlEditorViewModel.prototype.insertLink=function(e,t){t&&this.setActive(t),this.visibleInsertLinkPopup()||(this.linkForInsert(this.oCrea.getSelectedText()),this.closeAllPopups(),this.visibleInsertLinkPopup(!0),this.linkFocused(!0))},CHtmlEditorViewModel.prototype.insertLinkFromPopup=function(e,t){this.linkForInsert().length>0&&(Utils.Address.isCorrectEmail(this.linkForInsert())?this.oCrea.insertEmailLink(this.linkForInsert()):this.oCrea.insertLink(this.linkForInsert())),this.closeInsertLinkPopup(e,t)},CHtmlEditorViewModel.prototype.closeInsertLinkPopup=function(e,t){this.visibleInsertLinkPopup(!1),t&&t.stopPropagation()},CHtmlEditorViewModel.prototype.textColor=function(e,t){this.setActive(t),this.visibleFontColorPopup()?this.closeAllPopups():(this.closeAllPopups(),this.visibleFontColorPopup(!0),this.oFontColorPicker.onShow(),this.oBackColorPicker.onShow())},CHtmlEditorViewModel.prototype.colorToHex=function(e){if("#"===e.substr(0,1))return e;for(var t=/(.*?)rgb\((\d+), (\d+), (\d+)\)/.exec(e),i=parseInt(t[2],10),s=parseInt(t[3],10),o=parseInt(t[4],10),n=o|s<<8|i<<16,r=n.toString(16);r.length<6;)r="0"+r;return t[1]+"#"+r},CHtmlEditorViewModel.prototype.setTextColorFromPopup=function(e){this.oCrea.textColor(this.colorToHex(e)),this.closeAllPopups()},CHtmlEditorViewModel.prototype.setBackColorFromPopup=function(e){this.oCrea.backgroundColor(this.colorToHex(e)),this.closeAllPopups()},CHtmlEditorViewModel.prototype.insertImage=function(e,t){return this.setActive(t),this.allowInsertImage()&&!this.visibleInsertImagePopup()&&(this.imagePathFromWeb(""),this.closeAllPopups(),this.visibleInsertImagePopup(!0),this.initUploader()),!0},CHtmlEditorViewModel.prototype.insertWebImageFromPopup=function(e,t){this.allowInsertImage()&&this.imagePathFromWeb().length>0&&this.oCrea.insertImage(this.imagePathFromWeb()),this.closeInsertImagePopup(e,t)},CHtmlEditorViewModel.prototype.insertComputerImageFromPopup=function(e,t){var i=Utils.File.getViewLinkByHash(AppData.Accounts.currentId(),t.Hash),s=!1;this.allowInsertImage()&&i.length>0&&(s=this.oCrea.insertImage(i),s&&($(this.oCrea.$editableArea).find('img[src="'+i+'"]').attr("data-x-src-cid",e),t.CID=e,this.uploadedImagePathes.push(t))),this.closeInsertImagePopup()},CHtmlEditorViewModel.prototype.closeInsertImagePopup=function(e,t){this.visibleInsertImagePopup(!1),t&&t.stopPropagation()},CHtmlEditorViewModel.prototype.initUploader=function(){this.imageUploaderButton()&&!this.oJua&&(this.oJua=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:2,clickElement:this.imageUploaderButton(),hiddenElementsPosition:Utils.isRTL()?"right":"left",disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!0,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.bInsertImageAsBase64?this.oJua.on("onSelect",_.bind(this.onEditorDrop,this)):this.oJua.on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)))},CHtmlEditorViewModel.prototype.initEditorUploader=function(){if(AppData.App.AllowInsertImage&&this.uploaderAreaDom()&&!this.editorUploader){var e=null,t=null;this.oParent&&this.oParent.composeUploaderDragOver&&this.oParent.onFileUploadProgress&&this.oParent.onFileUploadStart&&this.oParent.onFileUploadComplete?(e=_.bind(function(){this.editorUploaderBodyDragOver(!0),this.oParent.composeUploaderDragOver(!0)},this),t=_.bind(function(){this.editorUploaderBodyDragOver(!1),this.oParent.composeUploaderDragOver(!1)},this),this.editorUploader=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.editorUploader.on("onDragEnter",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!0)).on("onDragLeave",_.bind(this.oParent.composeUploaderDragOver,this.oParent,!1)).on("onBodyDragEnter",e).on("onBodyDragLeave",t).on("onProgress",_.bind(this.oParent.onFileUploadProgress,this.oParent)).on("onSelect",_.bind(this.onEditorDrop,this)).on("onStart",_.bind(this.oParent.onFileUploadStart,this.oParent)).on("onComplete",_.bind(this.oParent.onFileUploadComplete,this.oParent))):(e=_.bind(this.editorUploaderBodyDragOver,this,!0),t=_.bind(this.editorUploaderBodyDragOver,this,!1),this.editorUploader=new Jua({queueSize:1,dragAndDropElement:this.bAllowImageDragAndDrop?this.uploaderAreaDom():null,disableMultiple:!0,disableAjaxUpload:!1,disableDragAndDrop:!this.bAllowImageDragAndDrop}),this.editorUploader.on("onBodyDragEnter",e).on("onBodyDragLeave",t).on("onSelect",_.bind(this.onEditorDrop,this)))}},CHtmlEditorViewModel.prototype.onEditorDrop=function(e,t){var i=null,s=null,o=this,n=!1,r=Math.random().toString(),a="";if(t&&t.File&&"string"==typeof t.File.type)if(AppData.App.AllowInsertImage&&0===t.File.type.indexOf("image/"))s=t.File,AppData.App.ImageUploadSizeLimit>0&&s.size>AppData.App.ImageUploadSizeLimit?App.Screens.showPopup(AlertPopup,[Utils.i18n("COMPOSE/UPLOAD_ERROR_SIZE")]):(i=new window.FileReader,n=this.oCrea.isFocused(),n||this.oCrea.setFocus(!0),a=s.name+"_"+r,this.oCrea.insertHtml('<img id="'+a+'" src="skins/Default/images/wait.gif" />',!0),n||this.oCrea.fixFirefoxCursorBug(),i.onload=function(e){o.oCrea.changeImageSource(a,e.target.result)},i.readAsDataURL(s));else{if(this.oParent&&this.oParent.onFileUploadSelect)return this.oParent.onFileUploadSelect(e,t),!0;App.browser.ie10AndAbove||App.Screens.showPopup(AlertPopup,[Utils.i18n("HTMLEDITOR/UPLOAD_ERROR_NOT_IMAGE")])}return!1},CHtmlEditorViewModel.prototype.isFileImage=function(e){if("string"==typeof e.Type)return-1!==e.Type.indexOf("image");var t=e.FileName.lastIndexOf("."),i=e.FileName.substr(t+1),s=["jpg","jpeg","gif","tif","tiff","png"];return-1!==$.inArray(i,s)},CHtmlEditorViewModel.prototype.onFileUploadSelect=function(e,t){return this.isFileImage(t)?(this.closeInsertImagePopup(),!0):(App.Screens.showPopup(AlertPopup,[Utils.i18n("HTMLEDITOR/UPLOAD_ERROR_NOT_IMAGE")]),!1)},CHtmlEditorViewModel.prototype.onFileUploadComplete=function(e,t,i){var s="";i&&i.Result?i.Result.Error?(s=Utils.i18n("size"===i.Result.Error?"COMPOSE/UPLOAD_ERROR_SIZE":"COMPOSE/UPLOAD_ERROR_UNKNOWN"),App.Screens.showPopup(AlertPopup,[s])):(this.oCrea.setFocus(!0),this.insertComputerImageFromPopup(e,i.Result.Attachment)):App.Screens.showPopup(AlertPopup,[Utils.i18n("COMPOSE/UPLOAD_ERROR_UNKNOWN")])},CHtmlEditorViewModel.prototype.setActive=function(e){e.stopPropagation(),this.activitySource(1)},CColorPickerViewModel.prototype.onShow=function(){$(this.colorPickerDom()).find("span.color-item").on("click",_.bind(function(e){e.stopPropagation(),this.setColorFromPopup($(e.target).data("color"))},this))},CColorPickerViewModel.prototype.setColorFromPopup=function(e){this.pickHandler.call(this.pickContext,e)},CPhoneViewModel.prototype.answer=function(){this.action(Enums.PhoneAction.IncomingConnect)},CPhoneViewModel.prototype.multiAction=function(){var e=this.action();e===Enums.PhoneAction.OfflineActive?this.action(Enums.PhoneAction.Offline):e===Enums.PhoneAction.Online?(this.action(Enums.PhoneAction.OnlineActive),this.getLogs(),_.delay(_.bind(function(){this.inputFocus(!0)},this),500)):e===Enums.PhoneAction.OnlineActive&&this.validateNumber()?(this.phone&&(this.phone.phoneToCall(this.input()),this.action(Enums.PhoneAction.Outgoing)),this.inputFocus(!1)):e!==Enums.PhoneAction.OnlineActive||this.validateNumber()?(e===Enums.PhoneAction.Outgoing||e===Enums.PhoneAction.Incoming||e===Enums.PhoneAction.OutgoingConnect||e===Enums.PhoneAction.IncomingConnect)&&(this.action(Enums.PhoneAction.Online),this.dropdownShow(!1)):(this.action(Enums.PhoneAction.Online),this.dropdownShow(!1))},CPhoneViewModel.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e,PhoneOnly:"1"};this.phoneAutocompleteItem(null),e=Utils.trim(e),""!==e&&App.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result.List&&(_.each(e.Result.List,function(e){_.each(e.Phones,function(t){i.push({label:""!==e.Name?e.Name+" <"+e.Email+"> "+t:e.Email+" "+t,value:t,frequency:e.Frequency})},this)},this),i=_.sortBy(_.compact(i),function(e){return-e.frequency})),t(i)},this)},CPhoneViewModel.prototype.validateNumber=function(){return/^[^a-zA-Z\u00BF-\u1FFF\u2C00-\uD7FF]+$/g.test(this.input())},CPhoneViewModel.prototype.onLogItem=function(e){this.input(e.phoneToCall),this.dropdownShow(!1)},CPhoneViewModel.prototype.getLogs=function(){this.spinner(!0),this.logs([]),this.logsToShow([]),this.phone.getLogs(this.onLogsResponse,this)},CPhoneViewModel.prototype.onLogsResponse=function(e){e&&e.Result&&(this.logs([]),_.each(e.Result,function(e){e.phoneToCall=this.phone.getCleanedPhone("incoming"===e.UserDirection?e.From:e.To),e.phoneToShow=e.UserDisplayName?e.UserDisplayName:e.phoneToCall,e.phoneToShow&&this.logs.push(e)},this),this.logs(_.sortBy(this.logs(),function(e){return-Date.parse(e.StartTime)}).slice(0,100)),this.seeMore()),this.spinner(!1)},CPhoneViewModel.prototype.seeMore=function(){this.logsToShow(this.logs().slice(0,this.logsToShow().length+10))},CPhoneViewModel.prototype.timer=function(){var e=0,t=0,i=0,s=function(e){var t=e.toString();return 1===t.length?t="0"+t:t};return function(o){"start"===o?(t=0,i=0,e=setInterval(_.bind(function(){60===t&&(t=0,i++),this.report(Utils.i18n("PHONE/PASSED_TIME")+" "+s(i)+":"+s(t)),t++},this),1e3)):"stop"===o&&clearInterval(e)}}(),CWrapLoginViewModel.prototype.__name="CWrapLoginViewModel",CWrapLoginViewModel.prototype.onShow=function(){this.oLoginViewModel.onShow&&this.oLoginViewModel.onShow()},CWrapLoginViewModel.prototype.onApplyBindings=function(){this.oLoginViewModel.onApplyBindings&&this.oLoginViewModel.onApplyBindings()},CWrapLoginViewModel.prototype.changeLanguage=function(e){e&&this.allowLanguages()&&(this.currentLanguage(e),this.oLoginViewModel.changingLanguage(!0),App.Ajax.send({Action:"SystemUpdateLanguageOnLogin",Language:e},function(){window.location.reload()},this))},CLoginViewModel.prototype.__name="CLoginViewModel",CLoginViewModel.prototype.onApplyBindings=function(){$html.addClass("non-adjustable-valign")},CLoginViewModel.prototype.onShow=function(){this.fillFields()},CLoginViewModel.prototype.fillFields=function(){_.delay(_.bind(function(){this.focusFields()},this),1)},CLoginViewModel.prototype.focusFields=function(){this.emailVisible()&&""===this.email()?this.emailFocus(!0):this.loginVisible()&&""===this.login()&&this.loginFocus(!0)},CLoginViewModel.prototype.signIn=function(){$(".check_autocomplete_input").trigger("input").trigger("change").trigger("keydown");var e=this.loginFormType(),t=this.email(),i=this.login(),s=this.password();this.loading()||this.changingLanguage()||""===Utils.trim(s)||!(Enums.LoginFormType.Login===e&&""!==Utils.trim(i)||Enums.LoginFormType.Email===e&&""!==Utils.trim(t)||Enums.LoginFormType.Both===e&&""!==Utils.trim(t))?this.shake(!0):this.sendRequest()},CLoginViewModel.prototype.onSystemLoginResponse=function(e){!1===e.Result?(this.loading(!1),this.shake(!0),App.Api.showErrorByCode(e,Utils.i18n("WARNING/LOGIN_PASS_INCORRECT"))):(App.Storage.setData("AuthToken",e.Result.AuthToken),""!==window.location.search&&null===Utils.Common.getRequestParam("reset-pass")&&null===Utils.Common.getRequestParam("invite-auth")&&null===Utils.Common.getRequestParam("external-services")?Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!0):Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!1))},CLoginViewModel.prototype.sendRequest=function(){var e={Action:"SystemLogin",Email:this.emailVisible()?this.email():"",IncLogin:this.loginVisible()?this.login():"",IncPassword:this.password(),SignMe:this.signMe()?"1":"0"};this.loading(!0),App.Ajax.send(e,this.onSystemLoginResponse,this)},CForgotViewModel.prototype.__name="CForgotViewModel",CForgotViewModel.prototype.executeGetQuestion=function(){var e={Action:"AccountGetForgotQuestion",Email:this.email()};this.gettingQuestion(!0),App.Ajax.send(e,this.onAccountGetForgotQuestionResponse,this)},CForgotViewModel.prototype.onAccountGetForgotQuestionResponse=function(e){var t="";this.gettingQuestion(!1),!1===e.Result?App.Api.showErrorByCode(e,Utils.i18n("LOGIN/ERROR_GETTING_QUESTION")):(t=Utils.pString(e.Result.Question),""===t?App.Api.showError(Utils.i18n("LOGIN/ERROR_PASSWORD_RESET_NOT_AVAILABLE")):(this.question(t),this.visibleEmailForm(!1),this.visibleQuestionForm(!0),this.visiblePasswordForm(!1)))},CForgotViewModel.prototype.executeValidateAnswer=function(){var e={Action:"AccountValidateForgotQuestion",Email:this.email(),Question:this.question(),Answer:this.answer()};this.validatingAnswer(!0),App.Ajax.send(e,this.onAccountValidateForgotQuestionResponse,this)},CForgotViewModel.prototype.onAccountValidateForgotQuestionResponse=function(e){this.validatingAnswer(!1),!1===e.Result?App.Api.showErrorByCode(e,Utils.i18n("LOGIN/ERROR_WRONG_ANSWER")):(this.visibleEmailForm(!1),this.visibleQuestionForm(!1),this.visiblePasswordForm(!0))},CForgotViewModel.prototype.executeChangePassword=function(){if(this.password()!==this.confirmPassword())App.Api.showError(Utils.i18n("WARNING/PASSWORDS_DO_NOT_MATCH"));else{var e={Action:"AccountChangeForgotPassword",Email:this.email(),Question:this.question(),Answer:this.answer(),Password:this.password()};this.changingPassword(!0),App.Ajax.send(e,this.onAccountChangeForgotPasswordResponse,this)}},CForgotViewModel.prototype.onAccountChangeForgotPasswordResponse=function(e){this.changingPassword(!1),!1===e.Result?App.Api.showErrorByCode(e,Utils.i18n("LOGIN/ERROR_RESETTING_PASSWORD")):(this.gotoForgot(!1),App.Api.showReport(Utils.i18n("LOGIN/REPORT_PASSWORD_CHANGED")))},CRegisterViewModel.prototype.__name="CRegisterViewModel",CRegisterViewModel.prototype.registerAccount=function(){if(this.password()!==this.confirmPassword())App.Api.showError(Utils.i18n("WARNING/PASSWORDS_DO_NOT_MATCH"));else{var e={Action:"AccountRegister",Name:this.name(),Email:this.login()+"@"+this.selectedDomain(),Password:this.password(),Question:this.allowQuestionPart?this.visibleYourQuestion()?this.yourQuestion():this.question():"",Answer:this.allowQuestionPart?this.answer():""};this.loading(!0),App.Ajax.send(e,this.onAccountRegisterResponse,this)}},CRegisterViewModel.prototype.onAccountRegisterResponse=function(e){!1===e.Result?(this.loading(!1),App.Api.showErrorByCode(e,Utils.i18n("WARNING/LOGIN_PASS_INCORRECT"))):window.location.reload()},CMessageListViewModel.prototype.addNewAccount=function(){App.Api.createMailAccount(AppData.Accounts.getEmail())},CMessageListViewModel.prototype.createDatePickerObject=function(e){$(e).datepicker({showOtherMonths:!0,selectOtherMonths:!0,monthNames:Utils.getMonthNamesArray(),dayNamesMin:Utils.i18n("DATETIME/DAY_NAMES_MIN").split(" "),nextText:"",prevText:"",firstDay:AppData.User.CalendarWeekStartsOn,showOn:"focus",dateFormat:this.dateFormatDatePicker}),$(e).mousedown(function(){$("#ui-datepicker-div").toggle()})},CMessageListViewModel.prototype.changeRoutingForMessageList=function(e,t,i,s,o){var n=App.Routing.setHash(App.Links.mailbox(e,t,i,s,o));n&&s.length>0&&this.search()===s&&this.listChangedThrottle(!this.listChangedThrottle())},CMessageListViewModel.prototype.onEnterPress=function(e){e.openThread()},CMessageListViewModel.prototype.onMessageDblClick=function(e){if(!this.isSavingDraft(e)){var t=this.folderList().getFolderByFullName(e.folder());t.type()===Enums.FolderTypes.Drafts?App.Api.composeMessageFromDrafts(e.folder(),e.uid()):this.openMessageInNewWindowBinded(e)}},CMessageListViewModel.prototype.onFolderListSubscribe=function(){this.setCurrentFolder(),this.requestMessageList()},CMessageListViewModel.prototype.onShow=function(){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CMessageListViewModel.prototype.onHide=function(){this.selector.useKeyboardKeys(!1),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CMessageListViewModel.prototype.onRoute=function(e){var t=App.Links.parseMailbox(e),i=this.currentPage()!==t.Page||this.folderFullName()!==t.Folder||this.filters()!==t.Filters||t.Filters===Enums.FolderFilter.Unseen&&App.MailCache.waitForUnseenMessages()||this.search()!==t.Search,s=AppData.User.MailsPerPage!==this.oPageSwitcher.perPage();this.pageSwitcherLocked(!0),this.folderFullName()!==t.Folder||this.search()!==t.Search||this.filters()!==t.Filters?this.oPageSwitcher.clear():this.oPageSwitcher.setPage(t.Page,AppData.User.MailsPerPage),this.pageSwitcherLocked(!1),t.Page!==this.oPageSwitcher.currentPage()&&App.Routing.replaceHash(App.Links.mailbox(t.Folder,this.oPageSwitcher.currentPage(),t.Uid,t.Search,t.Filters)),this.currentPage(this.oPageSwitcher.currentPage()),this.folderFullName(t.Folder),this.filters(t.Filters),this.search(t.Search),this.searchInput(this.search()),this.searchSpan.notifySubscribers(),this.setCurrentFolder(),(i||s||0===this.collection().length)&&(t.Filters===Enums.FolderFilter.Unseen&&App.MailCache.waitForUnseenMessages(!0),this.requestMessageList()),this.highlightTrigger.notifySubscribers(!0)},CMessageListViewModel.prototype.setCurrentFolder=function(){this.folderList().setCurrentFolder(this.folderFullName(),this.filters()),this.folderType(App.MailCache.folderList().currentFolderType())},CMessageListViewModel.prototype.requestMessageList=function(){var e=this.folderList().currentFolderFullName(),t=this.oPageSwitcher.currentPage();e.length>0?App.MailCache.changeCurrentMessageList(e,t,this.search(),this.filters()):App.MailCache.checkCurrentFolderList()},CMessageListViewModel.prototype.calculateSearchStringFromAdvancedForm=function(){var e=this.searchInputFrom(),t=this.searchInputTo(),i=this.searchInputSubject(),s=this.searchInputText(),o=this.searchAttachmentsCheckbox(),n=(this.searchAttachments(),this.searchDateStart()),r=this.searchDateEnd(),a=[],l=function(e){return e=$.trim(e).replace(/"/g,'\\"'),(-1<e.indexOf(" ")||-1<e.indexOf('"'))&&(e='"'+e+'"'),e};return""!==e&&a.push("from:"+l(e)),""!==t&&a.push("to:"+l(t)),""!==i&&a.push("subject:"+l(i)),""!==s&&a.push("text:"+l(s)),o&&a.push("has:attachments"),(""!==n||""!==r)&&a.push("date:"+l(n)+"/"+l(r)),a.join(" ")},CMessageListViewModel.prototype.onSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=1,i=this.searchInput();this.bAdvancedSearch()&&(i=this.calculateSearchStringFromAdvancedForm(),this.searchInput(i),this.bAdvancedSearch(!1)),this.changeRoutingForMessageList(e,t,"",i,this.filters())},CMessageListViewModel.prototype.onRetryClick=function(){this.requestMessageList()},CMessageListViewModel.prototype.onClearSearchClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"",i="",s=1;this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,s,t,i,this.filters())},CMessageListViewModel.prototype.onClearFilterClick=function(){var e=this.folderList().currentFolderFullName(),t=this.currentMessage()?this.currentMessage().uid():"",i="",s=1,o="";this.clearAdvancedSearch(),this.changeRoutingForMessageList(e,s,t,i,o)},CMessageListViewModel.prototype.onStopSearchClick=function(){this.onClearSearchClick()},CMessageListViewModel.prototype.isSavingDraft=function(e){var t=this.folderList().currentFolder();return t.type()===Enums.FolderTypes.Drafts&&e.uid()===App.MailCache.savingDraftUid()},CMessageListViewModel.prototype.routeForMessage=function(e){if(null!==e&&!this.isSavingDraft(e)){var t=this.folderList().currentFolder(),i=this.folderList().currentFolderFullName(),s=this.oPageSwitcher.currentPage(),o=e.uid(),n=this.search();""!==o&&(bMobileApp&&t.type()===Enums.FolderTypes.Drafts?App.Routing.setHash(App.Links.composeFromMessage("drafts",e.folder(),e.uid())):(this.changeRoutingForMessageList(i,s,o,n,this.filters()),bMobileApp&&App.MailCache.currentMessage()&&o===App.MailCache.currentMessage().uid()&&App.MailCache.currentMessage.valueHasMutated()))}},CMessageListViewModel.prototype.onApplyBindings=function(e){var t=this,i=_.bind(function(e){e&&e.stopPropagation&&e.stopPropagation()},this);$(".message_list",e).on("click",function(){t.isFocused(!1)}).on("click",".message_sub_list .item .flag",function(e){t.onFlagClick(ko.dataFor(this)),e&&e.stopPropagation&&e.stopPropagation()}).on("dblclick",".message_sub_list .item .flag",i).on("click",".message_sub_list .item .thread",i).on("dblclick",".message_sub_list .item .thread",i),this.selector.initOnApplyBindings(".message_sub_list .item",".message_sub_list .item.selected",".message_sub_list .item .custom_checkbox",$(".message_list",e),$(".message_list_scroll.scroll-inner",e)),this.initUploader()},CMessageListViewModel.prototype.onFlagClick=function(e){this.isSavingDraft(e)||App.MailCache.executeGroupOperation("MessageSetFlagged",[e.uid()],"flagged",!e.flagged())},CMessageListViewModel.prototype.executeMarkAsRead=function(){App.MailCache.executeGroupOperation("MessageSetSeen",this.checkedOrSelectedUids(),"seen",!0)},CMessageListViewModel.prototype.executeMarkAsUnread=function(){App.MailCache.executeGroupOperation("MessageSetSeen",this.checkedOrSelectedUids(),"seen",!1)},CMessageListViewModel.prototype.executeMarkAllRead=function(){App.MailCache.executeGroupOperation("MessagesSetAllSeen",[],"seen",!0)},CMessageListViewModel.prototype.executeMoveToFolder=function(e){App.MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListViewModel.prototype.executeCopyToFolder=function(e){App.MailCache.copyMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListViewModel.prototype.onDeletePress=function(e){var t=_.map(e,function(e){return e.uid()
});t.length>0&&App.Api.deleteMessages(t,App)},CMessageListViewModel.prototype.executeDelete=function(){App.Api.deleteMessages(this.checkedOrSelectedUids(),App)},CMessageListViewModel.prototype.executeSpam=function(){var e=this.folderList().spamFolderFullName();this.folderList().currentFolderFullName()!==e&&App.MailCache.moveMessagesToFolder(e,this.checkedOrSelectedUids())},CMessageListViewModel.prototype.executeNotSpam=function(){var e=this.folderList().inboxFolder();e&&this.folderList().currentFolderFullName()!==e.fullName()&&App.MailCache.moveMessagesToFolder(e.fullName(),this.checkedOrSelectedUids())},CMessageListViewModel.prototype.clearAdvancedSearch=function(){this.searchInputFrom(""),this.searchInputTo(""),this.searchInputSubject(""),this.searchInputText(""),this.bAdvancedSearch(!1),this.searchAttachmentsCheckbox(!1),this.searchAttachments(""),this.searchDateStart(""),this.searchDateEnd("")},CMessageListViewModel.prototype.onAdvancedSearchClick=function(){this.bAdvancedSearch(!this.bAdvancedSearch())},CMessageListViewModel.prototype.calculateSearchStringForDescription=function(){return'<span class="part">'+Utils.encodeHtml(this.search())+"</span>"},CMessageListViewModel.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Message/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:this.isPublic,disableFolderDragAndDrop:this.isPublic,disableDragAndDrop:this.isPublic,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({Folder:e.folderFullName()})}}}),this.oJua.on("onDrop",_.bind(this.onFileDrop,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},CMessageListViewModel.prototype.onFileDrop=function(e){e&&e.File&&e.File.type&&0===e.File.type.indexOf("message/")||App.Api.showError(Utils.i18n("MAILBOX/ERROR_INCORRECT_FILE_EXTENSION"))},CMessageListViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?App.Api.showError(i.ErrorCode&&i.ErrorCode===Enums.Errors.IncorrectFileExtension?Utils.i18n("CONTACTS/ERROR_INCORRECT_FILE_EXTENSION"):Utils.i18n("WARNING/ERROR_UPLOAD_FILE")):App.MailCache.executeCheckMail(!0)},CMessagePaneViewModel.prototype.__name="CMessagePaneViewModel",CMessagePaneViewModel.prototype.resizeDblClick=function(e,t){""!==t.target.className&&t.target.className.search(/add_contact|icon|link|title|subject|link|date|from/)&&(Utils.calmEvent(t),Utils.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=$(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[5,"min",!0]))},CMessagePaneViewModel.prototype.notifySender=function(){this.currentMessage()&&""!==this.currentMessage().readingConfirmation()&&(App.Ajax.send({Action:"MessageSendConfirmation",Confirmation:this.currentMessage().readingConfirmation(),Subject:Utils.i18n("MESSAGE/RETURN_RECEIPT_MAIL_SUBJECT"),Text:Utils.i18n("MESSAGE/RETURN_RECEIPT_MAIL_TEXT",{EMAIL:AppData.Accounts.getEmail(),SUBJECT:this.subject()}),ConfirmFolder:this.currentMessage().folder(),ConfirmUid:this.currentMessage().uid()}),this.currentMessage().readingConfirmation(""))},CMessagePaneViewModel.prototype.onFolderListSubscribe=function(){AppData.SingleMode&&this.onMessagesSubscribe()},CMessagePaneViewModel.prototype.onMessagesSubscribe=function(){!this.currentMessage()&&this.uid().length>0&&App.MailCache.setCurrentMessage(this.uid(),this.folder())},CMessagePaneViewModel.prototype.onCurrentMessageSubscribe=function(){var e=null,t=null,i=this.currentMessage(),s=i?AppData.Accounts.getAccount(i.accountId()):null;if(this.singleMode()&&window.opener&&window.opener.oReplyDataFromViewPane?(this.replyText(window.opener.oReplyDataFromViewPane.ReplyText),this.replyDraftUid(window.opener.oReplyDataFromViewPane.ReplyDraftUid),window.opener.oReplyDataFromViewPane=null):i&&i.uid()===this.displayedMessageUid()||(this.replyText(""),this.replyDraftUid("")),i&&this.uid()===i.uid()){if(this.subject(i.subject()),this.importance(i.importance()),this.from(i.oFrom.getDisplay()),this.fromEmail(i.oFrom.getFirstEmail()),this.fullFrom(i.oFrom.getFull()),this.oFromAddr(i.oFrom.aCollection.length>0?i.oFrom.aCollection[0]:null),this.to(i.oTo.getFull()),this.aToAddr(i.oTo.aCollection),this.cc(i.oCc.getFull()),this.aCcAddr(i.oCc.aCollection),this.bcc(i.oBcc.getFull()),this.aBccAddr(i.oBcc.aCollection),this.currentAccountEmail(s.email()),this.aAllRecipients(_.uniq(_.union(this.aToAddr(),this.aCcAddr(),this.aBccAddr()))),this.mobileApp||this.requestContactsFromCache(_.union(i.oFrom.aCollection,this.aAllRecipients())),this.midDate(i.oDateModel.getMidDate()),this.fullDate(i.oDateModel.getFullDate()),this.isLoading(""!==i.uid()&&!i.completelyFilled()),this.setMessageBody(),this.rtlMessage(i.rtl()),this.singleMode()){var o=[],n=Date.now().toString();_.each(i.attachments(),_.bind(function(e){var t=new CMailAttachmentModel;t.copyProperties(e),t.getInThumbQueue(n),o.push(t)},this)),this.attachments(o)}else this.attachments(i.attachments());if(null!==this.ical()&&this.ical().animation(!1),e=i.ical(),e&&this.singleMode()&&(e=this.getIcalCopy(e)),this.ical(e),null!==this.ical()&&(_.defer(_.bind(function(){null!==this.ical()&&this.ical().animation(!0)},this)),this.ical().updateAttendeeStatus(this.fromEmail())),t=i.vcard(),t&&this.singleMode()&&(t=this.getVcardCopy(t)),this.vcard(t),!i.completelyFilled()||i.trimmed()){var r=i.completelyFilled()?i.trimmed:i.completelyFilled;this.singleMode()?i.completelyFilledSingleModeSubscription=r.subscribe(this.onCurrentMessageSubscribe,this):i.completelyFilledSubscription=r.subscribe(this.onCurrentMessageSubscribe,this)}else i.completelyFilledSubscription?(i.completelyFilledSubscription.dispose(),i.completelyFilledSubscription=void 0):i.completelyFilledSingleModeSubscription&&(i.completelyFilledSingleModeSubscription.dispose(),i.completelyFilledSingleModeSubscription=void 0)}else this.isLoading(!1),$(this.domTextBody()).empty().data("displayed-message-uid",""),this.displayedMessageUid(""),this.rtlMessage(!1),this.attachments([]),this.visiblePicturesControl(!1),this.visibleShowPicturesLink(!1),this.ical(null),this.vcard(null),this.decryptPassword(""),this.visibleDecryptControl(!1),this.visibleVerifyControl(!1)},CMessagePaneViewModel.prototype.updateMomentDate=function(){var e=this.currentMessage();e&&e.oDateModel&&(this.midDate(e.oDateModel.getMidDate()),this.fullDate(e.oDateModel.getFullDate()))},CMessagePaneViewModel.prototype.requestContactsFromCache=function(e){var t=_.map(e,function(e){return e.sEmail});this.recipientsContacts([]),App.ContactsCache.getContactsByEmails(t,this.onContactResponse,this)},CMessagePaneViewModel.prototype.onContactResponse=function(e,t){e&&(this.recipientsContacts.push(e),this.recipientsContacts(_.uniq(this.recipientsContacts()))),_.each(_.union([this.oFromAddr()],this.aAllRecipients()),function(i){i&&i.sEmail===t&&(i.loaded(!0),i.found(!!e))})},CMessagePaneViewModel.prototype.getVcardCopy=function(e){var t=new CVcardModel;return t.uid(e.uid()),t.file(e.file()),t.name(e.name()),t.email(e.email()),t.exists(e.exists()),t.isJustSaved(e.isJustSaved()),t},CMessagePaneViewModel.prototype.getIcalCopy=function(e){var t=new CIcalModel;return t.uid(e.uid()),t.file(e.file()),t.attendee(e.attendee()),t.type(e.type()),t.cancelDecision(e.cancelDecision()),t.replyDecision(e.replyDecision()),t.isJustSaved(e.isJustSaved()),t.location(e.location()),t.description(e.description()),t.when(e.when()),t.calendarId(e.calendarId()),t.selectedCalendarId(e.selectedCalendarId()),t.calendars(e.calendars()),t.animation(e.animation()),t},CMessagePaneViewModel.prototype.setMessageBody=function(){if(this.currentMessage()){var e=this.currentMessage(),t=e.text(),i=$(this.domTextBody()),s=null,o="",n=t.length,r=5e6,a=[];this.textBody(t),i.data("displayed-message-uid")===e.uid()&&(a=this.getBlockquotesStatus()),i.empty(),e.isPlain()||n>r?(i.html(t),this.visiblePicturesControl(!1)):(s=e.getDomText(),o=s.length>0?s.html():"",i.append(o),this.visiblePicturesControl(e.hasExternals()&&!e.isExternalsAlwaysShown()),this.visibleShowPicturesLink(!e.isExternalsShown()),Utils.htmlStartsWithBlockquote(o)||this.doHidingBlockquotes(a)),this.decryptPassword(""),this.visibleDecryptControl(AppData.User.enableOpenPgp()&&e.encryptedMessage()),this.visibleVerifyControl(AppData.User.enableOpenPgp()&&e.signedMessage()),i.data("displayed-message-uid",e.uid()),this.displayedMessageUid(e.uid()),i.find("[data-id='appointment_actions_part']").hide()}},CMessagePaneViewModel.prototype.getBlockquotesStatus=function(){var e=[];return $($("blockquote",$(this.domTextBody())).get()).each(function(){var t=$(this);t.hasClass("blockquote_before_toggle")&&e.push(t.hasClass("collapsed"))}),e},CMessagePaneViewModel.prototype.doHidingBlockquotes=function(e){var t=120,i=80,s=0;$($("blockquote",$(this.domTextBody())).get()).each(function(){var o=$(this),n=o.parents("blockquote"),r=$('<span class="blockquote_toggle"></span>').html(Utils.i18n("MESSAGE/SHOW_QUOTED_TEXT")),a=!0;0===n.length&&o.height()>t&&(o.addClass("blockquote_before_toggle").after(r).wrapInner('<div class="blockquote_content"></div>'),r.bind("click",function(){a?(o.height("auto"),r.html(Utils.i18n("MESSAGE/HIDE_QUOTED_TEXT")),a=!1):(o.height(i),r.html(Utils.i18n("MESSAGE/SHOW_QUOTED_TEXT")),a=!0),o.toggleClass("collapsed",a)}),s<e.length&&(a=e[s],s++),o.height(a?i:"auto").toggleClass("collapsed",a))})},CMessagePaneViewModel.prototype.onRoute=function(e){var t=App.Links.parseMailbox(e);""!==this.replyText()&&this.uid()!==t.Uid&&this.saveReplyMessage(!1),this.uid(t.Uid),this.folder(t.Folder),App.MailCache.setCurrentMessage(this.uid(),this.folder()),this.contentHasFocus(!0)},CMessagePaneViewModel.prototype.showPictures=function(){App.MailCache.showExternalPictures(!1),this.visibleShowPicturesLink(!1),this.setMessageBody()},CMessagePaneViewModel.prototype.alwaysShowPictures=function(){var e=this.currentMessage()?this.currentMessage().oFrom.getFirstEmail():"";e.length>0&&App.Ajax.send({Action:"EmailSetSafety",Email:e}),App.MailCache.showExternalPictures(!0),this.visiblePicturesControl(!1),this.setMessageBody()},CMessagePaneViewModel.prototype.openInNewWindow=function(){this.openMessageInNewWindowBinded(this.currentMessage())},CMessagePaneViewModel.prototype.addToContacts=function(e,t){App.Api.contactCreate(t,e,this.onContactResponse,this)},CMessagePaneViewModel.prototype.onAddToContactsResponse=function(e,t){e.Result&&""!==t.HomeEmail&&(App.Api.showReport(Utils.i18n("CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED")),App.ContactsCache.clearInfoAboutEmail(t.HomeEmail),App.ContactsCache.getContactsByEmails([t.HomeEmail],this.onContactResponse,this))},CMessagePaneViewModel.prototype.getReplyHtmlText=function(){return'<div style="font-family: '+this.defaultFontName+'; font-size: 16px">'+App.MessageSender.getHtmlFromText(this.replyText())+"</div>"},CMessagePaneViewModel.prototype.executeReplyOrForward=function(e){this.currentMessage()&&(App.MessageSender.setReplyData(this.getReplyHtmlText(),this.replyDraftUid()),this.replyText(""),this.replyDraftUid(""),App.Api.composeMessageAsReplyOrForward(e,this.currentMessage().folder(),this.currentMessage().uid()))},CMessagePaneViewModel.prototype.executeDeleteMessage=function(){this.currentMessage()&&(this.singleMode()&&window.opener&&window.opener.App&&window.opener.App.MailCache?App.Api.deleteMessages([this.currentMessage().uid()],window.opener.App,function(){window.close()}):this.mobileApp&&App.Api.deleteMessages([this.currentMessage().uid()],App))},CMessagePaneViewModel.prototype.executePrevMessage=function(){this.isEnablePrevMessage()&&this.moveToSingleMessageView(this.prevMessageUid())},CMessagePaneViewModel.prototype.executeNextMessage=function(){this.isEnableNextMessage()&&this.moveToSingleMessageView(this.nextMessageUid())},CMessagePaneViewModel.prototype.moveToSingleMessageView=function(e){var t=App.MailCache.folderList().currentFolderFullName(),i=[Enums.Screens.SingleMessageView,t,"msg"+e];App.Routing.setHash(i)},CMessagePaneViewModel.prototype.executeReply=function(){this.executeReplyOrForward(Enums.ReplyType.Reply)},CMessagePaneViewModel.prototype.executeReplyAll=function(){this.executeReplyOrForward(Enums.ReplyType.ReplyAll)},CMessagePaneViewModel.prototype.executeResend=function(){this.executeReplyOrForward(Enums.ReplyType.Resend)},CMessagePaneViewModel.prototype.executeForward=function(){this.executeReplyOrForward(Enums.ReplyType.Forward)},CMessagePaneViewModel.prototype.executePrint=function(){var e=this.currentMessage(),t=e?Utils.WindowOpener.open("",this.subject()+"-print"):null,i="";e&&t&&(this.textBodyForNewWindow(e.getConvertedHtml(Utils.Common.getAppPath(),!0)),i=$(this.domMessageForPrint()).html(),$(t.document.body).html(i),t.print())},CMessagePaneViewModel.prototype.executeSave=function(){this.currentMessage()&&App.Api.downloadByUrl(this.currentMessage().downloadLink())},CMessagePaneViewModel.prototype.executeSaveAsPdf=function(){if(this.currentMessage()){var e=this.currentMessage().getDomText(),t=this.currentMessage().accountId(),i=function(e){try{var t=document.createElement("canvas"),i=null;t.width=e.width,t.height=e.height,i=t.getContext("2d"),i.drawImage(e,0,0),e.src=t.toDataURL("image/png")}catch(s){}};$("img[data-x-src-cid]",e).each(function(){i(this)}),App.Ajax.send({Action:"MessageGetPdfFromHtml",Subject:this.subject(),Html:e.html()},function(e){e&&e.Result&&e.Result.Hash?App.Api.downloadByUrl(Utils.getDownloadLinkByHash(t,e.Result.Hash)):App.Api.showError(Utils.i18n("WARNING/CREATING_PDF_ERROR"))},this)}},CMessagePaneViewModel.prototype.changeAddMenuVisibility=function(){var e=!this.visibleAddMenu();this.visibleAddMenu(e)},CMessagePaneViewModel.prototype.onMessageSendOrSaveResponse=function(e,t){var i=App.MessageSender.onMessageSendOrSaveResponse(e,t,this.requiresPostponedSending());switch(i.Action){case"MessageSend":this.replySendingStarted(!1),i.Result&&this.replyText("");break;case"MessageSave":i.Result&&this.replyDraftUid(i.NewUid),this.replySavingStarted(!1),this.replyAutoSavingStarted(!1)}},CMessagePaneViewModel.prototype.executeSendQuickReplyCommand=function(){this.isEnableSendQuickReply()&&(this.replySendingStarted(!0),this.requiresPostponedSending(this.replyAutoSavingStarted()),App.MessageSender.sendReplyMessage("MessageSend",this.getReplyHtmlText(),this.replyDraftUid(),this.onMessageSendOrSaveResponse,this,this.requiresPostponedSending()),this.replyTextFocus(!1))},CMessagePaneViewModel.prototype.executeSaveQuickReply=function(){this.saveReplyMessage(!1)},CMessagePaneViewModel.prototype.saveReplyMessage=function(e){this.isEnableSaveQuickReply()&&(e?this.replyAutoSavingStarted(!0):this.replySavingStarted(!0),App.MessageSender.sendReplyMessage("MessageSave",this.getReplyHtmlText(),this.replyDraftUid(),this.onMessageSendOrSaveResponse,this))},CMessagePaneViewModel.prototype.stopAutosaveTimer=function(){window.clearTimeout(this.autoSaveTimer)},CMessagePaneViewModel.prototype.startAutosaveTimer=function(){if(this.isEnableSaveQuickReply()){var e=_.bind(this.saveReplyMessage,this,!0);this.stopAutosaveTimer(),AppData.User.AllowAutosaveInDrafts&&(this.autoSaveTimer=window.setTimeout(e,1e3*AppData.App.AutoSaveIntervalSeconds))}},CMessagePaneViewModel.prototype.downloadAllAttachments=function(){this.currentMessage()&&this.currentMessage().downloadAllAttachments()},CMessagePaneViewModel.prototype.saveAttachmentsToFiles=function(){this.currentMessage()&&this.currentMessage().saveAttachmentsToFiles()},CMessagePaneViewModel.prototype.downloadAllAttachmentsSeparately=function(){this.currentMessage()&&this.currentMessage().downloadAllAttachmentsSeparately()},CMessagePaneViewModel.prototype.onApplyBindings=function(e){App.registerSessionTimeoutFunction(_.bind(function(){""!==this.replyText()&&this.saveReplyMessage(!1)},this)),$(e).on("mousedown","a",function(e){if(e&&3!==e.which){var t=$(this).attr("href");if(t&&"mailto:"===t.toString().toLowerCase().substr(0,7))return App.Api.composeMessageToAddresses(t.toString()),!1}return!0}),this.hotKeysBind()},CMessagePaneViewModel.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){var t=App.Screens.currentScreen()===Enums.Screens.Mailbox&&e&&!e.ctrlKey&&!e.shiftKey&&!Utils.isTextFieldFocused()&&this.isEnableReply();t&&e.keyCode===Enums.Key.q?(e.preventDefault(),this.replyTextFocus(!0)):t&&e.keyCode===Enums.Key.r&&this.executeReply()},this))},CMessagePaneViewModel.prototype.showSourceHeaders=function(){var e=this.currentMessage(),t=e&&e.completelyFilled()?Utils.WindowOpener.open("",this.subject()+"-headers"):null;t&&$(t.document.body).html("<pre>"+Utils.encodeHtml(e.sourceHeaders())+"</pre>")},CMessagePaneViewModel.prototype.onDecryptMessageClick=function(){this.currentMessage()&&this.currentMessage().encryptedMessage()&&this.decryptVerifyMessage(!1)},CMessagePaneViewModel.prototype.onVerifyMessageClick=function(){this.currentMessage()&&this.currentMessage().signedMessage()&&this.decryptVerifyMessage(!0)},CMessagePaneViewModel.prototype.decryptVerifyMessage=function(e){var t=_.bind(function(t){var i=this.currentMessage();t&&i&&(e&&i.signedMessage()?this.verifyMessage(t):i.encryptedMessage()&&this.decryptMessage(t))},this);App.Api.pgp(t,AppData.User.IdUser)},CMessagePaneViewModel.prototype.decryptMessage=function(e){var t=this.currentMessage(),i=t.textRaw(),s=AppData.Accounts.getEmail(),o=t.oFrom.getFirstEmail(),n=this.decryptPassword(),r=e.decryptAndVerify(i,s,o,n),a=!1;r&&r.result&&!r.errors&&(t.text("<pre>"+Utils.encodeHtml(r.result)+"</pre>"),t.$text=null,t.encryptedMessage(!1),this.decryptPassword(""),this.visibleDecryptControl(!1),this.setMessageBody(),App.Api.showReport(r.notices?Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED"):Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED_AND_VERIFIED"))),r&&(r.errors||r.notices)&&(a=App.Api.showPgpErrorByCode(r,Enums.PgpAction.DecryptVerify),a&&App.Api.showReport(Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_DECRYPTED_AND_NOT_SIGNED")))},CMessagePaneViewModel.prototype.verifyMessage=function(e){var t=this.currentMessage(),i=t.textRaw(),s=t.oFrom.getFirstEmail(),o=e.verify(i,s);o&&o.result&&!o.errors&&!o.notices&&(t.text("<pre>"+Utils.encodeHtml(o.result)+"</pre>"),t.$text=null,t.signedMessage(!1),this.visibleVerifyControl(!1),this.setMessageBody(),App.Api.showReport(Utils.i18n("OPENPGP/REPORT_MESSAGE_SUCCESSFULLY_VERIFIED"))),o&&(o.errors||o.notices)&&App.Api.showPgpErrorByCode(o,Enums.PgpAction.Verify)},CMessagePaneViewModel.prototype.switchDetailsVisibility=function(){this.detailsVisible(!this.detailsVisible()),App.Storage.setData("MessageDetailsVisible",this.detailsVisible()?"1":"0")},CMailViewModel.prototype.executeCompose=function(){App.Api.composeMessage()},CMailViewModel.prototype.executeCheckMail=function(){App.MailCache.checkMessageFlags(),App.MailCache.executeCheckMail(!0)},CMailViewModel.prototype.openMessageInNewWindow=function(e){var t=this.folderList().getFolderByFullName(e.folder()),i=t.type()===Enums.FolderTypes.Drafts;!this.oMessagePane.currentMessage()||this.oMessagePane.currentMessage().uid()!==e.uid()||""===this.oMessagePane.replyText()&&""===this.oMessagePane.replyDraftUid()||(window.oReplyDataFromViewPane={ReplyText:this.oMessagePane.replyText(),ReplyDraftUid:this.oMessagePane.replyDraftUid()},this.oMessagePane.replyText(""),this.oMessagePane.replyDraftUid("")),Utils.WindowOpener.openMessage(e,i)},CMailViewModel.prototype.gotoFolderList=function(){this.changeSelectedPanel(Enums.MobilePanel.Groups)},CMailViewModel.prototype.gotoMessageList=function(){return this.changeSelectedPanel(Enums.MobilePanel.Items),!0},CMailViewModel.prototype.gotoMessagePane=function(){App.MailCache.currentMessage()?this.changeSelectedPanel(Enums.MobilePanel.View):this.gotoMessageList()},CMailViewModel.prototype.changeSelectedPanel=function(e){this.mobileApp&&this.selectedPanel()!==e&&(this.selectedPanel(e),(bIsWindowsPhone||App.browser.ie)&&(this.$viewModel.hide(),_.defer(_.bind(function(){this.$viewModel.show()},this))))},CMailViewModel.prototype.resizeDblClick=function(e,t){t.preventDefault(),t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,Utils.removeSelection(),this.jqPanelHelper||(this.jqPanelHelper=$(".MailLayout .panel_helper")),this.jqPanelHelper.trigger("resize",[600,"max"])},CMailViewModel.prototype.onRoute=function(e){this.oMessageList.onRoute(e),this.oMessagePane.onRoute(e)},CMailViewModel.prototype.onShow=function(){this.oMessageList.onShow()},CMailViewModel.prototype.onHide=function(){this.oMessageList.onHide()},CMailViewModel.prototype.onApplyBindings=function(){var e=this;this.oMessageList.onApplyBindings(this.$viewModel),this.oMessagePane.onApplyBindings(this.$viewModel),$(this.domFolderList()).on("click","span.folder",function(t){e.folderList().currentFolderFullName()!==$(this).data("folder")&&(t.ctrlKey?e.oMessageList.executeCopyToFolder($(this).data("folder")):e.oMessageList.executeMoveToFolder($(this).data("folder")))}),this.hotKeysBind()},CMailViewModel.prototype.hotKeysBind=function(){$(document).on("keydown",$.proxy(function(e){var t=e.keyCode,i=e&&!e.ctrlKey&&!e.altKey&&!e.shiftKey&&!Utils.isTextFieldFocused()&&App.Screens.currentScreen()===Enums.Screens.Mailbox,s=this.oMessageList,o=s.collection()[0],n=o&&App.MailCache.currentMessage()&&o.uid()===App.MailCache.currentMessage().uid();i&&t===Enums.Key.s||i&&n&&t===Enums.Key.Up?(e.preventDefault(),this.searchFocus()):s.isFocused()&&e&&t===Enums.Key.Down&&o?(e.preventDefault(),s.isFocused(!1),s.routeForMessage(o)):i&&t===Enums.Key.n&&(window.location.href="#compose")},this))},CMailViewModel.prototype.dragAndDropHelper=function(e,t){e&&e.checked(!0);var i=Utils.draggableMessages(),s=this.oMessageList.checkedOrSelectedUids(),o=s.length;return i.data("p7-message-list-folder",this.folderList().currentFolderFullName()),i.data("p7-message-list-uids",s),$(".count-text",i).text(Utils.i18n("MAILBOX/DRAG_TEXT_PLURAL",{COUNT:t?"+ "+o:o},null,o)),i},CMailViewModel.prototype.messagesDrop=function(e,t,i){if(e){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-message-list-folder"):"",n=s?s.data("p7-message-list-uids"):null;""!==o&&null!==n&&(Utils.uiDropHelperAnim(t,i),t.ctrlKey?this.oMessageList.executeCopyToFolder(e.fullName()):this.oMessageList.executeMoveToFolder(e.fullName()),this.uncheckMessages())}},CMailViewModel.prototype.searchFocus=function(){this.oMessageList.selector.useKeyboardKeys()&&!Utils.isTextFieldFocused()&&this.oMessageList.isFocused(!0)},CMailViewModel.prototype.backToList=function(){App.Routing.setPreviousHash()},CMailViewModel.prototype.onVolumerClick=function(e,t){t.stopPropagation()},CMailViewModel.prototype.uncheckMessages=function(){_.each(App.MailCache.messages(),function(e){e.checked(!1)})},CComposeViewModel.prototype.__name="CComposeViewModel",CComposeViewModel.prototype.isEnableSending=function(){var e=0===this.toAddr().length&&0===this.ccAddr().length&&0===this.bccAddr().length,t=this.folderList()&&0!==this.folderList().iAccountId;return t&&!this.sending()&&!e&&this.allAttachmentsUploaded()},CComposeViewModel.prototype.isEnableSaving=function(){var e=this.folderList()&&0!==this.folderList().iAccountId;return this.shown()&&e&&!this.sending()&&!this.saving()},CComposeViewModel.prototype.initInputosaurus=function(e,t,i,s){e()&&$(e()).length>0&&$(e()).inputosaurus({width:"auto",parseOnBlur:!0,autoCompleteSource:_.bind(function(e,t){this.autocompleteCallback(e.term,t)},this),autoCompleteDeleteItem:_.bind(function(e){this.autocompleteDeleteItem(e)},this),autoCompleteAppendTo:$(e()).closest("td"),change:_.bind(function(e){i(!0),this.setRecipient(t,e.target.value),this.minHeightAdjustTrigger(!0),i(!1)},this),copy:_.bind(function(e){this.inputosaurusBuffer=e},this),paste:_.bind(function(){var e=this.inputosaurusBuffer||"";return this.inputosaurusBuffer="",e},this),focus:_.bind(this.focusedField,this,s),mobileDevice:bMobileDevice})},CComposeViewModel.prototype.fromToExpandColaps=function(){this.fromToExpandColapssed(!this.fromToExpandColapssed()),this.oHtmlEditor.resize()},CComposeViewModel.prototype.onApplyBindings=function(){this.$viewModel.on("resize",".panel_content",_.debounce(_.bind(function(){this.oHtmlEditor.resize()},this),1)),ko.computed(function(){this.visibleBcc(),this.visibleCc(),this.fromToExpandColapssed(),this.oHtmlEditor.resize()},this),App.registerSessionTimeoutFunction(_.bind(this.executeSave,this,!1)),this.hotKeysBind()},CComposeViewModel.prototype.hotKeysBind=function(){this.$viewModel.on("keydown",$.proxy(function(e){if(e&&e.ctrlKey&&!e.altKey&&!e.shiftKey){var t=e.keyCode,i=this.shown()&&(!this.minimized||!this.minimized()),s=i&&e&&e.ctrlKey,o=Enums.Key;s&&t===o.s?(e.preventDefault(),e.returnValue=!1,this.isEnableSaving()&&this.saveCommand()):s&&t===o.Enter&&""!==this.toAddr()&&this.sendCommand()}},this))},CComposeViewModel.prototype.getMessageOnRoute=function(){var e=this.routeParams(),t="",i="";""!==this.routeType()&&3===e.length&&(t=e[1],i=e[2],App.MailCache.getMessage(t,i,this.onMessageResponse,this))},CComposeViewModel.prototype.onShow=function(){var e=this.focusedField();this.shown(!0),$(this.splitterDom()).trigger("resize"),this.useSaveMailInSentItems(AppData.User.getUseSaveMailInSentItems()),this.saveMailInSentItems(AppData.User.getSaveMailInSentItems()),this.oHtmlEditor.initCrea(this.textBody(),this.plainText(),"7"),this.oHtmlEditor.commit(),this.initUploader(),this.backToListOnSendOrSave(!1),this.startAutosaveTimer(),this.focusedField(e),$html.addClass("screen-compose"),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CComposeViewModel.prototype.onRoute=function(e){var t="",i={};switch(this.plainText(!1),this.pgpSecured(!1),this.pgpEncrypted(!1),this.fromDrafts(!1),this.bUploadStatus=!1,window.clearTimeout(this.iUploadAttachmentsTimer),this.messageUploadAttachmentsStarted(!1),this.draftUid(""),this.draftInfo.removeAll(),this.setDataFromMessage(new CMessageModel),this.isDraftsCleared(!1),this.routeType(e.length>0?e[0]:""),this.routeType()){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:case Enums.ReplyType.Resend:case Enums.ReplyType.Forward:case"drafts":this.routeParams(e),0!==this.folderList().iAccountId&&this.getMessageOnRoute();break;default:t=App.MessageSender.getSignatureText(this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),AppData.SingleMode&&window.opener&&window.opener.aMessagesParametersFromCompose&&window.opener.aMessagesParametersFromCompose[window.name]?this.setMessageDataInSingleMode(window.opener.aMessagesParametersFromCompose[window.name]):""!==t&&this.textBody("<br /><br />"+t+"<br />"),"to"===this.routeType()&&2===e.length&&(i=App.Links.parseToAddr(e[1]),this.setRecipient(this.toAddr,i.to),i.hasMailto&&(this.subject(i.subject),this.setRecipient(this.ccAddr,i.cc),this.setRecipient(this.bccAddr,i.bcc),""!==i.body&&this.textBody("<div>"+i.body+"</div>"))),"vcard"===this.routeType()&&2===e.length&&this.addContactAsAttachment(e[1]),"file"===this.routeType()&&2===e.length&&this.addFilesAsAttachment(e[1]),"data-as-file"===this.routeType()&&3===e.length&&this.addDataAsAttachment(e[1],e[2]),_.defer(_.bind(function(){this.focusAfterFilling()},this))}this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0),this.allowFiles(AppData.User.IsFilesSupported&&AppData.User.filesEnable()),AppData.SingleMode&&this.changedInPreviousWindow()&&_.defer(_.bind(this.executeSave,this,!0))},CComposeViewModel.prototype.focusToAddr=function(){$(this.toAddrDom()).inputosaurus("focus")},CComposeViewModel.prototype.focusCcAddr=function(){$(this.ccAddrDom()).inputosaurus("focus")},CComposeViewModel.prototype.focusBccAddr=function(){$(this.bccAddrDom()).inputosaurus("focus")},CComposeViewModel.prototype.focusAfterFilling=function(){switch(this.focusedField()){case"to":this.focusToAddr();break;case"cc":this.visibleCc(!0),this.focusCcAddr();break;case"bcc":this.visibleBcc(!0),this.focusBccAddr();break;case"subject":this.subjectFocused(!0);break;case"text":this.oHtmlEditor.setFocus();break;default:0===this.toAddr().length?this.focusToAddr():0===this.subject().length?this.subjectFocused(!0):this.oHtmlEditor.setFocus()}},CComposeViewModel.prototype.beforeHide=function(e){var t=Utils.i18n("COMPOSE/CONFIRM_DISCARD_CHANGES"),i=_.bind(function(t){t&&Utils.isFunc(e)?(this.commit(),e()):App.Routing.historyBackWithoutParsing(Enums.Screens.Compose)},this);!this.closeBecauseSingleCompose()&&this.hasSomethingToSave()?App.Screens.showPopup(ConfirmPopup,[t,i]):Utils.isFunc(e)&&e()},CComposeViewModel.prototype.onHide=function(){this.stopAutosaveTimer(),!Utils.isFunc(this.closeCommand)&&this.hasSomethingToSave()&&this.executeSave(!0),this.fromToExpandColapssed(!1),this.shown(!1),this.routeParams([]),this.subjectFocused(!1),this.focusedField(""),this.oHtmlEditor.closeAllPopups(),this.oHtmlEditor.visibleLinkPopup(!1),this.messageUploadAttachmentsStarted(!1),$html.removeClass("screen-compose").removeClass("screen-compose-cc").removeClass("screen-compose-bcc").removeClass("screen-compose-attachments"),this.minHeightRemoveTrigger(!0),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CComposeViewModel.prototype.sendingAndSavingSubscription=function(){(this.sending()||this.saving())&&this.stopAutosaveTimer(),this.sending()||this.saving()||this.startAutosaveTimer()},CComposeViewModel.prototype.stopAutosaveTimer=function(){window.clearTimeout(this.autoSaveTimer)},CComposeViewModel.prototype.startAutosaveTimer=function(){if(this.shown()&&!this.pgpSecured()){var e=_.bind(this.executeSave,this,!0);this.stopAutosaveTimer(),AppData.User.AllowAutosaveInDrafts&&(this.autoSaveTimer=window.setTimeout(e,1e3*AppData.App.AutoSaveIntervalSeconds))}},CComposeViewModel.prototype.setRecipient=function(e,t){e()===t?e.valueHasMutated():e(t)},CComposeViewModel.prototype.onMessageResponse=function(e){var t=null;if(null===e)this.setDataFromMessage(new CMessageModel);else{switch(this.routeType()){case Enums.ReplyType.Reply:case Enums.ReplyType.ReplyAll:this.oSenderSelector.setFetcherOrIdentityByReplyMessage(e),t=App.MessageSender.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.setRecipient(this.bccAddr,t.Bcc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Enums.ReplyType.Forward:this.oSenderSelector.setFetcherOrIdentityByReplyMessage(e),t=App.MessageSender.getReplyDataFromMessage(e,this.routeType(),this.senderAccountId(),this.selectedFetcherOrIdentity(),!0),this.draftInfo(t.DraftInfo),this.draftUid(t.DraftUid),this.setRecipient(this.toAddr,t.To),this.setRecipient(this.ccAddr,t.Cc),this.subject(t.Subject),this.textBody(t.Text),this.attachments(t.Attachments),this.inReplyTo(t.InReplyTo),this.references(t.References);break;case Enums.ReplyType.Resend:this.setDataFromMessage(e);break;case"drafts":this.draftUid(e.uid()),this.setDataFromMessage(e),this.fromDrafts(!0)}this.routeType("")}this.attachments().length>0&&this.requestAttachmentsTempName(),this.visibleCc(""!==this.ccAddr()),this.visibleBcc(""!==this.bccAddr()),this.commit(!0),_.defer(_.bind(function(){this.focusAfterFilling()},this)),this.minHeightAdjustTrigger(!0)},CComposeViewModel.prototype.setDataFromMessage=function(e){var t="",i=!1,s=!1,o=App.MessageSender.getFirstFetcherOrIdentityByRecipientsOrDefault(e.oFrom.aCollection,e.accountId());this.oSenderSelector.changeSenderAccountId(e.accountId(),o),e.isPlain()?(i=-1!==e.textRaw().indexOf("-----BEGIN PGP MESSAGE-----"),s=-1!==e.textRaw().indexOf("-----BEGIN PGP SIGNED MESSAGE-----"),s||i?(t=e.textRaw(),this.pgpSecured(!0),this.pgpEncrypted(i)):t=e.textRaw()):t=e.getConvertedHtml(),this.draftInfo(e.draftInfo()),this.inReplyTo(e.inReplyTo()),this.references(e.references()),this.setRecipient(this.toAddr,e.oTo.getFull()),this.setRecipient(this.ccAddr,e.oCc.getFull()),this.setRecipient(this.bccAddr,e.oBcc.getFull()),this.subject(e.subject()),this.attachments(e.attachments()),this.plainText(e.isPlain()),this.textBody(t),this.selectedImportance(e.importance()),this.selectedSensitivity(e.sensitivity()),this.readingConfirmation(e.readingConfirmation())
},CComposeViewModel.prototype.addDataAsAttachment=function(e,t){var i="data-as-attachment-"+Math.random(),s={Action:"DataAsAttachmentUpload",Data:e,FileName:t,Hash:i},o=new CMailAttachmentModel;this.subject(t.substr(0,t.length-4)),o.fileName(t),o.hash(i),o.uploadStarted(!0),this.attachments.push(o),this.messageUploadAttachmentsStarted(!0),App.Ajax.send(s,this.onDataAsAttachmentUpload,this)},CComposeViewModel.prototype.onDataAsAttachmentUpload=function(e,t){var i=e.Result,s=t.Hash,o=_.find(this.attachments(),function(e){return e.hash()===s});this.messageUploadAttachmentsStarted(!1),o&&(i&&i.Attachment?o.parseFromUpload(i.Attachment,e.AccountID):o.errorFromUpload())},CComposeViewModel.prototype.addFilesAsAttachment=function(e){var t=null,i=[],s=null;_.each(e,function(e){t=new CMailAttachmentModel,t.fileName(e.fileName()),t.hash(e.hash()),t.thumb(e.thumb()),t.uploadStarted(!0),this.attachments.push(t),i.push(e.hash())},this),i.length>0&&(s={Action:"FilesUpload",Hashes:i},this.messageUploadAttachmentsStarted(!0),App.Ajax.send(s,this.onFilesUpload,this))},CComposeViewModel.prototype.onFilesUpload=function(e,t){var i=e.Result,s=t.Hashes,o=Date.now().toString();this.messageUploadAttachmentsStarted(!1),$.isArray(i)?_.each(i,function(t){var i=_.find(this.attachments(),function(e){return e.hash()===t.Hash});i&&(i.parseFromUpload(t,e.AccountID),i.hash(t.NewHash),i.getInThumbQueue(o))},this):_.each(s,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this)},CComposeViewModel.prototype.addContactAsAttachment=function(e){var t=new CMailAttachmentModel,i=null;e&&(t.fileName("contact-"+e.idContact()+".vcf"),t.uploadStarted(!0),this.attachments.push(t),i={Action:"ContactVCardUpload",ContactId:e.idContact(),Global:e.global()?"1":"0",Name:t.fileName(),SharedWithAll:e.sharedToAll()?"1":"0"},this.messageUploadAttachmentsStarted(!0),App.Ajax.send(i,this.onContactVCardUpload,this))},CComposeViewModel.prototype.onContactVCardUpload=function(e,t){var i=e.Result,s=null;this.messageUploadAttachmentsStarted(!1),i?(s=_.find(this.attachments(),function(e){return e.fileName()===i.Name&&e.uploadStarted()}),s&&s.parseFromUpload(i,e.AccountID)):(s=_.find(this.attachments(),function(e){return e.fileName()===t.Name&&e.uploadStarted()}),s&&s.errorFromUpload())},CComposeViewModel.prototype.requestAttachmentsTempName=function(){var e=_.map(this.attachments(),function(e){return e.uploadUid(e.hash()),e.uploadStarted(!0),e.hash()}),t={Action:"MessageAttachmentsUpload",Attachments:e};e.length>0&&(this.messageUploadAttachmentsStarted(!0),App.Ajax.send(t,this.onMessageUploadAttachmentsResponse,this))},CComposeViewModel.prototype.onMessageUploadAttachmentsResponse=function(e,t){var i=t.Attachments;this.messageUploadAttachmentsStarted(!1),e.Result?_.each(e.Result,_.bind(this.setAttachTepmNameByHash,this)):(_.each(i,function(e){var t=_.find(this.attachments(),function(t){return t.hash()===e});t&&t.errorFromUpload()},this),App.Api.showError(Utils.i18n("COMPOSE/UPLOAD_ERROR_REPLY_ATTACHMENTS")))},CComposeViewModel.prototype.setAttachTepmNameByHash=function(e,t){_.each(this.attachments(),function(i){i.hash()===e&&(i.tempName(t),i.uploadStarted(!1))})},CComposeViewModel.prototype.setMessageDataInSingleMode=function(e){this.draftInfo(e.draftInfo),this.draftUid(e.draftUid),this.inReplyTo(e.inReplyTo),this.references(e.references),this.setRecipient(this.toAddr,e.toAddr),this.setRecipient(this.ccAddr,e.ccAddr),this.setRecipient(this.bccAddr,e.bccAddr),this.subject(e.subject),this.attachments(_.map(e.attachments,function(e){var t=new CMailAttachmentModel;return t.parse(e,this.senderAccountId()),t},this)),this.textBody(e.textBody),this.selectedImportance(e.selectedImportance),this.selectedSensitivity(e.selectedSensitivity),this.readingConfirmation(e.readingConfirmation),this.changedInPreviousWindow(e.changedInPreviousWindow),this.oSenderSelector.changeSenderAccountId(e.senderAccountId,e.selectedFetcherOrIdentity),this.focusedField(e.focusedField)},CComposeViewModel.prototype.commit=function(e){this.toAddr.commit(),this.ccAddr.commit(),this.bccAddr.commit(),this.subject.commit(),this.oHtmlEditor.commit(),this.attachmentsChanged(!1),e||this.changedInPreviousWindow(!1)},CComposeViewModel.prototype.isChanged=function(){var e=this.toAddr.changed(),t=this.ccAddr.changed(),i=this.bccAddr.changed(),s=this.subject.changed(),o=this.oHtmlEditor.textChanged(),n=this.attachmentsChanged(),r=this.changedInPreviousWindow();return e||t||i||s||o||n||r},CComposeViewModel.prototype.executeBackToList=function(){AppData.SingleMode?window.close():this.shown()&&App.Routing.setPreviousHash(),this.backToListOnSendOrSave(!1)},CComposeViewModel.prototype.onFileUploadSelect=function(e,t){var i;return App.Api.showErrorIfAttachmentSizeLimit(t.FileName,Utils.pInt(t.Size))?!1:(i=new CMailAttachmentModel,i.onUploadSelect(e,t),this.attachments.push(i),!0)},CComposeViewModel.prototype.getAttachmentByUid=function(e){return _.find(this.attachments(),function(t){return t.uploadUid()===e})},CComposeViewModel.prototype.onFileUploadStart=function(e){var t=this.getAttachmentByUid(e);t&&t.onUploadStart()},CComposeViewModel.prototype.onFileUploadProgress=function(e,t,i){var s=this.getAttachmentByUid(e);s&&s.onUploadProgress(t,i)},CComposeViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=this.getAttachmentByUid(e),o=Date.now().toString();s&&(s.onUploadComplete(e,t,i),"image"===s.type().substr(0,5)&&(s.thumb(!0),s.getInThumbQueue(o)))},CComposeViewModel.prototype.onFileRemove=function(e){var t=this.getAttachmentByUid(e);this.oJua&&this.oJua.cancel(e),this.attachments.remove(t)},CComposeViewModel.prototype.initUploader=function(){this.shown()&&this.composeUploaderButton()&&null===this.oJua&&(this.oJua=new Jua({action:"?/Upload/Attachment/",name:"jua-uploader",queueSize:2,clickElement:this.composeUploaderButton(),hiddenElementsPosition:Utils.isRTL()?"right":"left",dragAndDropElement:this.composeUploaderDropPlace(),disableAjaxUpload:!1,disableFolderDragAndDrop:!1,disableDragAndDrop:!1,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.oJua.on("onDragEnter",_.bind(this.composeUploaderDragOver,this,!0)).on("onDragLeave",_.bind(this.composeUploaderDragOver,this,!1)).on("onBodyDragEnter",_.bind(this.composeUploaderBodyDragOver,this,!0)).on("onBodyDragLeave",_.bind(this.composeUploaderBodyDragOver,this,!1)).on("onProgress",_.bind(this.onFileUploadProgress,this)).on("onSelect",_.bind(this.onFileUploadSelect,this)).on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this)),this.allowDragNDrop(this.oJua.isDragAndDropSupported()))},CComposeViewModel.prototype.getSendSaveParameters=function(e){var t=App.MessageSender.convertAttachmentsForSending(this.attachments());return _.each(this.oHtmlEditor.uploadedImagePathes(),function(e){t[e.TempName]=[e.Name,e.CID,"1","1"]}),{AccountID:this.senderAccountId(),FetcherID:this.selectedFetcherOrIdentity()&&this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",IdentityID:this.selectedFetcherOrIdentity()&&!this.selectedFetcherOrIdentity().FETCHER?this.selectedFetcherOrIdentity().id():"",DraftInfo:this.draftInfo(),DraftUid:this.draftUid(),To:this.toAddr(),Cc:this.ccAddr(),Bcc:this.bccAddr(),Subject:this.subject(),Text:this.plainText()?this.oHtmlEditor.getPlainText():this.oHtmlEditor.getText(e),IsHtml:this.plainText()?"0":"1",Importance:this.selectedImportance(),Sensitivity:this.selectedSensitivity(),ReadingConfirmation:this.readingConfirmation()?"1":"0",Attachments:t,InReplyTo:this.inReplyTo(),References:this.references()}},CComposeViewModel.prototype.onMessageSendOrSaveResponse=function(e,t){var i=App.MessageSender.onMessageSendOrSaveResponse(e,t,this.requiresPostponedSending());switch(this.commit(),i.Action){case"MessageSave":i.Result&&t.DraftUid===this.draftUid()&&(this.draftUid(Utils.pString(i.NewUid)),AppData.SingleMode&&App.Routing.replaceHashDirectly(App.Links.composeFromMessage("drafts",t.DraftFolder,this.draftUid()))),this.saving(!1);break;case"MessageSend":i.Result&&this.backToListOnSendOrSave()&&(Utils.isFunc(this.closeCommand)?this.closeCommand():this.executeBackToList()),this.sending(!1)}},CComposeViewModel.prototype.verifyDataForSending=function(){var e=Utils.Address.getIncorrectEmailsFromAddressString(this.toAddr()),t=Utils.Address.getIncorrectEmailsFromAddressString(this.ccAddr()),i=Utils.Address.getIncorrectEmailsFromAddressString(this.bccAddr()),s=_.union(e,t,i),o=Utils.i18n("COMPOSE/WARNING_INPUT_CORRECT_EMAILS")+s.join(", ");return s.length>0?(App.Screens.showPopup(AlertPopup,[o]),!1):!0},CComposeViewModel.prototype.executeSend=function(e){var t=e===!0;this.isEnableSending()&&this.verifyDataForSending()&&(!t&&this.enableOpenPgp()&&AppData.User.AutosignOutgoingEmails&&!this.pgpSecured()?this.openPgpPopup(!0):(this.sending(!0),this.requiresPostponedSending(!this.allowStartSending()),App.MessageSender.send("MessageSend",this.getSendSaveParameters(!0),this.saveMailInSentItems(),!0,this.onMessageSendOrSaveResponse,this,this.requiresPostponedSending())),this.backToListOnSendOrSave(!0))},CComposeViewModel.prototype.executeSaveCommand=function(){this.executeSave(!1)},CComposeViewModel.prototype.executeSave=function(e,t){if(e=Utils.isUnd(e)?!1:e,t=Utils.isUnd(t)?!0:t,!e||!App.MailCache.disableComposeAutosave()){var i=Utils.i18n("OPENPGP/CONFIRM_SAVE_ENCRYPTED_DRAFT"),s=Utils.i18n("COMPOSE/TOOL_SAVE"),o=_.bind(function(i){i&&(t?(this.saving(!0),App.MessageSender.send("MessageSave",this.getSendSaveParameters(!1),this.saveMailInSentItems(),!e,this.onMessageSendOrSaveResponse,this)):App.MessageSender.send("MessageSave",this.getSendSaveParameters(!1),this.saveMailInSentItems(),!e,App.MessageSender.onMessageSendOrSaveResponse,App.MessageSender))},this);this.isEnableSaving()&&(!e||this.isChanged()?!e&&this.pgpSecured()?App.Screens.showPopup(ConfirmPopup,[i,o,"",s]):o(!0):e&&this.startAutosaveTimer(),this.backToListOnSendOrSave(!0))}},CComposeViewModel.prototype.changeBccVisibility=function(){this.visibleBcc(!this.visibleBcc()),this.visibleBcc()?this.focusBccAddr():this.focusToAddr()},CComposeViewModel.prototype.changeCcVisibility=function(){this.visibleCc(!this.visibleCc()),this.visibleCc()?this.focusCcAddr():this.focusToAddr()},CComposeViewModel.prototype.getMessageDataForSingleMode=function(){var e=_.map(this.attachments(),function(e){return{"@Object":"Object/CApiMailAttachment",FileName:e.fileName(),TempName:e.tempName(),MimeType:e.type(),MimePartIndex:e.mimePartIndex(),EstimatedSize:e.size(),CID:e.cid(),ContentLocation:e.contentLocation(),IsInline:e.inline(),IsLinked:e.linked(),Hash:e.hash()}});return{accountId:this.senderAccountId(),draftInfo:this.draftInfo(),draftUid:this.draftUid(),inReplyTo:this.inReplyTo(),references:this.references(),senderAccountId:this.senderAccountId(),selectedFetcherOrIdentity:this.selectedFetcherOrIdentity(),toAddr:this.toAddr(),ccAddr:this.ccAddr(),bccAddr:this.bccAddr(),subject:this.subject(),attachments:e,textBody:this.oHtmlEditor.getText(),selectedImportance:this.selectedImportance(),selectedSensitivity:this.selectedSensitivity(),readingConfirmation:this.readingConfirmation(),changedInPreviousWindow:this.isChanged(),focusedField:this.focusedField()}},CComposeViewModel.prototype.openInNewWindow=function(){var e="id"+Math.random().toString(),t={},i=null,s="#"+Enums.Screens.SingleCompose;this.closeBecauseSingleCompose(!0),t=this.getMessageDataForSingleMode(),this.draftUid().length>0&&!this.isChanged()?(s=App.Routing.buildHashFromArray(App.Links.composeFromMessage("drafts",App.MailCache.folderList().draftsFolderFullName(),this.draftUid(),!0)),i=Utils.WindowOpener.openTab(s)):this.isChanged()?(window.aMessagesParametersFromCompose||(window.aMessagesParametersFromCompose=[]),window.aMessagesParametersFromCompose[e]=t,i=Utils.WindowOpener.openTab(s,e)):(s=App.Routing.buildHashFromArray(_.union([Enums.Screens.SingleCompose],this.routeParams())),i=Utils.WindowOpener.openTab(s)),this.commit(),Utils.isFunc(this.closeCommand)?this.closeCommand():this.executeBackToList()},CComposeViewModel.prototype.autocompleteCallback=function(e,t){var i={Action:"ContactSuggestions",Search:e};App.Ajax.send(i,function(e){var i=[];e&&e.Result&&e.Result&&e.Result.List&&(i=_.map(e.Result.List,function(e){var t="",i=e.Email;return e.IsGroup?t=e.Name&&0<Utils.trim(e.Name).length?'"'+e.Name+'" ('+e.Email+")":"("+e.Email+")":(t=Utils.Address.getFullEmail(e.Name,e.Email),i=t),{label:t,value:i,frequency:e.Frequency,id:e.Id,global:e.Global,sharedToAll:e.SharedToAll}}),i=_.sortBy(_.compact(i),function(e){return e.frequency}).reverse()),t(i)},this)},CComposeViewModel.prototype.onShowFilesPopupClick=function(){var e=_.bind(this.addFilesAsAttachment,this);App.Screens.showPopup(FileStoragePopup,[e])},CComposeViewModel.prototype.confirmOpenPgp=function(){var e=Utils.i18n("OPENPGP/CONFIRM_HTML_TO_PLAIN_FORMATTING"),t=_.bind(function(e){e&&this.openPgpPopup(!1)},this);this.notInlineAttachments().length>0&&(e+="\r\n\r\n"+Utils.i18n("OPENPGP/CONFIRM_HTML_TO_PLAIN_ATTACHMENTS")),App.Screens.showPopup(ConfirmPopup,[e,t])},CComposeViewModel.prototype.openPgpPopup=function(e){var t=this.oHtmlEditor.getPlainText(),i=_.bind(function(t,i){e||(this.stopAutosaveTimer(),this.executeSave(!0)),this.plainText(!0),this.textBody(t),this.pgpSecured(!0),this.pgpEncrypted(i),e&&this.executeSend(!0)},this),s=_.bind(function(){e&&this.executeSend(!0)},this);App.Screens.showPopup(COpenPgpEncryptPopup,[t,AppData.Accounts.getEmail(this.senderAccountId()),this.recipientEmails(),e,i,s])},CComposeViewModel.prototype.undoPgp=function(){var e=this.textBody(),t=[];this.pgpSecured()&&(this.plainText(!1),this.fromDrafts()&&!this.pgpEncrypted()?(t=e.split("-----BEGIN PGP SIGNED MESSAGE-----"),2===t.length&&(e=t[1]),t=e.split("-----BEGIN PGP SIGNATURE-----"),2===t.length&&(e=t[0]),t=e.split("\r\n\r\n"),t.length>0&&(t.shift(),e=t.join("\r\n\r\n")),e="<div>"+e.replace(/\r\n/gi,"<br />")+"</div>",this.textBody(e)):this.oHtmlEditor.undoAndClearRedo(),this.fromToExpandColapssed(!1),this.pgpSecured(!1),this.pgpEncrypted(!1))},CComposeViewModel.prototype.autocompleteDeleteItem=function(e){var t={Action:"ContactSuggestionDelete",ContactId:e.id,SharedToAll:e.sharedToAll?"1":"0"};App.Ajax.send(t,function(){return!0},this)},CSenderSelector.prototype.changeSelectedSender=function(e){if(e){var t=Utils.pString(e.id());e.FETCHER&&(t="fetcher"+t),_.find(this.senderList(),function(e){return e.id===t})&&(this.lockSelectedSender(!0),this.selectedSender(t),this.selectedFetcherOrIdentity(e),this.lockSelectedSender(!1))}},CSenderSelector.prototype.changeSenderAccountId=function(e,t){var i=!1;this.senderAccountId()!==e&&(AppData.Accounts.hasAccountWithId(e)?(this.senderAccountId(e),i=!0):AppData.Accounts.hasAccountWithId(this.senderAccountId())||(this.senderAccountId(AppData.Accounts.currentId()),i=!0)),(i||0===this.senderList().length)&&(this.fillSenderList(t),i=!0),!i&&t&&this.changeSelectedSender(t)},CSenderSelector.prototype.fillSenderList=function(e){var t=[],i=AppData.Accounts.getAccount(this.senderAccountId());i&&(_.isArray(i.identities())&&_.each(i.identities(),function(e){e.enabled()&&t.push({fullEmail:e.fullEmail(),id:Utils.pString(e.id())})},this),i.identitiesSubscribtion||(i.identitiesSubscribtion=i.identities.subscribe(function(){this.fillSenderList(e),this.changeSelectedSender(i.getDefaultIdentity())},this)),i.fetchers()?_.each(i.fetchers().collection(),function(e){var i=e.fullEmail();e.isOutgoingEnabled()&&i.length>0&&t.push({fullEmail:i,id:"fetcher"+e.id()})},this):i.fetchersSubscribtion||(i.fetchersSubscribtion=i.fetchers.subscribe(function(){this.fillSenderList(e)},this))),this.senderList(t),this.changeSelectedSender(e)},CSenderSelector.prototype.setFetcherOrIdentityByReplyMessage=function(e){var t=e.oTo.aCollection.concat(e.oCc.aCollection),i=App.MessageSender.getFirstFetcherOrIdentityByRecipientsOrDefault(t,e.accountId());i&&this.changeSelectedSender(i)},CContactsImportViewModel.prototype.onApplyBindings=function(e){this.oJua=new Jua({action:"?/Upload/Contacts/",name:"jua-uploader",queueSize:1,clickElement:$("#jue_import_button",e),hiddenElementsPosition:Utils.isRTL()?"right":"left",disableAjaxUpload:!1,disableDragAndDrop:!0,disableMultiple:!0,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()}}}),this.oJua.on("onStart",_.bind(this.onFileUploadStart,this)).on("onComplete",_.bind(this.onFileUploadComplete,this))},CContactsImportViewModel.prototype.onFileUploadStart=function(){this.importing(!0)},CContactsImportViewModel.prototype.onFileUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1,o=0;this.importing(!1),this.oParent.requestContactList(),s?App.Api.showError(i.ErrorCode&&i.ErrorCode===Enums.Errors.IncorrectFileExtension?Utils.i18n("CONTACTS/ERROR_INCORRECT_FILE_EXTENSION"):Utils.i18n("WARNING/ERROR_UPLOAD_FILE")):(o=Utils.pInt(i.Result.ImportedCount),o>0?App.Api.showReport(Utils.i18n("CONTACTS/CONTACT_IMPORT_HINT_PLURAL",{NUM:o},null,o)):App.Api.showError(Utils.i18n("WARNING/CONTACTS_IMPORT_NO_CONTACTS")))},CContactsViewModel.prototype.groupDropdownToggle=function(e){this.currentGroupDropdown(e)},CContactsViewModel.prototype.gotoGroupList=function(){this.changeSelectedPanel(Enums.MobilePanel.Groups)},CContactsViewModel.prototype.gotoContactList=function(){return this.changeSelectedPanel(Enums.MobilePanel.Items),!0},CContactsViewModel.prototype.gotoViewPane=function(){this.changeSelectedPanel(Enums.MobilePanel.View)},CContactsViewModel.prototype.backToContactList=function(){var e=this.selectedGroupType(),t=e===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"";App.Routing.setHash(App.Links.contacts(e,t,this.search(),this.oPageSwitcher.currentPage()))},CContactsViewModel.prototype.changeSelectedPanel=function(e){this.mobileApp&&this.selectedPanel()!==e&&(this.selectedPanel(e),(bIsWindowsPhone||App.browser.ie)&&(this.$viewModel.hide(),_.defer(_.bind(function(){this.$viewModel.show()},this))))},CContactsViewModel.prototype.executeSave=function(e){var t={},i=[];e===this.selectedItem()&&this.selectedItem().canBeSave()?e instanceof CContactModel&&!e.readOnly()?(_.each(this.groupFullCollection(),function(e){e&&e.checked()&&i.push(e.Id())}),e.groups(i),t=e.toObject(),t.Action=e.isNew()?"ContactCreate":"ContactUpdate",t.SharedToAll=e.isNew()?Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0":e.sharedToAll()?"1":"0",e.edited()&&e.edited(!1),e.isNew()&&this.selectedItem(null),this.selectedItem()&&App.ContactsCache.clearInfoAboutEmail(this.selectedItem().email()),(this.selectedGroupType()===Enums.ContactsGroupListType.Global||this.selectedGroupType()===Enums.ContactsGroupListType.All)&&this.recivedAnimUnshare(!0),App.Ajax.send(t,this.onContactCreateResponse,this)):e instanceof CGroupModel&&!e.readOnly()&&(t=e.toObject(),t.Action=e.isNew()?"ContactsGroupCreate":"ContactsGroupUpdate",this.gotoGroupList(),e.edited()&&e.edited(!1),e.isNew()&&!this.mobileApp&&this.selectedItem(null),App.Ajax.send(t,this.onGroupCreateResponse,this)):App.Api.showError(Utils.i18n("CONTACTS/ERROR_EMPTY_CONTACT"))},CContactsViewModel.prototype.executeNewContact=function(){if(this.showPersonalContacts()){var e=this.selectedGroupInList();this.oContactModel.switchToNew(),this.oContactModel.groups(e?[e.Id()]:[]),this.selectedItem(this.oContactModel),this.selector.itemSelected(null),this.gotoViewPane()}},CContactsViewModel.prototype.executeNewGroup=function(){this.oGroupModel.switchToNew(),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.gotoViewPane()},CContactsViewModel.prototype.executeDelete=function(){var e=this.selectedGroupType();if(e===Enums.ContactsGroupListType.Personal||e===Enums.ContactsGroupListType.SharedToAll){var t=_.filter(this.selector.listCheckedOrSelected(),function(e){return!e.ReadOnly()}),i=t.length,s=Utils.i18n("CONTACTS/CONFIRM_DELETE_CONTACT_PLURAL",{},null,i),o=_.bind(function(e){e&&this.deleteContacts(t)},this);App.Screens.showPopup(ConfirmPopup,[s,o])}else e===Enums.ContactsGroupListType.SubGroup&&this.removeFromGroupCommand()},CContactsViewModel.prototype.deleteContacts=function(e){var t=this,i=this.selectedContact(),s=_.map(e,function(e){return e.Id()});0<s.length&&(this.preLoadingList(!0),_.each(e,function(e){e&&(App.ContactsCache.clearInfoAboutEmail(e.Email()),!i||e.IsGroup()||e.ReadOnly()||i.readOnly()||i.idContact()!==e.Id()||(i=null,this.selectedContact(null)))},this),_.each(this.collection(),function(t){-1<Utils.inArray(t,e)&&t.deleted(!0)}),_.delay(function(){t.collection.remove(function(e){return e.deleted()})},500),App.Ajax.send({Action:"ContactDelete",ContactsId:s.join(","),SharedToAll:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0"},this.requestContactList,this),App.ContactsCache.markVcardsNonexistentByUid(s))},CContactsViewModel.prototype.executeRemoveFromGroup=function(){var e=this,t=this.selectedGroupInList(),i=this.selector.listCheckedOrSelected(),s=_.map(i,function(e){return e.ReadOnly()?"":e.Id()});s=_.compact(s),t&&0<s.length&&(this.preLoadingList(!0),_.each(this.collection(),function(e){-1<Utils.inArray(e,i)&&e.deleted(!0)}),_.delay(function(){e.collection.remove(function(e){return e.deleted()})},500),App.Ajax.send({Action:"ContactsRemoveFromGroup",GroupId:t.Id(),ContactsId:s.join(",")},this.requestContactList,this))},CContactsViewModel.prototype.executeImport=function(){this.selectedItem(null),this.oContactImportViewModel.visibility(!0),this.selector.itemSelected(null),this.selectedGroupType(Enums.ContactsGroupListType.Personal),this.gotoViewPane()},CContactsViewModel.prototype.executeCSVExport=function(){App.Api.downloadByUrl(Utils.getExportContactsLink("csv"))},CContactsViewModel.prototype.executeVCFExport=function(){App.Api.downloadByUrl(Utils.getExportContactsLink("vcf"))},CContactsViewModel.prototype.executeCancel=function(){var e=this.selectedItem();e&&(e instanceof CContactModel&&!e.readOnly()?e.isNew()?this.selectedItem(null):e.edited()&&e.edited(!1):e instanceof CGroupModel&&!e.readOnly()&&(e.isNew()?this.selectedItem(null):e.edited()&&(this.selectedItem(this.selectedOldItem()),e.edited(!1)),this.gotoGroupList())),this.oContactImportViewModel.visibility(!1)},CContactsViewModel.prototype.executeAddContactsToGroup=function(e,t){e&&_.isArray(t)&&0<t.length&&(e.recivedAnim(!0),this.executeAddContactsToGroupId(e.Id(),t))},CContactsViewModel.prototype.executeAddContactsToGroupId=function(e,t){e&&_.isArray(t)&&0<t.length&&App.Ajax.send({Action:"ContactsAddToGroup",GroupId:e,ContactsId:t},this.onContactsAddToGroupResponse,this)},CContactsViewModel.prototype.onContactsAddToGroupResponse=function(){this.requestContactList(),this.selector.itemSelected()&&this.requestContact(this.selector.itemSelected().sId)},CContactsViewModel.prototype.executeAddSelectedContactsToGroup=function(e){var t=this.selector.listCheckedOrSelected(),i=[];e&&_.isArray(t)&&0<t.length&&_.each(t,function(e){e&&!e.IsGroup()&&i.push([e.Id(),e.Global()?"1":"0"])},this),this.executeAddContactsToGroup(e,i)},CContactsViewModel.prototype.groupsInContactView=function(e){var t=[],i=[];return e&&!e.groupsIsEmpty()&&(i=e.groups(),t=_.filter(this.groupFullCollection(),function(e){return 0<=Utils.inArray(e.Id(),i)})),t},CContactsViewModel.prototype.onShow=function(){this.selector.useKeyboardKeys(!0),this.oPageSwitcher.show(),this.oPageSwitcher.perPage(AppData.User.ContactsPerPage),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!0)},CContactsViewModel.prototype.onHide=function(){this.selector.listCheckedOrSelected(!1),this.selector.useKeyboardKeys(!1),this.selectedItem(null),this.oPageSwitcher.hide(),this.oJua&&this.oJua.setDragAndDropEnabledStatus(!1)},CContactsViewModel.prototype.onApplyBindings=function(){this.selector.initOnApplyBindings(".contact_sub_list .item",".contact_sub_list .selected.item",".contact_sub_list .item .custom_checkbox",$(".contact_list",this.$viewModel),$(".contact_list_scroll.scroll-inner",this.$viewModel));var e=this;this.$viewModel.on("click",".content .item.add_to .dropdown_helper .item",function(){$(this).hasClass("new-group")?e.executeNewGroup():e.executeAddSelectedContactsToGroup(ko.dataFor(this))}),this.showPersonalContacts(!!AppData.User.ShowPersonalContacts),this.showGlobalContacts(!!AppData.User.ShowGlobalContacts),this.showSharedToAllContacts(!!AppData.App.AllowContactsSharing),this.selectedGroupType.valueHasMutated(),this.oContactImportViewModel.onApplyBindings(this.$viewModel),this.requestGroupFullList(),this.hotKeysBind(),this.initUploader()},CContactsViewModel.prototype.hotKeysBind=function(){var e=!1;$(document).on("keydown",_.bind(function(t){var i=t.keyCode,s=this.collection()[0],o=this.isSearchFocused(),n=!1,r=App.Screens.currentScreen()===Enums.Screens.Contacts;r&&!Utils.isTextFieldFocused()&&!o&&t&&i===Enums.Key.s?(t.preventDefault(),this.searchFocus()):s&&(n=s.selected(),s&&o&&t&&i===Enums.Key.Down?(this.isSearchFocused(!1),this.selector.itemSelected(s),e=!0):!o&&e&&n&&t&&i===Enums.Key.Up?(this.isSearchFocused(!0),this.selector.itemSelected(!1),e=!1):n?e=!0:n||(e=!1))},this))},CContactsViewModel.prototype.requestContactList=function(){this.loadingList(!0),App.Ajax.send({Action:Enums.ContactsGroupListType.Global===this.selectedGroupType()?"ContactGlobalList":"ContactList",Offset:(this.oPageSwitcher.currentPage()-1)*AppData.User.ContactsPerPage,Limit:AppData.User.ContactsPerPage,SortField:this.sortType(),SortOrder:this.sortOrder()?"1":"0",Search:this.search(),GroupId:this.selectedGroupInList()?this.selectedGroupInList().Id():"",SharedToAll:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0",SharedToAll1:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0",All:Enums.ContactsGroupListType.All===this.selectedGroupType()?"1":"0"},this.onContactListResponse,this)},CContactsViewModel.prototype.requestGroupFullList=function(){App.Ajax.send({Action:"ContactsGroupFullList"},this.onGroupListResponse,this)},CContactsViewModel.prototype.requestContact=function(e){this.loadingViewPane(!0);var t=_.find(this.collection(),function(t){return t.sId===e});t&&(this.selector.itemSelected(t),App.Ajax.send({Action:t.Global()?"ContactGlobal":"ContactGet",ContactId:t.Id(),SharedToAll:t.IsSharedToAll()?"1":"0"},this.onContactGetResponse,this))},CContactsViewModel.prototype.requestContactById=function(e,t){this.loadingViewPane(!0),e&&App.Ajax.send({Action:t?"ContactGlobal":"ContactGet",ContactId:e},this.onContactGetResponse,this)},CContactsViewModel.prototype.editGroup=function(e){var t=new CGroupModel;t.populate(e),this.selectedOldItem(t),e.edited(!0)},CContactsViewModel.prototype.changeGroupType=function(e){App.Routing.setHash(App.Links.contacts(e))},CContactsViewModel.prototype.onViewGroupClick=function(e){App.Routing.setHash(App.Links.contacts(Enums.ContactsGroupListType.SubGroup,e.Id()))},CContactsViewModel.prototype.onRoute=function(e){var t=App.Links.parseContacts(e),i=[Enums.ContactsGroupListType.Personal,Enums.ContactsGroupListType.SharedToAll,Enums.ContactsGroupListType.Global,Enums.ContactsGroupListType.All],s=this.selectedGroupType()===Enums.ContactsGroupListType.SubGroup?this.currentGroupId():"",o=this.selectedGroupType()!==t.Type||s!==t.GroupId||this.search()!==t.Search,n=!0,r=!1;this.pageSwitcherLocked(!0),o?this.oPageSwitcher.clear():this.oPageSwitcher.setPage(t.Page,AppData.User.ContactsPerPage),this.pageSwitcherLocked(!1),t.Page!==this.oPageSwitcher.currentPage()&&App.Routing.replaceHash(App.Links.contacts(t.Type,t.GroupId,t.Search,this.oPageSwitcher.currentPage())),this.currentPage()!==t.Page&&(this.currentPage(t.Page),r=!0),-1!==Utils.inArray(t.Type,i)?this.selectedGroupType(t.Type):(s!==t.GroupId||""===t.Uid)&&(n=this.viewGroup(t.GroupId),n?r=!1:App.Routing.replaceHash(App.Links.contacts())),this.search()!==t.Search&&(this.search(t.Search),r=!0),this.contactUidForRequest(""),t.Uid?0===this.collection().length?this.contactUidForRequest(t.Uid):this.requestContact(t.Uid):(this.selector.itemSelected(null),this.gotoContactList()),r&&this.requestContactList(),this.createNewContact()},CContactsViewModel.prototype.viewGroup=function(e){var t=_.find(this.groupFullCollection(),function(t){return t&&t.Id()===e});return t&&(this.oGroupModel.clear(),this.oGroupModel.idGroup(t.Id()).name(t.Name()),t.IsOrganization()&&this.requestGroup(t),this.selectedGroupInList(t),this.selectedItem(this.oGroupModel),this.selector.itemSelected(null),this.selector.listCheckedOrSelected(!1),App.Ajax.send({Action:"ContactsGroupEvents",GroupId:e},this.onGroupEventsResponse,this)),!!t},CContactsViewModel.prototype.deleteGroup=function(e){e&&(App.Ajax.send({Action:"ContactsGroupDelete",GroupId:e},this.requestGroupFullList,this),this.selectedGroupType(Enums.ContactsGroupListType.Personal),this.groupFullCollection.remove(function(t){return t&&t.Id()===e}))},CContactsViewModel.prototype.mailGroup=function(e){e&&App.Ajax.send({Action:"ContactList",Offset:0,Limit:99,SortField:Enums.ContactSortType.Email,SortOrder:"1",GroupId:e.idGroup()},function(e){if(e&&e.Result&&e.Result.List){var t=0,i=0,s=[],o=null,n=[],r=e.Result.List;for(i=r.length;i>t;t++)r[t]&&"Object/CContactListItem"===Utils.pExport(r[t],"@Object","")&&(o=new CContactListItemModel,o.parse(r[t]),n.push(o));s=_.map(n,function(e){return e.EmailAndName()}),s=_.compact(s),App.Api.composeMessageToAddresses(s.join(", "))}},this)},CContactsViewModel.prototype.dragAndDropHelper=function(e){e&&e.checked(!0);var t=this.selector.itemSelected(),i=Utils.draggableMessages(),s=this.selector.listCheckedOrSelected().length,o=s>0?_.map(this.selector.listCheckedOrSelected(),function(e){return[e.Id(),e.Global()?"1":"0"]}):[];return t&&!t.checked()&&t.checked(!0),i.data("p7-contatcs-type",this.selectedGroupType()),i.data("p7-contatcs-uids",o),$(".count-text",i).text(Utils.i18n("CONTACTS/DRAG_TEXT_PLURAL",{COUNT:s},null,s)),i},CContactsViewModel.prototype.contactsDrop=function(e,t,i){if(e){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-contatcs-uids"):null;null!==o&&(Utils.uiDropHelperAnim(t,i),this.executeAddContactsToGroup(e,o))}},CContactsViewModel.prototype.contactsDropToGroupType=function(e,t,i){var s=i&&i.helper?i.helper:null,o=s?s.data("p7-contatcs-type"):null,n=s?s.data("p7-contatcs-uids"):null;e!==o&&null!==o&&null!==n&&(Utils.uiDropHelperAnim(t,i),this.executeShare())},CContactsViewModel.prototype.searchFocus=function(){this.selector.useKeyboardKeys()&&!Utils.isTextFieldFocused()&&this.isSearchFocused(!0)},CContactsViewModel.prototype.onContactDblClick=function(e){e&&App.Api.composeMessageToAddresses(e.EmailAndName())},CContactsViewModel.prototype.onClearSearchClick=function(){this.searchInput(""),this.searchSubmitCommand()},CContactsViewModel.prototype.onContactGetResponse=function(e){if(e&&e.Action&&e.Result){var t=new CContactModel,i=this.selector.itemSelected();t.parse(e.Result),i&&i.Id()===t.idContact()&&this.selectedItem(t)}},CContactsViewModel.prototype.onContactCreateResponse=function(e){e&&e.Action&&e.Result&&(App.Api.showReport(Utils.i18n("ContactCreate"===e.Action?"CONTACTS/REPORT_CONTACT_SUCCESSFULLY_ADDED":"CONTACTS/REPORT_CONTACT_SUCCESSFULLY_UPDATED")),this.requestContactList())},CContactsViewModel.prototype.onContactListResponse=function(e){if(e&&e.Action&&e.Result){var t=0,i=0,s=[],o=this.selector.itemSelected(),n=null,r=this.selector.listChecked(),a=r&&0<r.length?_.map(r,function(e){return e.Id()}):[],l=null;for(i=e.Result.List.length;i>t;t++)e.Result.List[t]&&"Object/CContactListItem"===Utils.pExport(e.Result.List[t],"@Object","")&&(l=new CContactListItemModel,l.parse(e.Result.List[t]),s.push(l));o&&(n=_.find(s,function(e){return o.Id()===e.Id()})),a&&0<a.length&&_.each(s,function(e){e.checked(-1<Utils.inArray(e.Id(),a))}),this.collection(s),this.loadingList(!1),this.oPageSwitcher.setCount(Utils.pInt(e.Result.ContactCount)),n&&(this.selector.itemSelected(n),this.requestContact(o.Id())),this.selectedGroupContactsList(e.Result.List),o&&this.requestContact(o.Id()),this.contactCount(e.Result.ContactCount)
}},CContactsViewModel.prototype.viewAllMails=function(){var e=this.selectedGroupContactsList(),t="email:";e&&(_.each(e,function(e){_.each(e.Emails,function(e){t=t+e+","})}),App.MailCache.searchMessagesInInbox(t))},CContactsViewModel.prototype.onGroupListResponse=function(e){if(e&&e.Action&&e.Result){var t=0,i=0,s=[],o=_.find(this.groupFullCollection(),function(e){return e.selected()}),n=null;for(this.groupFullCollection(s),i=e.Result.length;i>t;t++)e.Result[t]&&"Object/CContactListItem"===Utils.pExport(e.Result[t],"@Object","")&&(n=new CContactListItemModel,n.parse(e.Result[t]),n.IsGroup()&&(o&&o.Id()===n.Id()&&this.selectedGroupInList(n),s.push(n)));this.groupFullCollection(s)}},CContactsViewModel.prototype.onGroupCreateResponse=function(e){if(e&&e.Action&&e.Result){var t=_.map(this.selector.listChecked(),function(e){return[e.Id(),e.Global()?"1":"0"]});this.executeAddContactsToGroupId(Utils.pString(e.Result.IdGroup),t),this.mobileApp||(this.selectedItem(null),this.selector.itemSelected(null)),App.Api.showReport(Utils.i18n("CONTACTS/REPORT_GROUP_SUCCESSFULLY_ADDED")),this.requestContactList(),this.requestGroupFullList()}},CContactsViewModel.prototype.executeShare=function(){var e=this,t=this.selector.listCheckedOrSelected(),i=this.selectedContact(),s=_.map(t,function(e){return e.ReadOnly()?"":e.Id()});s=_.compact(s),0<s.length&&(_.each(t,function(e){e&&(App.ContactsCache.clearInfoAboutEmail(e.Email()),!i||e.IsGroup()||e.ReadOnly()||i.readOnly()||i.idContact()!==e.Id()||(i=null,this.selectedContact(null)))},this),_.each(this.collection(),function(e){-1<Utils.inArray(e,t)&&e.deleted(!0)}),_.delay(function(){e.collection.remove(function(e){return e.deleted()})},500),Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?this.recivedAnimUnshare(!0):this.recivedAnimShare(!0),App.Ajax.send({Action:"ContactUpdateSharedToAll",ContactsId:s.join(","),SharedToAll:Enums.ContactsGroupListType.SharedToAll===this.selectedGroupType()?"1":"0"},this.onContactUpdateSharedToAllResponse,this))},CContactsViewModel.prototype.onContactUpdateSharedToAllResponse=function(){},CContactsViewModel.prototype.requestGroup=function(e){this.loadingViewPane(!0),e&&App.Ajax.send({Action:"ContactsGroup",GroupId:e.Id()},this.onGroupResponse,this)},CContactsViewModel.prototype.onGroupResponse=function(e){if(e&&e.Action&&e.Result){var t=e.Result;this.oGroupModel.idGroup(Utils.pString(t.IdGroup)).name(t.Name).isOrganization(t.IsOrganization).company(t.Company).country(t.Country).state(t.State).city(t.City).street(t.Street).zip(t.Zip).phone(t.Phone).fax(t.Fax).email(t.Email).web(t.Web)}},CContactsViewModel.prototype.onGroupEventsResponse=function(e){if(e&&e.Action&&e.Result){var t=e.Result;this.oGroupModel.events(t)}},CContactsViewModel.prototype.reload=function(){this.requestContactList()},CContactsViewModel.prototype.initUploader=function(){var e=this;this.uploaderArea()&&(this.oJua=new Jua({action:"?/Upload/Contacts/",name:"jua-uploader",queueSize:2,dragAndDropElement:this.uploaderArea(),disableAjaxUpload:this.isPublic,disableFolderDragAndDrop:this.isPublic,disableDragAndDrop:this.isPublic,hidden:{Token:function(){return AppData.Token},AccountID:function(){return AppData.Accounts.currentId()},AdditionalData:function(){return JSON.stringify({GroupId:e.selectedGroupType()===Enums.ContactsGroupListType.SubGroup?e.currentGroupId():"",IsShared:e.selectedGroupType()===Enums.ContactsGroupListType.SharedToAll})}}}),this.oJua.on("onComplete",_.bind(this.onContactUploadComplete,this)).on("onBodyDragEnter",_.bind(this.bDragActive,this,!0)).on("onBodyDragLeave",_.bind(this.bDragActive,this,!1)))},CContactsViewModel.prototype.onContactUploadComplete=function(e,t,i){var s=!t||!i||i.Error||i.Result.Error||!1;s?i.ErrorCode?App.Api.showErrorByCode(i,Utils.i18n("The file must have .CSV or .VCF extension.")):App.Api.showError(Utils.i18n("WARNING/UNKNOWN_ERROR")):this.reload()},CContactsViewModel.prototype.createNewContact=function(){App.ContactsCache.newContactParams&&(this.newContactCommand(),this.selectedItem().extented(!0),_.each(App.ContactsCache.newContactParams,function(e,t){this.oContactModel[t]&&this.oContactModel[t](e)},this),App.ContactsCache.newContactParams=null)},CScreens.prototype.initScreens=function(){},CScreens.prototype.initLayout=function(){},CScreens.prototype.init=function(){this.initScreens(),this.initLayout(),$("#pSevenContent").addClass("single_mode"),_.defer(function(){AppData.SingleMode||$("#pSevenContent").removeClass("single_mode")}),this.informationScreen(this.showNormalScreen(Enums.Screens.Information))},CScreens.prototype.hasOpenedMinimizedPopups=function(){var e=!1;return _.each(this.popups,function(t){var i=t.__vm;i.minimized&&i.minimized()&&(e=!0)}),e},CScreens.prototype.hasOpenedMaximizedPopups=function(){var e=!1;return _.each(this.popups,function(t){var i=t.__vm;i.minimized&&i.minimized()||(e=!0)}),e},CScreens.prototype.getCurrentScreenModel=function(){var e=this.oScreens[this.currentScreen()],t="undefined"!=typeof e?e.Model:null;return t},CScreens.prototype.showCurrentScreen=function(e,t){var i=this.oScreens[this.currentScreen()],s="undefined"!=typeof i?i.Model:null;this.currentScreen()!==e&&(s&&i.bInitialized&&s.hideViewModel(),this.currentScreen(e)),this.showNormalScreen(e,t),this.resizeAll()},CScreens.prototype.showNormalScreen=function(e,t){var i=e,s=this.oScreens[i];return s&&(s.bInitialized="boolean"!=typeof s.bInitialized?!1:s.bInitialized,s.bInitialized||(s.Model=this.initViewModel(s.Model,s.TemplateName),s.bInitialized=!0),s.Model.showViewModel(t)),s?s.Model:null},CScreens.prototype.initViewModel=function(e,t){var i=null,s=null;return i=new e,s=$('div[data-view-model="'+t+'"]').attr("data-bind","template: {name: '"+t+"'}").hide(),i.$viewModel=s,i.bShown=!1,i.showViewModel=function(e){bMobileApp&&(bIsWindowsPhone||App.browser.ie)?_.defer(_.bind(function(){this.$viewModel.show()},this)):this.$viewModel.show(),"function"==typeof this.onRoute&&this.onRoute(e),this.bShown||("function"==typeof this.onShow&&this.onShow(e),AfterLogicApi.runPluginHook&&this.__name&&AfterLogicApi.runPluginHook("view-model-on-show",[this.__name,this]),this.bShown=!0)},i.hideViewModel=function(){this.$viewModel.hide(),"function"==typeof this.onHide&&this.onHide(),this.bShown=!1},ko.applyBindings(i,s[0]),"function"==typeof i.onApplyBindings&&i.onApplyBindings(s),i},CScreens.prototype.showPopup=function(e,t){if(e){if(!e.__builded){var i=null,s=new e,o=s.popupTemplate?s.popupTemplate():"";""!==o&&(i=$('div[data-view-model="'+o+'"]').attr("data-bind","template: {name: '"+o+"'}").removeClass("visible").hide(),i&&1===i.length&&(s.visibility=ko.observable(!1),e.__builded=!0,e.__vm=s,s.$viewModel=i,e.__dom=i,s.showViewModel=Utils.createCommand(s,function(){App&&App.Screens&&App.Screens.showPopup(e)}),s.closeCommand=Utils.createCommand(s,function(){App&&App.Screens&&App.Screens.hidePopup(e)}),ko.applyBindings(s,i[0]),Utils.delegateRun(s,"onApplyBindings",[i])))}e.__vm&&e.__dom&&(e.__vm.visibility()||(e.__dom.show(),_.delay(function(){e.__dom.addClass("visible")},50),e.__vm.visibility(!0),this.popups.push(e),1===this.popups.length&&(this.keyupPopupBinded=_.bind(this.keyupPopup,this),$(document).on("keyup",this.keyupPopupBinded))),Utils.delegateRun(e.__vm,"onShow",t))}},CScreens.prototype.keyupPopup=function(e){var t=this.popups.length>0?this.popups[this.popups.length-1].__vm:null;if(e&&t&&(!t.minimized||!t.minimized())){var i=window.parseInt(e.keyCode,10);Enums.Key.Esc===i&&(t.onEscHandler?t.onEscHandler(e):t.closeCommand()),Enums.Key.Enter!==i&&Enums.Key.Space!==i||!t.onEnterHandler||t.onEnterHandler()}},CScreens.prototype.hidePopup=function(e){e&&e.__vm&&e.__dom&&(this.keyupPopupBinded&&1===this.popups.length&&($(document).off("keyup",this.keyupPopupBinded),this.keyupPopupBinded=void 0),e.__dom.removeClass("visible").hide(),e.__vm.visibility(!1),Utils.delegateRun(e.__vm,"onHide"),this.popups=_.without(this.popups,e))},CScreens.prototype.showLoading=function(e){this.informationScreen()&&this.informationScreen().showLoading(e)},CScreens.prototype.hideLoading=function(){this.informationScreen()&&this.informationScreen().hideLoading()},CScreens.prototype.showReport=function(e,t){this.informationScreen()&&this.informationScreen().showReport(e,t)},CScreens.prototype.showError=function(e,t,i,s){this.informationScreen()&&this.informationScreen().showError(e,t,i,s)},CScreens.prototype.hideError=function(e){this.informationScreen()&&this.informationScreen().hideError(e)},CScreens.prototype.initHelpdesk=function(){var e=this.oScreens[Enums.Screens.Helpdesk];AppData.User.IsHelpdeskSupported&&e&&!e.bInitialized&&(e.Model=this.initViewModel(e.Model,e.TemplateName),e.bInitialized=!0)},CScreens.prototype.initScreens=function(){this.oScreens[Enums.Screens.Information]={Model:CInformationViewModel,TemplateName:"Common_InformationViewModel"},this.oScreens[Enums.Screens.Login]={Model:CWrapLoginViewModel,TemplateName:"Login_WrapLoginViewModel"},this.oScreens[Enums.Screens.Header]={Model:CHeaderMobileViewModel,TemplateName:"Common_HeaderMobileViewModel"},this.oScreens[Enums.Screens.Mailbox]={Model:CMailViewModel,TemplateName:"Mail_LayoutSidePane_MailViewModel"},this.oScreens[Enums.Screens.SingleMessageView]={Model:CMessagePaneViewModel,TemplateName:"Mail_LayoutSidePane_MessagePaneViewModel"},this.oScreens[Enums.Screens.Compose]={Model:CComposeViewModel,TemplateName:"Mail_ComposeViewModel"}},CScreens.prototype.initLayout=function(){$("#pSevenContent").append($("#Layout").html())},CMailCache.prototype.init=function(){var e=null;if(App.Ajax.openedRequestsCount.subscribe(function(){0===App.Ajax.openedRequestsCount()&&_.delay(_.bind(function(){0===App.Ajax.requests().length&&(this.checkMailStarted(!1),this.folderListLoading.removeAll())},this),10)},this),AppData.SingleMode&&window.opener&&(e=window.opener.App.MailCache,this.oFolderListItems=e.oFolderListItems,this.uidList(e.uidList()),e.uidList.subscribe(_.bind(function(){this.uidList(e.uidList())},this)),window.name)){var t,i=Utils.pInt(window.name);0===i&&window.opener&&window.opener.aMessagesParametersFromCompose&&(t=window.opener.aMessagesParametersFromCompose[window.name],i=t?t.accountId:0),0!==i&&this.currentAccountId(i)}this.currentAccountId.valueHasMutated()},CMailCache.prototype.getCurrentFolder=function(){return this.folderList().currentFolder()},CMailCache.prototype.getFolderByFullName=function(e,t){var i=this.oFolderListItems[e];return i?i.getFolderByFullName(t):null},CMailCache.prototype.checkCurrentFolderList=function(){var e=AppData.Accounts.getCurrent(),t=this.oFolderListItems[e.id()];!e.allowMail()||t||this.messagesLoading()||(this.messagesLoading(!0),this.messagesLoadingError(!1),this.getFolderList(e.id()))},CMailCache.prototype.getFolderList=function(e){var t=AppData.Accounts.getAccount(e),i={AccountID:e,Action:"FoldersGetList"};t&&t.allowMail()?(this.folderListLoading.push(e),App.Ajax.send(i,this.onFoldersGetListResponse,this)):e===this.currentAccountId()&&this.messagesLoading(!1)},CMailCache.prototype.markMessageReplied=function(e,t,i,s){var o=this.oFolderListItems[e],n=null;o&&(n=o.getFolderByFullName(t),n&&n.markMessageReplied(i,s))},CMailCache.prototype.hideThreads=function(e){AppData.User.useThreads()&&e.folder()===this.folderList().currentFolderFullName()&&!e.threadOpened()&&this.folderList().currentFolder().hideThreadMessages(e)},CMailCache.prototype.showOpenedThreads=function(e){this.messages(this.getMessagesWithThreads(e,this.uidList(),this.messages()))},CMailCache.prototype.useThreadsInCurrentList=function(e){e=e||this.uidList();var t=this.folderList().currentFolder(),i=t&&t.withoutThreads(),s=""===e.search()&&""===e.filters();return AppData.User.useThreads()&&!i&&s},CMailCache.prototype.getMessagesWithThreads=function(e,t,i){var s=[],o=[],n=this.folderList().currentFolder();return n&&e===n.fullName()&&this.useThreadsInCurrentList(t)?(o=_.filter(i,function(e){return!e.threadPart()}),_.each(o,function(e){var t=[];s.push(e),e.threadCount()>0&&(e.threadOpened()&&(t=this.folderList().currentFolder().getThreadMessages(e),s=_.union(s,t)),n.computeThreadData(e))},this),s):i},CMailCache.prototype.setMessagesFromUidList=function(e,t,i,s){var o=e.getUidsForOffset(t,i),n=_.map(o,function(e){return i[e]},this),r=n.length;return s&&(this.messages(this.getMessagesWithThreads(this.folderList().currentFolderFullName(),e,n)),t+r<e.resultCount()&&r<AppData.User.MailsPerPage&&(e.filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.messagesLoading(!0),this.currentMessage()&&(this.currentMessage().deleted()||this.currentMessage().folder()!==this.folderList().currentFolderFullName())&&this.currentMessage(null)),o},CMailCache.prototype.executeCheckMail=function(e){var t=this.oFolderListItems[this.currentAccountId()],i=AppData.Accounts.getCurrentFetchersAndFiltersFolderNames(),s=t?[t.inboxFolderFullName(),t.spamFolderFullName(),t.currentFolderFullName()]:[],o=t?t.iAccountId:0,n=this.checkMailStarted()&&this.checkMailStartedAccountId()===o,r=null;AppData.Auth&&(e||!App.Ajax.hasOpenedRequests("FoldersGetRelevantInformation")||!n)&&s.length>0&&(s=_.uniq(_.compact(_.union(s,i))),r={Action:"FoldersGetRelevantInformation",Folders:s,AccountID:o},this.checkMailStarted(!0),this.checkMailStartedAccountId(o),App.Ajax.send(r,this.onFoldersGetRelevantInformationResponse,this))},CMailCache.prototype.setAutocheckmailTimer=function(){clearTimeout(this.iAutoCheckMailTimer),!AppData.SingleMode&&AppData.User.AutoCheckMailInterval>0&&(this.iAutoCheckMailTimer=setTimeout(function(){App.Ajax.isSearchMessages()||(App.MailCache.checkMessageFlags(),App.MailCache.executeCheckMail(!1))},60*AppData.User.AutoCheckMailInterval*1e3))},CMailCache.prototype.checkMessageFlags=function(){var e=this.folderList().inboxFolder(),t=e?e.getFlaggedMessageUids():[],i={Action:"MessagesGetFlags",Folder:this.folderList().inboxFolderFullName(),Uids:t};t.length>0&&App.Ajax.send(i,this.onMessagesGetFlagsResponse,this)},CMailCache.prototype.onMessagesGetFlagsResponse=function(e,t){var i=this.oFolderListItems[t.AccountID],s=i?i.inboxFolder():null;s&&(e.Result&&_.each(e.Result,function(e,t){-1===_.indexOf(e,"\\flagged")&&s.setMessageUnflaggedByUid(t)}),s.removeFlaggedMessageListsFromCache(),App.Prefetcher.prefetchStarredMessageList())},CMailCache.prototype.changeCurrentMessageList=function(e,t,i,s){this.requestCurrentMessageList(e,t,i,s,!0)},CMailCache.prototype.requestCurrentMessageList=function(e,t,i,s,o){var n=this.requestMessageList(e,t,i,s||"",!0,o||!1),r=60*AppData.User.AutoCheckMailInterval*1e3,a=n.Folder.relevantInformationLastMoment?moment().diff(n.Folder.relevantInformationLastMoment):r+1;this.uidList(n.UidList),this.page(t),this.messagesLoading(n.RequestStarted),this.messagesLoadingError(!1),!n.RequestStarted&&r>0&&a>r&&this.executeCheckMail(!0)},CMailCache.prototype.requestMessageList=function(e,t,i,s,o,n){var r=this.oFolderListItems[this.currentAccountId()],a=r?r.getFolderByFullName(e):null,l=a&&a.withoutThreads(),h=AppData.User.useThreads()&&!l&&""===i&&""===s,c=a?a.getUidList(i,s):null,p=c&&-1===c.resultCount(),u=(t-1)*AppData.User.MailsPerPage,d={Action:"MessagesGetList",Folder:e,Offset:u,Limit:AppData.User.MailsPerPage,Search:i,Filters:s,UseThreads:h?"1":"0"},m=!1,g=!1,f=o?this.onCurrentMessagesGetListResponse:this.onMessagesGetListResponse,b=[];return a.type()===Enums.FolderTypes.Inbox&&""===s&&(d.InboxUidnext=a.sUidNext),p&&c.search()===this.uidList().search()&&c.filters()===this.uidList().filters()&&(c=this.uidList()),c&&(b=this.setMessagesFromUidList(c,u,a.oMessages,n)),c&&(g=p||u+b.length<c.resultCount()&&b.length<AppData.User.MailsPerPage,m=a.hasChanges()||g),m?App.Ajax.send(d,f,this):this.waitForUnseenMessages(!1),{UidList:c,RequestStarted:m,DataExpected:g,Folder:a}},CMailCache.prototype.executeEmptyTrash=function(){var e=this.folderList().trashFolder();e&&e.emptyFolder()},CMailCache.prototype.executeEmptySpam=function(){var e=this.folderList().spamFolder();e&&e.emptyFolder()},CMailCache.prototype.onClearFolder=function(e){if(e&&e.selected()){this.messages.removeAll(),this.currentMessage(null);var t=e?e.getUidList(this.uidList().search(),this.uidList().filters()):null;this.uidList(t?t:new CUidListModel),this.checkMailStarted(!1),this.setAutocheckmailTimer()}},CMailCache.prototype.moveMessagesToFolder=function(e,t,i){if(t.length>0){var s=this.folderList().currentFolder(),o=s&&s.type()===Enums.FolderTypes.Drafts,n=o&&Utils.WindowOpener.getOpenedDraftUids(),r=o&&_.find(t,_.bind(function(e){return-1!==Utils.inArray(e,n)},this)),a=this.folderList().getFolderByFullName(e),l={Action:"MessageMove",Folder:s?s.fullName():"",ToFolder:e,Uids:t.join(",")},h=null,c=_.bind(function(){this.uidList().filters()===Enums.FolderFilter.Unseen&&this.uidList().resultCount()>AppData.User.MailsPerPage&&this.waitForUnseenMessages(!0),h=s.markDeletedByUids(t),a.addMessagesCountsDiff(h.MinusDiff,h.UnseenMinusDiff),(Utils.isUnd(i)?0:!i)||a.recivedAnim(!0),this.excludeDeletedMessages(),a.markHasChanges(),App.Ajax.send(l,this.onMoveMessagesResponse,this),a&&a.type()===Enums.FolderTypes.Trash&&AfterLogicApi.runPluginHook("move-messages-to-trash",[AppData.Accounts.currentId(),l.Folder,t]),a&&a.type()===Enums.FolderTypes.Spam&&AfterLogicApi.runPluginHook("move-messages-to-spam",[AppData.Accounts.currentId(),l.Folder,t])},this);s&&a&&(r?(this.disableComposeAutosave(!0),App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/CONFIRM_MESSAGE_FOR_DELETE_IS_EDITED"),_.bind(function(e){e&&(Utils.WindowOpener.closeComposesWithDraftUids(t),c()),this.disableComposeAutosave(!1)},this),"",Utils.i18n("MAILBOX/BUTTON_CLOSE_DELETE_DRAFT")])):c())}},CMailCache.prototype.copyMessagesToFolder=function(e,t,i){if(t.length>0){var s=this.folderList().currentFolder(),o=this.folderList().getFolderByFullName(e),n={Action:"MessageCopy",Folder:s?s.fullName():"",ToFolder:e,Uids:t.join(",")};s&&o&&((Utils.isUnd(i)?0:!i)||o.recivedAnim(!0),o.markHasChanges(),App.Ajax.send(n,this.onCopyMessagesResponse,this),o&&o.type()===Enums.FolderTypes.Trash&&AfterLogicApi.runPluginHook("copy-messages-to-trash",[AppData.Accounts.currentId(),n.Folder,t]),o&&o.type()===Enums.FolderTypes.Spam&&AfterLogicApi.runPluginHook("copy-messages-to-spam",[AppData.Accounts.currentId(),n.Folder,t]))}},CMailCache.prototype.excludeDeletedMessages=function(){_.delay(_.bind(function(){var e=this.folderList().currentFolder(),t=(this.page()-1)*AppData.User.MailsPerPage;this.setMessagesFromUidList(this.uidList(),t,e.oMessages,!0)},this),500)},CMailCache.prototype.removeOneMessageFromCacheForFolder=function(e,t,i){var s=this.oFolderListItems[e],o=s?s.getFolderByFullName(t):null;o&&o.type()===Enums.FolderTypes.Drafts&&(o.markDeletedByUids([i]),o.commitDeleted([i]))},CMailCache.prototype.startMessagesLoadingWhenDraftSaving=function(e,t){var i=this.oFolderListItems[e],s=i?i.getFolderByFullName(t):null;s&&s.type()===Enums.FolderTypes.Drafts&&s.selected()&&this.messagesLoading(!0)},CMailCache.prototype.removeMessagesFromCacheForFolder=function(e,t){var i=this.oFolderListItems[e],s=i?i.getFolderByFullName(t):null,o=i?i.currentFolderFullName():null;s&&(s.markHasChanges(),this.currentAccountId()===e&&t===o&&this.requestCurrentMessageList(o,this.page(),this.uidList().search(),"",!0))},CMailCache.prototype.deleteMessages=function(e){var t=this.folderList().currentFolder();t&&this.deleteMessagesFromFolder(t,e)},CMailCache.prototype.deleteMessagesFromFolder=function(e,t){var i={Action:"MessageDelete",Folder:e.fullName(),Uids:t.join(",")};e.markDeletedByUids(t),this.excludeDeletedMessages(),App.Ajax.send(i,this.onMoveMessagesResponse,this),AfterLogicApi.runPluginHook("delete-messages",[AppData.Accounts.currentId(),i.Folder,t])},CMailCache.prototype.showExternalPictures=function(e){var t=[],i=null;this.currentMessage()&&(t=this.currentMessage().oFrom.aCollection,i=this.folderList().getFolderByFullName(this.currentMessage().folder()),e&&t.length>0?i.alwaysShowExternalPicturesForSender(t[0].sEmail):i.showExternalPictures(this.currentMessage().uid()))},CMailCache.prototype.setCurrentMessage=function(e,t){var i=this.folderList().currentFolder(),s=i&&e?i.oMessages[e]:null;!AppData.SingleMode||i&&i.fullName()===t||(this.folderList().setCurrentFolder(t,""),i=this.folderList().currentFolder()),s&&!s.deleted()?(this.currentMessage(s),this.currentMessage().seen()||this.executeGroupOperation("MessageSetSeen",[this.currentMessage().uid()],"seen",!0),i.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this)):(this.currentMessage(null),AppData.SingleMode&&i&&i.getCompletelyFilledMessage(e,this.onCurrentMessageResponse,this))},CMailCache.prototype.onCurrentMessageResponse=function(e,t){var i=this.currentMessage()?this.currentMessage().uid():"";null===e&&i===t?this.currentMessage(null):e&&i===t?this.currentMessage.valueHasMutated():AppData.SingleMode&&e&&null===this.currentMessage()&&this.currentMessage(e)},CMailCache.prototype.getMessage=function(e,t,i,s){var o=this.folderList().getFolderByFullName(e);o&&o.getCompletelyFilledMessage(t,i,s)},CMailCache.prototype.executeGroupOperation=function(e,t,i,s){var o=this.folderList().currentFolder(),n={Action:e,Folder:o?o.fullName():"",Uids:t.join(","),SetAction:s?1:0},r=(this.page()-1)*AppData.User.MailsPerPage,a=t.length,l=this.folderList().oStarredFolder?this.folderList().oStarredFolder.messageCount():0,h=o?o.getUidList("",Enums.FolderFilter.Flagged):null;o&&("MessageSetSeen"===n.Action&&this.iMessageSetSeenCount++,App.Ajax.send(n,this.onExecuteGroupOperationResponse,this),o.executeGroupOperation(i,t,s),o.type()===Enums.FolderTypes.Inbox&&"flagged"===i&&(this.uidList().filters()===Enums.FolderFilter.Flagged?s||(this.uidList().deleteUids(t),this.folderList().oStarredFolder&&this.folderList().oStarredFolder.messageCount(h.resultCount())):(o.removeFlaggedMessageListsFromCache(),""===this.uidList().search()&&this.folderList().oStarredFolder&&this.folderList().oStarredFolder.messageCount(s?l+a:l-a>0?l-a:0))),"seen"===i&&o.removeUnseenMessageListsFromCache(),(this.uidList().filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.setMessagesFromUidList(this.uidList(),r,o.oMessages,!0))},CMailCache.prototype.onExecuteGroupOperationResponse=function(e,t){"MessageSetSeen"===t.Action&&(this.iMessageSetSeenCount--,this.iMessageSetSeenCount<0&&(this.iMessageSetSeenCount=0),this.folderList().currentFolder()&&0===this.iMessageSetSeenCount&&(this.uidList().filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&this.requestCurrentMessageList(this.folderList().currentFolder().fullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1))},CMailCache.prototype.onFoldersGetListResponse=function(e,t){var i=new CFolderListModel,s=parseInt(e.AccountID,10),o=this.oFolderListItems[s],n=o?o.oNamedCollection:{};e.Result===!1?(App.Api.showErrorByCode(e),t.AccountID===this.currentAccountId()&&0===this.messages().length&&(this.messagesLoading(!1),this.messagesLoadingError(!0))):(i.parse(s,e.Result,n),o&&i.oStarredFolder.messageCount(o.oStarredFolder.messageCount()),this.oFolderListItems[s]=i,setTimeout(_.bind(this.getAllFoldersRelevantInformation,this,s),2e3),this.currentAccountId()===s&&this.folderList(i),this.editedAccountId()===s&&this.editedFolderList(i),AppData.Accounts.defaultId()===s&&this.defaultFolderList(i)),this.folderListLoading.remove(s)},CMailCache.prototype.setCurrentFolderList=function(e){var t=e.iAccountId;t===this.currentAccountId()&&t!==this.folderList().iAccountId&&this.folderList(e)},CMailCache.prototype.getAllFoldersRelevantInformation=function(e){var t=this.oFolderListItems[e],i=t?t.getFoldersWithoutCountInfo():[],s={Action:"FoldersGetRelevantInformation",Folders:i,AccountID:e};i.length>0&&App.Ajax.send(s,this.onFoldersGetRelevantInformationResponse,this)},CMailCache.prototype.onFoldersGetRelevantInformationResponse=function(e){var t=!1,i=e.AccountID,s=this.oFolderListItems[i],o=this.folderList().currentFolderFullName(),n=this.currentAccountId()===i;e.Result===!1?(App.Api.showErrorByCode(e),App.Ajax.hasOpenedRequests("FoldersGetRelevantInformation")&&(t=!0)):s&&(_.each(e.Result&&e.Result.Counts,function(e,i){if(_.isArray(e)&&e.length>3){var r=e[0],a=e[1],l=e[2],h=e[3],c=!1,p=!1,u=null;u=s.getFolderByFullName(i),u&&(p=n&&u.fullName()===o,c=u.setRelevantInformation(l,h,r,a,p),p&&c&&this.uidList().filters()!==Enums.FolderFilter.Unseen&&(this.requestCurrentMessageList(u.fullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1),t=!0))}},this),s.countsCompletelyFilled(!0)),this.checkMailStarted(t),this.checkMailStarted()||this.setAutocheckmailTimer()},CMailCache.prototype.showNotificationsForNewMessages=function(e){var t=this.folderList().currentFolderFullName(),i=0,s="",o={};e.Result.New&&e.Result.New.length>0&&(i=e.Result.New.length,s=e.Result.New[0].Uid,o={action:"show",icon:"skins/wm_logo_140x140.png",title:Utils.i18n("NOTIFICATION/NEW_MESSAGE_PLURAL",{COUNT:i},null,i),timeout:5e3,callback:function(){window.focus(),App.Routing.setHash(App.Links.mailbox(t,1,s,"",""))}},1===i&&(o.body=Utils.i18n("MESSAGE/HEADER_SUBJECT")+": "+e.Result.New[0].Subject+"\r\n"+Utils.i18n("MESSAGE/HEADER_FROM")+": "+_.map(e.Result.New[0].From,function(e){return""!==e.DisplayName?e.DisplayName:e.Email}).join(", ")),App.desktopNotify(o))},CMailCache.prototype.onCurrentMessagesGetListResponse=function(e,t){this.checkMailStarted(!1),e.Result?(this.messagesLoadingError(!1),this.parseMessageList(e,t)):(App.Api.showErrorByCode(e),this.messagesLoading()!==!0||0!==this.messages().length&&e.ErrorCode===Enums.Errors.NotDisplayedError||this.messagesLoadingError(!0),this.messagesLoading(!1),this.setAutocheckmailTimer())},CMailCache.prototype.onMessagesGetListResponse=function(e,t){e&&e.Result&&this.parseMessageList(e,t)},CMailCache.prototype.parseMessageList=function(e,t){var i=e.Result,s=this.oFolderListItems[e.AccountID],o=null,n=null,r="1"===t.UseThreads,a=!1,l=this.currentAccountId()===e.AccountID&&this.folderList().currentFolderFullName()===i.FolderName,h=l&&this.uidList().search()===i.Search&&this.uidList().filters()===i.Filters,c=this.page()===i.Offset/AppData.User.MailsPerPage+1,p=[];this.showNotificationsForNewMessages(e),i!==!1&&"Collection/MessageCollection"===i["@Object"]&&(o=s.getFolderByFullName(i.FolderName),o.setRelevantInformation(i.UidNext.toString(),i.FolderHash,i.MessageCount,i.MessageUnseenCount,l&&!h),a=o.hasChanges(),o.removeAllMessageListsFromCacheIfHasChanges(),n=o.getUidList(i.Search,i.Filters),n.setUidsAndCount(i),_.each(i["@Collection"],function(e){var t=o.parseAndCacheMessage(e,!1,r);p.push(t)},this),AfterLogicApi.runPluginHook("response-custom-messages",[e.AccountID,o.fullName(),p]),h&&(this.uidList(n),c&&(n.filters()!==Enums.FolderFilter.Unseen||this.waitForUnseenMessages())&&(this.setMessagesFromUidList(n,i.Offset,o.oMessages,!0),this.messagesLoading(!1),this.waitForUnseenMessages(!1),this.setAutocheckmailTimer())),!a||!l||h&&c||this.uidList().filters()===Enums.FolderFilter.Unseen||this.requestCurrentMessageList(this.folderList().currentFolderFullName(),this.page(),this.uidList().search(),this.uidList().filters(),!1),o.type()===Enums.FolderTypes.Inbox&&n.filters()===Enums.FolderFilter.Flagged&&""===n.search()&&this.folderList().oStarredFolder&&(this.folderList().oStarredFolder.messageCount(n.resultCount()),this.folderList().oStarredFolder.hasExtendedInfo(!0)))},CMailCache.prototype.increaseStarredCount=function(){this.folderList().oStarredFolder&&this.folderList().oStarredFolder.increaseCountIfHasNotInfo()},CMailCache.prototype.onMoveMessagesResponse=function(e,t){var i=e.Result,s=this.folderList().getFolderByFullName(t.Folder),o=this.folderList().getFolderByFullName(t.ToFolder),n=o&&o.type()===Enums.FolderTypes.Trash,r=o&&o.type()===Enums.FolderTypes.Spam,a=null,l=Utils.i18n(n?"MAILBOX/CONFIRM_MESSAGES_DELETE_WITHOUT_TRASH":"MAILBOX/CONFIRM_MESSAGES_MARK_SPAM_WITHOUT_SPAM"),h=_.bind(function(e){e&&s&&this.deleteMessagesFromFolder(s,t.Uids.split(","))},this),c=this.folderList().currentFolder(),p=c.fullName(),u=!1;if(i===!1?(a=s.revertDeleted(t.Uids.split(",")),o?(o.addMessagesCountsDiff(-a.PlusDiff,-a.UnseenPlusDiff),e.ErrorCode===Enums.Errors.ImapQuota&&(n||r)?App.Screens.showPopup(ConfirmPopup,[l,h]):App.Api.showErrorByCode(e,Utils.i18n("MAILBOX/ERROR_MOVING_MESSAGES"))):App.Api.showErrorByCode(e,Utils.i18n("MAILBOX/ERROR_DELETING_MESSAGES")),u=!0):s.commitDeleted(t.Uids.split(",")),p===s.fullName()||o&&p===o.fullName())switch(c.markHasChanges(),this.uidList().filters()){case Enums.FolderFilter.Flagged:break;case Enums.FolderFilter.Unseen:this.waitForUnseenMessages()&&this.requestCurrentMessageList(p,this.page(),this.uidList().search(),this.uidList().filters(),u);break;default:this.requestCurrentMessageList(p,this.page(),this.uidList().search(),this.uidList().filters(),u)}else p!==s.fullName()?App.Prefetcher.startFolderPrefetch(s):o&&p!==o.fullName()&&App.Prefetcher.startFolderPrefetch(o)},CMailCache.prototype.onCopyMessagesResponse=function(e,t){var i=e.Result,s=this.folderList().getFolderByFullName(t.Folder),o=this.folderList().getFolderByFullName(t.ToFolder),n=this.folderList().currentFolder(),r=n.fullName();i===!1&&App.Api.showErrorByCode(e,Utils.i18n("MAILBOX/ERROR_COPYING_MESSAGES")),r===s.fullName()||o&&r===o.fullName()?(n.markHasChanges(),this.requestCurrentMessageList(r,this.page(),this.uidList().search(),"",!1)):r!==s.fullName()?App.Prefetcher.startFolderPrefetch(s):o&&r!==o.fullName()&&App.Prefetcher.startFolderPrefetch(o)},CMailCache.prototype.searchMessagesInCurrentFolder=function(e){var t=this.folderList().currentFolderFullName()||"INBOX",i=this.currentMessage()?this.currentMessage().uid():"",s=this.uidList().filters();App.Routing.setHash(App.Links.mailbox(t,1,i,e,s))},CMailCache.prototype.searchMessagesInInbox=function(e){App.Routing.setHash(App.Links.mailbox(this.folderList().inboxFolderFullName()||"INBOX",1,"",e,""))},CMailCache.prototype.countMessages=function(e){var t=[],i=function(e){_.each(e.subfolders(),function(e){e.subscribed()&&(t.push(e.unseenMessageCount()),e.subfolders().length&&e.subscribed()&&i(e))},this)};e.expanded()||e.bNamespace?e.subfoldersMessagesCount(0):(i(e),e.subfoldersMessagesCount(_.reduce(t,function(e,t){return e+t},0)))},CMailCache.prototype.changeDatesInMessages=function(){_.each(this.oFolderListItems,function(e){_.each(e.oNamedCollection,function(e){_.each(e.oMessages,function(e){e.updateMomentDate()},this)})})},CContactsCache.prototype.clearInfoAboutEmail=function(e){this.contacts[e]=void 0},CContactsCache.prototype.getContactsByEmails=function(e,t,i){if(AppData.User.ShowContacts){var s=[],o=Math.random().toString();_.each(e,_.bind(function(e){var o=this.contacts[e];void 0!==o?t.apply(i,[o,e]):(this.contacts[e]=null,s.push(e))},this)),s.length>0&&(this.responseHandlers[o]={func:t,context:i},App.Ajax.send({Action:"ContactsGetByEmails",Emails:s.join(","),HandlerId:o},this.onContactsGetByEmailsResponse,this))}},CContactsCache.prototype.onContactsGetByEmailsResponse=function(e,t){var i=this.responseHandlers[t.HandlerId],s=e.Result;s&&_.each(s,_.bind(function(e,t){var s=new CContactModel;s&&(s.parse(e),this.contacts[t]=s,i&&i.func.apply(i.context,[s,t]))},this)),this.responseHandlers[t.HandlerId]=void 0},CContactsCache.prototype.addVcard=function(e){this.vcardAttachments.push(e)},CContactsCache.prototype.markVcardsNonexistentByUid=function(e){_.each(this.vcardAttachments,function(t){-1!==_.indexOf(e,t.uid())&&t.exists(!1)})},CContactsCache.prototype.markVcardExistentByFile=function(e){_.each(this.vcardAttachments,function(t){t.file()===e&&t.exists(!0)})},CCalendarCache.prototype.addIcal=function(e){_.each(this.icalAttachments,function(t){t.uid()===e.uid()&&(e.sSequence>=t.sSequence?t.lastModification(!1):e.lastModification(!1))}),this.icalAttachments.push(e),0===this.calendars().length&&this.canRequestCalendarList()&&this.requestCalendarList()},CCalendarCache.prototype.firstRequestCalendarList=function(){return this.canRequestCalendarList(!0),this.icalAttachments.length>0&&0===this.calendars().length&&this.requestCalendarList(),this.calendarsLoadingStarted()
},CCalendarCache.prototype.onCalendarListResponse=function(e){if(e&&e.Result){var t=AppData.Accounts,i=t.currentId(),s=t.getAccount(i).email(),o=_.filter(e.Result,function(e){return e.Owner===s||e.Access===Enums.CalendarAccess.Full||e.Access===Enums.CalendarAccess.Write});this.calendars(_.map(o,function(e){return{name:e.Name+" <"+e.Owner+">",id:e.Id}}))}this.calendarsLoadingStarted(!1)},CCalendarCache.prototype.requestCalendarList=function(){this.calendarsLoadingStarted()||(App.Ajax.send({Action:"CalendarList"},this.onCalendarListResponse,this),this.calendarsLoadingStarted(!0))},CCalendarCache.prototype.markIcalNonexistent=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventDelete()})},CCalendarCache.prototype.markIcalTypeByFile=function(e,t,i,s,o,n){_.each(this.icalAttachments,function(r){e===r.file()&&(r.type(t),r.cancelDecision(i),r.replyDecision(s),r.calendarId(o),r.selectedCalendarId(n))})},CCalendarCache.prototype.markIcalTentative=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventTentative()})},CCalendarCache.prototype.markIcalAccepted=function(e){_.each(this.icalAttachments,function(t){e===t.uid()&&t.onEventAccept()})},AbstractApp.prototype.init=function(){},AbstractApp.prototype.collectScreensData=function(){},AbstractApp.prototype.run=function(){},AbstractApp.prototype.momentDateTriggerCallback=function(){var e=ko.dataFor(this);e&&e.updateMomentDate&&e.updateMomentDate()},AbstractApp.prototype.fastMomentDateTrigger=function(){$(".moment-date-trigger-fast").each(this.momentDateTriggerCallback)},AbstractApp.prototype.setTitle=function(e){document.title=".",document.title=e||""},AbstractApp.prototype.tokenProblem=function(){var e="window.location.reload(); return false;",t=Utils.i18n("WARNING/TOKEN_PROBLEM_HTML",{RELOAD_FUNC:e});AppData.Auth=!1,App.Api.showError(t,!0,!0)},_.extend(AppBase.prototype,AbstractApp.prototype),AppBase.prototype.initPhone=function(){return null},AppBase.prototype.init=function(){var e=AppData.User,t=new CUserSettingsModel,i=AppData.Accounts,s=new CAccountListModel,o=AppData.App,n=new CAppSettingsModel(!!o.AllowOpenPGP&&this.Api.isPgpSupported());n.parse(o),AppData.App=n,t.parse(e),AppData.User=t,s.parse(Utils.pInt(AppData.Default),i),AppData.Accounts=s,this.MailCache=new CMailCache,this.Phone=this.initPhone(t.AllowVoice&&!this.browser.ie&&!bMobileApp),this.useGoogleAnalytics(),this.collectScreensData(),$(window).unload(function(){bMobileDevice||Utils.WindowOpener.closeAll()}),this.nowDateNumber=ko.observable(moment().date()),window.setInterval(function(){App.fastMomentDateTrigger(),App.nowDateNumber(moment().date())},6e4),this.nowDateNumber.subscribe(function(){this.MailCache.changeDatesInMessages()},this),this.browser.ie8AndBelow&&$("body").css("overflow","hidden"),this.Storage.setData("AuthToken",this.Storage.getData("AuthToken"))},AppBase.prototype.collectScreensData=function(){},AppBase.prototype.registerHelpdeskUpdateFunction=function(e){this.fHelpdeskUpdate=e},AppBase.prototype.updateHelpdesk=function(){this.fHelpdeskUpdate&&this.fHelpdeskUpdate()},AppBase.prototype.useGoogleAnalytics=function(){var e=null,t=null;AppData.App.GoogleAnalyticsAccount&&0<AppData.App.GoogleAnalyticsAccount.length&&(window._gaq=window._gaq||[],window._gaq.push(["_setAccount",AppData.App.GoogleAnalyticsAccount]),window._gaq.push(["_trackPageview"]),e=document.createElement("script"),e.type="text/javascript",e.async=!0,e.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t))},AppBase.prototype.logout=function(e){var t={Action:"SystemLogout",AuthToken:App.Storage.getData("AuthToken")};e&&(t.LastErrorCode=e),App.Ajax.send(t,this.onLogout,this),AppData.Auth=!1},AppBase.prototype.authProblem=function(){this.logout(Enums.Errors.AuthError)},AppBase.prototype.onLogout=function(){Utils.WindowOpener.closeAll(),App.Routing.finalize(),""!==AppData.App.CustomLogoutUrl?window.location.href=AppData.App.CustomLogoutUrl:Utils.Common.clearAndReloadLocation(App.browser.ie8AndBelow,!0)},AppBase.prototype.getAccounts=function(){return AppData.Accounts},AppBase.prototype.run=function(){this.Screens.init(),Utils.checkCookies(),bIsIosDevice&&AppData&&AppData.Auth&&AppData.App.IosDetectOnLogin&&AppData.App.AllowIosProfile?window.location.href="?ios":AppData&&AppData.Auth?(AppData.SingleMode=this.Routing.isSingleMode(),AppData.SingleMode&&window.opener&&AppData.Accounts.populateIdentitiesFromSourceAccount(window.opener.App.getAccounts()),AppData.App.AllowWebMail&&this.MailCache.init(),AppData.HelpdeskRedirect&&this.Routing.currentScreen!==Enums.Screens.Helpdesk&&this.Routing.setHash([Enums.Screens.Helpdesk]),this.initRouting()):AppData&&""!==AppData.App.CustomLoginUrl?window.location.href=AppData.App.CustomLoginUrl:(this.Screens.showCurrentScreen(Enums.Screens.Login),this.checkLoginScreenStartError()),this.phoneInOneTab(),AppData.App.AllowAppRegisterMailto&&Utils.registerMailto(this.browser.firefox),AppData.Accounts.unlockEditedWhenCurrentChange(),this.startResetPass(),this.displaySocialWelcome()},AppBase.prototype.startResetPass=function(){AppData.Auth&&""!==this.sResetPassHash&&App.Api.showChangeDefaultAccountPasswordPopup()},AppBase.prototype.displaySocialWelcome=function(){var e=AppData.Accounts.getDefault(),t=AppData.Accounts.hasMailAccount();t||!e||App.Storage.hasData("SocialWelcomeShowed"+e.id())||""===AppData.User.SocialName||(App.Screens.showPopup(ConfirmPopup,[Utils.i18n("MAILBOX/INFO_SOCIAL_WELCOME",{SOCIALNAME:AppData.User.SocialName,SITENAME:AppData.App.SiteName,EMAIL:e.email()}),function(e){e&&App.Api.showConfigureMailPopup()},"",Utils.i18n("MAILBOX/BUTTON_CONFIGURE_MAIL"),Utils.i18n("MAIN/BUTTON_CLOSE")]),App.Storage.setData("SocialWelcomeShowed"+e.id(),"1"))},AppBase.prototype.checkLoginScreenStartError=function(){var e=Utils.pInt(Utils.Common.getRequestParam("error"));0!==e&&App.Api.showErrorByCode({ErrorCode:e,ErrorMessage:""},"",!0),AppData&&AppData.LastErrorCode===Enums.Errors.AuthError&&this.Api.showError(Utils.i18n("WARNING/AUTH_PROBLEM"),!1,!0)},AppBase.prototype.initRouting=function(){var e=!!_.find(Enums.Screens,function(e){return e===AppData.App.DefaultTab});e&&(AppData.App.AllowWebMail||AppData.App.DefaultTab!==Enums.Screens.Mailbox)?this.Routing.init(AppData.App.DefaultTab):AppData.App.AllowWebMail?this.Routing.init(Enums.Screens.Mailbox):this.headerTabs().length>0&&this.Routing.init(this.headerTabs()[0].name)},AppBase.prototype.getHelpLink=function(e){return AppData&&AppData.Links&&AppData.Links[e]?AppData.Links[e]:""},AppBase.prototype.addScreenToHeader=function(e,t,i,s,o,n,r){var a=this.Routing.buildHashFromArray([e]),l=this;e===Enums.Screens.Helpdesk&&(a=ko.computed(function(){return"#"+l.Routing.lastHelpdeskHash()})),Enums.Screens[e]=e,this.Screens.oScreens[e]={Model:o,TemplateName:s},this.headerTabs.push({name:e,title:t,hash:a,koVisibleTab:n,koRecivedAnim:r}),this.screensTitle[e]=i},AppBase.prototype.registerSessionTimeoutFunction=function(e){this.sessionTimeoutFunctions.push(e)},AppBase.prototype.initSessionTimeout=function(){this.setSessionTimeout(),$("body").on("click",_.bind(this.setSessionTimeout,this)).on("keydown",_.bind(this.setSessionTimeout,this))},AppBase.prototype.setSessionTimeout=function(){clearTimeout(this.iSessionTimeout),AppData&&AppData.Auth&&AppData.App.IdleSessionTimeout&&(this.iSessionTimeout=setTimeout(_.bind(this.logoutBySessionTimeout,this),AppData.App.IdleSessionTimeout))},AppBase.prototype.logoutBySessionTimeout=function(){AppData.Auth&&(_.each(this.sessionTimeoutFunctions,function(e){e()}),_.delay(_.bind(this.logout,this),500))},AppBase.prototype.initHeaderInfo=function(){this.browser.ie?$(document).bind("focusin",_.bind(this.onFocus,this)).bind("focusout",_.bind(this.onBlur,this)):$(window).bind("focus",_.bind(this.onFocus,this)).bind("blur",_.bind(this.onBlur,this))},AppBase.prototype.onFocus=function(){this.focused(!0)},AppBase.prototype.onBlur=function(){this.focused(!1)},AppBase.prototype.setTitle=function(e){var t=this.newMessagesCount(),i="";e=e||"",e=this.focused()||0===t||!AppData.App.AllowWebMail?this.getTitleByScreen():Utils.i18n("TITLE/HAS_UNSEEN_MESSAGES_PLURAL",{COUNT:t},null,t)+" - "+AppData.Accounts.getEmail(),this.favico&&(i=t>99?"99+":t,this.favico._cachevalue!==i&&(this.favico._cachevalue=i,this.favico.badge(i))),document.title=".",document.title=e},AppBase.prototype.getTitleByScreen=function(){var e="",t="";try{this.MailCache.currentMessage()&&(t=this.MailCache.currentMessage().subject())}catch(i){}switch(this.currentScreen()){case Enums.Screens.Login:e=Utils.i18n("TITLE/LOGIN",null,"");break;case Enums.Screens.Mailbox:e=AppData.Accounts.getEmail()+" - "+Utils.i18n("TITLE/MAILBOX");break;case Enums.Screens.Compose:case Enums.Screens.SingleCompose:e=AppData.Accounts.getEmail()+" - "+Utils.i18n("TITLE/COMPOSE");break;case Enums.Screens.SingleMessageView:e=AppData.Accounts.getEmail()+" - "+Utils.i18n("TITLE/VIEW_MESSAGE"),t&&(e=t+" - "+e);break;default:this.screensTitle[this.currentScreen()]&&(e=this.screensTitle[this.currentScreen()])}return""===e?e=AppData.App.SiteName:e+=AppData.App.SiteName&&""!==AppData.App.SiteName?" - "+AppData.App.SiteName:"",e},AppBase.prototype.desktopNotify=function(e){Utils.desktopNotify(e)},AppBase.prototype.phoneInOneTab=function(){if(this.Phone&&window.localStorage){var e=this;$(window).on("storage",function(){"false"!==window.localStorage.getItem("p7phoneLoad")&&window.localStorage.setItem("p7phoneLoad","false")}),window.localStorage.setItem("p7phoneLoad",Math.floor(900*Math.random()+100).toString()),window.setTimeout(function(){AppData.SingleMode||!e.Phone||"false"===window.localStorage.getItem("p7phoneLoad")&&!window.sessionStorage.getItem("p7phoneTab")||(e.Phone.init(),window.sessionStorage.setItem("p7phoneTab","true"))},1e3)}},_.extend(AppMobile.prototype,AppBase.prototype),AppMobile.prototype.collectScreensData=function(){AppData.User.ShowContacts&&this.addScreenToHeader("contacts",Utils.i18n("HEADER/CONTACTS"),Utils.i18n("TITLE/CONTACTS"),"Contacts_ContactsViewModel",CContactsViewModel,!0,this.ContactsCache.recivedAnim)},App=new AppMobile,window.App=App,AppData.AllowMobile&&-1===AppData.IsMobile){var bMobile=window.matchMedia("all and (min-width: 768px)").matches?0:1;window.App.Ajax.send({Action:"SystemSetMobile",Mobile:bMobile},function(){bMobile?window.location.reload():$(function(){_.defer(function(){App.run()})})},this)}else $(function(){_.defer(function(){App.run()})});window.Modernizr&&navigator&&window.Modernizr.addTest("mobile",function(){return bMobileApp}),window.AfterLogicApi=AfterLogicApi,window.Enums=Enums,$html.removeClass("no-js").addClass("js"),$html.hasClass("pdf")&&(aViewMimeTypes.push("application/pdf"),aViewMimeTypes.push("application/x-pdf"))}(jQuery,window,ko,crossroads,hasher);
